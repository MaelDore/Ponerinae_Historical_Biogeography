##### Script 02: Curate biogeographic information #####

####################################
#       Author: Maël Doré          #
#  Contact: mael.dore@gmail.com    #
####################################

### Goals

# Curate the specimen-level database for biogeographic information
  # Detect errors in coordinates and manually curated them
  # Use maps to visually detect outliers and correct them
  # Draw random coordinates when missing
  # Clean duplicates
# Aggregated information at taxa-level and update the taxa-level summary df
  # Nb of occurrences
  # Presence/Absence in each Bioregion per taxa
     # Create multiple Bioregion schemes

###

### Inputs

# Specimen-level database
# Taxa-level summary database
# NaturalEarth administrative shapefile to provide country shp for CoordinatesCleaner
# GeoBoundaries shapefile to provide new polygon membership for both GABI and AntWeb
# Bentity2 shapefile from GABI

###

### Sources

# AntWeb. Version 8.101. California Academy of Science, online at https://www.antweb.org. Accessed 14 November 2023.
# GABI: Data release 1.0 of 18 January 2020.
   # Guénard, B., Weiser, M., Gomez, K., Narula, N., Economo, E.P. (2017) The Global Ant Biodiversity Informatics (GABI) database: synthesizing data on the geographic distributions of ant species. Myrmecological News 24: 83-89.

###

### Outputs

# Taxa-level database for taxonomic, ecologic and biogeographic information
# Curated Specimen-level database
# Maps of dubious records per taxa
# Genus-level summary table for biogeographic occcurrences

###


# Clean environment
rm(list = ls())

##### 1/ Load stuff ####

# Intall rgeos from Archive
# install.packages("./packages/rgeos_0.6-4.tar.gz", repos = NULL, type = "source")

# Install lwgeom from Source
# install.packages("lwgeom", type = "source")

### 1.1/ Load packages ####
library(tidyverse)
library(readxl)
library(openxlsx)  # Use Rccp. No need of Java
library(treeio)    # To read tree from any phylogenetic format
library(ggtree)    # To plot tree using the tidyverse grammar
library(tidytree)  # To manipulate tlb_tree tibble that store info on tree topology as list of edges
library(phytools)
library(ape)
library(rnaturalearth)
library(rnaturalearthdata)
library(CoordinateCleaner)
library(mapview)
library(sf)
library(sp)
library(rgeos)
library(units)
library(RColorBrewer)
library(htmlwidgets)
library(htmltools)
library(lwgeom)


### 1.2/ Load databases to clean ####

## Load the curated databases
GABI_database_Ponerinae <- readRDS(file = "./input_data/GABI_Data_Release1.0_18012020/GABI_database_Ponerinae.rds")
AntWeb_database_curated <- readRDS(file = "./input_data/AntWeb_data/AntWeb_database_curated.rds")
Biogeographic_database_Ponerinae <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae.rds")

# date_table <- str_split(string = AntWeb_database_curated$datecollectedstartstr, pattern = "-", simplify = T)
# table(date_table[(nchar(date_table[,1]) == 4), ])
# 
# View(AntWeb_database_curated[str_detect(string = AntWeb_database_curated$datecollectedstartstr, pattern = "1812-"), ])


## Load taxa-level summary df
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")

### 1.3/ Save initial geographic information (to compare if updated) ####

Biogeographic_database_Ponerinae <- Biogeographic_database_Ponerinae %>% 
  mutate(Latitude_dec_initial = Latitude_dec) %>%
  mutate(Longitude_dec_initial = Longitude_dec) %>%
  rename(Country_initial = Country) %>%
  mutate(adm1_initial = adm1) %>%
  mutate(adm2_initial = adm2) %>%
  mutate(Locality_initial = Locality) %>%
  mutate(bentity2_name_initial = bentity2_name) %>%
  mutate(Elevation_initial = Elevation)
  
##### 2/ Check dubious records with CoordinateCleaner #####

?CoordinateCleaner::cc_aohi()    # Flag for coordinates falling into Artificial Hotspots listed by Park et al., 2022
?CoordinateCleaner::cc_cap()     # Flag capitals
?CoordinateCleaner::cc_cen()     # Flag country centroids
?CoordinateCleaner::cc_coun()    # Flag for mismatch between country ID and GPS coordinates
?CoordinateCleaner::cc_dupl()    # Flag duplicates based on name and coordinates
?CoordinateCleaner::cc_equ()     # Flag for equal long/lat
?CoordinateCleaner::cc_inst()    # Flag for coordinates in the vicinity of biodiversity institutions
?CoordinateCleaner::cc_outl()    # Flag for outliers based on mean or minimal distance to other points per taxa
?CoordinateCleaner::cc_sea()     # Flag for coordinates outside of landmass
?CoordinateCleaner::cc_urb()     # Flag for coordinates within urban areas
?CoordinateCleaner::cc_val()     # Flag for coordinates within erroneous and NA coordinates
?CoordinateCleaner::cc_zero()    # Flag for coordinates with null lat or long

?CoordinateCleaner::clean_coordinates # Run all tests


### 2.1/ Assign country ISO codes used to detect mismatch with CoordinateCleaner ####

?CoordinateCleaner::countryref

## Extract country metadata

# # From CoordinateCleaner
# Countries_metadata <- CoordinateCleaner::countryref

# From Natural Earth (since the polygon layer used for matching is from NE, better use directly metadata from NE)
# Countries_NE_sf <- rnaturalearth::ne_countries('medium', returnclass = "sf")
Countries_NE_sf <- rnaturalearth::ne_load(file_name = "ne_10m_admin_0_countries", returnclass = 'sf', destdir = "./input_data/NaturalEarth_maps/Natural_Earth_quick_start/10m_cultural/")
plot(Countries_NE_sf["ISO_A3"])
Countries_NE_metadata <- st_drop_geometry(Countries_NE_sf[, c("SUBUNIT", "ISO_A3")])

table(Countries_NE_metadata$ISO_A3)

# Remove NA
# Countries_NE_metadata <- Countries_NE_metadata[complete.cases(Countries_NE_metadata), ]

#Countries_NE_metadata[!complete.cases(Countries_NE_metadata), ]
Countries_NE_metadata[Countries_NE_metadata$ISO_A3 == "-99", ]
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("France"), "ISO_A3"]) # Includes departments such as Guadeloupe, Martinique, French Guyana, Reunion, and Mayotte
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Norway"), "ISO_A3"]) # Includes Svaldbard and other islands
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Kosovo", "Republic of Serbia"), "ISO_A3"]) 
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Akrotiri Sovereign Base Area", "Dhekelia Sovereign Base Area", "Cyprus", "Cyprus No Mans Area", "Northern Cyprus"), "ISO_A3"])  # British military bases and Turkish area in Cyprus
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Ashmore and Cartier Islands", "Australia", "East Timor"), "ISO_A3"]) # North of Australia
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Bajo Nuevo Bank (Petrel Is.)", "Serranilla Bank", "Colombia", "Jamaica"), "ISO_A3"]) # Caribbean island/reef. Part of Columbia but disputed.
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Baykonur Cosmodrome", "Kazakhstan"), "ISO_A3"]) # In Kazakhstan
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Bir Tawil", "Egypt", "Sudan"), "ISO_A3"]) # Unclaimed territory at the border of Egypt and Sudan
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Brazilian Island", "Uruguay", "Brazil", "Argentina"), "ISO_A3"]) # Disputed Island in Rio Uruguay at the border of Uruguay, Brazil, and Argentina
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Clipperton Island", "Mexico"), "ISO_A3"]) 
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Australia"), "ISO_A3"]) # SE of Australia
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Indian Ocean Territories", "Australia"), "ISO_A3"]) # NW of Australia. Cocos Islands + Christmas Islands
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Scarborough Reef", "Spratly Islands", "Philippines"), "ISO_A3"]) # East of the Philippines. Disputed with China and Taiwan.
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("India", "Siachen Glacier", "Pakistan"), "ISO_A3"]) # Disputed glacier at the border of Pakistan and India
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Somaliland", "Somalia"), "ISO_A3"]) # Norht of Somalia
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Southern Patagonian Ice Field", "Chile", "Argentina"), "ISO_A3"]) # Disputed glacier at the border of Chile and Argentina
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("US Naval Base Guantanamo Bay", "Cuba"), "ISO_A3"]) # US Military base in Cuba

# # Replace NA in "medium" scale
# Countries_NE_metadata$iso_a3[Countries_NE_metadata$name == "Kosovo"] <- "XXK"
# Countries_NE_metadata$iso_a3[Countries_NE_metadata$name == "Ashmore and Cartier Is."] <- "ATC" # North of Australia
# Countries_NE_metadata$iso_a3[Countries_NE_metadata$name == "N. Cyprus"] <- "CYN"
# Countries_NE_metadata$iso_a3[Countries_NE_metadata$name == "Indian Ocean Ter."] <- "CCI" # Christmas Island and Cocos Islands
# Countries_NE_metadata$iso_a3[Countries_NE_metadata$name == "Siachen Glacier"] <- "SCG" # India-Pakistan border
# Countries_NE_metadata$iso_a3[Countries_NE_metadata$name == "Somaliland"] <- "SOL"

# Replace -99 in "small" scale
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Akrotiri Sovereign Base Area"] <- "ASB" # British military bases in Cyprus
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Ashmore and Cartier Islands"] <- "ATC" # North of Australia
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Bajo Nuevo Bank (Petrel Is.)"] <- "BNB" # Caribbean island/reef. Part of Columbia but disputed.
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Baykonur Cosmodrome"] <- "BKC" # In Kazakhstan
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Bir Tawil"] <- "BTW" # Unclaimed territory at the border of Egypt and Sudan
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Brazilian Island"] <- "BIS" # Disputed Island in Rio Uruguay at the border of Uruguay, Brazil, and Argentina
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Clipperton Island"] <- "CPT" # Disputed Island in Rio Uruguay at the border of Uruguay, Brazil, and Argentina
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Coral Sea Islands"] <- "CSI" # SE of Australia
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Cyprus No Mans Area"] <- "CNM"
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Dhekelia Sovereign Base Area"] <- "DSB" # British military bases in Cyprus
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "France"] <- "FRA" # Includes departments such as Guadeloupe, Martinique, French Guyana, Reunion, and Mayotte
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Indian Ocean Territories"] <- "CCI" # Christmas Island and Cocos Islands
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Kosovo"] <- "KOS"
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Northern Cyprus"] <- "CPN" # Turkish part of Cyprus
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Norway"] <- "NOR" # Includes Svaldbard and other islands
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Scarborough Reef"] <- "SCB" # East of the Philippines. Disputed with China and Taiwan.
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Serranilla Bank"] <- "SNB" # Caribbean island/reef. Part of Columbia but disputed.
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Siachen Glacier"] <- "SCG" # India-Pakistan border
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Somaliland"] <- "SOL" # North of Somalia
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Southern Patagonian Ice Field"] <- "SPG" # Disputed glacier at the border of Chile and Argentina
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "Spratly Islands"] <- "SPI" # East of the Philippines. Disputed with China and Taiwan.
Countries_NE_metadata$ISO_A3[Countries_NE_metadata$SUBUNIT == "US Naval Base Guantanamo Bay"] <- "GUT" # US Military base in Cuba

# Countries_NE_metadata[duplicated(Countries_NE_metadata$ISO_A3),]

## Save Countries_NE_sf with updated metadata to use as reference for clean_coordinates
Countries_NE_sf$ISO_A3 <- Countries_NE_metadata$ISO_A3
saveRDS(Countries_NE_sf, file = "./input_data/NaturalEarth_maps/Countries_NE_sf.rds")

# Extract only ISO3 entities
# Countries_metadata_IOS3 <- (Countries_metadata[!duplicated(Countries_metadata$iso3),])
View(Countries_NE_metadata)

# Create new field for ISO3 names
Biogeographic_database_Ponerinae$Country_ISO3_name <- Biogeographic_database_Ponerinae$Country_initial

# Check for names that do not match
# unique(Biogeographic_database_Ponerinae$Country_ISO3_name[!(Biogeographic_database_Ponerinae$Country_ISO3_name %in% Countries_NE_metadata$name)])
unique(Biogeographic_database_Ponerinae$Country_ISO3_name[!(Biogeographic_database_Ponerinae$Country_ISO3_name %in% Countries_NE_metadata$SUBUNIT)])

plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("French Southern and Antarctic Lands", "Madagascar"), "ISO_A3"]) # Includes Kerguelen, Europa island and other stuff
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("New Zealand"), "ISO_A3"]) # Includes Tokelau
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Netherlands"), "ISO_A3"]) # Includes Bonaire, Oranjestad and Saba
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Spain"), "ISO_A3"]) # Includes the Canarias
plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("United Kingdom"), "ISO_A3"]) # Includes the Canarias

# Repair mismatches
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "USA"] <- "United States"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Czech Republic"] <- "Czechia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Zaire"] <- "Democratic Republic of the Congo"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Cote d'Ivoire"] <- "Ivory Coast"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "French Guiana"] <- "France"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Serbia"] <- "Republic of Serbia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "England"] <- "United Kingdom"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Congo (Brazzaville)"] <- "Republic of the Congo"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Saint Vincent"] <- "Saint Vincent and the Grenadines"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Christmas Island"] <- "Indian Ocean Territories"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Trinidad"] <- "Trinidad and Tobago"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Bahamas"] <- "The Bahamas"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Guinea-Bissau [Portuguese Guinea]"] <- "Guinea-Bissau"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "New Guinea"] <- "Papua New Guinea" # May also be Indonesia
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Martinique"] <- "France"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Cape Verde"] <- "Cabo Verde"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Mariana Islands"] <- "Northern Mariana Islands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Mayotte"] <- "France"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Borneo"] <- "Indonesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Malaysia MULT"] <- "Malaysia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Micronesia, Federated States of"] <- "Federated States of Micronesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Great Britain"] <- "United Kingdom"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "?Unknown"] <- "Lesser Antilles"  # Could be many different Islands
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Guadeloupe Islands"] <- "France"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "U.S. Virgin Islands"] <- "United States Virgin Islands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Guadeloupe"] <- "France"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Papua New Guinea ERR"] <- "Papua New Guinea"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "British West Indies"] <- "British West Indies" # Cannot define suitable ISO-3 entities
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Papua New Guinea [Dutch New Guinea]"] <- "Indonesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Channel Islands"] <- "Guernsey" # Could also be Jersey
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Papua New Guinea [German New Guinea]"] <- "Papua New Guinea"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Tokelau"] <- "New Zealand"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Cocos (Keeling) Islands"] <- "Indian Ocean Territories"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Hispaniola"] <- "Dominican Republic"  # Could also be in Haiti
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Indonesia MULT"] <- "Indonesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Saint Kitts & Nevis"] <- "Saint Kitts and Nevis"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "US Virgin Islands"] <- "United States Virgin Islands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Indonesia ERR"] <- "Indonesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "New Guinea ERR"] <- "Papua New Guinea" # May also be Indonesia
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Brunei Darussalam"] <- "Brunei"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Solomon Islands ERR"] <- "Solomon Islands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Comoros Islands"] <- "Comoros"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "N. Mariana Is."] <- "Northern Mariana Islands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Wallis and Futuna Islands"] <- "Wallis and Futuna"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "New Guinea IND"] <- "Indonesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Indonesia [Dutch New Guinea]"] <- "Indonesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Sao Tome and Principe"] <- "São Tomé and Principe"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Netherlands Antilles"] <- "Aruba" # Could also be Curaçao or Bonaire (Netherlands)
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "UK"] <- "United Kingdom"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "New Guinea IND/PAPUA"] <- "Papua New Guinea" # May also be Indonesia
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Seychelles Islands"] <- "Seychelles"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Micronesia"] <- "Federated States of Micronesia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Solomon Islands MULT"] <- "Solomon Islands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Bonaire, Sint Eustatius and Saba"] <- "Netherlands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Hong Kong"] <- "Hong Kong S.A.R."
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Congo"] <- "Republic of the Congo"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Congo [French Congo]"] <- "Republic of the Congo"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Malaysia Peninsular"] <- "Malaysia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Macedonia"] <- "North Macedonia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Malaysia ERR"] <- "Malaysia"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Swaziland"] <- "eSwatini"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Macau"] <- "Macao S.A.R"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "?Unknown (Somalia? Or Ethiopia?)"] <- "Somaliland" # Could be Ethiopia/Somalia
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Democratic Republic of Congo"] <- "Democratic Republic of the Congo"
# Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Port of Entry"] <- NA
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "null"] <- NA
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Unknown"] <- NA
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Rhodesia"] <- "Zimbabwe"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Timor-Leste"] <- "East Timor"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Macaronesia"] <- "Spain"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Reunion"] <- "France"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Europa Island"] <- "French Southern and Antarctic Lands"
Biogeographic_database_Ponerinae$Country_ISO3_name[Biogeographic_database_Ponerinae$Country_ISO3_name == "Panam┬╖"] <- "Panama"

# Biogeographic_database_Ponerinae[Biogeographic_database_Ponerinae$Country_initial == "Macaronesia", ]

# Add ISO-3 code to Biogeographic database
# Biogeographic_database_Ponerinae$Country_ISO3_code <- Countries_metadata$iso3[match(x = Biogeographic_database_Ponerinae$Country_ISO3_name, table = Countries_metadata$name)]
# Biogeographic_database_Ponerinae$Country_ISO3_code <- Countries_NE_metadata$iso_a3[match(x = Biogeographic_database_Ponerinae$Country_ISO3_name, table = Countries_NE_metadata$name)]
Biogeographic_database_Ponerinae$Country_ISO3_code <- Countries_NE_metadata$ISO_A3[match(x = Biogeographic_database_Ponerinae$Country_ISO3_name, table = Countries_NE_metadata$SUBUNIT)]

table(Biogeographic_database_Ponerinae$Country_ISO3_code)

View(Biogeographic_database_Ponerinae[(is.na(Biogeographic_database_Ponerinae$Country_ISO3_code)), ])

## Save specimen database for Biogeographic data on Ponerinae
saveRDS(Biogeographic_database_Ponerinae, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae.rds")

### 2.2/ Remove "Port of Entry data" ####

table(Biogeographic_database_Ponerinae$Country_initial == "Port of Entry")

Biogeographic_database_Ponerinae <- Biogeographic_database_Ponerinae[!(Biogeographic_database_Ponerinae$Country_initial == "Port of Entry"), ]
# Biogeographic_database_Ponerinae_flags <- Biogeographic_database_Ponerinae_flags[!(Biogeographic_database_Ponerinae_flags$Country_initial == "Port of Entry"), ]
# Biogeographic_database_Ponerinae_NA_coords <- Biogeographic_database_Ponerinae_NA_coords[!(Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Port of Entry"), ]
# Biogeographic_database_Ponerinae_no_NA_coords <- Biogeographic_database_Ponerinae_no_NA_coords[!(Biogeographic_database_Ponerinae_no_NA_coords$Country_initial == "Port of Entry"), ]

### 2.3/ Repair broken coordinates ####

# Detect invalid coordinates
Biogeographic_database_Ponerinae$valid_coordinates <- cc_val(x = Biogeographic_database_Ponerinae,
                                                            lon = "Longitude_dec", lat = "Latitude_dec", 
                                                            value = "flagged", verbose = T)

# Flag entries with no coordinates
all_NA_coords <- apply(X = Biogeographic_database_Ponerinae[, c("Latitude_dec", "Longitude_dec")], MARGIN = 1, FUN = function (x) {all(is.na(x))})

# 25 cases of incomplete coordinates with either Latitude or Longitude missing
View(Biogeographic_database_Ponerinae[!Biogeographic_database_Ponerinae$valid_coordinates & !all_NA_coords, ])

table(Biogeographic_database_Ponerinae$Latitude_dec[!Biogeographic_database_Ponerinae$valid_coordinates])
table(Biogeographic_database_Ponerinae$Longitude_dec[!Biogeographic_database_Ponerinae$valid_coordinates])

## Repair them using localities using known mean and sd of latitude for the same locality

# Gorongosa in Mozambique, repaired using known mean and sd of latitude for the same locality
Gorongosa_n <- sum((Biogeographic_database_Ponerinae$adm2 == "Gorongosa") & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec), na.rm = T)
Gorongosa_mean <- mean(Biogeographic_database_Ponerinae$Latitude_dec[Biogeographic_database_Ponerinae$adm2 == "Gorongosa"], na.rm = T)
Gorongosa_sd <- sd(Biogeographic_database_Ponerinae$Latitude_dec[Biogeographic_database_Ponerinae$adm2 == "Gorongosa"], na.rm = T)
Biogeographic_database_Ponerinae$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae$adm2 == "Gorongosa"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- rnorm(n = Gorongosa_n, mean = Gorongosa_mean, sd = Gorongosa_sd)

# Gangwon Province in South Korea, repaired using known mean and sd of latitude for the same locality
Gangwon_n <- sum((Biogeographic_database_Ponerinae$adm1 == "Gangwon Province") & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec), na.rm = T)
Gangwon_mean <- mean(Biogeographic_database_Ponerinae$Latitude_dec[Biogeographic_database_Ponerinae$adm1 == "Gangwon Province"], na.rm = T)
Gangwon_sd <- sd(Biogeographic_database_Ponerinae$Latitude_dec[Biogeographic_database_Ponerinae$adm1 == "Gangwon Province"], na.rm = T)
Biogeographic_database_Ponerinae$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae$adm1 == "Gangwon Province"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- rnorm(n = Gangwon_n, mean = Gangwon_mean, sd = Gangwon_sd)

# Texas Tech University Center repaired using unique latitude known for the same locality
table(Biogeographic_database_Ponerinae$Latitude_dec[Biogeographic_database_Ponerinae$Locality == "Texas Tech University Center, Junction"])
Biogeographic_database_Ponerinae$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae$Locality == "Texas Tech University Center, Junction"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 30.471308
Biogeographic_database_Ponerinae$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae$Locality == "Texas Tech University Center, Junction, Lubbock"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 30.471308
Biogeographic_database_Ponerinae$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae$Locality == "Texas Tech University Center, Junction:Lubbock"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 30.471308

# Parque Nacional do Jaú, Castanho, Baixo Jaú using unique latitude known for the same locality
table(Biogeographic_database_Ponerinae$Latitude_dec[str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Baixo Jaú")])
Biogeographic_database_Ponerinae$Latitude_dec[(replace_na(data = str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Baixo Jaú"), replace = F)) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- -1.95

# Kruger Nat. Park in South Africa, repaired using known mean and sd of latitude for the same locality
Kruger_n <- sum((str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Kruger")) & !is.na(Biogeographic_database_Ponerinae$Latitude_dec) & is.na(Biogeographic_database_Ponerinae$Longitude_dec), na.rm = T)
Kruger_values <- Biogeographic_database_Ponerinae$Longitude_dec[str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Kruger")]
Kruger_values <- Kruger_values[!is.na(Kruger_values) & (Kruger_values > 30)]
Kruger_mean <- mean(Kruger_values, na.rm = T)
Kruger_sd <- sd(Kruger_values, na.rm = T)
Biogeographic_database_Ponerinae$Longitude_dec[replace_na(str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Kruger"), replace = F) & !is.na(Biogeographic_database_Ponerinae$Latitude_dec) & is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- rnorm(n = Kruger_n, mean = Kruger_mean, sd = Kruger_sd)


## If no available entries with GPS coordinates, repair them using GPS coordinates found from Google Maps.

# Buxa Tiger Reserve in India
Biogeographic_database_Ponerinae$Latitude_dec[(Biogeographic_database_Ponerinae$Locality == "Buxa Tiger Reserve") & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 26.616

# Carle Woods (Carl R. Hansen Woods) in Illinois, USA
Biogeographic_database_Ponerinae$Latitude_dec[(Biogeographic_database_Ponerinae$Locality == "Carle Woods") & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 42.053
Biogeographic_database_Ponerinae$Latitude_dec[(Biogeographic_database_Ponerinae$Locality == "Carle Woods") & replace_na(data = (Biogeographic_database_Ponerinae$Latitude_dec == 0), replace = F) & !is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 42.053

# Asuncion Botanical Garden in Paraguay
Biogeographic_database_Ponerinae$Longitude_dec[(str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Asuncion Botanical Garden")) & !is.na(Biogeographic_database_Ponerinae$Latitude_dec) & is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- -57.576

# # Oronoque River, Guyana
# Biogeographic_database_Ponerinae$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Oronoque River"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- -57.422
# Biogeographic_database_Ponerinae$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "Oronoque River"), replace = F) & is.na(Biogeographic_database_Ponerinae$Latitude_dec) & is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 2.6

# North Transvaal in South Africa
Biogeographic_database_Ponerinae$Longitude_dec[(str_detect(string = Biogeographic_database_Ponerinae$Locality, pattern = "North Transvaal")) & !is.na(Biogeographic_database_Ponerinae$Latitude_dec) & is.na(Biogeographic_database_Ponerinae$Longitude_dec)] <- 29.789


View(Biogeographic_database_Ponerinae[!Biogeographic_database_Ponerinae$valid_coordinates & !all_NA_coords, ])
# No more missing coordinates

# Reflag coordinates invalid coordinates
Biogeographic_database_Ponerinae$valid_coordinates <- cc_val(x = Biogeographic_database_Ponerinae,
                                                             lon = "Longitude_dec", lat = "Latitude_dec", 
                                                             value = "flagged", verbose = T)

table(Biogeographic_database_Ponerinae$Latitude_dec[!Biogeographic_database_Ponerinae$valid_coordinates])
table(Biogeographic_database_Ponerinae$Longitude_dec[!Biogeographic_database_Ponerinae$valid_coordinates])
# Empty because only NA

## Save specimen database for Biogeographic data on Ponerinae
saveRDS(Biogeographic_database_Ponerinae, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae.rds")

### 2.4/ Curate entries with zeros ####

#View(Biogeographic_database_Ponerinae_flags[!Biogeographic_database_Ponerinae_flags$.zer, ])

## Set to NA all points with (0,0) coordinates

all_zero_coords <- (Biogeographic_database_Ponerinae$Longitude_dec == 0) & (Biogeographic_database_Ponerinae$Latitude_dec == 0)

Biogeographic_database_Ponerinae$Latitude_dec[all_zero_coords] <- NA
Biogeographic_database_Ponerinae$Longitude_dec[all_zero_coords] <- NA

# Remaining entries should be credible despite Latitude == 0
View(Biogeographic_database_Ponerinae[replace_na(data = (Biogeographic_database_Ponerinae$Latitude_dec == 0), replace = F), ])

# Reflag coordinates invalid coordinates
Biogeographic_database_Ponerinae$valid_coordinates <- cc_val(x = Biogeographic_database_Ponerinae,
                                                             lon = "Longitude_dec", lat = "Latitude_dec", 
                                                             value = "flagged", verbose = T)

## Save specimen database for Biogeographic data on Ponerinae
saveRDS(Biogeographic_database_Ponerinae, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae.rds")


### 2.5/ Run global analysis ####

## Load specimen database for Biogeographic data on Ponerinae
Biogeographic_database_Ponerinae <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae.rds")


## 2.5.1/ Prepare landmass polygons ####

## Load more detailed reference for landmasses polygons
# Default is scale 110/small which left aside many small islands

map_NE_lands_sf <- rnaturalearth::ne_load(file_name = "ne_10m_land", returnclass = 'sf', destdir = "./input_data/NaturalEarth_maps/ne_10m_land/")
map_NE_minor_islands_sf <- rnaturalearth::ne_load(file_name = "ne_10m_minor_islands", returnclass = 'sf', destdir = "./input_data/NaturalEarth_maps/ne_10m_minor_islands/")
map_NE_all_lands_sf <- rbind(x = map_NE_lands_sf, y = map_NE_minor_islands_sf)

plot(map_NE_lands_sf["featurecla"])
plot(map_NE_minor_islands_sf["featurecla"])
plot(map_NE_all_lands_sf["featurecla"])

## Remove small islands (< 5 km²) to save computation time!

map_NE_lands_sf_cast <- st_as_sf(st_cast(map_NE_lands_sf, "POLYGON")) # Disaggregate MUTLIPOLYGON into POLYGONS
map_NE_lands_sf_cast$area <- st_area(map_NE_lands_sf_cast)
map_NE_lands_sf_cast$area <- set_units(map_NE_lands_sf_cast$area, km^2)

plot(map_NE_lands_sf_cast["area"])
plot(map_NE_lands_sf_cast[map_NE_lands_sf_cast$area > as_units(5, "km^2"), "area"])

map_NE_lands_sf_cast <- map_NE_lands_sf_cast[map_NE_lands_sf_cast$area > as_units(5, "km^2"), "area"]

## Apply buffer ourselves because terra version in CoordinateClean::cc_sea leads to error

# Consider lat/long to be Cartesian spatial coordinates.
# Not strictly correct. Lead to distance deformation and issue with buffer crossing -180/180 line...
# Distance in degrees. 0.05 ≈ 5.55 km at the equator

sf_use_s2(FALSE) # Need to desactivate s2 features that cannot deal with antimeridian crossing and coordinates beyond lat/long limits
map_NE_lands_sf_buffer <- st_buffer(x = map_NE_lands_sf_cast, dist = 0.05)
sf_use_s2(TRUE)

# map_NE_lands_sf_buffer <- st_make_valid(st_buffer(x = map_NE_lands_sf, dist = 0.1))
plot(map_NE_lands_sf["featurecla"])
plot(map_NE_lands_sf_buffer["area"])

## Adjust boundaries
# Need to limit to a 180/90 rectangle (extent beyond when adding buffer to Antarctica for instance)
st_bbox(map_NE_lands_sf)
st_bbox(map_NE_lands_sf_buffer)

geo_limits <- st_geometry(st_sfc(st_point(c(-180,-90)), st_point(c(180,90))), crs = st_crs(map_NE_lands_sf_buffer))
st_crs(geo_limits) <- st_crs(map_NE_lands_sf_buffer)
sf_use_s2(FALSE) # Need to desactivate s2 features that cannot deal with antimeridian crossing and coordinates beyond lat/long limits
map_NE_lands_sf_buffer <- st_crop(x = map_NE_lands_sf_buffer, y = geo_limits)
sf_use_s2(TRUE)

plot(map_NE_lands_sf_buffer)

# Check validity
table(st_is_valid(map_NE_lands_sf_buffer))
# plot(map_NE_lands_sf_buffer[!st_is_valid(map_NE_lands_sf_buffer), ])

## Save landmass buffer
saveRDS(map_NE_lands_sf_buffer, file = "./input_data/NaturalEarth_maps/map_NE_lands_sf_buffer.rds")

# ### sp version ###
# 
# ## Apply buffer ourselves because terra version in CoordinateClean::cc_sea leads to error
# 
# # Apply buffer via RGEOS because sf version sucks
# map_NE_lands_sp <- rnaturalearth::ne_load(file_name = "ne_10m_land", returnclass = 'sp', destdir = "./input_data/NaturalEarth_maps/ne_10m_land/")
# 
# plot(map_NE_lands_sp)
# 
# # Consider lat/long to be Cartesian spatial coordinates. 
# # Not strictly correct. Lead to distance deformation and issue with buffer crossing -180/180 line...
# # Better option with st_buffer in sf, which use spherical geometry, but does not seems to work...
# # Convert to a unique mutipolygon (which may fasten computation?)
# # Distance in degrees. 0.05 ≈ 5.55 km at the equator
# map_NE_lands_sp_buffer <- rgeos::gBuffer(spgeom = map_NE_lands_sp, width = 0.05)
# 
# plot(map_NE_lands_sp_buffer)
# 
# ## Adjust boundaries
# # Need to limit to a 180/90 rectangle (extent beyond when adding buffer to Antarctica for instance)
# st_bbox(map_NE_lands_sp)
# st_bbox(map_NE_lands_sp_buffer)
# 
# # geo_limits <- st_geometry(st_sfc(st_point(c(-180,-90)), st_point(c(180,90))), crs = st_crs(map_NE_lands_sf_buffer))
# # st_crs(geo_limits) <- st_crs(map_NE_lands_sf_buffer)
# # map_NE_lands_sf_buffer <- st_intersection(x = map_NE_lands_sf_buffer, y = geo_limits)
# 
# geo_limits <- SpatialPolygons(Srl = list(Polygons(srl = list(Polygon(coords = rbind(c(-180,-90), c(-180,90), c(180,90), c(180, -90), c(-180,-90)), hole = as.logical(NA))), ID = "bbox_180_90")), proj4string = raster::crs(map_NE_lands_sp_buffer))
# map_NE_lands_sp_buffer <- gIntersection(spgeom1 = map_NE_lands_sp_buffer, spgeom2 = geo_limits)
# 
# ## Simplify shapes to accelerate computation (If applied earlier, make gIntersection crash for some reason...)
# map_NE_lands_sp_buffer <- gSimplify(map_NE_lands_sp_buffer, tol = 0.1, topologyPreserve = T)
# 
# plot(map_NE_lands_sp_buffer)
# 
# # map_NE_lands_sf_buffer <- st_buffer(x = map_NE_lands_sf, dist = 0.01)
# # # map_NE_lands_sf_buffer <- st_make_valid(st_buffer(x = map_NE_lands_sf, dist = 0.1))
# # plot(map_NE_lands_sf["featurecla"])
# # plot(map_NE_lands_sf_buffer["featurecla"])
# 
# ## Convert to sf and clean out invalid features
# 
# map_NE_lands_sf_buffer <- st_as_sf(map_NE_lands_sp_buffer)
# plot(map_NE_lands_sf_buffer)
# 
# # Some features are invalid. Need to remove them?
# st_is_valid(map_NE_lands_sf_buffer)
# # map_NE_lands_sf_buffer_cast <- st_cast(map_NE_lands_sf_buffer, "POLYGON") # Disaggregate MUTLIPOLYGON into POLYGONS
# # map_NE_lands_sf_buffer_cast$valid <- st_is_valid(map_NE_lands_sf_buffer_cast) # Check validity of each polygon
# # 
# # plot(map_NE_lands_sf_buffer_cast["valid"])
# 
# ## Merge polygons to avoid overlaps due to buffering
# sf_use_s2(FALSE)
# map_NE_lands_sf_buffer <- st_union(x = st_make_valid(map_NE_lands_sf_buffer))
# sf_use_s2(TRUE)
# 
# st_is_valid(map_NE_lands_sf_buffer)
# st_bbox(map_NE_lands_sf_buffer)
# 
# plot(map_NE_lands_sf["featurecla"])
# plot(map_NE_lands_sf_buffer)
# 
# ## Remove islands smaller than 10 km² (after buffer is applied so way smaller in practice) to save computation time
# 
# map_NE_lands_sf_buffer <- st_as_sf(st_cast(map_NE_lands_sf_buffer, "POLYGON")) # Disaggregate MUTLIPOLYGON into POLYGONS
# st_geometry(map_NE_lands_sf_buffer) <- "geometry"
# 
# 
# names(map_NE_lands_sf_buffer) <- c("geometry")
# test <- map_NE_lands_sf_buffer
# test$area <- st_area(test)
# test$area <- set_units(test$area, km^2)
# 
# plot(test)
# plot(test[test$area > as_units(80, "km^2"), ])
# 
# ### sp version ###

### 2.5.2/ Run global test ####

## Load landmass buffer
map_NE_lands_sf_buffer <- readRDS(file = "./input_data/NaturalEarth_maps/map_NE_lands_sf_buffer.rds")

## Load better quality country polygons
# Countries_NE_sf <- rnaturalearth::ne_countries(scale = 10, returnclass = "sf")
Countries_NE_sf <- readRDS(file = "./input_data/NaturalEarth_maps/Countries_NE_sf.rds")

## Extract entries with invalid coordinates
Biogeographic_database_Ponerinae_NA_coords <- Biogeographic_database_Ponerinae[!Biogeographic_database_Ponerinae$valid_coordinates, ]
Biogeographic_database_Ponerinae_no_NA_coords <- Biogeographic_database_Ponerinae[Biogeographic_database_Ponerinae$valid_coordinates, ]

## Save entries with NA data to retrieve later
saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

## Obtain flags for each test
# Biogeographic_database_Ponerinae_flags_rerun <- clean_coordinates(x = Biogeographic_database_Ponerinae_flags_rerun,
# Biogeographic_database_Ponerinae_flags_rerun <- clean_coordinates(x = Biogeographic_database_Ponerinae_flags,
Biogeographic_database_Ponerinae_flags <- clean_coordinates(x = Biogeographic_database_Ponerinae_no_NA_coords,
                           lon = "Longitude_dec", lat = "Latitude_dec",
                           countries = "Country_ISO3_code",
                           species = "Current_name",
                           value = "spatialvalid",         # To define the type of output. Can be a spatial df ("spatialvalid"), a logical vector recording entries with at least one flag ("flagged"), a df with dubious coordinates removed ("clean").
                           verbose = T,
                           # List of tests to run
                           tests = c(#"aohi",          # Coordinates found in Artificial Hotspots
                                     "capitals",      # Coordinates found in capitals
                                     "centroids",     # Coordinates found at centroids of countries
                                     "countries",     # Test if occurrences are found within a list of countries or a custom SpatialPolygon
                                     "duplicates",    # Check for duplicates (identical coordinates) within taxa
                                     #"equal",         # Check for coordinates with latitude = longitude
                                     # "gbif",         # Check if the coordinates is within a 1km radius around the GBIF headquarter
                                     "institutions",  # Test if occurrences are found arouf known institution locations
                                     "outliers",      # Test for minimum/mean distance to other occurrences per taxa
                                     # "range"         # Test if coordinates fall within species range extracted from IUCN
                                     "seas"           # Test if fall in the ocean
                                     # "urban"          # Test if fall within urban areas
                                     # "zeros"          # Test for coordinates with null latitude or longitude
                                     ), 
                           outliers_method = "distance",  # Use minimum distance to detect outlier
                           outliers_td = 1000,            # Minimum distance to detect outlier (in km)
                           # outliers_mtp = 5.             # Multiplier for the IRQ of mean distance to flag as outlier
                           outliers_size = 3,             # Minimum number of records for a given taxa to test for outliers
                           # seas_scale = 10,               # Adjust resolution of landmass polygons used as reference. 10 = highest resolution.
                           seas_ref = map_NE_lands_sf_buffer,   # sf SpatialPolygons to use as reference for landmasses. Default is too coarse. 
                           # seas_ref = map_NE_all_lands_sf,   # sf SpatialPolygons to use as reference for landmasses. Default is too coarse. 
                           inst_rad = 200,                # Radius around Biodiversity institutions (in meters)
                           capitals_rad = 3000,           # Radius around capitals (in meters)
                           centroids_rad = 200,           # Radius around country centroids (in meters)
                           country_ref = Countries_NE_sf,  # sf SpatialPolygons to use as reference for countries
                           country_refcol = "ISO_A3",     # Name of ISO3 column
                           country_buffer = 5000,         # Buffer around country polygons (in meters)
                           # seas_buffer = 5000,            # Buffer around landmass limits (in meters) # Does not work properly with scale 10 map. Make our own prior
                           aohi_rad = 3000)               # Buffer around AOHI coordinates (in meters)

# In case of successful rerun, replace previous run
# Biogeographic_database_Ponerinae_flags <- Biogeographic_database_Ponerinae_flags_rerun

# Check results for each test in specific columns in the output
View(Biogeographic_database_Ponerinae_flags)

## Save raw output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")
# saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags_backup.rds")

### 2.6/ Curate records for each category ####

## Load flagged output from CoordinateCleaner
Biogeographic_database_Ponerinae_flags <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")

### 2.6.1/ Prepare data ####

# Convert Flagged df to sf 
Biogeographic_database_Ponerinae_flags$Latitude_copy <- Biogeographic_database_Ponerinae_flags$Latitude_dec
Biogeographic_database_Ponerinae_flags$Longitude_copy <- Biogeographic_database_Ponerinae_flags$Longitude_dec
Biogeographic_database_Ponerinae_flags <- st_as_sf(Biogeographic_database_Ponerinae_flags, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_flags) <- sp::CRS('+init=EPSG:4326')

# Design factor level for type of flags
# Hierarchy of priorities: "zeros", "equal", "countries", "seas", "centroids", "capitals", "aohi", "institutions", "outliers", "urban", "duplicates"
Biogeographic_database_Ponerinae_flags$flag_type <- "OK"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.urb] <- "urban"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.otl] <- "outliers"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.inst] <- "institutions"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.aohi] <- "aohi"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cap] <- "capitals"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cen] <- "centroids"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.sea] <- "seas"
Biogeographic_database_Ponerinae_flags$flag_type[!as.logical(Biogeographic_database_Ponerinae_flags$.con)] <- "countries"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.equ] <- "equal"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.zer] <- "zeros"

Biogeographic_database_Ponerinae_flags$flag_type <- as.factor(Biogeographic_database_Ponerinae_flags$flag_type)  

table(Biogeographic_database_Ponerinae_flags$flag_type)

plot(Biogeographic_database_Ponerinae_flags["flag_type"])

## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")
# saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags_no_curation.rds")

### 2.6.2/ Curate records falling in wrong country ####

table(Biogeographic_database_Ponerinae_flags$.con)

View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "countries", ] %>% arrange(Country_ISO3_name, adm1, adm2, Locality))

test <- Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "countries", ] %>% arrange(Country_ISO3_name, adm1, adm2, Locality)
table(test$Source) # Mostly GABI records

## 2.6.2.1/ False positive: case of records flagged as wrong, but that are actually right (tiny islands not in the shapefiles) ####

# Australia, Islands in Torres Strait, Queensland
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00005107", "GABI_00005108")] <- "Murray Island"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00005107", "GABI_00005108")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00005107", "GABI_00005108")] <- TRUE
# Australia, Islands along Queensland coast. All records are within/around tiny islands and are correct
# plot(Biogeographic_database_Ponerinae_flags[(Biogeographic_database_Ponerinae_flags$flag_type == "countries") & (Biogeographic_database_Ponerinae_flags$adm1 == "Queensland"), "adm2"])
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = ((Biogeographic_database_Ponerinae_flags$flag_type == "countries") & (Biogeographic_database_Ponerinae_flags$adm1 == "Queensland")), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = ((Biogeographic_database_Ponerinae_flags$flag_type == "countries") & (Biogeographic_database_Ponerinae_flags$adm1 == "Queensland")), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00425260")] <- "Lizard Island"
# Australia, Reversby Island, South Australia
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = ((Biogeographic_database_Ponerinae_flags$flag_type == "countries") & (Biogeographic_database_Ponerinae_flags$adm1 == "South Australia")), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = ((Biogeographic_database_Ponerinae_flags$flag_type == "countries") & (Biogeographic_database_Ponerinae_flags$adm1 == "South Australia")), replace = F)] <- TRUE
# Australia, Imperieuse Reef, West of Broome, Western Australia
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00660331")] <- TRUE
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-031706")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00660331")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-031706")] <- TRUE
# Australia, Lord Howe Island, East of New South Wales
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00761142")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00761142")] <- TRUE
# Australia, Deception Bay, Groote Eylandt, Northern territory
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00674639")] <- TRUE
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-066527")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00674639")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-066527")] <- TRUE

# Brazil, small islands along the coast of Sao Paulo
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$adm2 %in% c("Ilha Queimada", "Ilha de Búzios", "Ilhabela")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$adm2 %in% c("Ilha Queimada", "Ilha de Búzios", "Ilhabela")] <- TRUE

# Ecudaor, Galapagos Islands, Seymour Norte
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0173306")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0173306")] <- TRUE

# Equatorial Guinea, Isla de N. Grande
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("mncn-ent-146093")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("mncn-ent-146093")] <- TRUE

# Federated States of Micronesia: Woleai Atoll, Nama Island
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Woleai"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nama Is"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Woleai"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nama Is"), replace = F)] <- TRUE

# France, Port-Cros, Ile de Bagaud
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01913833", "GABI_01913918")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01913833", "GABI_01913918")] <- TRUE

# Cocos (Keeling) Islands / Indian Ocean Territories
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00760735", "GABI_00760736", "GABI_00758961", "GABI_00758962", "GABI_00758963", "GABI_00758964")] <- "Cocos (Keeling) Islands"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00760735", "GABI_00760736", "GABI_00758961", "GABI_00758962", "GABI_00758963", "GABI_00758964")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00760735", "GABI_00760736", "GABI_00758961", "GABI_00758962", "GABI_00758963", "GABI_00758964")] <- TRUE

# Indonesia, Lampung, Krakatau Islands
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Krakatau Island"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Krakatau Island"), replace = F)] <- TRUE
# Indonesia, Lampung, Krakatau Islands, Pulau Sertung
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Sertung"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Sertung"), replace = F)] <- TRUE
# Indonesia, Lampung, (Krakatau Islands), Rakata Besar
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Rakata Besar"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Rakata Besar"), replace = F)] <- TRUE
# Indonesia, Nusa Tenggara Timur, Pulau Papagarang, Manggarai Barat
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Pulau Papagarang"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Pulau Papagarang"), replace = F)] <- TRUE
# Indonesia, Aceh, Pulau Banyak Barat, Pulau Panjang 
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Panjang"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Panjang"), replace = F)] <- TRUE

# Italia, Isola Palmarola and Ponza
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00823282", "GABI_00818898")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00823282", "GABI_00818898")] <- TRUE

# Japan, Oshima District, Ukechima Island
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01936354", "GABI_01936357")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01936354", "GABI_01936357")] <- TRUE
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01936354", "GABI_01936357")] <- "Ukechima Island"
# Japan, Kagoshima District, Minamisatsuma, Uji Island
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01755335")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01755335")] <- TRUE
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01755335")] <- "Uji Island"
# Japan, Kagoshima District, Mishima, Takeshima Island
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00349134")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00349134")] <- TRUE
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00349134")] <- "Takeshima Island"
# Japan, Ehime District, Aoshima Island
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0915202")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0915202")] <- TRUE

# Madagascar, Nosy Ratsy, Nosy Manampaho and Nosy Mangabe on the NE coast
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nosy Ratsy"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nosy Manampao"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nosy Ratsy"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nosy Manampao"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00473283")] <- "Masoala National Park, Nosy Mangabe"
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nosy Mangabe"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Mangabé Island"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Maroantsetra"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nosy Mangabe"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Mangabé Island"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Maroantsetra"), replace = F)] <- TRUE

# Malaysia, Borneo, Sabah, Mamutik Island
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Mamutik Island"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Mamutik Island"), replace = F)] <- TRUE

# Mauritius, Round Island
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Round Island"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Round Island"), replace = F)] <- TRUE

# Palau, Mecherchar Island
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02144550", "GABI_00679176", "GABI_00676605")] <- "Mecherchar Island"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02144550", "GABI_00679176", "GABI_00676605")] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02144550", "GABI_00679176", "GABI_00676605")] <- TRUE
# Palau, Sonsorol, Merir Island
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1, pattern = "Sonsorol") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Merir Island"
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1, pattern = "Sonsorol") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1, pattern = "Sonsorol") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE

# PNG, Manus, Hermit group, Luf Island
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Luf Is") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Luf Is") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
# PNG, Morobe Province, Tami Islands
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Tami") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Tami Islands"
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Tami") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Tami") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE

# Peru, Madre de Dios, P.N. Pampas de Heath
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Pampas de Heath") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Pampas de Heath") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE

# Saint Vincent and the Grenadines, many small islands: Baliceaux Island, Battowia Island, Catholic Island, Petit Canouan, Petit Saint Vincent Island, Savan Island
Biogeographic_database_Ponerinae_flags$.con[replace_na((Biogeographic_database_Ponerinae_flags$Locality %in% c("Baliceaux Island", "Battowia Island", "Catholic Island", "Petit Canouan", "Petit Saint Vincent Island", "Savan Island")) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na((Biogeographic_database_Ponerinae_flags$Locality %in% c("Baliceaux Island", "Battowia Island", "Catholic Island", "Petit Canouan", "Petit Saint Vincent Island", "Savan Island")) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE

# Samoa, Nu'utele Island
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00941224", "GABI_00941234")] <- "Nu'utele Island"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00941224", "GABI_00941234")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00941224", "GABI_00941234")] <- "TRUE"

# Seychelles, Aldabra Atoll and Cosmoledo Island
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-015992", "casent0172609")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-015992", "casent0172609")] <- "TRUE"

# Sierra Leone, Banana Islands
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02315552")] <- "Banana Islands"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02315552")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02315552")] <- "TRUE"

# Solomon Islands, Malaupaina Island
Biogeographic_database_Ponerinae_flags$Locality[(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -10.248) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 161.97)] <- "Malaupaina Island"
Biogeographic_database_Ponerinae_flags$.con[(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -10.248) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 161.97)] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -10.248) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 161.97)] <- "TRUE"
# Solomon Islands, Reef Islands, Nibanga Temau
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-046469")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00669091")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-046469")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00669091")] <- "TRUE"
# Solomon Islands, Santa Cruz Group, Vanikoro Island
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Vanikoro") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Vanikoro") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "TRUE"
# Solomon Islands, Santa Cruz Group, Anuta Island 
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Anuda Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Anuda Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "TRUE"
# Solomon Islands, Reef Islands, Matema Island
Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Matema Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Matema Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "TRUE"
# Solomon Island, Unnamed islands North of Santa Isabel
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00759029")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00759029")] <- "TRUE"

# South Korea, Maemuldo Islands
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00352044", "GABI_00352045")] <- "Maemuldo Islands"
Biogeographic_database_Ponerinae_flags$.con[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00352044", "GABI_00352045")] <- "TRUE"
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00352044", "GABI_00352045")] <- "TRUE"

# Spain, Galicia: Isla de Cíes and Isla de Ons
Biogeographic_database_Ponerinae_flags$.con[replace_na((Biogeographic_database_Ponerinae_flags$adm2_initial %in% c("Isla de Cíes", "Isla de Ons")) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na((Biogeographic_database_Ponerinae_flags$adm2_initial %in% c("Isla de Cíes", "Isla de Ons")) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- TRUE

## Convert back to logical the "countries" and "sea" flags
Biogeographic_database_Ponerinae_flags$.con <- as.logical(Biogeographic_database_Ponerinae_flags$.con)
Biogeographic_database_Ponerinae_flags$.sea <- as.logical(Biogeographic_database_Ponerinae_flags$.sea)

# geoBoundaries_adm1_sf <- st_read(dsn = "./input_data/geoBoundaries/geoBoundariesCGAZ_ADM1/", layer = "geoBoundariesCGAZ_ADM1")
# plot(geoBoundaries_adm1_sf["shapeName"])

# geoBoundaries_adm2_sf <- st_read(dsn = "./input_data/geoBoundaries/geoBoundariesCGAZ_ADM2/", layer = "geoBoundariesCGAZ_ADM2")
# plot(geoBoundaries_adm2_sf["shapeName"]) 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$shapeGroup == "AUS", "shapeName"])


## 2.6.2.2/ True positive: Erroneous coordinates to correct (close to border/imprecision, error of sign, error on one digit) ####

# Antigua and Barbuda => Wrong longitude. -61.82 instead of -62.82
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02105751", "GABI_02105752", "GABI_02105753")] <- -61.82

# Argentina, Iguazu National Park. Latitude should be negative
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Iguazu National Park", "2.9 km SW of San ignacio")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Iguazu National Park", "2.9 km SW of San ignacio")])
# Argentina, San Andresito => Wrong longitude. -54.5 instead of -55.9
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "San Androcito"), replace = F) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- -54.5
# Argentina, Reserva El Loro Hablador 
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "El Loro Hablador"), replace = F) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- -62.35
# Argentina, Parque Nacional Chaco => Wrong longitude. -59.61 instead of -41.04
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Parque Nacional Chaco"), replace = F) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- -59.61

# Cocos/Keeling Islands. Wrong ISO country (currently in Australia) + wrong rounded coordinates
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 96.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -12.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- 96.90
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 96.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -12.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- -12.116666670
Biogeographic_database_Ponerinae_flags$adm1[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 96.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -12.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- "Cocos (Keeling) Islands"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 96.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -12.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- "Indian Ocean Territories"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 96.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -12.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- "CCI"

# Australia, Queensland => Wrong longitude. Fall in ocean. 145.65 instead of 145.76666
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00651269")] <- 145.65
# Australia, Northern Territory, Howard Springs => Wrong rounded latitude falling North in the Indian Ocean. -12.50 instead of -12.00
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Howard Springs") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -12.50
# Australia, North Western Australia => Wrong latitude. Latitude should be negative.
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("TCMBW")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("TCMBW")])
# Australia, North Western Australia => Wrong longitude. Longitude should be positive.
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$bentity2_name_initial %in% c("South Western Australia")] <- abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$bentity2_name_initial %in% c("South Western Australia")])

# Barbados => Wrong longitude. Longitude should be negative. 
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Barbados")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Barbados")])
Biogeographic_database_Ponerinae_flags$bentity2_name[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Barbados")] <- "Lesser Antilles"
# Barbados => wrong rounded coordinates ending in the ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -59.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == 13.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- -59.58
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -59.00000) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == 13.000000) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")] <- 13.20

# Brazil => Wrong longitude. Longitude should be negative. 
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Brazil")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Brazil")])
# Brazil, Ceara => Wrong Latitude. Longitude should be negative. 
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Ceara")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Ceara")])
# Brazil, Espirito Santo, Linhares => Wrong rounded coordinates ending in the ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = ((Biogeographic_database_Ponerinae_flags$Locality_initial == "Linhares") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")), replace = F)] <- -40.04
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = ((Biogeographic_database_Ponerinae_flags$Locality_initial == "Linhares") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries")), replace = F)] <- -19.41
# Brazil, Mato Grosso do Sul, Serra da Bodoquena National Park => Wrong coordinates falling in Paraguay
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Da Mata farm")), replace = F)] <- -56.74
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kadiweu reserve")), replace = F)] <- -57.25
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Salobra river")), replace = F)] <- -56.76
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Salobra river")), replace = F)] <- -20.86
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sta Maria farm-Perdido river")), replace = F)] <- -56.92
# Brazil, Minas Gerais, Juiz de Fora => Wrong latitude. Latitude should be negative. 
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Juiz de Fora")), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Juiz de Fora")), replace = F)])
# Brazil, Rio de Janeiro => Wrong latitude ending in the ocean. -22.919 instead of 23.919
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Rio de Janeiro") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -22.919
# Brazil, Rondônia, Porto Velho => Wrong longitude ending in the ocean. -63.904 instead of -93.904
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Port Velho") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -63.904
# Brazil, Rondônia, Porto Velho => Latitude and Longitude are reversed!
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$adm2_initial, pattern = "Porto Velho") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$adm2_initial, pattern = "Porto Velho") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)]
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$adm2_initial, pattern = "Porto Velho") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$adm2_initial, pattern = "Porto Velho") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)]
# Brazil, Santa Catarina => Wrong signs for latitude/longitude. Should be negative + one records need to be shift back in the landmass
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Santa Catarina") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -48.553
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Santa Catarina") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -27.158
# Brazil, Sao Paulo, Mogi das Cruzes => Wrong rounded coordinates ending in the ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mogi das Cruzes") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -46.142
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mogi das Cruzes") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -23.532
# Brazil, Sao Paulo, Parque Leon Feffer => Wrong rounded coordinates ending in the ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Parque Leon Feffer") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -46.223
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Parque Leon Feffer") & Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -23.529

# Cameroon, Mbale Mejo to Ekingli => Wrong rounded coordinates
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("sam-hym-c002505")] <- 11.717
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("sam-hym-c002505")] <- 3.603

# China, Guangxi, Fangchenggang City, Mt. Shiwandashan => Wrong latitude, falling into China Sea => 21.91 instead of 21.18
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02357907")] <- 21.91
# China, Yunnan => Wrong longitude. Longitude should be positive.
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Yunnan")] <- abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Yunnan")])
# China, Yunnan, Bakaxiaozhai, Menglun Town => Wrong coordinates falling in Vietnam
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Menglun Town") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 101.254
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Menglun Town") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 21.931


# Colombia, Antioquia, Salgar => Wrong latitude. 5.963 instead of 68.70200
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Salgar") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 5.963
# Colombia, Atlantico, Piojó => Wrong coordinates. Fall into Caribbean sea North of the coast
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Piojó") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -75.108
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Piojó") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 10.749
# Colombia, Bolivar, Los Colorados Venado => Wrong longitude. -75.116 instead of -52.116
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Los Colorados Venado") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -75.116
# Colombia, Cauca, PNN Gorgona Mancora => Wrong longitude. -78.183 instead of -18.183
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "PNN Gorgona Mancora") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -78.183
# Colombia, Cauca, Cundinamarca => Wrong latitude. 5.000 instead of 50.000
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cundinamarca") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 5.000
# Colombia/Venezuela, Cesar, Sierra de Perija, Socorpa Mission. NP is in Venezuela so rounded coordinates are likely wrong. # Need also to change the country.
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0178780"] <- -72.867407
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0178780"] <- 9.948540
# Colombia, La Guajira => Wrong latitude. Latitude should be positive. 
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("La Guajira")] <- abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("La Guajira")])
# Colombia, Magdalena, Santa Marta => Wrong coordinates. Fall into Caribbean sea North of the coast. 11.242 instead of 11.352
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00529958"), replace = F)] <- -74.205
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00529958"), replace = F)] <- 11.242
# Colombia, Narino, Barbacoas, RN Río Ñambí => Wrong latitude. Latitude should be positive. 
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Narino")] <- abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Narino")])
# Colombia, Putumayo, Puerto Leguízamo => Wrong longitude. -74.983300 instead of -79.983300
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bajo Cusacante") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -74.983300
# Colombia, Risaralda, El Trapiche => Wrong longitude. -75.954167 instead of -6.954167
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "El Trapiche") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -75.954167
# Colombia, Valle del Cauca, Farallones de Cali National Park => Wrong longitude. -76.656000 instead of -79.656000
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Farallones de Cali National Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -76.656000
# Colombia, Valle del Cauca, Bajo Calima, Buenaventura => Wrong longitude. Should be negative.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bajo Calima") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bajo Calima") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)])

# Costa Rica, Alajuela => Coordinates reversed AND wrong signs! (Master class...)
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01692539", "GABI_01692601")] <- -1 * Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01692539", "GABI_01692601")]
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01692539", "GABI_01692601")] <- -1 * Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01692539", "GABI_01692601")]
# Costa Rica, Limon, Salsipuedes => Wrong latitude. Fall North to Limon in the Carribean sea. 10.007 instead of 10.07
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Salsipuedes") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 10.007
# Costa Rica, Puntarenas, Sirena => Wrong coordinates. Fall South in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sirena") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -83.59129
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sirena") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 8.480170
# Costa Rica, Puntarenas, Estacion Biological Las Cruces => Wrong longitude. -82.960 instead of -82.010000
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Estacion Biological Las Cruces") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -82.960
# Costa Rica, La Virgen => Wrong longitude. -83.75 instead of -8.75
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00527157"), replace = F)] <- -83.75

# Croatia, Dalmacia, Sucurac => Wrong coordinates falling in Montenegro
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sucurac") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 16.431
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sucurac") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 43.553
# Croatia, Hvar Island, Hvar => Wrong Longitude falling in the Adriatic Sea. 16.453 instead of 14.433333
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Hvar") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 16.453
# Croatia, Dalmacia, Kastela => Wrong coordinates falling in Bosnia & Herzegovina
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kastela") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 16.350
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kastela") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 43.555

# Cuba, Cumanayagua, Mina Carlota => Wrong coordinates falling in Mexico !
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cumanayagua, Mina Carlota") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -80.16667
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cumanayagua, Mina Carlota") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 22.06667

# DRC, Masosa => Wrong coordinates in Congo. Not sure of the new ones but better than random.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Masosa") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 22.323
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Masosa") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 2.215
# DRC, Manamama => Wrong coordinates in Congo. Not sure of the new ones but better than random.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Manamama") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 19.232
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Manamama") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -4.076
# Biogeographic_database_Ponerinae_flags$.con[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Manamama") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- T

# DRC/Central African Republic, Bangassou => Wrong rounded latitude (too South) and Wrong country
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bangassou") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 4.739

# Ecuador, Los Rios, Rio Palenque => Wrong latitude. Latitude should be negative.  
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Los Rios")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Los Rios")])
# Ecuador, Sucumbios, Limoncocha => Wrong longitude falling in Colombia. -76.6 instead of -73.6
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00845352"), replace = F)] <- -76.6
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00845352"), replace = F)] <- "Sucumbíos"

# El Salvador, Santa Ana, Montecristo => Wrong coordinates falling in Guatemala. -76.6 instead of -73.6
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_02152843"), replace = F)] <- -89.39258
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_02152843"), replace = F)] <- 14.39603

# Eritrea/Ethiopia, Nefasit => Wrong rounded coordinates + Wrong country: Eritrea instead of Ethiopia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_01942955"), replace = F)] <- 39.065
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_01942955"), replace = F)] <- 15.331
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_01942955"), replace = F)] <- "Nefasit"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01942955")] <- "Eritrea"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01942955")] <- "ERI"

# Micronesia, Tol Island, Mt. Unibot => Wrong coordinates falling in the lagoon
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mt. Unibot") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 151.628
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mt. Unibot") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 7.368
# Micronesia, Pohnpei, Ponape Agriculture & Trade School => Wrong rounded coordinates falling in the lagoon
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Ponape Agriculture & Trade School") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 158.308
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Ponape Agriculture & Trade School") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 6.842
# Micronesia, Woleai Atoll => Wrong coordinates falling in the lagoon
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Woleai Atoll") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 143.913
# Micronesia, Nama Island => Wrong coordinates falling in the lagoon
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Nama Is") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 152.576
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Nama Is") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 6.992

# French Guyana, Campus Agronomique in Kourou => Wrong longitude. Longitude should be positive.
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("French Guiana")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("French Guiana")])
# French Guyana, Sinnamary, Petit Saut => Wrong coordinates in Brazil
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00530228"), replace = F)] <- -53.050
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00530228"), replace = F)] <- 5.064

# Gabon, Aire d'Exploition Rationnelle de Faune des Monts Doudou => Wrong Latitude. Latitude should be negative.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Monts Doudou")), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Monts Doudou")), replace = F)])

# Greece, Corfú => Wrong latitude falling in the Ionian sea South to Corfu. 39.456667 instead of 39.286667
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Corfú")), replace = F)] <- 39.456667
# Greece, Macedonia, Pieria district, Olympus Mts. Litochoro, Faragi Enipeas => Wrong coordinates falling in the Egean Sea 
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00469648", "GABI_00469649")), replace = F)] <- 40.105
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00469648", "GABI_00469649")), replace = F)] <- 22.490
# Greece, Macedonia, Pieria district, Olympus Mts. Litochoro, Leptokaria-Karia road => Wrong coordinates falling in the Egean Sea 
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00469724")), replace = F)] <- 40.03333
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00469724")), replace = F)] <- 22.51666
# Greece, Macedonia, Pieria district, Platamonas Castle => Wrong coordinates falling in the Egean Sea 
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00469875")), replace = F)] <- 40.005
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00469875")), replace = F)] <- 22.598

# Guyana, Upper Demerara-Berbice, Mabura Hill => Wrong longitude. Longitude should be negative.
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("Guyana")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("Guyana")])

# India, Arunachal Pradesh, Lumla => Wrong coordinates falling in Bhoutan
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01662113")), replace = F)] <- 91.722
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01662113")), replace = F)] <- 27.530

# Indonesia, Sulawesi, Central Sulawesi Province, Berdikari => Wrong Latitude falling North in the Celebes Sea. 0.734 instead of 1.134
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Berdikari") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 0.734
# Indonesia, Sulawesi, Central Sulawesi Province, Bulili => Wrong Longitude falling East in the Celebes Sea. 120.0955 instead of 120.955
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bulili") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 120.0955
# Indonesia, East Nusa Tenggara Province, Nangagete => Wrong coordinates, falling SE in the Savu Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_02008543"), replace = F)] <- 122.2136
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_02008543"), replace = F)] <- -8.6771
# Indonesia, Lampung, Sunda Strait, Krakatau Islands, Pulau Panjang => Wrong rounded longitude, falling East in the sea. 105.38 instead of 105.4
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "anic32-066259"), replace = F)] <- 105.38
# Indonesia, Papua, Jayapura => Wrong longitude falling in the PNG side of the border
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "fmnhins0000117848"), replace = F)] <- 140.993
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_02199373"), replace = F)] <- 140.993
# Indonesia, West Papua, Sorong => Wrong coordinates falling North in the Pacific ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0281867"), replace = F)] <- 131.418
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0281867"), replace = F)] <- -1.039
# Indonesia, Aceh, Pulau Panjang => Wrong longitude falling West in the Indian ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-066249", "anic32-066250")), replace = F)] <- 97.416
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-066249", "anic32-066250")), replace = F)] <- "Pulau Panjang, Pulau Banyak Barat, Aceh"
# Indonesia, Palau Laut => Wrong coordinates falling in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pulo Laut") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 107.977
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pulo Laut") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 4.715

# Ivory Coast, Tai National Park => Wrong longitude falling in Liberia. -7.09642 instead of -7.89642 
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Foret de Tai") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -7.09642
# Ivory Coast, Tai Forest => Wrong rounded longitude falling in Liberia. -7.066667 instead of -7.666667
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tai Forest") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -7.066667

# Japan, Iwate Prefecture => Wrong Latitude falling South in the Pacific Ocean. 39.012222 instead of 33.012222
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Iwate Prefecture") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 39.012222
# Japan, Kagoshima Prefecture, Kagoshima City, Jigenji Park => Wrong coordinates falling South in the Pacific ocean 
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Jigenji Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 130.503
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Jigenji Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 31.511
# Japan, Kagoshima Prefecture, Sakurajima => Wrong coordinates falling South in the Pacific ocean 
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sakurajima") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 130.650
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sakurajima") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 31.583
# Japan, close to Akusekijima Island => Wrong coordinates falling East of Akusekijima Island
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00577065", "GABI_00577066")), replace = F)] <- 129.604
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00577065", "GABI_00577066")), replace = F)] <- 29.459

# Lesotho, Likhoele => Wrong Latitude falling North in South Africa. -29.81667 instead of -29.183333
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Likhoele") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -29.81667
# Lesotho, Mokhotlong => => Wrong coordinates falling East in South Africa.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mokhotlong") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 29.08333
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mokhotlong") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -29.71667
# Lesotho, Qachas Nek => => Wrong latitude falling South in South Africa. -30.1 instead of -30.9
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Qachas Nek") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -30.1

# Madagascar => Wrong Latitude. Latitude should be negative.
Biogeographic_database_Ponerinae_flags$Latitude_dec[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Madagascar")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Madagascar")])
# Madagascar, Marojejy National Park => Wrong Longitude falling West in the Mozambique Canal. 49.934722 instead of 46.934722
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00557292"), replace = F)] <- 49.934722

# Malaysia, Kelantan, Melawi Beach => Wrong coordinates falling NW in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Melawi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 102.420
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Melawi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 6.021
# Malaysia, Borneo, Sarawak, Kampong Sega => Wrong coordinates falling in Kalimantan, Indonesia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kampong Segu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 110.238
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kampong Segu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 1.424

# Malaysia, Borneo, Sarawak, Semengoh Forest Reserve => Wrong Latitude falling in Kalimantan, Indonesia. 1.401 instead of 0.8833333
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Semengoh Forest Reserve") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 1.401
# Malaysia, Borneo, Sarawak, Gunung Mulu National Park => Wrong Latitude falling in Brunei. 4.037 instead of 4.95
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Gunung Mulu National Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 4.037
# Malaysia, Borneo, Sarawak, Lambir Hills National Park => Wrong coordinates falling in Kalimantan, Indonesia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lambir Hills") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 114.04
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lambir Hills") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 4.200
# Borneo, Tobang => Coordinates are centroids of Borneo. Could relate to Tabang in Kalimantan, Indonesia.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tobang") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 116.017
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tobang") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 0.575
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tobang") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Indonesia"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tobang") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "IDN"

# Mali, Baboye => Wrong coordinates falling South in Burkina Faso
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Baboye") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -3.952
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Baboye") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 14.260

# Mauritius, Round Island => Wrong Longitude falling West in the Indian ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Round Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 57.784

# Mexico, Chiapas, Irlanda => Wrong coordinates falling in Guatemala
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Irlanda") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -93.332
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Irlanda") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 16.109
# Mexico, Chiapas, Soconusco => Wrong coordinates falling in Guatemala
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01103516", "GABI_01103514"), replace = F)] <- "Soconusco region"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Soconusco") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -92.297
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Soconusco") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 15.144
# Mexico, Jalisco, Estación Biológica Chamela. Wrong Latitude falling South into the Pacific Ocean 19.50 instead of 19.05
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Estación Biológica Chamela") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 19.50
# Mexico, Quintana Roo, Majahual => Wrong coordinates falling NE in the Caribbean Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Majahual") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -87.71013
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Majahual") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 18.71277
# Mexico, Quintana Roo, Puerto Morelos => Wrong rounded coordinates falling SE in the Caribbean Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Puerto Morelos") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -86.90278
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Puerto Morelos") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 20.84653 
# Mexico, Quintana Roo, Centro de Investigaciones Costeras La Mancha => Wrong coordinates with sign inversion falling in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01752436", "GABI_01752437"), replace = F)] <- -96.38125
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01752436", "GABI_01752437"), replace = F)] <- 19.59494

# Mozambique, Maputo, Delagoa Bay => Wrong rounded longitude falling East in the Bay
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Delagoa Bay") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 32.561

# Namibia, Oidimba Village => Wrong coordinates falling NW into Angola
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Edimba") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 16.496
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Edimba") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -17.476
# Namibia, Katima Mulilo => Wrong coordinates falling North into Zambia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Katima Mulilo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 24.26667
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Katima Mulilo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -17.50

# Palau, Ngatpang => Wrong rounded coordinates falling in SW in the Pacific
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Ngatpang") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 134.53244
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Ngatpang") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 7.45053
# Palau, Peleliu => Wrong rounded coordinates falling in SW in the Pacific
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Peleliu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 134.24308
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Peleliu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 7.01506
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Peleliu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Peleliu"

# Panama, STRI Gamboa, Pipeline Road => Wrong Longitude. Should be negative.
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Panama")] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[Biogeographic_database_Ponerinae_flags$Country_ISO3_name %in% c("Panama")])
# Panama, Nusagandi => Wrong rounded coordinates in Costa Rica!
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Nusagandi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -78.97927
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Nusagandi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 9.351060

# PNG, Bougainville Island, Buin Village
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Buin"), replace = F)] <- 155.688
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Buin"), replace = F)] <- -6.745

# PNG, Hermit group, Luf Island => Wrong Longitude falling East in the Pacific Ocean. 145.063 instead of 145.083
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Luf Is") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 145.063
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00654783"), replace = F)] <- 145.063
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00654783"), replace = F)] <- "Hermit group, Luf Island"
# PNG, Manaus, Lorengau => Wrong rounded coordinates falling SE in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lorengau") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 147.272
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lorengau") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -2.031
# PNG, Central Province, Wanigela => Wrong Latitude falling South in Pacific Ocean
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Wanigela") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -10.062
# PNG, Central Province, Bisianumu, near Sogeri => Wrong Latitude. Should be negative.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bisianumu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Bisianumu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)])
# PNG, East New Britain Province, Lamas => Wrong coordinates falling East into the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lamas") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 151.404
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lamas") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -5.6098
# PNG, East New Britain Province, Vouvou => Wrong coordinates falling East into the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Vouvou") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 151.4594
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Vouvou") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -5.440
# PNG, Sandaun Province, Aitape => Wrong rounded coordinates falling East into the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Aitape") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 142.35
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Aitape") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -3.13333 
# PNG, Morobe Province, Lae => Wrong coordinates falling far away
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lae") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 147.000
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lae") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -6.73333
# PNG, Mussau Talumalaus => Wrong rounded coordinates falling South in the Bismark Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mussau") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 149.621
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mussau") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1.436
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -5) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 150) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 149.621
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -5) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 150) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1.436
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -5) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 150) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Bismarck Archipelago, Mussau Island"
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -5) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 150) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "New Ireland"
# PNG, Western Province, Fly River => Wrong longitude falling East into the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Fly River") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 143.629

# Peru, Madre de Dios, Sachavacayoc Center => Wrong Latitude. Should be negative.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sachavacayoc") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sachavacayoc") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)])

# Philippines, no locality => Wrong Longitude falling West of the coast of South Luzon. Bring them back on the land assuming minimal error in coordinates. 124.13750 instead of 124.26750
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na((Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == 12.877214) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 124.13750

# Puerto Rico, Bosque Estatal Guanica => Wrong Longitude falling South in the Caribbean Sea. 17.97 instead of 17.84
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bosque Estatal Guanica") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 17.97
# Puerto Rico, Carite Lake region => Wrong rounded coordinates falling SE in the Caribbean Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Carite") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -66.100
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Carite") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 18.074

# Rwanda, Rubona => Wrong coordinates falling SW in DRC
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Rubona") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 29.256
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Rubona") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1.728

# Saint Vincent and the Grenadines, Savan Island => Wrong Longitude falling East in the Atlantic Ocean. -61.21111 instead of -61.12111
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Savan Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -61.21111

# Samoa => Wrong Latitude. Should be negative
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Country_ISO3_name, pattern = "Samoa") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Country_ISO3_name, pattern = "Samoa") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)])
# Samoa => Wrong Latitude falling South in the Pacific ocean. -13.583 instead of -16.583
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00761072", "GABI_00761107"), replace = F)] <- -13.583

# Saudi Arabia, Al Qatif => => Wrong Latitude falling North in the Arabic Sea. 26.533333 instead of 26.933333
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Al Qatif") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 26.533333

# Solomon Islands, Isabel Province => Wrong rounded longitude falling West in the Pacific Ocean. 159.115 instead of 159.5
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Isabel Province") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 159.115
# Solomon Islands, Cristobal Island, Wainoni => Wrong Latitude falling North in the Pacific Ocean. -10.566670 instead of -10.066670/-10.100000
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Wainoni") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -10.566670
# Solomon Islands, Santa Cruz Group, Nendo Island => Wrong rounded coordinates falling SE in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Locality[replace_na((Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -11) & is.na(Biogeographic_database_Ponerinae_flags$Locality_initial) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Santa Cruz Group, Nendo Island"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na((Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -11) & (Biogeographic_database_Ponerinae_flags$Locality == "Santa Cruz Group, Nendo Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 165.93927
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na((Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -11) & (Biogeographic_database_Ponerinae_flags$Locality == "Santa Cruz Group, Nendo Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -10.718873
# Solomon Islands, Reef Islands, Nibanga Temau => Wrong Longitude falling East in the Pacific Ocean. 166.310 instead of 166.167
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("anic32-046469")] <- 166.310
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00669091")] <- "Reef Islands, Nibanga Temau"
Biogeographic_database_Ponerinae_flags$Longitude_dec[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00669091")] <- 166.310
# Solomon Islands, Reef Islands, Matema Island => Wrong rounded coordinates falling SE in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Matema") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 166.184
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Matema") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -10.292
# Solomon Islands, Santa Cruz Group, Vanikoro Island => Wrong rounded coordinates falling NW in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Vanikoro") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 166.909
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Vanikoro") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -11.674
# Solomon Islands, Santa Cruz Group, Anuta Island => Wrong rounded coordinates falling SW in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Anuda Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 169.850
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Anuda Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -11.611


# South Africa, East London, Peddie District => Wrong Latitude falling South into the Ocean. -33.03333 instead of -33.125
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "East London") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -33.03333
# South Africa, Rainwoods (Small Holding), Near Witelsbos => Wrong Latitude falling South into the Ocean. -34.000 instead of -34.125000
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Witelsbos") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -34.000
# South Africa, Nongoma, Zululand => Wrong Latitude falling North in eSwatini. -27.9 instead of -27.1
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Nongom") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -27.9
# South Africa, Ntendeka Forest Reserve => Wrong Latitude falling North in eSwatini. -27.85 instead of -27.15
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Ntendeka") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -27.85
# South Africa, Umtamvuna Nature Reserve => Wrong Latitude falling South in the Indian Ocean. -31.031 instead of -31.228889
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Umtamvuna") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -31.031
# South Africa, Entabeni Forest Reserve => Wrong Latitude falling North in Botswana. -22.93333 instead of -22.066667
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Entabeni") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -22.93333
# South Africa, Soutpansberg Mountain => Wrong coordinates falling NW in Atlantic Ocean.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Soutpansberg") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 29.42801
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Soutpansberg") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -23.03564
# South Africa, Eastern Transvaal, Nelspruit => Wrong latitude. Should be negative.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Nelspruit"), replace = F)] <- -1 * abs(Biogeographic_database_Ponerinae_flags$Latitude_dec_initial[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Nelspruit"), replace = F)])
# South Africa, Thursford Farm => Wrong longitude. Should be positive.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Thursford"), replace = F)] <- abs(Biogeographic_database_Ponerinae_flags$Longitude_dec_initial[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Thursford"), replace = F)])

# Zambia, Lusaka => Wrong coordinates falling NW in Atlantic Ocean.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lusaka") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 28.31938
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lusaka") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -15.43585

# South Korea, Site 114 => Wrong Longitude, falling East in the Pacific Ocean. 129.32 instead of 129.42.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "114") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 129.32
# South Korea, Site 115 => Wrong Longitude, falling East in the Pacific Ocean. 129.319167 instead of 129.419167.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "115") & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "South Korea") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 129.319167
# South Korea, Site 116 => Wrong Longitude, falling East in the Pacific Ocean. 129.323889 instead of 129.433889.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "116") & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "South Korea") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 129.323889
# South Korea, Site 51 => Wrong Longitude, falling East in the Pacific Ocean. 128.425 instead of 128.535.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "51") & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "South Korea") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 128.425
# South Korea, Site 58 => Wrong Longitude, falling East in the Pacific Ocean. 128.529167 instead of 128.629167.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "58") & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "South Korea") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 128.529167
# South Korea, Site 159 => Wrong Longitude, falling East in the Pacific Ocean. 129.345278 instead of 129.445278.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "159") & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "South Korea") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 129.345278

# Spain, Illes Balears, Mallorca => Wrong coordinates falling in the Mediterranean Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00794898", "GABI_00794899"), replace = F)] <- 2.986
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00794898", "GABI_00794899"), replace = F)] <- 39.615
# Spain, Illes Canarias, El Hierro => Wrong Latitude falling North in the Atlantic Ocean. 27.75 instead of 27.85
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm2_initial, pattern = "El Hierro") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 27.75
# Spain, Illes Canarias, Gran Canaria Island, Las Palmas => Wrong Longitude falling East in the Atlantic Ocean. -15.428611 instead of -15.318611
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Las Palmas") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -15.428611
# Spain, Illes Canarias => Wrong coordinates falling in the middle of the archipelago, in the Atlantic Ocean.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00831742"), replace = F)] <- -15.70393
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00831742"), replace = F)] <- 28.10043
# Spain, Arroyo de la Ermita, Sierra Almijara => Wrong coordinates falling SE in the Mediterranean Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Arroyo de la Ermita") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -3.969
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Arroyo de la Ermita") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 36.894

# São Tomé and Principe, São Tomé Island => Wrong Latitude falling North in the Atlantic Ocean. 0.26492 instead of 0.56492
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "ey20045"), replace = F)] <- 0.26492

# Trinidad & Tobago, "Trinidad_b" => Falling in the Atlantic Ocean between the two islands. Take random coordiantes on Trinidad instead.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_code, pattern = "Trinidad_b") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -61.236
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_code, pattern = "Trinidad_b") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 10.416

# USA, California, Cold Canyon => Wrong latitude falling South into the Pacific Ocean. 38.511 instead of 36.511.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cold Canyon") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 38.511
# USA, Florida, Franklin County => Wrong rounded latitude falling South into the Caribbean Sea Ocean. 29.800 instead of 36.511.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Franklin County") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 29.916666
# USA, Florida, Seminole State Park => Wrong coordinates falling SE into the Carribean Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Seminole State Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -81.604
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Seminole State Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 25.976
# USA, Georgia, Cloud Land Canyon => Wrong Latitude falling South into the Carribean Sea. 34.834444 instead of 24.834444.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cloudland Canyon") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 34.834444
# USA, Georgia, Tugaloo => Wrong Latitude falling South into the Carribean Sea. 34.494722 instead of 24.484722.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tugaloo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 34.494722
# USA, Mississippi, Grand Bay Savanna => Wrong Latitude falling South into the Carribean Sea. 30.36 instead of 30.0475.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Grand Bay Savanna") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 30.36
# USA, Texas, Harlingen => Wrong Latitude falling South into the Carribean Sea. 26.165 instead of 23.6.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Harlingen") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 26.165
# USA, Hawaii, Oahu Island => Wrong rounded Latitude falling South into the Carribean Sea. 21.5 instead of 21.0.
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Oahu Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 21.5

# Vanuatu, Efate Island, Port Vila => Wrong rounded coordinates falling NW into the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Port Fila") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 168.32
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Port Fila") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -17.736

# Venezuela, Valle del Abismo => Wrong coordinates falling SE in Brazil
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Valle del Abismo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -61.6
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Valle del Abismo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 4.40
# Venezeuala, Azevedo District, Cupo => Wrong Longitude falling East in the Caribbean Sea. -66.372 instead of -65.622
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cupo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -66.372
# Venezeuala, Nueva Esparta, Isla Margarita, ca. Fuentidueño => Wrong Longitude falling West in the Caribbean Sea. -63.913056 instead of -64.913056
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Fuentidueño") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -63.913056
# Venezuela, San Critobal, Loma de Pio => Wrong coordinates falling NW in Colombia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Loma de Pio") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -72.200
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Loma de Pio") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 7.749
# Venezuela, San Antonio del Tachira => Wrong coordinates falling NW in Colombia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "San Antonio") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -72.442
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "San Antonio") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 7.818
# Venezuela, Tachira, San Cristobal, Santa Teresa => Wrong coordinates falling NW in Colombia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Santa Teresa") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -72.225
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Santa Teresa") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 7.800

# Viet Nam, Huong Son => Wrong coordinates falling SE in the China Sea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Huong Son") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 105.426
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Huong Son") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 18.512
# Viet Nam, Ba Vi National Park => Wrong Longitude falling East in the China Sea. 105.36083 instead of 108.36083
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Ba Vi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- 105.36083

# Wallis and Futuna, Wallis Island => Wrong coordinates falling NE in the Pacific Ocean
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00758995", "GABI_00754808"), replace = F)] <- -176.202
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00758995", "GABI_00754808"), replace = F)] <- -13.285

# Zambia, Mpulungu => Wrong rounded Latitude falling North in Lake Tanganyika. -8.83333 instead of -8.500
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mpulungu") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -8.83333

# Zimbabawe, Matopo Hills => Wrong Latitude falling South in South Africa. -20.45 instead of -27.45
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Matopo") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -20.45

# eSwatini, Pigg's Peak => Latitude falling North in South Africa. -26.033333 instead of -25.033333
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Piggspeak") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- -26.033333


Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Salgar")), replace = F)]
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Salgar")), replace = F)]

# plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Australia"), "ISO_A3"]) # Includes the Canarias
# plot(Countries_NE_sf[, "ISO_A3"])
# 
# plot(Countries_NE_sf[Countries_NE_sf$SUBUNIT %in% c("Palestine"), "ISO_A3"]) # Includes the Canarias

## 2.6.2.3/ True positive: Need to change country name ####

# American Samoa => Records are in the Western Samoa Islands, not the American Samoa
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00941224", "GABI_00941234")] <- "Samoa"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00941224", "GABI_00941234")] <- "WSM"

# Norfolk Island => Records are in Norfolk Island, not Australia
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Norfolk Island")] <- "Norfolk Island"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Norfolk Island")] <- "NFK"

# Botswana => Records and localities are in the South African side of the border
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00833495", "GABI_01954574")] <- "South Africa"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00833495", "GABI_01954574")] <- "ZAF"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("sam-hym-c016271", "sam-hym-c013580", "sam-hym-c013581")] <- "South Africa"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("sam-hym-c016271", "sam-hym-c013580", "sam-hym-c013581")] <- "ZAF"

# Hong Kong instead of China
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$adm1 %in% c("Hong Kong")] <- "Hong Kong S.A.R."
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$adm1 %in% c("Hong Kong")] <- "HKG"

# Macao instead of China
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$adm1 %in% c("Macau")] <- "Macao S.A.R."
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$adm1 %in% c("Macau")] <- "MAC"

# Sierra de Perija. NP and coordinates in Venezuela, not Colombia
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = paste0("Sierra de Perija", "|","Sierra de Parija")), replace = F)] <- "Venezuela"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = paste0("Sierra de Perija", "|","Sierra de Parija")), replace = F)] <- "VEN"

# Eritrea instead of some Ethiopia records
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00824708")] <- "Tesseney"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00824708")] <- "Eritrea"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00824708")] <- "ERI"

# Clipperton Island instead of France
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Clipperton Island")] <- "Clipperton Island"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$adm1_initial %in% c("Clipperton Island")] <- "CPT"

# Guyana instead of French Guyana/France for an erroneous record
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00845045")] <- "Guyana"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00845045")] <- "GUY"

# French Southern and Antarctic Lands instead of Europa Island/France for Europa Island
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$Locality_initialy %in% c("Europa Island")] <- "French Southern and Antarctic Lands"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Europa Island")] <- "ATF"

# Jordan instead of Israel. Coordinates falling in the Jordan side of the river.
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Jourdain")] <- "Jordan"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Jourdain")] <- "JOR"

# Sancurar in Ethiopia instead of Kenya
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00477580")] <- "Ethiopia"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00477580")] <- "ETH"

# Jericho in Palestine instead of Lebanon
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00798847")] <- "Palestine"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00798847")] <- "PSE"
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00798847")] <- "Jericho"

# Al-Mazra'a ash-Sharqiya in Palestine instead of Lebanon
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00798877")] <- "Palestine"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00798877")] <- "PSE"
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00798877")] <- "Al-Mazra'a ash-Sharqiya"

# ?Unknown are in Martinique/France
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("?Unknown")] <- "France"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("?Unknown")] <- "FRA"
Biogeographic_database_Ponerinae_flags$adm1[Biogeographic_database_Ponerinae_flags$Country_initial %in% c("?Unknown")] <- "Martinique"

# Namakunde in Angola instead of Namibia
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Namakunde")] <- "Angola"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$Locality_initial %in% c("Namakunde")] <- "AGO"
# Erikson's Drift, Kunene River in Angola instead of Namibia
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01943756")] <- "Angola"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01943756")] <- "AGO"

# Kongga/Buin Village in PNG instead of Solomon Islands
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Buin"), replace = F)] <- "Autonomous Region of Bougainville [North Solomons]"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Buin"), replace = F)] <- "Papua New Guinea"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Buin"), replace = F)] <- "PNG"

# Sorong in Indonesia, West Papua instead of PNG
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sorong"), replace = F)] <- "West Papua"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sorong"), replace = F)] <- "Indonesia"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sorong"), replace = F)] <- "IDN"

# Bali, Laba Sari in Indonesia instead of PNG
Biogeographic_database_Ponerinae_flags$Locality[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02095758", "GABI_02008560")] <- "Bali, Laba Sari"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02095758", "GABI_02008560")] <- "Indonesia"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_02095758", "GABI_02008560")] <- "IDN"

# Castelnuovo in Montenegro instead of Serbia/Croatia
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Castelnuovo"), replace = F)] <- "Montenegro"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Castelnuovo"), replace = F)] <- "MNE"

# Sona Mpungu Forest in Democratic Republic of the Congo instead of Republic of the Congo
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sona Mpungu Forest"), replace = F)] <- "Democratic Republic of the Congo"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sona Mpungu Forest"), replace = F)] <- "COD"

# Bangassou in Central African Republic instead of Equatorial Guinea
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bangassou"), replace = F)] <- "Central African Republic"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bangassou"), replace = F)] <- "CAF"

# Fond St Jacques in Martinique/France instead of Saint Lucia
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Fond St Jacques"), replace = F)] <- "Martinique"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Fond St Jacques"), replace = F)] <- "France"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Fond St Jacques"), replace = F)] <- "FRA"

# American Samoa instead of Samoa
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -14.295) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -170.70), replace = F)] <- "Anu'u Island"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -14.295) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -170.70), replace = F)] <- "American Samoa"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -14.295) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -170.70), replace = F)] <- "ASM"
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -14.23) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -169.45), replace = F)] <- "Ta'u Island"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -14.23) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -169.45), replace = F)] <- "American Samoa"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -14.23) & (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == -169.45), replace = F)] <- "ASM"

# Somalia to Somaliland: [Ouarsangueli] Warsangali, Ainabo, Shimbir Beris, Ceelbuh, Ina Dhakool
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID == "GABI_00835211"), replace = F)] <- "Ceelbuh"
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00833795", "GABI_00833796")), replace = F)] <- "Ina Dhakool"
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = (Biogeographic_database_Ponerinae_flags$Locality %in% c("[Ouarsangueli] Warsangali", "Ainabo", "Shimbir Beris", "Ceelbuh", "Ina Dhakool")), replace = F)] <- "Somaliland"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = (Biogeographic_database_Ponerinae_flags$Locality %in% c("[Ouarsangueli] Warsangali", "Ainabo", "Shimbir Beris", "Ceelbuh", "Ina Dhakool")), replace = F)] <- "SOL"

# Lusaka in Zambia instead of South Africa
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lusaka") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Zambia"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lusaka") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "ZMB"

# Eastern Equatoria, Lotti Forest, SW Slope Achali Mts. in South Sudan instead of Sudan
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Eastern Equatoria") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "South Sudan"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Eastern Equatoria") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "SSD"

# West Caprivi Park, Manywa River in Namibia instead of Zambia
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "West Caprivi Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Namibia"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "West Caprivi Park") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "NAM"

# From Lochiel to Mbabane. Point on South African side of the border.
Biogeographic_database_Ponerinae_flags$Country_ISO3_name[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01952400")] <- "South Africa"
Biogeographic_database_Ponerinae_flags$Country_ISO3_code[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_01952400")] <- "ZAF"


## 2.6.2.4/ True positive: False coordinates to remove (turn into NA) ####

# Check if locality is credible...

# DRC, Haut-Ubangi => Wrong coordinates in Congo. To draw at random in the adm1.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Haut Ubangi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Haut Ubangi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Haut Ubangi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- F
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Haut Ubangi") & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- "Nord Ubangi"

# Fiji => Wrong rounded coordinates falling in the Pacific Ocean # Draw random coordinates on the Fiji islands
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 179) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -18) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 179) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -18) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = (Biogeographic_database_Ponerinae_flags$Longitude_dec_initial == 179) & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial == -18) & (Biogeographic_database_Ponerinae_flags$flag_type == "countries"), replace = F)] <- F

# India, West Bengal => Wrong rounded coordinates falling in Bangladesh # Draw random coordinates in the West Bengal region
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0902607"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0902607"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0902607"), replace = F)] <- "West Bengal"
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0902607"), replace = F)] <- F

# Japan, Kagoshima Prefecture => Wrong coordinates falling in the Pacific Ocean # Draw random coordinates in the Kagoshima Prefecture
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0217561"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0217561"), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$adm1[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0217561"), replace = F)] <- "Kagoshima Prefecture"
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code == "casent0217561"), replace = F)] <- F

# Malaysia, Borneo => Coordinates at centroid of the island falling in Kalimantan, Indonesia but registered in Sarawak, Malaysia # Better to draw them randomly and label them as random
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0913723", "casent0903954", "casent0903955")), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0913723", "casent0903954", "casent0903955")), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0913723", "casent0903954", "casent0903955")), replace = F)] <- F

# New Zealand => Coordinates right in between the two main islands without further indications. # Drawn random coordinates in NZ
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00757929", "GABI_00757931", "GABI_00756746", "GABI_00757928")), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00757929", "GABI_00757931", "GABI_00756746", "GABI_00757928")), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = (Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00757929", "GABI_00757931", "GABI_00756746", "GABI_00757928")), replace = F)] <- F

# Philippines => Wrong rounded coordinates falling in the middle of the archipelago. # Draw random coordinates in the Philippines.
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0907422", "casent0915243")), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0907422", "casent0915243")), replace = F)] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[replace_na(data = (Biogeographic_database_Ponerinae_flags$Specimen_code %in% c("casent0907422", "casent0915243")), replace = F)] <- F

## 2.6.2.5/ Update Geometry ####

# Convert Flagged df to sf 
Biogeographic_database_Ponerinae_flags$Latitude_copy <- Biogeographic_database_Ponerinae_flags$Latitude_dec
Biogeographic_database_Ponerinae_flags$Longitude_copy <- Biogeographic_database_Ponerinae_flags$Longitude_dec
Biogeographic_database_Ponerinae_flags <- st_as_sf(Biogeographic_database_Ponerinae_flags, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_flags) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
Biogeographic_database_Ponerinae_flags <- Biogeographic_database_Ponerinae_flags %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_flags

## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")

table(Biogeographic_database_Ponerinae_flags$flag_type) # Need to rerun evaluation to see if all tagged entries are cleaned

### 2.6.3/ Curate records falling in water areas ####

View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "seas", ] %>% arrange(Country_ISO3_name, adm1, adm2, Locality, GABI_accession_ID, Specimen_code))

## 2.6.3.1/ False positive: case of records flagged as at seas, but that are actually on lands (tiny islands or deltas) ####

# Brazil, Ilha dos Porcos, Amazon Delta
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00753526")] <- TRUE

# Costa Rica, Osa, Sierpe, Isla del Caño
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Osa, Sierpe") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- "Osa, Sierpe, Isla del Caño"
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Isla del Caño") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Isla de Caño") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE

# Italy, Archipelago Pontino, Ventotene Island
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Ventotene") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE

# Japan, Kagoshima Prefecture, Minamisatsuma, Kamino Island
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00619696", "GABI_00617902")] <- TRUE
# Japan, Okinawa Prefecture, Iou-torishima Island
Biogeographic_database_Ponerinae_flags$.sea[Biogeographic_database_Ponerinae_flags$GABI_accession_ID %in% c("GABI_00349103")] <- TRUE

# Palau, Sonsorol, Sonsorol island
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Sonsorol") & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial < 5.34) & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- "Sonsorol, Sonsorol Island"
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Sonsorol") & (Biogeographic_database_Ponerinae_flags$Latitude_dec_initial > 5.34) & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- "Sonsorol, Fanna Island"
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm1_initial, pattern = "Sonsorol") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE

# Seychelles, Aride Island
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Aride") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE

# Spain, Galicia: Isla de Cíes and Isla de Ons
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$adm2_initial, pattern = "Isla de Ons") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Islas Cíes") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE

# USA, Keys Islands
Biogeographic_database_Ponerinae_flags$.sea[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = " Key") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- TRUE

## Convert back to logical the "countries" and "sea" flags
Biogeographic_database_Ponerinae_flags$.sea <- as.logical(Biogeographic_database_Ponerinae_flags$.sea)


##  2.6.3.2/ True positive: Slightly erroneous coordinates to correct (Fall in internal lakes, close to land, just imprecision) ####

# Brazil, Rio Grande do Sul, Parque Estadual de Itapua, Viamao => Wrong coordinates falling WE in Lake/Lagoa dos Patos
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Itapua") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- -51.026
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Itapua") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- -30.347

# Colombia, Magdalena, Cienaga Grande de Sta Maria => Wrong coordinates in the middle of the Lake
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cienaga Grande") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- -74.324

# Greece, Evrostina => Wrong coordinates falling into the Corinth Gulf
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Evrostina") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- 22.396
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Evrostina") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- 38.073

# Portugal, Leça da Palmeira => Wrong Longitude, falling West in the Atlantic Ocean. -8.701389 instead of -8.761389
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Leça da Palmeira") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- -8.701389

# Seychelles, Aride Island => Wrong rounded Latitude, falling North in the Pacific Ocean. -4.212 instead of -4.200
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Aride") & (Biogeographic_database_Ponerinae_flags$flag_type == "seas"), replace = F)] <- -4.212


# Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cienaga")), replace = F)]
# Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Cienaga")), replace = F)]

# Need to update the geometry to include new coordinates
# Rerun flag check to ensure changes have fixed them
# Modify again the false positives
# Need to check if they have a sea flag, or any other flag, too to change their flag

### 2.6.4/ Curate records in around country centroids ####

View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "centroids", ] %>% arrange(Country_ISO3_name, adm1, adm2, Locality, GABI_accession_ID, Specimen_code))

# Check if locality is available to retrieve true coordinates
# Check if uncertainty is too large to be kept (may be okay to keep those for small islands or countries)

## 2.6.4.1/ False positive: Records in localities that are close to country centroids, or centroids of small islands so it does not matter ####

# Cook Islands, Rarotonga
Biogeographic_database_Ponerinae_flags$.cen[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Rarotonga"), replace = F)] <- TRUE

# Martinique
Biogeographic_database_Ponerinae_flags$.cen[(Biogeographic_database_Ponerinae_flags$Country_initial == "Martinique") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- TRUE

# Haiti
Biogeographic_database_Ponerinae_flags$.cen[(Biogeographic_database_Ponerinae_flags$Country_initial == "Haiti") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- TRUE

# Christmas Island
Biogeographic_database_Ponerinae_flags$.cen[(Biogeographic_database_Ponerinae_flags$Country_initial == "Christmas Island") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- TRUE

# Santa Lucia, Praslin
Biogeographic_database_Ponerinae_flags$.cen[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Praslin"), replace = F)] <- TRUE

# Saint Martin, Loterie Farm
Biogeographic_database_Ponerinae_flags$.cen[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Loterie Farm"), replace = F)] <- TRUE

# Samoa Island
Biogeographic_database_Ponerinae_flags$.cen[(Biogeographic_database_Ponerinae_flags$Country_initial == "Samoa") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- TRUE

# Trinidad and Tobago, Lopinot Complex
Biogeographic_database_Ponerinae_flags$.cen[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Lopinot complex"), replace = F)] <- TRUE


## 2.6.4.2/ True positive: Records that have wrong coordinates according to their locality => To adjust ####

# Cameroun, Mount Cameroun above Buea
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Buea") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 9.214
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Buea") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 4.170

# Czech Republic, Radotínské údolí
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Radotínské") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 14.314
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Radotínské") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 49.997

# Equatorial Guinea, Bioko
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bioko") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 8.70
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bioko") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 3.50

# Ethiopia, Gughé highlands, Bonghé Valley
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bonghé") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 37.35
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bonghé") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 6.06
# Ethiopia, Dire Dawa
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Dire-Dawa") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 41.857
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Dire-Dawa") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 9.608

# Fiji, Sigatoka
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sigatoka") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 177.553
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Sigatoka") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -18.054
# Fiji, Kings Road
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kings Rd") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 178.437
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kings Rd") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -17.783

# Malawi, Mlanje
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Locality_code == "Mlanje") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 35.508
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Locality_code == "Mlanje") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -16.024
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Locality_code == "Mlanje_2000") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 35.568
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (Biogeographic_database_Ponerinae_flags$Locality_code == "Mlanje_2000") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -15.976

# Mexico, Peñon del Marquis
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Peñon del Marquis") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -99.017
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Peñon del Marquis") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 19.374
# Mexico, Pedrigales
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pedrigales") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -99.207
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pedrigales") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 19.322

# Mozambique, Amatongas Forest
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Amatongas") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 33.768
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Amatongas") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -19.182

# Myanmar, Bhamo
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bhamò") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 97.234
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Bhamò") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 24.262

# Taiwan, Akau
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Akau") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 120.473
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Akau") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 22.713
# Taiwan, Kosempo
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kosempo") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- "Jiaxian District [Kosempo, Formosa]"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kosempo") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 120.614
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Kosempo") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 23.121
# Taiwan, Pilam
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pilam") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- "Taitung District [Pilam, Formosa]"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pilam") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 121.126
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Pilam") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 22.759
# Taiwan, Taihorin
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taihorin") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- "Dalin [Taihorin, Formosa]"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taihorin") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 120.455
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taihorin") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 23.604
# Taiwan, Taihoku/Taipeh
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taihoku") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- "Taipei [Taihoku, Formosa]"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taihoku") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 121.538
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taihoku") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 25.038
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taipeh") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 121.538
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Taipeh") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 25.038
# Taiwan, Suisharyo
Biogeographic_database_Ponerinae_flags$Locality[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Suisharyo") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- "Yuchi [Suisharyo, Formosa]"
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Suisharyo") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 120.920
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Suisharyo") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 23.872

# Tanzania, Tanganyika
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tanganyika") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 29.958
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Tanganyika") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -6.246

# Uganda, Busnia
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Busnia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 34.089
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Busnia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 0.467
# uganda, Mabira Forest
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mabira Forest") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 33.009
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Mabira Forest") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 0.459

# Zimbabwe, Matsuma Dam
Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Matsuma Dam") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- 26.282
Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Matsuma Dam") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids"), replace = F)] <- -18.733


# Biogeographic_database_Ponerinae_flags$Longitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Akau")), replace = F)]
# Biogeographic_database_Ponerinae_flags$Latitude_dec[replace_na(data = (str_detect(string = Biogeographic_database_Ponerinae_flags$Locality, pattern = "Akau")), replace = F)]

## 2.6.4.3/ True positive: Records with no usable information => To assign to NA for random drawing ####

# Bolivia. -17.00, -65.0
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Bolivia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Bolivia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Bolivia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Brazil. -10.00, -55.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Brazil") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Brazil") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Brazil") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Cameroun. 6.00, 12.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Cameroon") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Cameroun") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Cameroon") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Cameroun") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Cameroon") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Cameroun") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# China. 35.00, 105.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "China") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "China") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "China") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Colombia. 4.00, -72.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Colombia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Colombia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Colombia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Costa Rica. 10.00, -84.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Costa Rica") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Costa Rica") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Costa Rica") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Ecuador. -2.00, -77.50
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Ecuador") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Ecuador") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Ecuador") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Ethiopia. 8.00, 38.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Ethiopia") & (Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Abyssinie", "Ethiopia")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Ethiopia") & (Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Abyssinie", "Ethiopia")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Ethiopia") & (Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Abyssinie", "Ethiopia")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Gabon. -1.00, 11.75
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Gabon") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Gabon") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Gabon") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Guinea. 11.00, -10.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Guinea") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Guinea") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Guinea") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# India. 20.00, 77.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "India") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "India") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "India") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Iran. 32.00, 53.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Iran") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Iran") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Iran") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Japan. 36.00, 138.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Japan") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Japan") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Japan") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Liberia. 6.50, -9.50
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Liberia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Liberia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Liberia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Mexico. 23.00, -102.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Mexique", "Mexico_Neotropical", "Mexico_Nearctic")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Mexique", "Mexico_Neotropical", "Mexico_Nearctic")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Mexique", "Mexico_Neotropical", "Mexico_Nearctic")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")]  <- FALSE

# Myanmar. 22.00, 98.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Birmania", "Birmanie", "Burmah")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Birmania", "Birmanie", "Burmah")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Locality_code %in% c("Birmania", "Birmanie", "Burmah")) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")]  <- FALSE

# Nigeria. 10.00, 8.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Nigeria") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Nigeria") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Nigeria") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Sierra Leone. 8.50, -11.50
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Sierra Leone") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Sierra Leone") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Sierra Leone") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Solomon Islands. -8.00, 159.00
Biogeographic_database_Ponerinae_flags$adm1[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Solomon Islands") & replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_flags$Locality_initial, pattern = "Isabel"), replace = F) & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- "Isabel Province"
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Solomon Islands") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Solomon Islands") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Solomon Islands") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Sri Lanka. 7.00, 81.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Sri Lanka") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Sri Lanka") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Sri Lanka") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Suriname. 4.00, -56.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Suriname") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Suriname") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Suriname") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Taiwan. 23.50, 121.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Taiwan") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Formosa_TW") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Taiwan") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Formosa_TW") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Taiwan") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Formosa_TW") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# United Kingdom. 54.00, -2.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "United Kingdom") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "United Kingdom") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "United Kingdom") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE

# Zimbabwe. -19.00, 29.00
Biogeographic_database_Ponerinae_flags$Longitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Zimbabwe") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Rhodesia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$Latitude_dec[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Zimbabwe") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Rhodesia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- NA
Biogeographic_database_Ponerinae_flags$valid_coordinates[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Zimbabwe") & (Biogeographic_database_Ponerinae_flags$Locality_code == "Rhodesia") & (Biogeographic_database_Ponerinae_flags$flag_type == "centroids")] <- FALSE


## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")

### 2.6.4.4/ Update geometry ####

# Convert Flagged df to sf 
Biogeographic_database_Ponerinae_flags$Latitude_copy <- Biogeographic_database_Ponerinae_flags$Latitude_dec
Biogeographic_database_Ponerinae_flags$Longitude_copy <- Biogeographic_database_Ponerinae_flags$Longitude_dec
Biogeographic_database_Ponerinae_flags <- st_as_sf(Biogeographic_database_Ponerinae_flags, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_flags) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
Biogeographic_database_Ponerinae_flags <- Biogeographic_database_Ponerinae_flags %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_flags

### 2.6.4.5/ Cut-Paste NA entries in the NA dataset ####

# Extract entries with new NA coords (assign to NA because they were flagged as error)
Biogeographic_database_Ponerinae_flags$valid_coordinates_rerun <- cc_val(x = Biogeographic_database_Ponerinae_flags,
                                                                         lon = "Longitude_dec", lat = "Latitude_dec", 
                                                                         value = "flagged", verbose = T)

table(Biogeographic_database_Ponerinae_flags$valid_coordinates)
table(Biogeographic_database_Ponerinae_flags$valid_coordinates_rerun)
View(x = Biogeographic_database_Ponerinae_flags[!Biogeographic_database_Ponerinae_flags$valid_coordinates_rerun, ])
View(x = Biogeographic_database_Ponerinae_flags[!Biogeographic_database_Ponerinae_flags$valid_coordinates_rerun & Biogeographic_database_Ponerinae_flags$valid_coordinates, ])

# Extract valid coordinates to rerun tests
Biogeographic_database_Ponerinae_flags_rerun <- Biogeographic_database_Ponerinae_flags %>% 
  filter(Biogeographic_database_Ponerinae_flags$valid_coordinates_rerun) %>% 
  select(-c(".val", ".cap", ".cen", ".sea", ".con", ".otl", ".inst", ".dpl", ".summary")) %>% 
  st_drop_geometry() # %>% 
# select(-c("Latitude_copy", "Longitude_copy"))
class(Biogeographic_database_Ponerinae_flags_rerun) <- "data.frame"

# Bind new NA entries to the NA dataset
Biogeographic_database_Ponerinae_NA_coords_new <- st_drop_geometry(Biogeographic_database_Ponerinae_flags[!Biogeographic_database_Ponerinae_flags$valid_coordinates_rerun, ])
Biogeographic_database_Ponerinae_NA_coords <- rbind(Biogeographic_database_Ponerinae_NA_coords, Biogeographic_database_Ponerinae_NA_coords_new[, names(Biogeographic_database_Ponerinae_NA_coords)])

## Save sf dataframe with coordinates with NA
saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

### 2.6.4.6/ Rerun evaluation to update flags ####

Biogeographic_database_Ponerinae_flags_rerun <- clean_coordinates(x = Biogeographic_database_Ponerinae_flags_rerun,
                                                            lon = "Longitude_dec", lat = "Latitude_dec",
                                                            countries = "Country_ISO3_code",
                                                            species = "Current_name",
                                                            value = "spatialvalid",         # To define the type of output. Can be a spatial df ("spatialvalid"), a logical vector recording entries with at least one flag ("flagged"), a df with dubious coordinates removed ("clean").
                                                            verbose = T,
                                                            # List of tests to run
                                                            tests = c(#"aohi",          # Coordinates found in Artificial Hotspots
                                                              "capitals",      # Coordinates found in capitals
                                                              "centroids",     # Coordinates found at centroids of countries
                                                              "countries",     # Test if occurrences are found within a list of countries or a custom SpatialPolygon
                                                              "duplicates",    # Check for duplicates (identical coordinates) within taxa
                                                              #"equal",         # Check for coordinates with latitude = longitude
                                                              # "gbif",         # Check if the coordinates is within a 1km radius around the GBIF headquarter
                                                              "institutions",  # Test if occurrences are found arouf known institution locations
                                                              "outliers",      # Test for minimum/mean distance to other occurrences per taxa
                                                              # "range"         # Test if coordinates fall within species range extracted from IUCN
                                                              "seas"           # Test if fall in the ocean
                                                              # "urban"          # Test if fall within urban areas
                                                              # "zeros"          # Test for coordinates with null latitude or longitude
                                                            ), 
                                                            outliers_method = "distance",  # Use minimum distance to detect outlier
                                                            outliers_td = 1000,            # Minimum distance to detect outlier (in km)
                                                            # outliers_mtp = 5.             # Multiplier for the IRQ of mean distance to flag as outlier
                                                            outliers_size = 3,             # Minimum number of records for a given taxa to test for outliers
                                                            # seas_scale = 10,               # Adjust resolution of landmass polygons used as reference. 10 = highest resolution.
                                                            seas_ref = map_NE_lands_sf_buffer,   # sf SpatialPolygons to use as reference for landmasses. Default is too coarse. 
                                                            # seas_ref = map_NE_all_lands_sf,   # sf SpatialPolygons to use as reference for landmasses. Default is too coarse. 
                                                            inst_rad = 200,                # Radius around Biodiversity institutions (in meters)
                                                            capitals_rad = 3000,           # Radius around capitals (in meters)
                                                            centroids_rad = 200,           # Radius around country centroids (in meters)
                                                            country_ref = Countries_NE_sf,  # sf SpatialPolygons to use as reference for countries
                                                            country_refcol = "ISO_A3",     # Name of ISO3 column
                                                            country_buffer = 5000,         # Buffer around country polygons (in meters)
                                                            # seas_buffer = 5000,            # Buffer around landmass limits (in meters) # Does not work properly with scale 10 map. Make our own prior
                                                            aohi_rad = 3000)               # Buffer around AOHI coordinates (in meters)

# In case of successful rerun, replace previous run
# Biogeographic_database_Ponerinae_flags <- Biogeographic_database_Ponerinae_flags_rerun

# Check results for each test in specific columns in the output
View(Biogeographic_database_Ponerinae_flags)


## 2.6.4.7/ Readjust flag types


# Convert Flagged df to sf 
Biogeographic_database_Ponerinae_flags <- st_drop_geometry(Biogeographic_database_Ponerinae_flags)
Biogeographic_database_Ponerinae_flags$Latitude_copy <- Biogeographic_database_Ponerinae_flags$Latitude_dec
Biogeographic_database_Ponerinae_flags$Longitude_copy <- Biogeographic_database_Ponerinae_flags$Longitude_dec
Biogeographic_database_Ponerinae_flags <- st_as_sf(Biogeographic_database_Ponerinae_flags, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_flags) <- sp::CRS('+init=EPSG:4326')


## Rerun all corrections so false positives are fixed


# Design factor level for type of flags
# Hierarchy of priorities: "zeros", "equal", "countries", "seas", "centroids", "capitals", "aohi", "institutions", "outliers", "urban", "duplicates"
Biogeographic_database_Ponerinae_flags$flag_type <- "OK"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.urb] <- "urban"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.otl] <- "outliers"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.inst] <- "institutions"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.aohi] <- "aohi"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cap] <- "capitals"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cen] <- "centroids"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.sea] <- "seas"
Biogeographic_database_Ponerinae_flags$flag_type[!as.logical(Biogeographic_database_Ponerinae_flags$.con)] <- "countries"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.equ] <- "equal"
# Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.zer] <- "zeros"

Biogeographic_database_Ponerinae_flags$flag_type <- as.factor(Biogeographic_database_Ponerinae_flags$flag_type)  

table(Biogeographic_database_Ponerinae_flags$flag_type)

View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "countries", ])
View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "seas", ])
View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "centroids", ])



## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")


### 2.6.5/ Curate records in capitals ####

# Look at locality names to check if nothing suspicious that could reflect the location of a specimen in collection rather than from the field.
View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "capitals", ] %>% arrange(Country_ISO3_name, adm1, adm2, Locality, GABI_accession_ID, Specimen_code))

# All seems fine, so mark them as false positive
# Biogeographic_database_Ponerinae_flags$.cap <- TRUE

# Update flag types
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cap & !Biogeographic_database_Ponerinae_flags$.inst] <- "institutions"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cap & Biogeographic_database_Ponerinae_flags$.inst & !Biogeographic_database_Ponerinae_flags$.otl] <- "outliers"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.cap & Biogeographic_database_Ponerinae_flags$.inst & Biogeographic_database_Ponerinae_flags$.otl] <- "OK"
Biogeographic_database_Ponerinae_flags$flag_type <- as.factor(Biogeographic_database_Ponerinae_flags$flag_type)  

# Mark them as false positive
Biogeographic_database_Ponerinae_flags$.cap <- TRUE

table(Biogeographic_database_Ponerinae_flags$flag_type)

## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")


### 2.6.6/ Curate records in around institutions ####

# Look at locality names to check if nothing suspicious that could reflect the location of a specimen in collection rather than from the field.
View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "institutions", ] %>% arrange(Country_ISO3_name, adm1, adm2, Locality, GABI_accession_ID, Specimen_code))

# All seems fine, so mark them as false positive
# Biogeographic_database_Ponerinae_flags$.inst <- TRUE

# Update flag types
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.inst & !Biogeographic_database_Ponerinae_flags$.otl] <- "outliers"
Biogeographic_database_Ponerinae_flags$flag_type[!Biogeographic_database_Ponerinae_flags$.inst & Biogeographic_database_Ponerinae_flags$.otl] <- "OK"
Biogeographic_database_Ponerinae_flags$flag_type <- as.factor(Biogeographic_database_Ponerinae_flags$flag_type)

# All seems fine, so mark them as false positive
Biogeographic_database_Ponerinae_flags$.inst <- TRUE

table(Biogeographic_database_Ponerinae_flags$flag_type)

## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")


### 2.6.7/ Curate outliers based on distance ####

## 2.6.7.1/ Plot occurrences of one taxa with distance outliers ####

# Look at locality names to check if outliers are credible or not.
View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$flag_type == "outliers", ] %>% arrange(Current_name, Country_ISO3_name, adm1, adm2, Locality, GABI_accession_ID, Specimen_code))

taxa_with_outliers_dist <- unique(Biogeographic_database_Ponerinae_flags$Current_name[Biogeographic_database_Ponerinae_flags$flag_type == "outliers"])
taxa_with_outliers_dist <- taxa_with_outliers_dist[order(taxa_with_outliers_dist)]
length(taxa_with_outliers_dist) # 205 taxa with distance-based outliers !

# Create Green/Red palette
Green_col <- RColorBrewer::brewer.pal(n = 6, "Greens")[5]
Red_col <- RColorBrewer::brewer.pal(n = 6, "Reds")[5]
pal_GR <- c(Green_col, Red_col)

# Taxa to test
Focal_taxon <- "Anochetus_afr01"
Focal_taxon <- "Anochetus_afr08"

mapviewOptions(fgb = FALSE) # Need this option to enable screenshots! Need to be set before creating the mapview object

# Plot by taxa in case of doubt for the group to evaluate
interactive_map_single_taxon <- mapview::mapview(x = Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$Current_name == Focal_taxon, ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                                 zcol = "flag_type",
                                                 cex = 7,
                                                 burst = T, legend = T,
                                                 # col.regions = pal(nb_flags), # Color to use to plot spatial units in the spatial object
                                                 col.regions = pal_GR, # Color to use to plot spatial units in the spatial object
                                                 layer.name = "Occurrences", # To specify the legend name of this layer
                                                 # map.types = mapviewGetOption("basemaps")
                                                 map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                                 # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                                 # ... # and many more, depending of the class of the spatial object
)

# Plot without title
interactive_map_single_taxon

mapshot(x = interactive_map_single_taxon,
        url = paste0("./maps/Taxa_occurrence_Control_maps/Interactive_map_occurrences_control_",Focal_taxon,".html"), # To save an interactive .html map
        remove_controls = NULL) # c("zoomControl", "layersControl", "homeButton", "scaleBar"))  # To specify which control buttons to remove (or not) from the output

### 2.6.7.2/ Loop to plot maps across taxa with distance-based outliers ####

for (i in seq_along(taxa_with_outliers_dist))
{
  Focal_taxon <- taxa_with_outliers_dist[i]
  
  # Need this option to enable screenshots! Need to be set before creating the mapview object
  mapviewOptions(fgb = FALSE) 
  
  # Plot by taxa in case of doubt for the group to evaluate
  interactive_map_focal_taxon <- mapview::mapview(x = Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$Current_name == Focal_taxon, ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                                   zcol = "flag_type",
                                                   cex = 7,
                                                   burst = T, legend = T,
                                                   # col.regions = pal(nb_flags), # Color to use to plot spatial units in the spatial object
                                                   col.regions = pal_GR, # Color to use to plot spatial units in the spatial object
                                                   layer.name = "Occurrences", # To specify the legend name of this layer
                                                   # map.types = mapviewGetOption("basemaps")
                                                   map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                                   # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                                   # ... # and many more, depending of the class of the spatial object
  )
  
  # Create title HTML object
  tag.map.title <- htmltools::tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 22px;
  }
   "))
  
  title <- tags$div(
    tag.map.title, 
    HTML(str_replace(string = Focal_taxon, pattern = "_", replacement = " ")) # Type title
  )  
  
  # Add title to the leafmap /mapview object
  interactive_map_focal_taxon@map <- interactive_map_focal_taxon@map %>%
    leaflet::addControl(title, position = "bottomleft", className = "map-title")
  
  interactive_map_focal_taxon
  
  # To save a screenshot
  mapshot(x = interactive_map_focal_taxon,
          file = paste0("./maps/Taxa_occurrence_Control_maps/Outliers_distance/occurrence_control_map_",Focal_taxon,".jpeg"), 
          remove_controls = NULL # delay = 0.5
  )
  
  mapviewOptions(fgb = TRUE)
  
  # Print progress
  cat(paste0(Sys.time(), " - Map plotted for ", Focal_taxon, " = Taxon N°",i,"/",length(taxa_with_outliers_dist),"\n"))
}


### 2.7/ Curate outliers found in dubious bioregions ####

## 2.7.1/ Assign bioregion to each entry ####

# Load country_sf with metadata
Countries_NE_sf <- readRDS(file = "./input_data/NaturalEarth_maps/Countries_NE_sf.rds")

# Export metadata to be filled manually for Bioregions
Countries_NE_sf_metadata <- st_drop_geometry(Countries_NE_sf[, c("SUBUNIT", "ISO_A3")])
Countries_NE_sf_metadata$Bioregion <- NA
# write.xlsx(x = Countries_NE_sf_metadata, file = "./input_data/Biogeographic_data/Countries_NE_sf_metadata.xlsx")

# Load metadata with bioregion assignment
Countries_NE_sf_metadata <- openxlsx::read.xlsx(xlsxFile = "./input_data/Biogeographic_data/Countries_NE_sf_metadata.xlsx")

# Assign Bioregion to entries
Biogeographic_database_Ponerinae_flags$Bioregion <- Countries_NE_sf_metadata$Bioregion[match(Biogeographic_database_Ponerinae_flags$Country_ISO3_code, Countries_NE_sf_metadata$ISO_A3)]

# Deal with the particular cases of countries overlapping bioregions

# France: Mayotte, Reunion, Guyane, Martinique, Guadeloupe
View(Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France", ] %>% arrange(Country_initial))
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Palearctic"
Biogeographic_database_Ponerinae_flags$Bioregion[str_detect(string = Biogeographic_database_Ponerinae_flags$Country_initial, pattern =  "Guadeloupe") & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Neotropics"
Biogeographic_database_Ponerinae_flags$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_flags$Country_initial ==  "Martinique", replace = F) | replace_na(data = Biogeographic_database_Ponerinae_flags$adm1 ==  "Martinique", replace = F)) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Neotropics"
Biogeographic_database_Ponerinae_flags$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_flags$Country_initial ==  "Mayotte", replace = F) | replace_na(data = Biogeographic_database_Ponerinae_flags$adm1 ==  "Mayotte", replace = F)) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Afrotropics"
Biogeographic_database_Ponerinae_flags$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_flags$Country_initial ==  "Reunion", replace = F)) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Afrotropics"
Biogeographic_database_Ponerinae_flags$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_flags$Country_initial ==  "Reunion", replace = F)) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Afrotropics"
Biogeographic_database_Ponerinae_flags$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_flags$Country_initial ==  "French Guiana", replace = F)) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "France")] <- "Neotropics"

# Indonesia: Longitude 125.5°. Not right but good enough for rough first estimates
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Longitude_dec < 125.5) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Indonesia")] <- "Indomalaya"
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Longitude_dec >= 125.5) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Indonesia")] <- "Australasia"

# Mexico: 22° Latitude. Not right but good enough for rough first estimates
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Latitude_dec < 22) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Mexico")] <- "Neotropics"
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Latitude_dec >= 22) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "Mexico")] <- "Nearctic"

# China: 33° Latitude (not right but enough for our data)
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Latitude_dec < 33) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "China")] <- "Indomalaya"
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Latitude_dec >= 33) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "China")] <- "Palearctic"

# USA, Hawaii: 150° longitude (works because we have no points in Alaska
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Longitude_dec < -150) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "United States")] <- "Australasia"
Biogeographic_database_Ponerinae_flags$Bioregion[(Biogeographic_database_Ponerinae_flags$Longitude_dec >= -150) & (Biogeographic_database_Ponerinae_flags$Country_ISO3_name == "United States")] <- "Nearctic"

# TAAF, Ile Europa: Afrotropics
Biogeographic_database_Ponerinae_flags$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_flags$Locality == "Europa Island", replace = F)] <- "Afrotropics"

# Netherlands, Saba Island: Neotropics
Biogeographic_database_Ponerinae_flags$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_flags$Country_initial == "Bonaire, Sint Eustatius and Saba", replace = F)] <- "Neotropics"

## Save sf output from CoordinateCleaner
saveRDS(Biogeographic_database_Ponerinae_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")


# Plot to check bioregion assignments
nb_bioregions <- length(unique(Biogeographic_database_Ponerinae_flags$Bioregion))
pal_bioregions <- brewer.pal(n = nb_bioregions, name = "Spectral")

interactive_map_bioregions <- mapview::mapview(x = Biogeographic_database_Ponerinae_flags[ ,], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                          zcol = "Bioregion",
                                          cex = 5,
                                          burst = T, legend = T,
                                          # col.regions = pal(nb_flags), # Color to use to plot spatial units in the spatial object
                                          col.regions = pal_bioregions, # Color to use to plot spatial units in the spatial object
                                          layer.name = "Bioregions", # To specify the legend name of this layer
                                          # map.types = mapviewGetOption("basemaps")
                                          map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                          # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                          # ... # and many more, depending of the class of the spatial object
)

interactive_map_bioregions


## 2.7.2/ Create taxa x bioregions quantitative table ####

# Create table with nb of occurrence per bioregions
Taxa_bioregions_quantitative_table <- Biogeographic_database_Ponerinae_flags %>%
  st_drop_geometry() %>% 
  group_by(Current_name, Bioregion) %>% 
  summarise(nb_occ = n()) %>% 
  pivot_wider(names_from = Bioregion, values_from = nb_occ) %>%
  mutate_all(., ~replace_na(.,0))

# Turn into percentage, then binary test for bioregions hosting less than 20% of occurrences
Taxa_bioregions_quantitative_table$Total_occ <- apply(X = Taxa_bioregions_quantitative_table[, -1], MARGIN = 1, FUN = sum) 
Taxa_bioregions_perc_table <- round(Taxa_bioregions_quantitative_table[, -1]/Taxa_bioregions_quantitative_table$Total_occ * 100, 1)
Taxa_bioregions_binary_test_table <- t(apply(X = Taxa_bioregions_perc_table, MARGIN = 1, FUN = function (x) {(x > 0) & (x <= 20)} ))
Taxa_bioregions_quantitative_table$Outliers_bioregion  <- apply(X = Taxa_bioregions_binary_test_table, MARGIN = 1, FUN = any)

table(Taxa_bioregions_quantitative_table$Outliers_bioregion)

# List taxa with outliers in dubious bioregions
taxa_with_bioregion_outliers <-Taxa_bioregions_quantitative_table$Current_name[Taxa_bioregions_quantitative_table$Outliers_bioregion]
taxa_with_bioregion_outliers <- taxa_with_bioregion_outliers[order(taxa_with_bioregion_outliers)]

### 2.7.3/ Plot distribution maps of suspicious taxa for bioregion-based outliers

# Prepare bioregion palette
nb_bioregions <- length(unique(Biogeographic_database_Ponerinae_flags$Bioregion))
pal_bioregions <- brewer.pal(n = nb_bioregions, name = "Spectral")
Bioregions_ordered <- c("Afrotropics", "Australasia", "Indomalaya", "Nearctic", "Neotropics", "Palearctic")

## Loop across taxa to plot maps

for (i in seq_along(taxa_with_bioregion_outliers))
{
  Focal_taxon <- taxa_with_bioregion_outliers[i]
  
  # Extract taxon data
  Taxon_data <- Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$Current_name == Focal_taxon, ]
  
  # Define bioregion palette according to available bioregions
  Bioregions_available <- unique(Taxon_data$Bioregion)
  Bioregions_indices <- which(Bioregions_ordered %in% Bioregions_available)
  pal_taxon <- pal_bioregions[Bioregions_indices]
  
  # Need this option to enable screenshots! Need to be set before creating the mapview object
  mapviewOptions(fgb = FALSE) 
  
  # Plot by taxa in case of doubt for the group to evaluate
  interactive_map_focal_taxon <- mapview::mapview(x = Biogeographic_database_Ponerinae_flags[Biogeographic_database_Ponerinae_flags$Current_name == Focal_taxon, ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                                  zcol = "Bioregion",
                                                  cex = 7,
                                                  burst = T, legend = T,
                                                  # col.regions = pal(nb_flags), # Color to use to plot spatial units in the spatial object
                                                  col.regions = pal_taxon, # Color to use to plot spatial units in the spatial object
                                                  layer.name = "Bioregions", # To specify the legend name of this layer
                                                  # map.types = mapviewGetOption("basemaps")
                                                  map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                                  # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                                  # ... # and many more, depending of the class of the spatial object
  )
  
  # Create title HTML object
  tag.map.title <- htmltools::tags$style(HTML("
  .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 22px;
  }
   "))
  
  title <- tags$div(
    tag.map.title, 
    HTML(str_replace(string = Focal_taxon, pattern = "_", replacement = " ")) # Type title
  )  
  
  # Add title to the leafmap /mapview object
  interactive_map_focal_taxon@map <- interactive_map_focal_taxon@map %>%
    leaflet::addControl(title, position = "bottomleft", className = "map-title")
  
  interactive_map_focal_taxon
  
  # To save a screenshot
  mapshot(x = interactive_map_focal_taxon,
          file = paste0("./maps/Taxa_occurrence_Control_maps/Outliers_bioregions/occurrence_control_map_",Focal_taxon,".jpeg"), 
          remove_controls = NULL # delay = 0.5
  )
  
  mapviewOptions(fgb = TRUE)
  
  # Print progress
  cat(paste0(Sys.time(), " - Map plotted for ", Focal_taxon, " = Taxon N°",i,"/",length(taxa_with_bioregion_outliers),"\n"))
}

### 2.7.3/ Create .xlsx tables to evaluate taxa ####

taxa_with_outliers <- union(taxa_with_outliers_dist, taxa_with_bioregion_outliers)

Evaluation_table_taxa_outliers <- data.frame(Taxa = taxa_with_outliers, Distance_outlier = NA, Bioregion_outlier = NA, Evaluation = NA, Interactive_map_needed = NA, Comments = NA)
Evaluation_table_taxa_outliers$Distance_outlier <- (Evaluation_table_taxa_outliers$Taxa %in% taxa_with_outliers_dist)
Evaluation_table_taxa_outliers$Bioregion_outlier <- (Evaluation_table_taxa_outliers$Taxa %in% taxa_with_bioregion_outliers)

openxlsx::write.xlsx(x = Evaluation_table_taxa_outliers, file = "./input_data/Biogeographic_data/Evaluation_table_taxa_outliers.xlsx")


##### 3/ Deal with NA coordinates #####

## Load occurrences with no GPS coordinates
Biogeographic_database_Ponerinae_NA_coords <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

# Fix coordinates to NA
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec <- NA
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec <- NA

# Indicate nature of occurrences
Biogeographic_database_Ponerinae_NA_coords$Interpolated_coordinates <- TRUE

### 3.1/ Load shape files ####

# Load bentity2 polygon shapes
Bentity2_sf <- st_read(dsn = "./input_data/GABI_Data_Release1.0_18012020/Bentity2_shapefile_fullres/", layer = "Bentity2_shapefile_fullres")

# Correct mistakes
Bentity2_sf$BENTITY2_N[Bentity2_sf$BENTITY2_N == "Norde de Santander"] <- "Norte de Santander"

# Remove polygons with NA names
table(is.na(Bentity2_sf$BENTITY2_N))


## Load geoBoundaries shapes files for Countries, adm1 and adm2

geoBoundaries_Countries_sf <- st_read(dsn = "./input_data/geoBoundaries/geoBoundariesCGAZ_ADM0/", layer = "geoBoundariesCGAZ_ADM0")
# plot(geoBoundaries_Countries_sf["shapeName"])
table(geoBoundaries_Countries_sf$shapeType)

geoBoundaries_adm1_sf <- st_read(dsn = "./input_data/geoBoundaries/geoBoundariesCGAZ_ADM1/", layer = "geoBoundariesCGAZ_ADM1")
# plot(geoBoundaries_adm1_sf["shapeName"])
# plot(geoBoundaries_adm1_sf["shapeGroup"])
table(geoBoundaries_adm1_sf$shapeType)

geoBoundaries_adm2_sf <- st_read(dsn = "./input_data/geoBoundaries/geoBoundariesCGAZ_ADM2/", layer = "geoBoundariesCGAZ_ADM2")
# plot(geoBoundaries_adm2_sf["shapeName"])
# plot(geoBoundaries_adm2_sf["shapeGroup"])
# plot(geoBoundaries_adm2_sf["shapeType"])
table(geoBoundaries_adm2_sf$shapeType)

# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$shapeGroup == "AUS", "shapeName"])

# Rename data columns
names(geoBoundaries_Countries_sf) <- c("Country_shapeGroup", "Country_shapeType",  "Country_shapeName",  "geometry")
names(geoBoundaries_adm1_sf) <- c("adm1_shapeName", "adm1_shapeID", "adm1_shapeGroup", "adm1_shapeType", "geometry")
names(geoBoundaries_adm2_sf) <- c("adm2_shapeName", "adm2_shapeID", "adm2_shapeGroup", "adm2_shapeType", "geometry")

# Remove polygons with NA names
table(is.na(geoBoundaries_Countries_sf$Country_shapeName))
table(is.na(geoBoundaries_adm1_sf$adm1_shapeName))
table(is.na(geoBoundaries_adm2_sf$adm2_shapeName))

geoBoundaries_adm2_sf <- geoBoundaries_adm2_sf %>% 
  filter(!is.na(geoBoundaries_adm2_sf$adm2_shapeName))

## Load Natural Earth shape files

NE_Countries_sf <- readRDS(file = "./input_data/NaturalEarth_maps/Countries_NE_sf.rds")
NE_subunits_sf <- ne_load(scale = 50, category = "cultural", type = 'map_subunits', returnclass = 'sf', destdir = "./input_data/NaturalEarth_maps/ne_50m_admin_0_map_subunits/")
NE_adm1_sf <- ne_load(file_name = "ne_10m_admin_1_states_provinces", returnclass = 'sf', destdir = "./input_data/NaturalEarth_maps/ne_10m_admin_1_states_provinces/")

# plot(NE_Countries_sf[, "ISO_A3"])
# plot(NE_subunits_sf[, "SUBUNIT"]) # If possible, use subunits because some countries have disjointed shapes such as France with the DOMTOM
# plot(NE_adm1_sf[, "name"])

# Remove polygons with NA names
table(is.na(NE_Countries_sf$ADMIN))
table(is.na(NE_subunits_sf$SUBUNIT))
table(is.na(NE_adm1_sf$name))

NE_adm1_sf <- NE_adm1_sf %>% 
  filter(!is.na(NE_adm1_sf$name))


### Load Geographic Names Server data

GNS_Localities_df <- read.csv(file = "./input_data/GNS_Administrative_Regions/Administrative_Regions.txt", sep = "\t")
GNS_Localities_sf <- st_as_sf(x = GNS_Localities_df, coords = c("long_dd", "lat_dd"))


### 3.2/ Compute areas of shape files to use to estimate uncertainty when drawing random points ####

## Areas of Bentity2_sf
sf_use_s2(FALSE)
Bentity2_sf$area <- st_area(Bentity2_sf)
Bentity2_sf$area <- set_units(Bentity2_sf$area, km^2)
sf_use_s2(TRUE)

# plot(x = Bentity2_sf[ , "BENTITY2_N"])
# plot(x = Bentity2_sf[ , "area"])

# Save Bentity2_sf
saveRDS(object = Bentity2_sf, file = "./input_data/GABI_Data_Release1.0_18012020/Bentity2_shapefile_fullres/Bentity2_sf.rds")

# Load Bentity2_sf
Bentity2_sf <- readRDS(file = "./input_data/GABI_Data_Release1.0_18012020/Bentity2_shapefile_fullres/Bentity2_sf.rds")


## Areas of geoBoundaries shape files
sf_use_s2(FALSE)
geoBoundaries_Countries_sf$area <- st_area(geoBoundaries_Countries_sf)
geoBoundaries_Countries_sf$area <- set_units(geoBoundaries_Countries_sf$area, km^2)
geoBoundaries_adm1_sf$area <- st_area(geoBoundaries_adm1_sf)
geoBoundaries_adm1_sf$area <- set_units(geoBoundaries_adm1_sf$area, km^2)
geoBoundaries_adm2_sf$area <- st_area(geoBoundaries_adm2_sf)
geoBoundaries_adm2_sf$area <- set_units(geoBoundaries_adm2_sf$area, km^2)
sf_use_s2(TRUE)

# plot(x = geoBoundaries_Countries_sf[ , "area"])
# plot(x = geoBoundaries_adm1_sf[ , "area"])
# plot(x = geoBoundaries_adm2_sf[ , "area"])

# Save GeoBoundaries shape files
saveRDS(object = geoBoundaries_Countries_sf, file = "./input_data/geoBoundaries/geoBoundaries_Countries_sf.rds")
saveRDS(object = geoBoundaries_adm1_sf, file = "./input_data/geoBoundaries/geoBoundaries_adm1_sf.rds")
saveRDS(object = geoBoundaries_adm2_sf, file = "./input_data/geoBoundaries/geoBoundaries_adm2_sf.rds")

# Load GeoBoundaries shape files
geoBoundaries_Countries_sf <- readRDS(file = "./input_data/geoBoundaries/geoBoundaries_Countries_sf.rds")
geoBoundaries_adm1_sf <- readRDS(file = "./input_data/geoBoundaries/geoBoundaries_adm1_sf.rds")
geoBoundaries_adm2_sf <- readRDS(file = "./input_data/geoBoundaries/geoBoundaries_adm2_sf.rds")


## Areas of Natural Earth shape files
sf_use_s2(FALSE)
NE_Countries_sf$area <- st_area(NE_Countries_sf)
NE_Countries_sf$area <- set_units(NE_Countries_sf$area, km^2)
NE_subunits_sf$area <- st_area(NE_subunits_sf)
NE_subunits_sf$area <- set_units(NE_subunits_sf$area, km^2)
NE_adm1_sf$area <- st_area(NE_adm1_sf)
NE_adm1_sf$area <- set_units(NE_adm1_sf$area, km^2)
sf_use_s2(TRUE)

# plot(x = NE_Countries_sf[ , "area"])
# plot(x = NE_subunits_sf[ , "area"])
# plot(x = NE_adm1_sf[ , "area"])

# Save Natural Earth shape files
saveRDS(object = NE_Countries_sf, file = "./input_data/NaturalEarth_maps/NE_Countries_sf.rds")
saveRDS(object = NE_subunits_sf, file = "./input_data/NaturalEarth_maps/NE_subunits_sf.rds")
saveRDS(object = NE_adm1_sf, file = "./input_data/NaturalEarth_maps/NE_adm1_sf.rds")

# Load Natural Earth shape files
NE_Countries_sf <- readRDS(file = "./input_data/NaturalEarth_maps/NE_Countries_sf.rds")
NE_subunits_sf <- readRDS(file = "./input_data/NaturalEarth_maps/NE_subunits_sf.rds")
NE_adm1_sf <- readRDS(file = "./input_data/NaturalEarth_maps/NE_adm1_sf.rds")


### 3.3/ Find matching Localities/adm2/adm1/Bentity2/Country_ISO2_name based on names ####

## 3.3.1/ Correct some entries to find better matches ####

## Create new column for SUBUNIT names

Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name <- Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name

# Hong Kong is a Country, not an adm1 of China
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Biogeographic_database_Ponerinae_NA_coords$adm1 == "Hong Kong"] <- "Hong Kong S.A.R." # SUBUNIT in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Biogeographic_database_Ponerinae_NA_coords$adm1 == "Hong Kong"] <- "HKG"
# French Guiana is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "French Guiana"] <- "French Guiana" # SUBUNIT in NE_SUBUNITS
# Mayotte is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Mayotte"] <- "Mayotte" # SUBUNIT in NE_SUBUNITS
# Guadeloupe is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Guadeloupe"] <- "Guadeloupe" # SUBUNIT in NE_SUBUNITS
# Martinique is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Martinique"] <- "Martinique" # SUBUNIT in NE_SUBUNITS
# Christmas Island is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Christmas Island" # SUBUNIT in NE_SUBUNITS
# Tokelau is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Tokelau"] <- "Tokelau" # SUBUNIT in NE_SUBUNITS
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Tokelau"] <- "Tokelau" # SUBUNIT in NE_SUBUNITS
# Pointe-à-Pitre is in Guadeloupe (Subunit) 
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Pointe-à-Pitre", replace = F)] <- "Guadeloupe" # SUBUNIT in NE_SUBUNITS

# Puerto Rico is a Subunit in NE
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$adm1 == "Puerto Rico"] <- "Puerto Rico" # SUBUNIT in NE_SUBUNITS

# SUBUNIT New Caledonia has bad polygons => Match on Country Admin Instead
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name == "New Caledonia", replace = F)] <- NA 


## Fix errors with Country names

# Correct error with Northern Mariana Islands
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "N. Mariana Is."] <- "Northern Mariana Islands"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Northern Mariana Islands", replace = F)] <- "Northern Mariana Islands"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Northern Mariana Islands", replace = F)] <- "MNP"

# Correct errors with Panama
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Panam·"] <- "Panama" # Country in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Panama"] <- "PAN" # Country in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Panama"] <- "Panama" # SUBUNIT in NE_Subunits

# Occurrences in Philippines (bentity2) are labeled as in Indonesia
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Philippines"] <- "Philippines" # Country in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Philippines"] <- "PHL" # Country in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Philippines"] <- "Philippines" # SUBUNIT in NE_Subunits

# Occurrences in Torres Strait Islands (bentity2) are labeled as in PNG as they should be in Australia
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Torres Strait Islands"] <- "Australia" # Country in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Torres Strait Islands"] <- "AUS" # Country in NE_Countries
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Torres Strait Islands"] <- "Australia" # SUBUNIT in NE_Subunits


## Fix errors with Bentity2

# Remove Bentity names for cases where SUBUNIT and Country admin are a better match

# Lesser Antilles in Bentity2 => match on SUBUNIT instead because it encompasses many countries
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Lesser Antilles", replace = F)] <- NA 
# Azerbaijan/Turkmenistan/Iran in Bentity2 => match on SUBUNIT instead because Bentity2 allows occurrences to be drawn in the Caspian Sea
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Azerbaijan", replace = F)] <- NA 
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Turkmenistan", replace = F)] <- NA 
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Iran", replace = F)] <- NA 
# Wallis and Futuna in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Wallis and Futuna", replace = F)] <- NA 
# Fiji in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Fiji", replace = F)] <- NA 
# Tonga in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Tonga", replace = F)] <- NA 
# Tokelau in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Tokelau", replace = F)] <- NA 
# Cuba in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Cuba", replace = F)] <- NA 
# Samoan Islands in Bentity2 => match on SUBUNIT instead because does not make a difference between American Samoa and Samoa
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Samoan Islands", replace = F)] <- NA 
# Bahamas in Bentity2 => match on SUBUNIT instead because some records from Barbados are attributed to Bahamas...
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Bahamas", replace = F)] <- NA 
# Hispaniola in Bentity2 => match on SUBUNIT instead because does not make a difference between Dominican Republic and Haiti
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Hispaniola", replace = F)] <- NA 
# Serbia in Bentity2 => match on SUBUNIT instead because does not make a difference between Kosovo and Serbia
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Serbia", replace = F)] <- NA 
# Israel and Palestine in Bentity2 => match on SUBUNIT instead because does not make a difference between Israel and Palestine
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Israel and Palestine", replace = F)] <- NA 
# Cameroon line Archipelago in Bentity2 => match on SUBUNIT instead because does not make a difference between Equatorial Guinea and São Tomé and Principe
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Cameroon line Archipelago", replace = F)] <- NA
# Sudan in Bentity2 => match on SUBUNIT instead because does not make a difference between Sudan and South Sudan
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Sudan", replace = F)] <- NA
# Occurrences in Laffarugh should be in Somaliland, not Ethiopia => Remove Bentity2 and use SUBUNIT Somaliland to match
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Laffarugh", replace = F)] <- NA
# Somalia in Bentity2 => match on SUBUNIT instead because does not make a difference between Somalia and Somaliland
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Somalia", replace = F)] <- NA
# Saudi Arabia in Bentity2 => match on SUBUNIT instead because it has bad polygon boundaries with Yemen
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Saudi Arabia", replace = F)] <- NA
# Comoros in Bentity2 => match on SUBUNIT instead because it does not make a difference between Comoros and Mayotte
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Comoros", replace = F)] <- NA
# Mascarene Islands in Bentity2 => match on SUBUNIT instead because it does not make a difference between Mauritius and La Reunion
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Mascarene Islands", replace = F)] <- NA
# Malaysia and Singapore => match on SUBUNIT instead because it does not make a difference between Malaysia and Singapoure
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Malaysia and Singapore", replace = F)] <- NA
# Caroline Islands in Bentity2 => Does not make a difference between Palau and Federated States of Micronesia. Match on SUBUNIT instead
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Caroline Islands", replace = F)] <- NA
# Marshall Islands in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Marshall Islands", replace = F)] <- NA
# Cyprus in Bentity2 => Does not make a difference between Cyprus and Northern Cyprus. Match on SUBUNIT instead
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Cyprus", replace = F)] <- NA
# Eritrea in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Eritrea", replace = F)] <- NA
# Seychelles in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Seychelles", replace = F)] <- NA
# Kiribati in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Kiribati", replace = F)] <- NA
# Panama in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Panama", replace = F)] <- NA
# New Caledonia in Bentity2 => match on SUBUNIT instead because bad polygons
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "New Caledonia", replace = F)] <- NA


# Hong Kong in Bentity2 => Rename SUBUNIT and Country as Hong Kong S.A.R. (HKG) instead of China
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Hong Kong", replace = F)] <- "Hong Kong S.A.R."
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Hong Kong", replace = F)] <- "Hong Kong S.A.R."
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Hong Kong", replace = F)] <- "HKG"

# Borneo in Bentity2 => match on adm1 instead because it does not make a difference between Malaysia and Indonesia
# Use Sarawak (adm1) for Malaysia when missing
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Borneo" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Malaysia" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- "Sarawak"
# Use East Kalimantan for Indonesia when missing
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Borneo" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- "East Kalimantan"
# Rename adequately when not missing by deleting the last portion
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Borneo" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- str_remove(string = Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Borneo" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)], pattern = " Province.*")

# Java in Bentity2 => Rename SUBUNIT and Country as Indonesia (IDN) instead of Malaysia
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Java", replace = F)] <- "Indonesia"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Java", replace = F)] <- "Indonesia"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Java", replace = F)] <- "IDN"

# Lesser Sunda Islands in Bentity2
# Name adm1 East Nusa Tenggara if missing
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Lesser Sunda Islands" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- "East Nusa Tenggara"
# Rename adequately when not missing by deleting the last portion
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Lesser Sunda Islands" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- str_remove(string = Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Lesser Sunda Islands" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)], pattern = " Province.*")

# New Guinea in Bentity2 => Does not make a difference between Papua New Guinea and Indonesia. 
# Match on SUBUNIT for PNG.
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "New Guinea" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Papua New Guinea", replace = F)] <- NA
# Rename SUBUNIT and Country as PNG for adm1 == "East New Britain Province"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$adm1 == "East New Britain Province", replace = F)] <- "Papua New Guinea"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$adm1 == "East New Britain Province", replace = F)] <- "Papua New Guinea"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$adm1 == "East New Britain Province", replace = F)] <- "PNG"
# Name adm1 as Papua for Indonesia, except cases with adm1 == "West Papua region" (match on anything with "West") to rename as West Papua
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "New Guinea" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & str_detect(string = Biogeographic_database_Ponerinae_NA_coords$adm1, pattern = "West"), replace = F)] <- "West Papua"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "New Guinea" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & !str_detect(string = Biogeographic_database_Ponerinae_NA_coords$adm1, pattern = "West"), replace = F)] <- "Papua"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "New Guinea" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- "Papua"

# Solomon Islands in Bentity2 => Does not make a difference between Solomon Islands and Bougainville Islands (PNG). 
# For Solomon Islands, remove all 'Province' from adm1 to try to match true Solomon Islands occurrence. Otherwise, match on SUBUNIT. 
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Solomon Islands" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- str_remove(string = Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Solomon Islands" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)], pattern = " Province.*")
# For PNG occurrence, name adm1 as Autonomous Region of Bougainville
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Solomon Islands" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Papua New Guinea", replace = F)] <- "Autonomous Region of Bougainville"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Solomon Islands", replace = F)] <- NA

# Mariana Islands in Bentity2 => Does not make a difference between Northern Mariana Islands and Guam. 
# For Northern Mariana Islands, match on SUBUNIT
# For Guam also, but need to rename Locality == "Guam" as Guam (GUM)
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Guam", replace = F)] <- "Guam"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Guam", replace = F)] <- "Guam"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Guam", replace = F)] <- "GUM"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Mariana Islands", replace = F)] <- NA


## Fix errors with adm1

## GB_adm1

# Balearic Islands = Illes Balears
Biogeographic_database_Ponerinae_NA_coords$adm1[Biogeographic_database_Ponerinae_NA_coords$adm1 == "Balearic Islands"] <- "Illes Balears" # adm1 in GB

# Tenerife & La Palma = Canarias
Biogeographic_database_Ponerinae_NA_coords$adm2[Biogeographic_database_Ponerinae_NA_coords$adm1 == "Tenerife"] <- "Tenerife" 
Biogeographic_database_Ponerinae_NA_coords$adm1[Biogeographic_database_Ponerinae_NA_coords$adm1 == "Tenerife"] <- "Canarias" # adm1 in GB
Biogeographic_database_Ponerinae_NA_coords$adm2[Biogeographic_database_Ponerinae_NA_coords$adm1 == "La Palma"] <- "La Palma" 
Biogeographic_database_Ponerinae_NA_coords$adm1[Biogeographic_database_Ponerinae_NA_coords$adm1 == "La Palma"] <- "Canarias" # adm1 in GB

# Colón (BG_adm1) in Panama is wrongly assigned to Honduras => Rename Colón as Colón Province
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Colón" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Panama", replace = F)] <- "Colón Province"
# San Salvador (BG_adm1) in El Salvador is wrongly assigned to Bahamas => Rename San Salvador as Departamento de San Salvador
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "San Salvador" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "El Salvador", replace = F)] <- "Departamento de San Salvador"
# Santiago (BG_adm1) in Costa Rica is wrongly assigned to Dominican Republic => Add Paraiso as adm2 and rename Santiago as Cartago in adm1
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Santiago" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Costa Rica", replace = F)] <- "Paraiso"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Santiago" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Costa Rica", replace = F)] <- "Cartago"
# Saint Thomas (BG_adm1) in United States Virgin Islands is wrongly assigned to Barbados => Use SUBUNIT (not even Bentity2) as United States Virgin Islands do not have adm2 and adm1 but Saint Thomas is the proper name of the island
Biogeographic_database_Ponerinae_NA_coords$Locality[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Saint Thomas", replace = F)] <- "Saint Thomas"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Saint Thomas", replace = F)] <- NA
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Saint Thomas", replace = F)] <- NA
# Santander (BG_adm1) in Cantabria, Spain is wrongly assigned to Colombia => Rename Santander as Cantabria for both adm1 and adm2
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Santander" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Spain", replace = F)] <- "Cantabria"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Santander" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Spain", replace = F)] <- "Cantabria"
# Distrito Federal (BG_adm1) in Venezuela is wrongly assigned to Brazil => Rename Distrito Federal as Distrito Capital
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Distrito Federal" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Venezuela", replace = F)] <- "Distrito Capital"
# Misiones (BG_adm1) in Paraguay is wrongly assigned to Argentina => Rename Misiones as MISIONES
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Misiones" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Paraguay", replace = F)] <- "MISIONES"
# San José (BG_adm1) in Costa Rica is wrongly assigned to Uruguay => Rename San José as Provincia San José
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "San José" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Costa Rica", replace = F)] <- "Provincia San José"
# Luxembourg (BG_adm1) in Belgium is wrongly assigned to Luxembourg => Rename Luxembourg as Luxemburg
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Luxembourg" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Belgium", replace = F)] <- "Luxemburg"
# Sud (BG_adm1) in Cameroon is wrongly assigned to Italia => Rename Sud as South
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Sud" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Cameroon", replace = F)] <- "South"
# Sud-Ouest (BG_adm1) in Cameroon is wrongly assigned to Burkina-Faso => Rename Sud-Ouest as South-West
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Sud-Ouest" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Cameroon", replace = F)] <- "South-West"
# Centre (BG_adm1) in France is wrongly assigned to Cameroon => Rename Centre as Centre-Val de Loire
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Centre" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "France", replace = F)] <- "Centre-Val de Loire"
# Northern (BG_adm1) in PNG is wrongly assigned to Sudan => Rename Northern as Northern (Oro) Province
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Northern" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Papua New Guinea", replace = F)] <- "Northern (Oro) Province"
# Victoria (BG_adm1) in Tanzania is wrongly assigned to Australia => Rename Victoria as Kigoma + adm2 = Uvinza
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Victoria" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Tanzania", replace = F)] <- "Uvinza"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Victoria" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Tanzania", replace = F)] <- "Kigoma"

# Eastern Equatoria (BG_adm1) in South Sudan. Is properly assigned, but country do not match.
# (Re)name Torit District (adm2) as Torit + Change SUBUNIT and Country for South Sudan
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Eastern Equatoria", replace = F)] <- "South Sudan"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Eastern Equatoria", replace = F)] <- "South Sudan"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Eastern Equatoria", replace = F)] <- "SSD"
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Eastern Equatoria" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "South Sudan", replace = F)] <- "Torit"

# Western (BG_adm1) in Kenya is wrongly assigned to Zambia => Rename Western as Kakamega, except when Locality is "Bungoma, Nzoia", then adm1 is Bungoma
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Western" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Kenya" & Biogeographic_database_Ponerinae_NA_coords$Locality == "Bungoma, Nzoia", replace = F)] <- "Bungoma"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Western" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Kenya", replace = F)] <- "Kakamega"
# Central (BG_adm1) in Paraguay is wrongly assigned to Zambia => Rename Central as CENTRAL
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Central" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Paraguay", replace = F)] <- "CENTRAL"
# Central (BG_adm1) in PNG is wrongly assigned to Zambia => Rename Central as Central Province
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Central" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Papua New Guinea", replace = F)] <- "Central Province"
# Eastern (BG_adm1) in Kenya is wrongly assigned to Zambia => Rename Eastern as Isiolo (like the adm2)
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Eastern" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Kenya", replace = F)] <- "Isiolo"

# Bedforeshire (BG_adm1) in UK is wrongly assigned to another part of UK => Rename adm2 as Bedford. Rename adm1 as England
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Bedforeshire" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "United Kingdom", replace = F)] <- "Bedford"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Bedforeshire" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "United Kingdom", replace = F)] <- "England"

# Sikkim (BG_adm1) in India is wrongly assigned to China and Bhoutan because the adm1 shp has a mistake! => Use North District as adm2
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Sikkim" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "India", replace = F)] <- "North District"
# Sikkim (BG_adm1) in Bangladesh is wrongly assigned to India/China => Rename Sikkim as Rangpur, and use Rangpur as adm2 too
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Sikkim" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Bangladesh", replace = F)] <- "Rangpur"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Sikkim" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Bangladesh", replace = F)] <- "Rangpur"

# Okinawa Prefecture (BG_adm1) is wider than Yaeyama Islands (Bentity2) => Match using Bentity2 instead of adm1
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Okinawa Prefecture" & Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Yaeyama Islands", replace = F)] <- NA

# Western Province (BG_adm1) in Kenya is wrongly assigned to PNG => Rename Western Province as Kakamega 
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Western Province" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Kenya", replace = F)] <- "Kakamega"
# Western Province (BG_adm1) in Solomon Islands is wrongly assigned to PNG => Rename Western Province as Western + Name adm2 as Marovo
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Western" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Solomon Islands", replace = F)] <- "Marovo"

# South Korean adm1 => Remove " Province" from adm1 names
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "South Korea" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- str_remove(string = Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "South Korea" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)], pattern = " Province.*")
# Hiroshima Prefecture (BG_adm1) => Rename Hiroshima Prefecture as Hiroshima
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$adm1 == "Hiroshima Prefecture", replace = F)] <- "Hiroshima"

# Otsu (Locality) is in Kumamoto, Japan => Provide Kumamoto as adm1
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Otsu", replace = F)] <- "Kumamoto"

# Izu Islands are in Tokyo prefecture but better to match them on Bentity2, so remove adm1
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Izu Islands", replace = F)] <- NA

# North Maluku Province [Maluku Utara] (BG_adm1) is North Maluku
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "North Maluku Province [Maluku Utara]", replace = F)] <- "North Maluku"

# Galapagos Islands (GB_adm1) should be renamed Galápagos
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Galapagos Islands", replace = F)] <- "Galápagos"
# Abidjan Department (GB_adm1) should be renamed District Autonome D'Abidjan
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Abidjan Department", replace = F)] <- "District Autonome D'Abidjan"

# Remove "Province" from Indonesia adm1 names
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$adm1 == "null", replace = F)] <- NA
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)] <- str_remove(string = Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Indonesia" & !is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), replace = F)], pattern = " Province.*")

# Locality with "Kenting National Park" in Taiwan is in adm1 Pingtung County
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_NA_coords$Locality, pattern = "Kenting National Park"), replace = F)] <- "Pingtung County"
# Locality "Djebel Bou-Berak" is in Boumerdès (GB_adm1) 
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$Locality == "Djebel Bou-Berak", replace = F)] <- "Boumerdès"


## NE_adm1

# Veracruz (NE_adm1) in Argentina is wrongly assigned to Mexico => Rename Veracruz (adm1) as Córdoba
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Veracruz" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Argentina", replace = F)] <- "Córdoba"
# Bolivar (NE_adm1) in Colombia is wrongly assigned to Ecuador => Rename Bolivar as Bolívar
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Bolivar" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Colombia", replace = F)] <- "Bolívar"
# Bolivar (NE_adm1) in Venezuela is wrongly assigned to Ecuador => Rename Bolivar as Bolívar
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Bolivar" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Venezuela", replace = F)] <- "Bolívar"
# Macau (NE_adm1) need to be associated with Macao S.A.R (MAC) as a SUBUNIT/Country Admin
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Macau", replace = F)] <- "Macao S.A.R"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Macau", replace = F)] <- "Macao S.A.R"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Macau", replace = F)] <- "MAC"


## Fix errors with adm2

## GB_adm2
# San Bernardino (GB_adm2) in Cordillera (adm1) in Paraguay is wrongly assigned to California, US => Rename San Bernardino as SAN BERNARDINO
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "San Bernardino" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Paraguay", replace = F)] <- "SAN BERNARDINO"
# Furnas (GB_adm2) in Goiás (adm1) in Brazil is wrongly assigned to Nebraska, US => Delete Furnas and use adm1
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Furnas" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Brazil", replace = F)] <- NA
# San Felipe (GB_adm2) in Texas (adm1) in US is wrongly assigned to Mexico => Rename San Felipe as Austin
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "San Felipe" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "United States", replace = F)] <- "Austin"
# San Jeronimo (GB_adm2) in Baja Verapaz (adm1) in Guatemala is wrongly assigned to Honduras => Rename San Jeronimo as San Jerónimo
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "San Jeronimo" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Guatemala", replace = F)] <- "San Jerónimo"
# La Palma (BG_adm2) in Canarias is wrongly assigned to Cuba => Rename La Palma as Palmas, Las
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "La Palma" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Spain", replace = F)] <- "Palmas, Las"
# Tenerife (BG_adm2) in Canarias is wrongly assigned to Colombia => Rename Tenerife as Santa Cruz de Tenerife
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Tenerife" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Spain", replace = F)] <- "Santa Cruz de Tenerife"
# El Cercado (BG_adm2) in Nuevo Leon, Mexico is wrongly assigned to Dominican Republic => Rename El Cercado as Santiago, rename locality as Horsetail Falls, El Cercado
Biogeographic_database_Ponerinae_NA_coords$Locality[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "El Cercado" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Mexico", replace = F)] <- "Horsetail Falls, El Cercado"
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "El Cercado" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Mexico", replace = F)] <- "Santiago"
# Natal (BG_adm2) in KwaZulu-Natal, South Africa is wrongly assigned to Brazil => Remove Natal to use adm1 KwaZulu-Natal instead
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Natal" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "South Africa", replace = F)] <- NA
# Concepcion (BG_adm2) in Bio Bio, Chile is wrongly assigned to Peru => Rename Concepcion as Provincia de Concepción
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Concepcion" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Chile", replace = F)] <- "Provincia de Concepción"
# Florida (BG_adm2) in US is wrongly assigned to Bolivia => Remove Florida (adm2) and use adm1 Florida instead
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Florida" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "United States", replace = F)] <- NA
# VILLETA (BG_adm2) in Colombia is wrongly assigned to Paraguay => Rename VILLETA as Villeta
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "VILLETA" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Colombia", replace = F)] <- "Villeta"
# Santiago (BG_adm2) in Los Leones, Chile is wrongly assigned to Brazil => Rename Santiago as Provincia de Santiago
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Santiago" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Chile", replace = F)] <- "Provincia de Santiago"
# York (BG_adm2) in Ontario, Canada is wrongly assigned to UK => Rename York as Toronto
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "York" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Canada", replace = F)] <- "Toronto"
# Cordoba (BG_adm2) in Veracruz, Mexico is wrongly assigned to Spain => Rename Cordoba (adm2) as Córdoba, and rename Veracruz (adm1) as Veracruz de Ignacio de la Llave
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Cordoba" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Mexico", replace = F)] <- "Veracruz de Ignacio de la Llave"
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Cordoba" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Mexico", replace = F)] <- "Córdoba"
# Baoshan (BG_adm2) in Yunnan, China is wrongly assigned to Taiwan => Rename Baoshan as Baoshanshi
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm2 == "Baoshan" & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "China", replace = F)] <- "Baoshanshi"

# Locality with "Luganville" in Vanuatu is adm2 Luganville and adm1 Sanma
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_NA_coords$Locality, pattern = "Luganville") & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Vanuatu", replace = F)] <- "Luganville"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_NA_coords$Locality, pattern = "Luganville") & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Vanuatu", replace = F)] <- "Sanma"

# Kepulauan Yapen Regency (GB_adm2) is Kepulauan Yapen
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$adm2 == "Kepulauan Yapen Regency", replace = F)] <- "Kepulauan Yapen"

 
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "TZA", ])
# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "TZA", ])


## Save cleaned NA_coords database before drawing new random coordinates
saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

# Load NA_coords database
Biogeographic_database_Ponerinae_NA_coords <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")


## 3.3.2/ Find matching localities in Geo Server Names ####

## To messy... Maybe go back to it for things that have no match in adm2 (and are not duplicates)

i <- 1
GNS_Localities_sf$full_name[str_detect(string = GNS_Localities_sf$full_name, pattern = paste0("(?i)",Biogeographic_database_Ponerinae_NA_coords$adm2[i]))]

GNS_Localities_sf$full_name
GNS_Localities_sf$full_nm_nd

## 3.3.3/ Find matching adm2 in GeoBoundaries ####

geoBoundaries_adm2_sf$adm2_shapeName[str_detect(string = geoBoundaries_adm2_sf$adm2_shapeName, pattern = paste0("(?i)",Biogeographic_database_Ponerinae_NA_coords$adm2[i]))]

table(Biogeographic_database_Ponerinae_NA_coords$adm2 %in% geoBoundaries_adm2_sf$adm2_shapeName)

# Record level of matching
Biogeographic_database_Ponerinae_NA_coords$matching_shp <- NA
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2 <- (Biogeographic_database_Ponerinae_NA_coords$adm2 %in% geoBoundaries_adm2_sf$adm2_shapeName)
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2] <- "GB_adm2"

## 3.3.4/ Find matching adm1 in GeoBoundaries ####

table(Biogeographic_database_Ponerinae_NA_coords$adm1 %in% geoBoundaries_adm1_sf$adm1_shapeName)

# Only for entries with no match for adm2
table(Biogeographic_database_Ponerinae_NA_coords$adm1[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp)] %in% geoBoundaries_adm1_sf$adm1_shapeName)

# Record level of matching
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1 <- (Biogeographic_database_Ponerinae_NA_coords$adm1 %in% geoBoundaries_adm1_sf$adm1_shapeName)
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2] <- "GB_adm1"

table(Biogeographic_database_Ponerinae_NA_coords$matching_shp)

## 3.3.6/ Find matching adm1 in Natural Earth ####

table(Biogeographic_database_Ponerinae_NA_coords$adm1 %in% NE_adm1_sf$name)

# Only for entries with no match for adm2 and GeoBoundaries_adm1
table(Biogeographic_database_Ponerinae_NA_coords$adm1[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp)] %in% NE_adm1_sf$name)

# Record level of matching
Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1 <- (Biogeographic_database_Ponerinae_NA_coords$adm1 %in% NE_adm1_sf$name)
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2] <- "NE_adm1"

table(Biogeographic_database_Ponerinae_NA_coords$matching_shp)

## 3.3.5/ Find matching Bentity2 ####

table(Biogeographic_database_Ponerinae_NA_coords$bentity2_name %in% Bentity2_sf$BENTITY2_N)

# Only for entries with no match for adm2 and adm1
table(Biogeographic_database_Ponerinae_NA_coords$bentity2_name[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp)] %in% Bentity2_sf$BENTITY2_N)

# Record level of matching
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2 <- (Biogeographic_database_Ponerinae_NA_coords$bentity2_name %in% Bentity2_sf$BENTITY2_N)
table(Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2, Biogeographic_database_Ponerinae_NA_coords$Source)
# All GABI entries have a match
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2 & !Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2] <- "Bentity2"

table(Biogeographic_database_Ponerinae_NA_coords$matching_shp)
table(is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp))

## 3.3.6/ Find matching SUBUNIT from Natural Earth ####

table(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name %in% NE_subunits_sf$SUBUNIT)

# plot(x = NE_subunits_sf[, "SUBUNIT"])

# Only for entries with no match for adm2, adm1, and Bentity2
table(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp)] %in% NE_subunits_sf$SUBUNIT)

# Record level of matching
Biogeographic_database_Ponerinae_NA_coords$matching_SUBUNIT <- (Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name %in% NE_subunits_sf$SUBUNIT)
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Biogeographic_database_Ponerinae_NA_coords$matching_SUBUNIT & !Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2 & !Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2] <- "NE_SUBUNIT"

table(Biogeographic_database_Ponerinae_NA_coords$matching_shp)
table(is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp))

## 3.3.7/ Find matching Country ADMIN from Natural Earth ####

table(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name %in% NE_Countries_sf$ADMIN)

# Only for entries with no match for adm2, adm1, Bentity2, and Country
table(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp)] %in% NE_Countries_sf$ADMIN)
table(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp)] %in% NE_Countries_sf$ADMIN)

# Record level of matching
Biogeographic_database_Ponerinae_NA_coords$matching_Country_Admin <- (Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name %in% NE_Countries_sf$ADMIN)
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Biogeographic_database_Ponerinae_NA_coords$matching_Country_Admin & !Biogeographic_database_Ponerinae_NA_coords$matching_SUBUNIT & !Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2 & !Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1 & !Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2] <- "NE_ADMIN"

table(Biogeographic_database_Ponerinae_NA_coords$matching_shp)
table(is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp))

### 3.4/ Remove entries with no matches ####

# Stuff from the Antilles with no more information
View(Biogeographic_database_Ponerinae_NA_coords[is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp), ])

Biogeographic_database_Ponerinae_NA_coords <- Biogeographic_database_Ponerinae_NA_coords %>% 
  filter(!is.na(Biogeographic_database_Ponerinae_NA_coords$matching_shp))

### 3.5/ Intersect all shapes to be able to select across homonyms based on name of higher level shape

sf_use_s2(FALSE)

# Project CRS to help intersection computation Use Robinson projection (ESRI:54030)? Winkel Tripel projection (ESRI:53042)? 
geoBoundaries_adm2_sf_Robinson <- st_transform(x = geoBoundaries_adm2_sf[, c("adm2_shapeName")], crs = st_crs("ESRI:54030"))
geoBoundaries_adm1_sf_Robinson <- st_transform(x = geoBoundaries_adm1_sf[, c("adm1_shapeName")], crs = st_crs("ESRI:54030"))
NE_adm1_sf_Robinson <- st_transform(x = NE_adm1_sf[, c("name")], crs = st_crs("ESRI:54030"))
Bentity2_sf_Robinson <- st_transform(x = Bentity2_sf[, c("BENTITY2_N")], crs = st_crs("ESRI:54030"))
NE_subunits_sf_Robinson <- st_transform(x = NE_subunits_sf[, c("SUBUNIT")], crs = st_crs("ESRI:54030"))
NE_Countries_sf_Robinson <- st_transform(x = NE_Countries_sf[, c("ADMIN")], crs = st_crs("ESRI:54030"))

# plot(Intersect_all_shp_GB_adm2_levels["adm2_shapeName"])

# Snap to grid of 500 m to avoid issue with intersecting nodes, but only work if data is projected... 
geoBoundaries_adm2_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(geoBoundaries_adm2_sf_Robinson, 500))
geoBoundaries_adm1_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(geoBoundaries_adm1_sf_Robinson, 500))
NE_adm1_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(NE_adm1_sf_Robinson, 500))
Bentity2_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(Bentity2_sf_Robinson, 500))
NE_subunits_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(NE_subunits_sf_Robinson, 500))
NE_Countries_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(NE_Countries_sf_Robinson, 500))

# Add zero buffer may solve issues...
geoBoundaries_adm2_sf_Robinson_grid500 <- st_buffer(geoBoundaries_adm2_sf_Robinson_grid500, 0)
geoBoundaries_adm1_sf_Robinson_grid500 <- st_buffer(geoBoundaries_adm1_sf_Robinson_grid500, 0)
NE_adm1_sf_Robinson_grid500 <- st_buffer(NE_adm1_sf_Robinson_grid500, 0)
Bentity2_sf_Robinson_grid500 <- st_buffer(Bentity2_sf_Robinson_grid500, 0)
NE_subunits_sf_Robinson_grid500 <- st_buffer(NE_subunits_sf_Robinson_grid500, 0)
NE_Countries_sf_Robinson_grid500 <- st_buffer(NE_Countries_sf_Robinson_grid500, 0)


## Intersect all shapes from adm2 to country ADMIN
Intersect_all_shp_GB_adm2_levels <- st_make_valid(st_intersection(geoBoundaries_adm2_sf_Robinson_grid500, geoBoundaries_adm1_sf_Robinson_grid500))
# Add 0° buffer to avoid issue with intersecting nodes
Intersect_all_shp_GB_adm2_levels <- st_buffer(Intersect_all_shp_GB_adm2_levels, 0)
table(sf::st_is_valid(Intersect_all_shp_GB_adm2_levels))
# Intersect with higher shape levels
Intersect_all_shp_GB_adm2_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm2_levels, NE_adm1_sf_Robinson_grid500)), 0)
Intersect_all_shp_GB_adm2_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm2_levels, Bentity2_sf_Robinson_grid500)), 0)
Intersect_all_shp_GB_adm2_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm2_levels, NE_subunits_sf_Robinson_grid500)), 0)
Intersect_all_shp_GB_adm2_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm2_levels, NE_Countries_sf_Robinson_grid500)), 0)

## Intersect all shapes from GB_adm1 to country ADMIN
Intersect_all_shp_GB_adm1_levels <- st_buffer(st_make_valid(st_intersection(geoBoundaries_adm1_sf_Robinson_grid500, NE_adm1_sf_Robinson_grid500)), 0)
# Intersect with higher shape levels
Intersect_all_shp_GB_adm1_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm1_levels, Bentity2_sf_Robinson_grid500)), 0)
Intersect_all_shp_GB_adm1_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm1_levels, NE_subunits_sf_Robinson_grid500)), 0)
Intersect_all_shp_GB_adm1_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_GB_adm1_levels, NE_Countries_sf_Robinson_grid500)), 0)

## Intersect all shapes from NE_adm1 to country ADMIN
Intersect_all_shp_NE_adm1_levels <- st_buffer(st_make_valid(st_intersection(NE_adm1_sf_Robinson_grid500, Bentity2_sf_Robinson_grid500)), 0)
# Intersect with higher shape levels
Intersect_all_shp_NE_adm1_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_NE_adm1_levels, NE_subunits_sf_Robinson_grid500)), 0)
Intersect_all_shp_NE_adm1_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_NE_adm1_levels, NE_Countries_sf_Robinson_grid500)), 0)

## Intersect all shapes from Bentity2 to country ADMIN
Intersect_all_shp_Bentity2_levels <- st_buffer(st_make_valid(st_intersection(Bentity2_sf_Robinson_grid500, NE_subunits_sf_Robinson_grid500)), 0)
# Intersect with higher shape levels
Intersect_all_shp_Bentity2_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_Bentity2_levels, NE_Countries_sf_Robinson_grid500)), 0)

## Intersect all shapes from NE_subunits to country ADMIN
Intersect_all_shp_NE_subunits_levels <- st_buffer(st_make_valid(st_intersection(NE_subunits_sf_Robinson_grid500, NE_Countries_sf_Robinson_grid500)), 0)

## Compute areas
Intersect_all_shp_GB_adm2_levels$area <- st_area(Intersect_all_shp_GB_adm2_levels)
Intersect_all_shp_GB_adm2_levels$area <- set_units(Intersect_all_shp_GB_adm2_levels$area, km^2)
Intersect_all_shp_GB_adm1_levels$area <- st_area(Intersect_all_shp_GB_adm1_levels)
Intersect_all_shp_GB_adm1_levels$area <- set_units(Intersect_all_shp_GB_adm1_levels$area, km^2)
Intersect_all_shp_NE_adm1_levels$area <- st_area(Intersect_all_shp_NE_adm1_levels)
Intersect_all_shp_NE_adm1_levels$area <- set_units(Intersect_all_shp_NE_adm1_levels$area, km^2)
Intersect_all_shp_Bentity2_levels$area <- st_area(Intersect_all_shp_Bentity2_levels)
Intersect_all_shp_Bentity2_levels$area <- set_units(Intersect_all_shp_Bentity2_levels$area, km^2)
Intersect_all_shp_NE_subunits_levels$area <- st_area(Intersect_all_shp_NE_subunits_levels)
Intersect_all_shp_NE_subunits_levels$area <- set_units(Intersect_all_shp_NE_subunits_levels$area, km^2)

## Transform back to WGS84
Intersect_all_shp_GB_adm2_levels <- st_transform(x = Intersect_all_shp_GB_adm2_levels, crs = st_crs(geoBoundaries_adm2_sf))
plot(Intersect_all_shp_GB_adm2_levels["adm2_shapeName"])
Intersect_all_shp_GB_adm1_levels <- st_transform(x = Intersect_all_shp_GB_adm1_levels, crs = st_crs(geoBoundaries_adm2_sf))
plot(Intersect_all_shp_GB_adm1_levels["adm1_shapeName"])
Intersect_all_shp_NE_adm1_levels <- st_transform(x = Intersect_all_shp_NE_adm1_levels, crs = st_crs(geoBoundaries_adm2_sf))
plot(Intersect_all_shp_NE_adm1_levels["name"])
Intersect_all_shp_Bentity2_levels <- st_transform(x = Intersect_all_shp_Bentity2_levels, crs = st_crs(geoBoundaries_adm2_sf))
plot(Intersect_all_shp_Bentity2_levels["BENTITY2_N"])
Intersect_all_shp_NE_subunits_levels <- st_transform(x = Intersect_all_shp_NE_subunits_levels, crs = st_crs(geoBoundaries_adm2_sf))
plot(Intersect_all_shp_NE_subunits_levels["SUBUNIT"])

## Remove empty polygons
Intersect_all_shp_GB_adm2_levels <- Intersect_all_shp_GB_adm2_levels[!st_is_empty(Intersect_all_shp_GB_adm2_levels), , drop = FALSE]
Intersect_all_shp_GB_adm1_levels <- Intersect_all_shp_GB_adm1_levels[!st_is_empty(Intersect_all_shp_GB_adm1_levels), , drop = FALSE]
Intersect_all_shp_NE_adm1_levels <- Intersect_all_shp_NE_adm1_levels[!st_is_empty(Intersect_all_shp_NE_adm1_levels), , drop = FALSE]
Intersect_all_shp_Bentity2_levels <- Intersect_all_shp_Bentity2_levels[!st_is_empty(Intersect_all_shp_Bentity2_levels), , drop = FALSE]
Intersect_all_shp_NE_subunits_levels <- Intersect_all_shp_NE_subunits_levels[!st_is_empty(Intersect_all_shp_NE_subunits_levels), , drop = FALSE]

sf_use_s2(TRUE)

## Save intersecting shp files
saveRDS(object = Intersect_all_shp_GB_adm2_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_GB_adm2_levels.rds")
saveRDS(object = Intersect_all_shp_GB_adm1_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_GB_adm1_levels.rds")
saveRDS(object = Intersect_all_shp_NE_adm1_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_NE_adm1_levels.rds")
saveRDS(object = Intersect_all_shp_Bentity2_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_Bentity2_levels.rds")
saveRDS(object = Intersect_all_shp_NE_subunits_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_NE_subunits_levels.rds")

# Load intersecting shp files
Intersect_all_shp_GB_adm2_levels <- readRDS(file = "./input_data/Biogeographic_data/Intersect_all_shp_GB_adm2_levels.rds")
Intersect_all_shp_GB_adm1_levels <- readRDS(file = "./input_data/Biogeographic_data/Intersect_all_shp_GB_adm1_levels.rds")
Intersect_all_shp_NE_adm1_levels <- readRDS(file = "./input_data/Biogeographic_data/Intersect_all_shp_NE_adm1_levels.rds")
Intersect_all_shp_Bentity2_levels <- readRDS(file = "./input_data/Biogeographic_data/Intersect_all_shp_Bentity2_levels.rds")
Intersect_all_shp_NE_subunits_levels <- readRDS(file = "./input_data/Biogeographic_data/Intersect_all_shp_NE_subunits_levels.rds")

### 3.5/ Draw random coordinates in new polygon ####

Biogeographic_database_Ponerinae_NA_coords$Interpolated_coordinates <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area <- NA

# List all sf files
all_sf_files <- list(geoBoundaries_adm2_sf[, c("adm2_shapeName", "area")], 
                     geoBoundaries_adm1_sf[, c("adm1_shapeName", "area")], 
                     NE_adm1_sf[, c("name", "area")], 
                     Bentity2_sf[, c("BENTITY2_N", "area")], 
                     NE_subunits_sf[, c("SUBUNIT", "area")], 
                     NE_Countries_sf[, c("ADMIN", "area")])
# List all intersecting sf files (without non-intersecting polygons)
all_intersecting_sf_files <- list(Intersect_all_shp_GB_adm2_levels, 
                                  Intersect_all_shp_GB_adm1_levels, 
                                  Intersect_all_shp_NE_adm1_levels, 
                                  Intersect_all_shp_Bentity2_levels, 
                                  Intersect_all_shp_NE_subunits_levels, 
                                  NE_Countries_sf[, c("ADMIN", "area")])
# List all matching levels
matching_level_list <- c("GB_adm2", "GB_adm1", "NE_adm1", "Bentity2", "NE_SUBUNIT", "NE_ADMIN")

### 3.5.1/ Loop per entry #### 

set.seed(seed = 644668)

Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID <- NA
Biogeographic_database_Ponerinae_NA_coords$multiple_matches <- FALSE # Record cases of entries with multiple name matching, so the shape must be extracted from the file with all intersected levels of shapes

# Biogeographic_database_Ponerinae_NA_coords <- st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords)

sf_use_s2(FALSE)
for (i in 1:nrow(Biogeographic_database_Ponerinae_NA_coords))
# for (i in 34400:nrow(Biogeographic_database_Ponerinae_NA_coords))
# for (i in occ_to_update)
{ 
  # i <- 1
  # i <- 466
  
  # which(Biogeographic_database_Ponerinae_NA_coords$adm1 == "San Salvador")
  

  # fix <- F
  
  # Extract matching level
  matching_lvl <- Biogeographic_database_Ponerinae_NA_coords$matching_shp[i]
  
  # Extract name of matching shape
  focal_occ_shp_names <- Biogeographic_database_Ponerinae_NA_coords[i, c("adm2", "adm1", "adm1", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name")]
  matching_level_binary <- Biogeographic_database_Ponerinae_NA_coords[i, c("matching_GB_adm2", "matching_GB_adm1", "matching_NE_adm1", "matching_Bentity2", "matching_SUBUNIT", "matching_Country_Admin")]
  matching_shp_index <- which(matching_lvl == matching_level_list)
  focal_occ_shp_name <- focal_occ_shp_names[matching_shp_index][1,1]
  
  # Retrieve associated shape
  focal_occ_sf_file <- all_sf_files[[matching_shp_index]]
  focal_occ_shp_index <- which(st_drop_geometry(focal_occ_sf_file[, 1]) == focal_occ_shp_name)
  
  # Need to decide what to do for cases with multiple matches
  if(length(focal_occ_shp_index) != 1)
  {  
    Biogeographic_database_Ponerinae_NA_coords$multiple_matches[i] <- TRUE
    
    # Extract shp files with intersecting all other higher levels
    Intersect_higher_shp_levels <- all_intersecting_sf_files[[matching_shp_index]]
    
    # Check for other matches in the shape files intersecting all higher levels
    focal_occ_all_shp_indices <- which(st_drop_geometry(Intersect_higher_shp_levels[, 1]) == focal_occ_shp_name)
    focal_occ_all_shp_matches <- Intersect_higher_shp_levels[focal_occ_all_shp_indices, ]
    # plot(focal_occ_all_shp_matches[, 1])
    
    # Find the shape(s) with the most matches
    nb_matches <- apply(X = st_drop_geometry(focal_occ_all_shp_matches), MARGIN = 1, FUN = function (x) { sum(apply(X = sapply(X = x, `==`, focal_occ_shp_names), MARGIN = 2, FUN = any, na.rm = TRUE))  })
    focal_occ_all_shp_best_matches <- focal_occ_all_shp_matches [nb_matches == max(nb_matches), ]   
    # In case of equality, use the one with the highest area, because some shapes are likely artefact of poorly matching boundaries across data source
    focal_occ_all_shp_best_match <- arrange(focal_occ_all_shp_best_matches, desc(area))[1, ]
    # plot(focal_occ_all_shp_best_match[, 1])
    
    # Extract the ID of the shp file in Intersect_higher_shp_levels
    focal_occ_shp_index <- which(row.names(focal_occ_all_shp_best_match) == row.names(Intersect_higher_shp_levels))
   
    # Record shp ID and extract shape
    Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[i] <- focal_occ_shp_index
    focal_occ_shp <- focal_occ_all_shp_best_match
    
    # # Florida in the USA, not in Uruguay
    # if ((focal_occ_shp_names["adm1"] == "Florida") & (focal_occ_shp_names["Country_ISO3_name"] == "United States")) { focal_occ_shp_index <- 108 ; fix <- T }
    # if (!fix) { stop(paste0("i = ",i))}

  } else {
    
    # Record shp ID and extract shape
    Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[i] <- focal_occ_shp_index
    focal_occ_shp <- focal_occ_sf_file[focal_occ_shp_index, ]
    
  }
  
  # Sample randomly a point
  focal_occ_point_sf <- suppressMessages(suppressWarnings(sf::st_sample(x = focal_occ_shp, size = 1, exact = TRUE)))
  # Extract coordinates
  focal_occ_longlat <- as.numeric(focal_occ_point_sf[[1]])
  # Record coordinates
  Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[i] <- focal_occ_longlat[1]
  Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[i] <- focal_occ_longlat[2]
  
  # Inform of uncertainty based on area of the polygon
  Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[i] <- focal_occ_shp$area
  
  # Print progress
  if ( i %% 100 == 0) { cat(paste0(Sys.time(), " - Occurrence n°",i, " / ", nrow(Biogeographic_database_Ponerinae_NA_coords),"\n")) }
}
sf_use_s2(TRUE)

# Transform into sf object
Biogeographic_database_Ponerinae_NA_coords$Latitude_copy <- Biogeographic_database_Ponerinae_NA_coords$Latitude_dec
Biogeographic_database_Ponerinae_NA_coords$Longitude_copy <- Biogeographic_database_Ponerinae_NA_coords$Longitude_dec
Biogeographic_database_Ponerinae_NA_coords <- st_as_sf(Biogeographic_database_Ponerinae_NA_coords, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_NA_coords) <- st_crs(geoBoundaries_adm2_sf)
# Remove copies of Long/Lat if still present
# Biogeographic_database_Ponerinae_NA_coords <- Biogeographic_database_Ponerinae_NA_coords %>% select(-c("Longitude_copy", "Latitude_copy"))

# Check results
plot(NE_Countries_sf[, c("ADMIN")])
plot(Biogeographic_database_Ponerinae_NA_coords[, "Country_ISO3_name"], add = T)
plot(Biogeographic_database_Ponerinae_NA_coords[, "Country_ISO3_name"])

test_map <- ggplot() + 
  geom_sf(data = NE_Countries_sf, fill = NA, show.legend = FALSE) + 
  geom_sf(data = Biogeographic_database_Ponerinae_NA_coords, mapping = aes(col = Country_ISO3_name), show.legend = FALSE) +
  theme_minimal()
print(test_map)

# Save database of NA coordinates
saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")


### 3.5.2/ Double-check for potential errors by checking country compatibility using CoordinatesCleaner ####

# Load landmass buffer
map_NE_lands_sf_buffer <- readRDS(file = "./input_data/NaturalEarth_maps/map_NE_lands_sf_buffer.rds")

# Scan new random coordinates
Biogeographic_database_Ponerinae_NA_coords_flags <- clean_coordinates(x = st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords),
                                                            lon = "Longitude_dec", lat = "Latitude_dec",
                                                            countries = "Country_ISO3_code",
                                                            species = "Current_name",
                                                            value = "spatialvalid",         # To define the type of output. Can be a spatial df ("spatialvalid"), a logical vector recording entries with at least one flag ("flagged"), a df with dubious coordinates removed ("clean").
                                                            verbose = T,
                                                            # List of tests to run
                                                            tests = c("countries",     # Test if occurrences are found within a list of countries or a custom SpatialPolygon
                                                                      "seas"           # Test if fall in the ocean
                                                            ), 
                                                            # seas_scale = 10,               # Adjust resolution of landmass polygons used as reference. 10 = highest resolution.
                                                            seas_ref = map_NE_lands_sf_buffer,   # sf SpatialPolygons to use as reference for landmasses. Default is too coarse. 
                                                            # seas_ref = map_NE_all_lands_sf,   # sf SpatialPolygons to use as reference for landmasses. Default is too coarse. 
                                                            country_ref = Countries_NE_sf,  # sf SpatialPolygons to use as reference for countries
                                                            country_refcol = "ISO_A3",     # Name of ISO3 column
                                                            country_buffer = 5000         # Buffer around country polygons (in meters)
                                                            # seas_buffer = 5000,            # Buffer around landmass limits (in meters) # Does not work properly with scale 10 map. Make our own prior
                                                            )

table(Biogeographic_database_Ponerinae_NA_coords_flags$.con)
table(Biogeographic_database_Ponerinae_NA_coords_flags$.sea)
table(Biogeographic_database_Ponerinae_NA_coords_flags$.con, Biogeographic_database_Ponerinae_NA_coords_flags$.sea)

View(Biogeographic_database_Ponerinae_NA_coords_flags[!Biogeographic_database_Ponerinae_NA_coords_flags$.con, ])

Biogeographic_database_Ponerinae_NA_coords_flags$flag_type <- "OK"
Biogeographic_database_Ponerinae_NA_coords_flags$flag_type[!Biogeographic_database_Ponerinae_NA_coords_flags$.con] <- "country"
Biogeographic_database_Ponerinae_NA_coords_flags$flag_type[!Biogeographic_database_Ponerinae_NA_coords_flags$.sea] <- "sea"

table(Biogeographic_database_Ponerinae_NA_coords_flags$flag_type)

## Make an interactive plot to spot issues

# Transform into sf object
Biogeographic_database_Ponerinae_NA_coords_flags$Latitude_copy <- Biogeographic_database_Ponerinae_NA_coords_flags$Latitude_dec
Biogeographic_database_Ponerinae_NA_coords_flags$Longitude_copy <- Biogeographic_database_Ponerinae_NA_coords_flags$Longitude_dec
Biogeographic_database_Ponerinae_NA_coords_flags <- st_as_sf(Biogeographic_database_Ponerinae_NA_coords_flags, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_NA_coords_flags) <- st_crs(geoBoundaries_adm2_sf)

# Save database of NA coords with flags
saveRDS(Biogeographic_database_Ponerinae_NA_coords_flags, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords_flags.rds")


nb_flags <- length(unique(Biogeographic_database_Ponerinae_NA_coords_flags$flag_type[]))
nb_matching_shp <- length(unique(Biogeographic_database_Ponerinae_NA_coords_flags$matching_shp[]))

# Define palette function
pal <- mapviewPalette("mapviewSpectralColors")

# RColorBrewer::display.brewer.all()

# pal <- brewer.pal(n = nb_taxa, name = "Spectral")
pal_flags <- brewer.pal(n = nb_flags, name = "Spectral")
pal_matching_shp <- brewer.pal(n = nb_matching_shp, name = "Spectral")
# pal_4 <- pal[c(1, 4, 5, 6)]
# pal_2 <- pal[c(5, 6)]

plot(Biogeographic_database_Ponerinae_NA_coords_flags[, ]["flag_type"])

### With color per flag types (2 flag types)
interactive_map_flags <- mapview::mapview(x = Biogeographic_database_Ponerinae_NA_coords_flags[Biogeographic_database_Ponerinae_NA_coords_flags$flag_type != "OK", ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                          zcol = "flag_type",
                                          cex = 5,
                                          burst = T, legend = T,
                                          col.regions = pal_flags, # Color to use to plot spatial units in the spatial object
                                          # col.regions = pal_2, # Color to use to plot spatial units in the spatial object
                                          layer.name = "Occurrences", # To specify the legend name of this layer
                                          # map.types = mapviewGetOption("basemaps")
                                          map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                          # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                          # ... # and many more, depending of the class of the spatial object
)

interactive_map_flags


### With color per matching levels (6 matching levels)
interactive_map_matching_levels <- mapview::mapview(x = Biogeographic_database_Ponerinae_NA_coords_flags[Biogeographic_database_Ponerinae_NA_coords_flags$flag_type != "OK", ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                          zcol = "matching_shp",
                                          cex = 5,
                                          burst = T, legend = T,
                                          col.regions = pal_matching_shp, # Color to use to plot spatial units in the spatial object
                                          # col.regions = pal_2, # Color to use to plot spatial units in the spatial object
                                          layer.name = "Occurrences", # To specify the legend name of this layer
                                          # map.types = mapviewGetOption("basemaps")
                                          map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                          # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                          # ... # and many more, depending of the class of the spatial object
)

interactive_map_matching_levels


### 3.5.3/ Manually adjust occurrences falling in seas/oceans ####

# Tokelau, adjusting Longitude towards E
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00761219", replace = F)] <- -171.184

# Clipperton Island, adjusting Longitude towards W
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00419641", replace = F)] <- -109.232

# Christmas Island, adjusting towards SW
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00419755", replace = F)] <- 105.686
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00419755", replace = F)] <- -10.450
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00756976", replace = F)] <- 105.626
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00756976", replace = F)] <- -10.482

# Yaeyama Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00618780", replace = F)] <- 24.055
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00878895", replace = F)] <- 24.233
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00370786", replace = F)] <- 24.243
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00370786", replace = F)] <- 124.0212

# Toshima Island, Izu Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00876563", replace = F)] <- 34.52001245
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00451303", replace = F)] <- 34.52511473
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00876846", replace = F)] <- 34.51973486
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00349130", replace = F)] <- 34.52636874
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988676", replace = F)] <- 34.524
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988676", replace = F)] <- 139.275
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988698", replace = F)] <- 34.520
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988698", replace = F)] <- 139.281
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988700", replace = F)] <- 34.518
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988700", replace = F)] <- 139.287

# Kōzushima, Izu Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00876803", replace = F)] <- 34.194
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988688", replace = F)] <- 34.227
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00876857", replace = F)] <- 34.212
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988685", replace = F)] <- 34.2107

# Hachijoko Island, Izu Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00349250", replace = F)] <- 33.123

# Aogashima, Izu Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00365707", replace = F)] <- 32.457
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00365707", replace = F)] <- 139.768

# Torishima Island, Izu Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988694", replace = F)] <- 30.483
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988686", replace = F)] <- 30.482
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988686", replace = F)] <- 140.310

# Nishinoshima Island, Ogasawara Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348195", replace = F)] <- 27.248
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348195", replace = F)] <- 140.875

# Muko Island, Ogasawara Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348158", replace = F)] <- 27.685

# Nakodojima Island, Ogasawara Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00497313", replace = F)] <- 27.628
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00497313", replace = F)] <- 142.178
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00878467", replace = F)] <- 27.626
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00877245", replace = F)] <- 27.6302
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348107", replace = F)] <- 27.629
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348107", replace = F)] <- 142.182
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00347016", replace = F)] <- 27.6226
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00347016", replace = F)] <- 142.185

# Mejima Island, Ogasawara Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348145", replace = F)] <- 26.567

# Minamitori-shima, Ogasawara Islands, Japan
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348119", replace = F)] <- 24.2905
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348119", replace = F)] <- 153.9829
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988973", replace = F)] <- 24.2872
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00988973", replace = F)] <- 153.9811
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348128", replace = F)] <- 24.2831
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$GABI_accession_ID == "GABI_00348128", replace = F)] <- 153.9844

## Rerun the flagging to check if the correction worked

# Save database of NA coordinates
saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "DZA", ])
# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "DZA", ])
# 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName %in% c("East District", "North District", "West District", "South District"), "adm2_shapeName"])
# 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Marovo", "adm2_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Sikkim", "adm1_shapeName"])


### 3.6/ Record new polygons and associated uncertainty ####

# Load database of NA coordinates
# Biogeographic_database_Ponerinae_NA_coords <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

### 3.6.1/ Build shp files with all intersecting shp levels, including non-intersecting shp ####

# Use this instead of previous intersecting shp files because it preserve polygons that are not intersecting on all levels
# Will provide an NA if the level does not intersect

sf_use_s2(FALSE)

# Project CRS to help intersection computation Use Robinson projection (ESRI:54030)? Winkel Tripel projection (ESRI:53042)? 
geoBoundaries_adm2_sf_Robinson <- st_transform(x = geoBoundaries_adm2_sf[, c("adm2_shapeName")], crs = st_crs("ESRI:54030"))
geoBoundaries_adm1_sf_Robinson <- st_transform(x = geoBoundaries_adm1_sf[, c("adm1_shapeName")], crs = st_crs("ESRI:54030"))
NE_adm1_sf_Robinson <- st_transform(x = NE_adm1_sf[, c("name")], crs = st_crs("ESRI:54030"))
Bentity2_sf_Robinson <- st_transform(x = Bentity2_sf[, c("BENTITY2_N")], crs = st_crs("ESRI:54030"))
NE_subunits_sf_Robinson <- st_transform(x = NE_subunits_sf[, c("SUBUNIT")], crs = st_crs("ESRI:54030"))
NE_Countries_sf_Robinson <- st_transform(x = NE_Countries_sf[, c("ADMIN")], crs = st_crs("ESRI:54030"))

# plot(Intersect_all_shp_GB_adm2_levels["adm2_shapeName"])

# Snap to grid of 500 m to avoid issue with intersecting nodes, but only work if data is projected... 
geoBoundaries_adm2_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(geoBoundaries_adm2_sf_Robinson, 500))
geoBoundaries_adm1_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(geoBoundaries_adm1_sf_Robinson, 500))
NE_adm1_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(NE_adm1_sf_Robinson, 500))
Bentity2_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(Bentity2_sf_Robinson, 500))
NE_subunits_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(NE_subunits_sf_Robinson, 500))
NE_Countries_sf_Robinson_grid500 <- st_make_valid(lwgeom::st_snap_to_grid(NE_Countries_sf_Robinson, 500))

# Add zero buffer may solve issues...
geoBoundaries_adm2_sf_Robinson_grid500 <- st_buffer(geoBoundaries_adm2_sf_Robinson_grid500, 0)
geoBoundaries_adm1_sf_Robinson_grid500 <- st_buffer(geoBoundaries_adm1_sf_Robinson_grid500, 0)
NE_adm1_sf_Robinson_grid500 <- st_buffer(NE_adm1_sf_Robinson_grid500, 0)
Bentity2_sf_Robinson_grid500 <- st_buffer(Bentity2_sf_Robinson_grid500, 0)
NE_subunits_sf_Robinson_grid500 <- st_buffer(NE_subunits_sf_Robinson_grid500, 0)
NE_Countries_sf_Robinson_grid500 <- st_buffer(NE_Countries_sf_Robinson_grid500, 0)

# Get intersection between GB_adm2 and GB_adm1
Intersect_all_shp_all_levels <- st_buffer(st_make_valid(st_intersection(geoBoundaries_adm2_sf_Robinson_grid500, geoBoundaries_adm1_sf_Robinson_grid500)), 0)
# Get differences to record non-intersecting polygons in GB_adm2
Intersect_all_shp_all_levels_GB_adm2_diff <- st_buffer(st_make_valid(st_difference(geoBoundaries_adm2_sf_Robinson_grid500, st_union(st_geometry(Intersect_all_shp_all_levels)))), 0)
# Get differences to record non-intersecting polygons in GB_adm1
Intersect_all_shp_all_levels_GB_adm1_diff <- st_buffer(st_make_valid(st_difference(geoBoundaries_adm1_sf_Robinson_grid500, st_union(st_geometry(Intersect_all_shp_all_levels)))), 0)
# Bind all polygons (intersecting and non-intersecting)
Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, Intersect_all_shp_all_levels_GB_adm2_diff, Intersect_all_shp_all_levels_GB_adm1_diff)

# plot(Intersect_all_shp_all_levels_GB_adm2_diff[, "adm2_shapeName"])
# plot(Intersect_all_shp_all_levels_GB_adm1_diff[, "adm1_shapeName"])
# plot(Intersect_all_shp_all_levels[, "area"])

# Save Intersecting files for all levels, including non-intersecting polygons
saveRDS(object = Intersect_all_shp_all_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")
saveRDS(object = Intersect_all_shp_all_levels_GB_adm2_diff, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels_GB_adm2_diff.rds")
saveRDS(object = Intersect_all_shp_all_levels_GB_adm1_diff, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels_GB_adm1_diff.rds")


# Get intersection between GB_amd2/GB_adm1 and NE_adm1
Intersect_all_shp_all_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_all_levels, NE_adm1_sf_Robinson_grid500)), 0)
# Get differences to record non-intersecting polygons in NE_adm1
Intersect_all_shp_all_levels_NE_adm1_diff <- st_buffer(st_make_valid(st_difference(NE_adm1_sf_Robinson_grid500, st_union(st_geometry(Intersect_all_shp_all_levels)))), 0)
# Bind all polygons (intersecting and non-intersecting)
Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, Intersect_all_shp_all_levels_NE_adm1_diff)

# plot(Intersect_all_shp_all_levels_NE_adm1_diff[, "name"])
# plot(Intersect_all_shp_all_levels[, "area"])

# Save Intersecting files for all levels, including non-intersecting polygons
saveRDS(object = Intersect_all_shp_all_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")
saveRDS(object = Intersect_all_shp_all_levels_NE_adm1_diff, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels_NE_adm1_diff.rds")


# Get intersection between GB_amd2/GB_adm1/NE_adm1 and Bentity2
Intersect_all_shp_all_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_all_levels, Bentity2_sf_Robinson_grid500)), 0)
# Get differences to record non-intersecting polygons in Bentity2
Intersect_all_shp_all_levels_Bentity2_diff <- st_buffer(st_make_valid(st_difference(Bentity2_sf_Robinson_grid500, st_union(st_geometry(Intersect_all_shp_all_levels)))), 0)
# Bind all polygons (intersecting and non-intersecting)
Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, Intersect_all_shp_all_levels_Bentity2_diff)

# plot(Intersect_all_shp_all_levels_Bentity2_diff[, "BENTITY2_N"])
# plot(Intersect_all_shp_all_levels[, "area"])

# Save Intersecting files for all levels, including non-intersecting polygons
saveRDS(object = Intersect_all_shp_all_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")
saveRDS(object = Intersect_all_shp_all_levels_Bentity2_diff, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels_Bentity2_diff.rds")


# Get intersection between GB_amd2/GB_adm1/NE_adm1/Bentity2 and NE_Subunits
Intersect_all_shp_all_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_all_levels, NE_subunits_sf_Robinson_grid500)), 0)
# Get differences to record non-intersecting polygons in NE_subunits
Union_before_Subunits <- st_buffer(st_make_valid(st_union(st_geometry(Intersect_all_shp_all_levels))), 0)
Intersect_all_shp_all_levels_NE_subunits_diff <- st_buffer(st_make_valid(st_difference(NE_subunits_sf_Robinson_grid500, Union_before_Subunits)), 0)
# Bind all polygons (intersecting and non-intersecting)
Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, Intersect_all_shp_all_levels_NE_subunits_diff)

# plot(Union_before_Subunits[, "adm2_shapeName"])
# plot(Intersect_all_shp_all_levels_NE_subunits_diff[, "SUBUNIT"])
# plot(Intersect_all_shp_all_levels[, "area"])

# Save Intersecting files for all levels, including non-intersecting polygons
saveRDS(object = Intersect_all_shp_all_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")
saveRDS(object = Intersect_all_shp_all_levels_NE_subunits_diff, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels_NE_subunits_diff.rds")


# Get intersection between GB_amd2/GB_adm1/NE_adm1/Bentity2/NE_Subunits and NE_Countries
Intersect_all_shp_all_levels <- st_buffer(st_make_valid(st_intersection(Intersect_all_shp_all_levels, NE_Countries_sf_Robinson_grid500)), 0)
# Get differences to record non-intersecting polygons in NE_Countries
Intersect_all_shp_all_levels_NE_Countries_diff <- st_buffer(st_make_valid(st_difference(NE_Countries_sf_Robinson_grid500, st_union(st_geometry(Intersect_all_shp_all_levels)))), 0)
# Bind all polygons (intersecting and non-intersecting)
Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, Intersect_all_shp_all_levels_NE_Countries_diff)

# plot(Intersect_all_shp_all_levels_NE_Countries_diff[, "ADMIN"])
# plot(Intersect_all_shp_all_levels[, "adm2_shapeName"])

# Save Intersecting files for all levels, including non-intersecting polygons
saveRDS(object = Intersect_all_shp_all_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")
saveRDS(object = Intersect_all_shp_all_levels_NE_Countries_diff, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels_NE_Countries_diff.rds")

## Compute areas
Intersect_all_shp_all_levels$area <- st_area(Intersect_all_shp_all_levels)
Intersect_all_shp_all_levels$area <- set_units(Intersect_all_shp_all_levels$area, km^2)

hist(Intersect_all_shp_all_levels$area)

## Transform back to WGS84
Intersect_all_shp_all_levels <- st_transform(x = Intersect_all_shp_all_levels, crs = st_crs(geoBoundaries_adm2_sf))

## Repair manually invalid shapes that cross the antimeridian
Intersect_all_shp_all_levels_validity_test <- st_is_valid(Intersect_all_shp_all_levels)
table(Intersect_all_shp_all_levels_validity_test) # 3827 shapes to repair
table(is.na(Intersect_all_shp_all_levels_validity_test)) # 4 shapes that cannot be repaired and need to be manually curated
which(is.na(Intersect_all_shp_all_levels_validity_test))

plot(st_geometry(Intersect_all_shp_all_levels)[[82960]])
# Shape 82960 has a sub-polygon with only 1 point. Needs to be removed manually
sapply(st_geometry(Intersect_all_shp_all_levels)[[82960]], function(x) nrow(x[[1]]))
error_ID <- which(sapply(st_geometry(Intersect_all_shp_all_levels)[[82960]], function(x) nrow(x[[1]])) < 2)
geom_temp <- st_geometry(Intersect_all_shp_all_levels)
geom_temp[[82960]][error_ID] <- NULL
st_geometry(Intersect_all_shp_all_levels) = geom_temp
plot(st_geometry(Intersect_all_shp_all_levels)[[82960]])

plot(st_geometry(Intersect_all_shp_all_levels)[[83171]])
# Shape 83171 has a sub-polygon LinearRing with less than 4 points. Needs to be removed manually
sapply(st_geometry(Intersect_all_shp_all_levels)[[83171]], function(x) nrow(x[[1]]))
error_ID <- which(sapply(st_geometry(Intersect_all_shp_all_levels)[[83171]], function(x) nrow(x[[1]])) < 4)
geom_temp <- st_geometry(Intersect_all_shp_all_levels)
geom_temp[[83171]][error_ID] <- NULL
st_geometry(Intersect_all_shp_all_levels) = geom_temp
plot(st_geometry(Intersect_all_shp_all_levels)[[83171]])

plot(st_geometry(Intersect_all_shp_all_levels)[[251632]])
# Shape 251632 has a sub-polygon LinearRing with less than 4 points. Needs to be removed manually
sapply(st_geometry(Intersect_all_shp_all_levels)[[251632]], function(x) nrow(x[[1]]))
error_ID <- which(sapply(st_geometry(Intersect_all_shp_all_levels)[[251632]], function(x) nrow(x[[1]])) < 4)
geom_temp <- st_geometry(Intersect_all_shp_all_levels)
geom_temp[[251632]][error_ID] <- NULL
st_geometry(Intersect_all_shp_all_levels) = geom_temp
plot(st_geometry(Intersect_all_shp_all_levels)[[251632]])

plot(st_geometry(Intersect_all_shp_all_levels)[[262960]])
# Shape 262960 has a sub-polygon with only 1 point. Needs to be removed manually
sapply(st_geometry(Intersect_all_shp_all_levels)[[262960]], function(x) nrow(x[[1]]))[error_ID]
error_ID <- which(sapply(st_geometry(Intersect_all_shp_all_levels)[[262960]], function(x) nrow(x[[1]])) == 1)
geom_temp <- st_geometry(Intersect_all_shp_all_levels)
geom_temp[[262960]][error_ID] <- NULL
st_geometry(Intersect_all_shp_all_levels) = geom_temp
plot(st_geometry(Intersect_all_shp_all_levels)[[262960]])

## Repair automatically other shapes
Intersect_all_shp_all_levels <- st_buffer(st_make_valid(Intersect_all_shp_all_levels), 0)
Intersect_all_shp_all_levels <- st_make_valid(Intersect_all_shp_all_levels) # To run until no more invalid shapes remain
table(st_is_valid(Intersect_all_shp_all_levels))

## Remove empty polygons
Intersect_all_shp_all_levels <- Intersect_all_shp_all_levels[!st_is_empty(Intersect_all_shp_all_levels), , drop = FALSE]

## Add shape ID
Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

plot(Intersect_all_shp_all_levels["Intersect_shp_ID"])

# Save Intersecting files for all levels, including non-intersecting polygons
saveRDS(object = Intersect_all_shp_all_levels, file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")

sf_use_s2(TRUE)


### 3.6.2/ Loop per entry (old slow version) ####

# # Load Intersecting files for all levels, including non-intersecting polygons
# Intersect_all_shp_all_levels <- readRDS(file = "./input_data/Biogeographic_data/Intersect_all_shp_all_levels.rds")
# 
# Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2 <- FALSE
# Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1 <- FALSE
# Biogeographic_database_Ponerinae_NA_coords$Interpolated_Bentity2 <- FALSE
# Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2 <- 100
# Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1 <- 100
# 
# entries_with_no_matching_shp <- c()
# 
# sf_use_s2(FALSE)
# # for (i in 1:nrow(Biogeographic_database_Ponerinae_NA_coords))
# for (i in 7347:nrow(Biogeographic_database_Ponerinae_NA_coords))
# # for (i in entries_with_no_matching_shp)
# { 
#   # i <- 2505
#   # i <- 7347
#   
#   ## Extract matching level and shp ID
#   matching_lvl <- Biogeographic_database_Ponerinae_NA_coords$matching_shp[i]
#   matching_shp_ID <- Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[i]
#   matching_shp_index <- which(matching_lvl == matching_level_list)
#   
#   ## Extract shape with all levels where coordinates are falling
#   new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], Intersect_all_shp_all_levels)))
#   
#   # If extraction through intersection failed, look for closest shape
#   if (nrow(new_shp_all_levels) == 0)
#   {
#     new_shp_all_levels_ID <- suppressMessages(suppressWarnings(sf::st_nearest_feature(Biogeographic_database_Ponerinae_NA_coords[i, ], Intersect_all_shp_all_levels)))
#     new_shp_all_levels <- Intersect_all_shp_all_levels[new_shp_all_levels_ID, ]
#   }
# 
#   # print(new_shp_all_levels)
#   
#   ## Test if shape retrieved has the same name as the one used to draw the coordinates
#   initial_shp_names <- Biogeographic_database_Ponerinae_NA_coords[i, c("adm2", "adm1", "adm1", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name")]
#   new_shp_names <- new_shp_all_levels[1, c("adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N", "SUBUNIT",  "ADMIN")]
#   initial_shp_name <- st_drop_geometry(initial_shp_names)[1, matching_shp_index]
#   new_shp_name <- st_drop_geometry(new_shp_names)[1, matching_shp_index]
#   match_test <- replace_na(data = initial_shp_name == new_shp_name, replace = FALSE)
#     
#   ## Skip an entry of no matching shp if found 
#   if ((nrow(new_shp_all_levels) == 0))
#   {
#     # Record ID of entry with an error
#     entries_with_no_matching_shp <- c(entries_with_no_matching_shp, i)
#     
#     cat(paste0("ERROR: Entry n°", i, " has no match\n"))
#   
#   } else { # If there is a match, proceed to extract shp names
#     
#     if (!match_test) # If matching level do not match, throw a warning message, but still proceed
#     {
#       cat(paste0("WARNING: Entry n°", i, " has an error in matching shp names. Initial ",matching_lvl," = ",initial_shp_name,". New ",matching_lvl," = ",new_shp_name,"\n"))
#     }
#     
#     ## Extract shape used to draw coordinates
#     if (!Biogeographic_database_Ponerinae_NA_coords$multiple_matches[i]) # Case with a single match from initial shp file
#     {
#       focal_occ_sf_file <- all_sf_files[[matching_shp_index]]
#     } else { # Case with multiple matches so shape from intersecting shp file
#       focal_occ_sf_file <- all_intersecting_sf_files[[matching_shp_index]]
#     }
#     focal_occ_shp <- focal_occ_sf_file[matching_shp_ID, ]
#     
#     # plot(focal_occ_shp[, "area"])
#     
#     ## Record names for all levels others than the one used for matching
#     # Also record adm1/adm2 uncertainty based on area overlap with the polygon used to draw random coordinates
#     if (matching_lvl %in% c("GB_adm2"))
#     { 
#       # Record adm1
#       Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- st_drop_geometry(new_shp_all_levels[, "adm1_shapeName"])[1,1]
#       # Record Bentity2
#       Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- st_drop_geometry(new_shp_all_levels[, "BENTITY2_N"])[1,1]
#       # Record SUBUNIT
#       Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- st_drop_geometry(new_shp_all_levels[, "SUBUNIT"])[1,1]
#       # Record Country Admin
#       Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- st_drop_geometry(new_shp_all_levels[, "ADMIN"])[1,1]
#       
#       # Uncertainty is null because adm2 was retrieved by name
#       Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 0
#       # Uncertainty is null because adm1 was retrieved from adm2
#       Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 0
#     }
#     if (matching_lvl %in% c("GB_adm1"))
#     {
#       # Record adm2 if drawn from adm1
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- st_drop_geometry(new_shp_all_levels[, "adm2_shapeName"])[1,1]
#       
#       # Record Bentity2
#       Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- st_drop_geometry(new_shp_all_levels[, "BENTITY2_N"])[1,1]
#       # Record SUBUNIT
#       Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- st_drop_geometry(new_shp_all_levels[, "SUBUNIT"])[1,1]
#       # Record Country Admin
#       Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- st_drop_geometry(new_shp_all_levels[, "ADMIN"])[1,1]
#       
#       # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_SUBUNIT area used to draw the random coordinates
#       all_sf_files[[1]]$GB_adm2_shp_ID <- 1:nrow(all_sf_files[[1]]) # Add shp ID
#       GB_adm2_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[1]])))[, "GB_adm2_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm2_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
#         GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
#         GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
#         GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#       
#       # adm1 Uncertainty is null because adm1 was retrieved by name
#       Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 0
#     }
#     if (matching_lvl %in% c("NE_adm1"))
#     {
#       # Record adm2 and GB adm1 if drawn from NE adm1
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- st_drop_geometry(new_shp_all_levels[, "adm2_shapeName"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- st_drop_geometry(new_shp_all_levels[, "adm1_shapeName"])[1,1]
#       
#       # Record Bentity2
#       Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- st_drop_geometry(new_shp_all_levels[, "BENTITY2_N"])[1,1]
#       # Record SUBUNIT
#       Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- st_drop_geometry(new_shp_all_levels[, "SUBUNIT"])[1,1]
#       # Record Country Admin
#       Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- st_drop_geometry(new_shp_all_levels[, "ADMIN"])[1,1]
#       
#       # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_SUBUNIT area used to draw the random coordinates
#       all_sf_files[[1]]$GB_adm2_shp_ID <- 1:nrow(all_sf_files[[1]]) # Add shp ID
#       GB_adm2_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[1]])))[, "GB_adm2_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm2_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
#         GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
#         GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
#         GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#       
#       # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the Bentity2 area used to draw the random coordinates
#       all_sf_files[[2]]$GB_adm1_shp_ID <- 1:nrow(all_sf_files[[2]]) # Add shp ID
#       GB_adm1_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[2]])))[, "GB_adm1_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm1_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
#         GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
#         GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
#         GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#     }
#     if (matching_lvl %in% c("Bentity2"))
#     {
#       # Record adm2 and adm1 if drawn from Bentity2
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- st_drop_geometry(new_shp_all_levels[, "adm2_shapeName"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- st_drop_geometry(new_shp_all_levels[, "adm1_shapeName"])[1,1]
#       
#       # Record SUBUNIT
#       Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- st_drop_geometry(new_shp_all_levels["SUBUNIT"])[1,1]
#       # Record Country Admin
#       Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- st_drop_geometry(new_shp_all_levels["ADMIN"])[1,1]
#       
#       # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_SUBUNIT area used to draw the random coordinates
#       all_sf_files[[1]]$GB_adm2_shp_ID <- 1:nrow(all_sf_files[[1]]) # Add shp ID
#       GB_adm2_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[1]])))[, "GB_adm2_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm2_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
#         GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
#         GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
#         GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#       
#       # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the Bentity2 area used to draw the random coordinates
#       all_sf_files[[2]]$GB_adm1_shp_ID <- 1:nrow(all_sf_files[[2]]) # Add shp ID
#       GB_adm1_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[2]])))[, "GB_adm1_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm1_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
#         GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
#         GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
#         GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#     }
#     if (matching_lvl %in% c("NE_SUBUNIT"))
#     {
#       # Record adm2, adm1 and Bentity2 if drawn from SUBUNIT
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_Bentity2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- st_drop_geometry(new_shp_all_levels[, "adm2_shapeName"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- st_drop_geometry(new_shp_all_levels[, "adm1_shapeName"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- st_drop_geometry(new_shp_all_levels["BENTITY2_N"])[1,1]
#       
#       # Record Country Admin
#       Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- st_drop_geometry(new_shp_all_levels[, "ADMIN"])[1,1]
#       
#       # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_SUBUNIT area used to draw the random coordinates
#       all_sf_files[[1]]$GB_adm2_shp_ID <- 1:nrow(all_sf_files[[1]]) # Add shp ID
#       GB_adm2_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[1]])))[, "GB_adm2_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm2_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
#         GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
#         GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
#         GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#       
#       # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the Bentity2 area used to draw the random coordinates
#       all_sf_files[[2]]$GB_adm1_shp_ID <- 1:nrow(all_sf_files[[2]]) # Add shp ID
#       GB_adm1_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[2]])))[, "GB_adm1_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm1_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
#         GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
#         GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
#         GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#     }
#     if (matching_lvl %in% c("NE_ADMIN"))
#     {
#       # Record adm2, adm1, Bentity2, and SUBUNIT if drawn from Country ADMIN
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$Interpolated_Bentity2[i] <- TRUE
#       Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- st_drop_geometry(new_shp_all_levels[, "adm2_shapeName"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- st_drop_geometry(new_shp_all_levels[, "adm1_shapeName"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- st_drop_geometry(new_shp_all_levels[, "BENTITY2_N"])[1,1]
#       Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- st_drop_geometry(new_shp_all_levels[, "SUBUNIT"])[1,1]
#       
#       # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_SUBUNIT area used to draw the random coordinates
#       all_sf_files[[1]]$GB_adm2_shp_ID <- 1:nrow(all_sf_files[[1]]) # Add shp ID
#       GB_adm2_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[1]])))[, "GB_adm2_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm2_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
#         GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
#         GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
#         GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#       
#       # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the Bentity2 area used to draw the random coordinates
#       all_sf_files[[2]]$GB_adm1_shp_ID <- 1:nrow(all_sf_files[[2]]) # Add shp ID
#       GB_adm1_shp_ID <- st_drop_geometry(suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[2]])))[, "GB_adm1_shp_ID"])[1,1] # Extract ID of the shape where the occurrence falls
#       # If intersection failed, record an uncertainty of 100%
#       if (is.na(GB_adm1_shp_ID)) 
#       {
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
#       } else { # Else compute uncertainty as the ratio of areas
#         GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
#         GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
#         GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
#         GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
#         GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
#         Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
#       }
#     }
#   }
# 
#   # Print progress
#   if ( i %% 100 == 0) { cat(paste0(Sys.time(), " - Occurrence n°",i, " / ", nrow(Biogeographic_database_Ponerinae_NA_coords),"\n")) }
# }
# sf_use_s2(TRUE)
# 
# ## Save database of NA coordinates
# # saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

### 3.6.2/ Loop per entry (new batch version) ####

# MORE EFFICIENT WAY: Using batch to match intersection shapes from all initial files 

### 3.6.2.1/ Add shape_ID to sf files ####

NE_Countries_sf$NE_Country_sf_ID <- 1:nrow(NE_Countries_sf)
NE_subunits_sf$NE_SUBUNIT_sf_ID <- 1:nrow(NE_subunits_sf)
Bentity2_sf$Bentity2_sf_ID <- 1:nrow(Bentity2_sf)
NE_adm1_sf$NE_adm1_sf_ID <- 1:nrow(NE_adm1_sf)
geoBoundaries_adm1_sf$GB_adm1_sf_ID <- 1:nrow(geoBoundaries_adm1_sf)
geoBoundaries_adm2_sf$GB_adm2_sf_ID <- 1:nrow(geoBoundaries_adm2_sf)

Biogeographic_database_Ponerinae_NA_coords$Occurrence_ID_NA_coords <- 1:nrow(Biogeographic_database_Ponerinae_NA_coords)

### 3.6.2.2/ Find intersecting shp from initial files by batch ####

# Step needed to limit the number of run of st_intersection which would be too big to run as a loop per entries

out <- data.frame() # Store output
batch_size <- 1000   # Number of entries per batch
nb_batches <- (nrow(Biogeographic_database_Ponerinae_NA_coords) %/% batch_size) + is.numeric((nrow(Biogeographic_database_Ponerinae_NA_coords) %% batch_size) > 0)
seq_i <- seq(from = 1, to = batch_size * nb_batches + 1, by = batch_size)

sf_use_s2(FALSE)
for (i in seq_i)
{
  # i <- 1
  
  # Get indices of batch entries
  batch_i <- seq(from = i, by = 1, length.out = batch_size)
  
  # Adjust indices for the last batch
  if (max(batch_i) > nrow(Biogeographic_database_Ponerinae_NA_coords)) { batch_i <- min(batch_i):nrow(Biogeographic_database_Ponerinae_NA_coords) }
  
  # Find intersecting polygons for Countries/SUBUNIT/Bentity2/adm1/adm2/
  out_batch_Countries <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[batch_i, ], NE_Countries_sf[, c("ADMIN", "NE_Country_sf_ID")])))
  out_batch_SUBUNIT <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[batch_i, ], NE_subunits_sf[, c("SUBUNIT", "NE_SUBUNIT_sf_ID")])))
  out_batch_bentity2 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[batch_i, ], Bentity2_sf[, c("BENTITY2_N", "Bentity2_sf_ID")])))
  out_batch_NE_adm1 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[batch_i, ], NE_adm1_sf[, c("name", "NE_adm1_sf_ID")])))
  out_batch_GB_adm1 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[batch_i, ], geoBoundaries_adm1_sf[, c("adm1_shapeName", "GB_adm1_sf_ID")])))
  out_batch_GB_adm2 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_NA_coords[batch_i, ], geoBoundaries_adm2_sf[, c("adm2_shapeName", "GB_adm2_sf_ID")])))
  
  # Keep only the first match per occurrence
  out_batch_Countries <- out_batch_Countries %>% 
    arrange(Occurrence_ID_NA_coords) %>% 
    group_by(Occurrence_ID_NA_coords) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID_NA_coords)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_SUBUNIT <- out_batch_SUBUNIT %>% 
    arrange(Occurrence_ID_NA_coords) %>% 
    group_by(Occurrence_ID_NA_coords) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID_NA_coords)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_bentity2 <- out_batch_bentity2 %>% 
    arrange(Occurrence_ID_NA_coords) %>% 
    group_by(Occurrence_ID_NA_coords) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID_NA_coords)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_NE_adm1 <- out_batch_NE_adm1 %>% 
    arrange(Occurrence_ID_NA_coords) %>% 
    group_by(Occurrence_ID_NA_coords) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID_NA_coords)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_GB_adm1 <- out_batch_GB_adm1 %>% 
    arrange(Occurrence_ID_NA_coords) %>% 
    group_by(Occurrence_ID_NA_coords) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID_NA_coords)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_GB_adm2 <- out_batch_GB_adm2 %>% 
    arrange(Occurrence_ID_NA_coords) %>% 
    group_by(Occurrence_ID_NA_coords) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID_NA_coords)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  
  # Join batch output for multiple levels, including entry for occurrences with no match (keeping track with ID)
  out_batch <- suppressMessages(left_join(x = st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords[batch_i, ]), y = st_drop_geometry(out_batch_Countries)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_SUBUNIT)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_bentity2)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_NE_adm1)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_GB_adm1)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_GB_adm2)))
  
  # Merge batch output with global output
  out <- rbind(out, out_batch)
  
  # Print progress
  cat(paste0(Sys.time(), " - Occurrence n°",max(batch_i), " / ", nrow(Biogeographic_database_Ponerinae_NA_coords),"\n"))
  
}
sf_use_s2(TRUE)

# Check that the final numbers of row are equal
nrow(out)
nrow(Biogeographic_database_Ponerinae_NA_coords)

View(out)

# If the output file seems valid, replace initial file
Biogeographic_database_Ponerinae_NA_coords <- out

## Convert back to sf
Biogeographic_database_Ponerinae_NA_coords$Latitude_copy <- Biogeographic_database_Ponerinae_NA_coords$Latitude_dec
Biogeographic_database_Ponerinae_NA_coords$Longitude_copy <- Biogeographic_database_Ponerinae_NA_coords$Longitude_dec
Biogeographic_database_Ponerinae_NA_coords <- st_as_sf(Biogeographic_database_Ponerinae_NA_coords, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_NA_coords) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
# Biogeographic_database_Ponerinae_NA_coords <- Biogeographic_database_Ponerinae_NA_coords %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_NA_coords

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

### 3.6.2.3/ Loop per entry to compute adm1/adm2/Bentity2 uncertainty and update shape names ####

Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2 <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1 <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_Bentity2 <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2 <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1 <- 100

Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp <- NA

# List all matching levels
matching_level_list <- c("GB_adm2", "GB_adm1", "NE_adm1", "Bentity2", "NE_SUBUNIT", "NE_ADMIN")

# List of initial files used to draw the random points
all_sf_files <- list(geoBoundaries_adm2_sf[, c("adm2_shapeName", "area")], 
                     geoBoundaries_adm1_sf[, c("adm1_shapeName", "area")], 
                     NE_adm1_sf[, c("name", "area")], 
                     Bentity2_sf[, c("BENTITY2_N", "area")], 
                     NE_subunits_sf[, c("SUBUNIT", "area")], 
                     NE_Countries_sf[, c("ADMIN", "area")])

# Initial vector to store entries with no match between the shape used for drawing the random point, and the shape where the point is found
# Need manual inspection


Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[Gibraltar_entries] <- 36.1364
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[Gibraltar_entries] <- -5.347
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[Gibraltar_entries] <- "Spain"
Biogeographic_database_Ponerinae_NA_coords$NE_SUBUNIT_sf_ID[Gibraltar_entries] <- 67
Biogeographic_database_Ponerinae_NA_coords$ADMIN[Gibraltar_entries] <- "Spain"
Biogeographic_database_Ponerinae_NA_coords$NE_Country_sf_ID[Gibraltar_entries] <- 154
Biogeographic_database_Ponerinae_NA_coords$GB_adm2_sf_ID[Gibraltar_entries] <- NA
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[Gibraltar_entries] <- NA
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[Gibraltar_entries] <- NA
Biogeographic_database_Ponerinae_NA_coords$GB_adm1_sf_ID[Gibraltar_entries] <- NA
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Gibraltar_entries] <- "NE_adm1"
Biogeographic_database_Ponerinae_NA_coords$name[Gibraltar_entries] <- "Gibraltar"
Biogeographic_database_Ponerinae_NA_coords$NE_adm1_sf_ID[Gibraltar_entries] <- 1234
Biogeographic_database_Ponerinae_NA_coords$adm1[Gibraltar_entries] <- NA

entries_with_no_matching_shp <- c()

sf_use_s2(FALSE)
for (i in 1:nrow(Biogeographic_database_Ponerinae_NA_coords))
# for (i in 50095:nrow(Biogeographic_database_Ponerinae_NA_coords))
# for (i in entries_with_no_matching_shp)
{
  # i <- 1
  # i <- 46891

  ## Extract matching level and shp ID
  matching_lvl <- Biogeographic_database_Ponerinae_NA_coords$matching_shp[i]
  matching_shp_ID <- Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[i]
  matching_shp_index <- which(matching_lvl == matching_level_list)

  ## Extract shp ID of all levels, and of target level used for drawing the random point
  All_intersecting_shp_ID <- st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords[i, c("GB_adm2_sf_ID", "GB_adm1_sf_ID", "NE_adm1_sf_ID", "Bentity2_sf_ID", "NE_SUBUNIT_sf_ID", "NE_Country_sf_ID")])
  new_shp_ID <- All_intersecting_shp_ID[, matching_shp_index ,drop = T]
  
  ## Extract intersecting shape from the level used to draw the random point
  new_shp_target_level <- all_sf_files[[matching_shp_index]][new_shp_ID, ]
  
  # If extraction through intersection failed, look for closest shape
  if (nrow(new_shp_target_level) != 1)
  {
    new_shp_ID <- suppressMessages(suppressWarnings(sf::st_nearest_feature(Biogeographic_database_Ponerinae_NA_coords[i, ], all_sf_files[[matching_shp_index]])))
    new_shp_target_level <- all_sf_files[[matching_shp_index]][new_shp_ID, ]
    
    cat(paste0("WARNING: Entry n°", i, " has no intersecting shp at matching level. Need to fetch the closest shape instead.\n"))
  }

  # plot(new_shp_target_level[, "area"])

  ## Test if shape retrieved has the same name as the one used to draw the coordinates
  initial_shp_names <- st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords[i, c("adm2", "adm1", "adm1", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name")])
  new_shp_names <- st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords[i, c("adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N", "SUBUNIT",  "ADMIN")])
  initial_shp_name <- initial_shp_names[1, matching_shp_index]
  new_shp_name <- new_shp_names[1, matching_shp_index]
  match_test <- replace_na(data = initial_shp_name == new_shp_name, replace = FALSE)

  # Record if the intersecting shape is the same as the one use to draw the coordinates
  Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp[i] <- match_test
  
  ## Skip an entry if no matching shp is found
  if ((nrow(new_shp_target_level) != 1))
  {
    # Record ID of entry with an error
    entries_with_no_matching_shp <- c(entries_with_no_matching_shp, i)

    cat(paste0("ERROR: Entry n°", i, " has no match\n"))

  } else { # If there is a match, proceed to extract shp names

    if (!match_test) # If matching level do not match, throw a warning message, but still proceed
    {
      cat(paste0("WARNING: Entry n°", i, " has an error in matching shp names. Initial ",matching_lvl," = ",initial_shp_name,". New ",matching_lvl," = ",new_shp_name,"\n"))
    }

    ## Extract shape used to draw coordinates
    if (!Biogeographic_database_Ponerinae_NA_coords$multiple_matches[i]) # Case with a single match from initial shp file
    {
      focal_occ_sf_file <- all_sf_files[[matching_shp_index]]
    } else { # Case with multiple matches so shape from intersecting shp file
      focal_occ_sf_file <- all_intersecting_sf_files[[matching_shp_index]]
    }
    focal_occ_shp <- focal_occ_sf_file[matching_shp_ID, ]

    # plot(focal_occ_shp[, "area"])

    ## Record names for all levels others than the one used for matching
    # Also record adm1/adm2 uncertainty based on area overlap with the polygon used to draw random coordinates
    if (matching_lvl %in% c("GB_adm2"))
    {
      # Record adm1
      Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- new_shp_names["adm1_shapeName"][1,1]
      # Record Bentity2
      Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- new_shp_names["BENTITY2_N"][1,1]
      # Record SUBUNIT
      Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- new_shp_names["SUBUNIT"][1,1]
      # Record Country Admin
      Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- new_shp_names["ADMIN"][1,1]

      # Uncertainty is null because adm2 was retrieved by name
      Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 0
      # Uncertainty is null because adm1 was retrieved from adm2
      Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 0
    }
    if (matching_lvl %in% c("GB_adm1"))
    {
      # Record adm2 if drawn from adm1
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- new_shp_names["adm2_shapeName"][1,1]

      # Record Bentity2
      Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- new_shp_names["BENTITY2_N"][1,1]
      # Record SUBUNIT
      Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- new_shp_names["SUBUNIT"][1,1]
      # Record Country Admin
      Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- new_shp_names["ADMIN"][1,1]

      # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the GB_adm1 area used to draw the random coordinates
      GB_adm2_shp_ID <- All_intersecting_shp_ID[ , "GB_adm2_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm2_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
        GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
        GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
        GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }

      # adm1 Uncertainty is null because adm1 was retrieved by name
      Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 0
    }
    if (matching_lvl %in% c("NE_adm1"))
    {
      # Record adm2 and GB adm1 if drawn from NE adm1
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- new_shp_names["adm2_shapeName"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- new_shp_names["adm1_shapeName"][1,1]

      # Record Bentity2
      Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- new_shp_names["BENTITY2_N"][1,1]
      # Record SUBUNIT
      Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- new_shp_names["SUBUNIT"][1,1]
      # Record Country Admin
      Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- new_shp_names["ADMIN"][1,1]

      # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_adm1 area used to draw the random coordinates
      GB_adm2_shp_ID <- All_intersecting_shp_ID[ , "GB_adm2_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm2_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
        GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
        GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
        GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }

      # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the NE_adm1 area used to draw the random coordinates
      GB_adm1_shp_ID <- All_intersecting_shp_ID[ , "GB_adm1_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm1_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
        GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
        GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
        GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }
    }
    if (matching_lvl %in% c("Bentity2"))
    {
      # Record adm2 and adm1 if drawn from Bentity2
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- new_shp_names["adm2_shapeName"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- new_shp_names["adm1_shapeName"][1,1]

      # Record SUBUNIT
      Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- new_shp_names["SUBUNIT"][1,1]
      # Record Country Admin
      Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- new_shp_names["ADMIN"][1,1]

      # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the Bentity2 area used to draw the random coordinates
      GB_adm2_shp_ID <- All_intersecting_shp_ID[ , "GB_adm2_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm2_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
        GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
        GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
        GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }

      # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the Bentity2 area used to draw the random coordinates
      GB_adm1_shp_ID <- All_intersecting_shp_ID[ , "GB_adm1_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm1_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
        GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
        GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
        GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }
    }
    if (matching_lvl %in% c("NE_SUBUNIT"))
    {
      # Record adm2, adm1 and Bentity2 if drawn from SUBUNIT
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_Bentity2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- new_shp_names["adm2_shapeName"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- new_shp_names["adm1_shapeName"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- new_shp_names["BENTITY2_N"][1,1]

      # Record Country Admin
      Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[i] <- new_shp_names["ADMIN"][1,1]

      # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_SUBUNIT area used to draw the random coordinates
      GB_adm2_shp_ID <- All_intersecting_shp_ID[ , "GB_adm2_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm2_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
        GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
        GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
        GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }

      # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the NE_SUBUNIT area used to draw the random coordinates
      GB_adm1_shp_ID <- All_intersecting_shp_ID[ , "GB_adm1_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm1_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
        GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
        GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
        GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }
    }
    if (matching_lvl %in% c("NE_ADMIN"))
    {
      # Record adm2, adm1, Bentity2, and SUBUNIT if drawn from Country ADMIN
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$Interpolated_Bentity2[i] <- TRUE
      Biogeographic_database_Ponerinae_NA_coords$adm2[i] <- new_shp_names["adm2_shapeName"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$adm1[i] <- new_shp_names["adm1_shapeName"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$bentity2_name[i] <- new_shp_names["BENTITY2_N"][1,1]
      Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[i] <- new_shp_names["SUBUNIT"][1,1]

      # adm2 Uncertainty is 100% - the percentage of area covered by GB_adm2 within the NE_ADMIN area used to draw the random coordinates
      GB_adm2_shp_ID <- All_intersecting_shp_ID[ , "GB_adm2_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm2_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm2_shp <- all_sf_files[[1]][GB_adm2_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm2_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm2_shp, focal_occ_shp))) # Build the intersection shp between adm2 shp and adm1 shape used to draw the occurrence
        GB_adm2_intersection_shp$area <- st_area(GB_adm2_intersection_shp) # Compute area of intersecting shape
        GB_adm2_intersection_shp$area <- set_units(GB_adm2_intersection_shp$area, km^2) # Convert to km2
        GB_adm2_overlap_perc <- as.numeric(GB_adm2_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[i] <- round(100 - GB_adm2_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }

      # adm1 Uncertainty is 100% - the percentage of area covered by GB_adm1 within the NE_ADMIN area used to draw the random coordinates
      GB_adm1_shp_ID <- All_intersecting_shp_ID[ , "GB_adm1_sf_ID"] # Extract ID of the shape where the occurrence falls
      # If intersection failed, record an uncertainty of 100%
      if (is.na(GB_adm1_shp_ID))
      {
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- 100
      } else { # Else compute uncertainty as the ratio of areas
        GB_adm1_shp <- all_sf_files[[2]][GB_adm1_shp_ID, ] # Extract the shape where the occurrence falls
        GB_adm1_intersection_shp <- suppressMessages(suppressWarnings(sf::st_intersection(GB_adm1_shp, focal_occ_shp))) # Build the intersection shp between GB_adm1 shp and NE_adm1 shape used to draw the occurrence
        GB_adm1_intersection_shp$area <- st_area(GB_adm1_intersection_shp) # Compute area of intersecting shape
        GB_adm1_intersection_shp$area <- set_units(GB_adm1_intersection_shp$area, km^2) # Convert to km2
        GB_adm1_overlap_perc <- as.numeric(GB_adm1_intersection_shp$area / focal_occ_shp$area * 100) # Compute % of area overlap
        Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[i] <- round(100 - GB_adm1_overlap_perc, 1) # Turn into % of area non-overlap = % uncertainty
      }
    }
  }

  # Print progress
  if ( i %% 100 == 0) { cat(paste0(Sys.time(), " - Occurrence n°",i, " / ", nrow(Biogeographic_database_Ponerinae_NA_coords),"\n")) }
}
sf_use_s2(TRUE)

## Save database of NA coordinates
# saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")


### 3.6.3/ Manual correction of entries with wrong matching due to border effects ####

## Check for entries with mismatch between shp used to draw the random point, and intersecting shp
table(Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp, Biogeographic_database_Ponerinae_NA_coords$matching_shp)

## Check for NE_SUBUNIT
View(Biogeographic_database_Ponerinae_NA_coords[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "NE_SUBUNIT", c("matching_shp", "Latitude_dec", "Longitude_dec", "SUBUNIT_name", "SUBUNIT", "Locality", "adm2", "adm1", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N",  "ADMIN")])

# Use all intersecting name as SUBUNIT_name
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "NE_SUBUNIT"] <- Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "NE_SUBUNIT"]

## Update Country_ISO3_name based on Country_ISO3_code when not in accordance with their code
# Also update ADMIN, SUBUNIT and SUBUNIT_name

Expected_Country_ISO3_name <- Countries_NE_sf$ADMIN[match(x = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code, table = Countries_NE_sf$ADM0_A3)]
Not_matching_ISO3_code <- replace_na(Expected_Country_ISO3_name != Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name, replace = F)
table(Not_matching_ISO3_code)

View(Biogeographic_database_Ponerinae_NA_coords[Not_matching_ISO3_code, c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "Country_initial", "ADMIN", "Country_ISO3_name", "Country_ISO3_code", "SUBUNIT_name", "SUBUNIT", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N")])

# All entries should be back to the proper match for Country_ISO3_name, and SUBUNIT
# Except:

# Country_ISO3_name = Jersey => Change Country_ISO3_code = JEY
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Not_matching_ISO3_code & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Jersey"] <- "JEY"
# Country_ISO3_name = Puerto Rico => Change Country_ISO3_code = PRI
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Not_matching_ISO3_code & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Puerto Rico"] <- "PRI"
# Country_ISO3_name = Clipperton Island => Change Country_ISO3_code = CLP # Not a SUBUNIT
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Not_matching_ISO3_code & Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Clipperton Island"] <- "CLP"

# Rerun expected names based on newly updated codes for the exceptions
Expected_Country_ISO3_name_rerun <- Countries_NE_sf$ADMIN[match(x = Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code, table = Countries_NE_sf$ADM0_A3)]

# Update all entries with the expected Country name
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Not_matching_ISO3_code] <- Expected_Country_ISO3_name_rerun[Not_matching_ISO3_code]
Biogeographic_database_Ponerinae_NA_coords$ADMIN[Not_matching_ISO3_code] <- Expected_Country_ISO3_name_rerun[Not_matching_ISO3_code]
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[Not_matching_ISO3_code] <- Expected_Country_ISO3_name_rerun[Not_matching_ISO3_code]
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Not_matching_ISO3_code] <- Expected_Country_ISO3_name_rerun[Not_matching_ISO3_code]

Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[replace_na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT == "Clipperton Island", F)] <- NA
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT == "Clipperton Island", F)] <- NA

## Ignore NE_adm1 as GB_adm1 as been updated
View(Biogeographic_database_Ponerinae_NA_coords[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "NE_adm1", c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "adm1", "adm1_shapeName", "adm2", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "adm2_shapeName", "name", "BENTITY2_N", "SUBUNIT_name", "SUBUNIT", "ADMIN")])

## Check for GB_adm1
View(Biogeographic_database_Ponerinae_NA_coords[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "GB_adm1", c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "adm1", "adm1_shapeName", "adm2", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "adm2_shapeName", "name", "BENTITY2_N", "SUBUNIT_name", "SUBUNIT", "ADMIN")])

# Use adm1 as it is correct for all mismatched entries
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "GB_adm1"] <- Biogeographic_database_Ponerinae_NA_coords$adm1[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "GB_adm1"]

## Check for GB_adm2
View(Biogeographic_database_Ponerinae_NA_coords[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "GB_adm2", c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "adm2", "adm2_shapeName", "adm1", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "adm1_shapeName", "name", "BENTITY2_N", "SUBUNIT_name", "SUBUNIT", "ADMIN")])

# Use adm2 as it is correct for all mismatched entries
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "GB_adm2"] <- Biogeographic_database_Ponerinae_NA_coords$adm2[!Biogeographic_database_Ponerinae_NA_coords$Drawing_shp_matches_intersecting_shp & Biogeographic_database_Ponerinae_NA_coords$matching_shp == "GB_adm2"]

## Have a special look at entries with intersecting shp = NA

## Use Country_code to update Country_name, ADMIN with NA
table(is.na(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name))
View(Biogeographic_database_Ponerinae_NA_coords[is.na(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name), c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "Country_initial", "ADMIN", "Country_ISO3_name", "Country_ISO3_code", "SUBUNIT_name", "SUBUNIT", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N")])

Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[is.na(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name)] <- Expected_Country_ISO3_name_rerun[is.na(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name)]
Biogeographic_database_Ponerinae_NA_coords$ADMIN[is.na(Biogeographic_database_Ponerinae_NA_coords$ADMIN)] <- Expected_Country_ISO3_name_rerun[is.na(Biogeographic_database_Ponerinae_NA_coords$ADMIN)]

## Update Christmas Island
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Indian Ocean Territories"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Indian Ocean Territories"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Christmas Island"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Christmas Island"
Biogeographic_database_Ponerinae_NA_coords$adm1[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Other Territories"
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Other Territories"
Biogeographic_database_Ponerinae_NA_coords$adm2[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Christmas Island"
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[Biogeographic_database_Ponerinae_NA_coords$Country_initial == "Christmas Island"] <- "Christmas Island"

## SUBUNIT with NA
table(is.na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name))
View(Biogeographic_database_Ponerinae_NA_coords[is.na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name), c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "Country_ISO3_name", "Country_ISO3_code", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N", "SUBUNIT_name", "SUBUNIT", "Country_initial", "ADMIN")])

# Use Country_ISO3_name if valid SUBUNIT
Expected_SUBUNIT <- Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[is.na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name)]
Expected_SUBUNIT_validity_test <- Expected_SUBUNIT %in% NE_subunits_sf$SUBUNIT 

# Adjust the non-valid ones
Expected_SUBUNIT[!Expected_SUBUNIT_validity_test]
Expected_SUBUNIT[Expected_SUBUNIT == "United States of America"] <- "United States"
Expected_SUBUNIT[Expected_SUBUNIT == "United Republic of Tanzania"] <- "Tanzania"
Expected_SUBUNIT[Expected_SUBUNIT == "Equatorial Guinea"] <- "Bioko"
Expected_SUBUNIT[Expected_SUBUNIT == "Trinidad and Tobago"] <- c("Tobago", "Trinidad", "Trinidad","Tobago", "Trinidad", "Trinidad", "Trinidad", "Trinidad", "Trinidad", "Trinidad", "Tobago", "Tobago", "Trinidad", "Tobago", "Tobago", "Trinidad", "Tobago", "Trinidad", "Tobago", "Trinidad")

Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name)] <- Expected_SUBUNIT
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[is.na(Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name)] <- Expected_SUBUNIT

## adm1 with NA
table(is.na(Biogeographic_database_Ponerinae_NA_coords$adm1))
View(Biogeographic_database_Ponerinae_NA_coords[is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "adm1_initial", "Country_ISO3_name", "Country_ISO3_code", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N", "SUBUNIT_name", "SUBUNIT", "Country_initial", "ADMIN")])

## May use adm1 initial if valid GB_adm1
Expected_adm1 <- Biogeographic_database_Ponerinae_NA_coords$adm1_initial[is.na(Biogeographic_database_Ponerinae_NA_coords$adm1)]
Expected_adm1_validity_test <- Expected_adm1 %in% geoBoundaries_adm1_sf$adm1_shapeName 
Expected_adm1[Expected_adm1_validity_test]

# Update case-by-case based on adm1_initial
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Rio de Janeiro" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Rio de Jeneiro"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Hainan" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Hainan Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Guangdong" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Guangzhou Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Zhejiang" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Zhejiang Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Fujian" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Fujian Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Guangxi" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Guangxi Zhuang Autonomous Region"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Shanghai" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Shanghai Municipality"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Narino" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Nariño"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Mohéli" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Moheli"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Comoros" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Moheli"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Guanacaste" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Provincia Guanacaste"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Puntarenas" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Provincia Puntarenas"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Pedernales Province" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Pedernales"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Napo Province" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Napo"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Guayas Province" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Guayas"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Bioko" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Bioko Sur"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Chuuk State" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Chuuk"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Karnataka" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Karnataka"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Maharashtra" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Maharashtra"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Tamil Nadu" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Tamil Nadu"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Gujarat" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Gujarat"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Veracruz" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Veracruz de Ignacio de la Llave"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Yucatan" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Yucatan"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Hwanghae-namdo" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "South Hwanghae"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Negros Oriental" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Central Visayas"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Davao Oriental" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Davao Region"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Azores" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Região Autónoma dos Açores"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Madeira" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Região Autónoma da Madeira"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name == "Solomon Islands" & Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Western Province" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Western"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Trat" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Trat Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Trat" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Trat Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Narathiwat" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Narathiwat Province"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1_initial == "Trang province" & is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), F)] <- "Trang Province"

## adm2 with NA
table(is.na(Biogeographic_database_Ponerinae_NA_coords$adm1))
View(Biogeographic_database_Ponerinae_NA_coords[is.na(Biogeographic_database_Ponerinae_NA_coords$adm1), c("matching_shp", "Latitude_dec", "Longitude_dec", "Locality", "adm2_initial", "Country_ISO3_name", "Country_ISO3_code", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName",  "name", "BENTITY2_N", "SUBUNIT_name", "SUBUNIT", "Country_initial", "ADMIN")])


# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "IRN", ])
# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "TZA", ])
# View(Intersect_all_shp_all_levels[Intersect_all_shp_all_levels$adm1_shapeName == "Valle del Cauca", "adm2_shapeName"])
#
# 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName %in% c("Tamazunchale", "San Martín Chalchicuautla"), "adm2_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% c("Tamazunchale", "San Martín Chalchicuautla"), "adm1_shapeName"])
# 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Shimanto", "adm2_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Kochi Prefecture", "adm1_shapeName"])


## Special case to deal manually

# error_entry <- Biogeographic_database_Ponerinae_NA_coords[23270, ]
# print(error_entry)


## WARNING: Entry n°25069 has an error. Should be in Azerbaijan, not Russia
error_entry <- Biogeographic_database_Ponerinae_NA_coords[25069, ]
print(error_entry)

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[25069] <- "Azerbaijan"
Biogeographic_database_Ponerinae_NA_coords$BENTITY2_N[25069] <- "Azerbaijan"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[25069] <- "Azerbaijan"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[25069] <- "Azerbaijan"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[25069] <- "Azerbaijan"

## WARNING: Entry n°48757 has an error. Should be in Ghana, not Togo
error_entry <- Biogeographic_database_Ponerinae_NA_coords[48757, ]
print(error_entry)

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[48757] <- 6.166
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[48757] <- -0.59962
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[48757] <- "Ghana"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[48757] <- "Ghana"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[48757] <- "Ghana"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[48757] <- "Ghana"
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[48757] <- "Eastern Region"
Biogeographic_database_Ponerinae_NA_coords$adm1[48757] <- "Eastern Region"
Biogeographic_database_Ponerinae_NA_coords$adm2[48757] <- "Fanteakwa South"
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[48757] <- "Fanteakwa South"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[48757] <- "Ghana"
Biogeographic_database_Ponerinae_NA_coords$BENTITY2_N[48757] <- "Ghana"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[48757] <- "NE_SUBUNIT"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[48757] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[48757] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[48757] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[48757] <- set_units(st_area(NE_subunits_sf[NE_subunits_sf$SUBUNIT == "Ghana", "SUBUNIT"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[48757] <- which(NE_subunits_sf$SUBUNIT == "Ghana")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[48757] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[48757] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[48757] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[48757] <- 99
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[48757] <- 90

## WARNING: Entry n°19878 has an error. Should be in Somalia, not Ethiopia

Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[19878] <- 1.718
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[19878] <- 44.770
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[19878] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[19878] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[19878] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[19878] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[19878] <- "Shabeellaha Hoose"
Biogeographic_database_Ponerinae_NA_coords$adm1[19878] <- "Shabeellaha Hoose"
Biogeographic_database_Ponerinae_NA_coords$adm2[19878] <- "MARKA"
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[19878] <- "MARKA"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[19878] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$BENTITY2_N[19878] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[19878] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[19878] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[19878] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[19878] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[19878] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "MARKA", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[19878] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "MARKA")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[19878] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[19878] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[19878] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[19878] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[19878] <- 0

## WARNING: Entry n°24796 has an error. Should be in Somalia, not in the ocean...

Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[24796] <- 5.35049
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[24796] <- 48.527
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[24796] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[24796] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[24796] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[24796] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[24796] <- "Mudug"
Biogeographic_database_Ponerinae_NA_coords$adm1[24796] <- "Mudug"
Biogeographic_database_Ponerinae_NA_coords$adm2[24796] <- "HOBYO"
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[24796] <- "HOBYO"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[24796] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$BENTITY2_N[24796] <- "Somalia"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[24796] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[24796] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[24796] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[24796] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[24796] <- set_units(st_area(NE_subunits_sf[NE_subunits_sf$SUBUNIT == "Iran", "SUBUNIT"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[24796] <- which(NE_subunits_sf$SUBUNIT == "Iran")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[24796] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[24796] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[24796] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[24796] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[24796] <- 0

## WARNING: Entry n°23270 has an error. Should be in Iran, not NA!

Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[23270] <- "Iran"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[23270] <- "Iran"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[23270] <- "Iran"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[23270] <- "Iran"
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[23270] <- "Mazandaran"
Biogeographic_database_Ponerinae_NA_coords$adm1[23270] <- "Mazandaran"
Biogeographic_database_Ponerinae_NA_coords$adm2[23270] <- "Amol"
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[23270] <- "Amol"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[23270] <- "Iran"
Biogeographic_database_Ponerinae_NA_coords$BENTITY2_N[23270] <- "Iran"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[23270] <- "NE_SUBUNIT"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[23270] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[23270] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[23270] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[23270] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "MARKA", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[23270] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "MARKA")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[23270] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[23270] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[23270] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[23270] <- 99
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[23270] <- 95


## Locality = Barro Colorado

Barro_Colorado_entries <- which(replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_NA_coords$Locality, pattern = "Barro Colorado"), replace = FALSE))

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[Barro_Colorado_entries] <- 9.1578
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[Barro_Colorado_entries] <- -79.846
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Barro_Colorado_entries] <- "Panama"
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT[Barro_Colorado_entries] <- "Panama"
Biogeographic_database_Ponerinae_NA_coords$ADMIN[Barro_Colorado_entries] <- "Panama"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Barro_Colorado_entries] <- "Panama"
Biogeographic_database_Ponerinae_NA_coords$adm1_shapeName[Barro_Colorado_entries] <- "Provincia de Panamá Oeste"
Biogeographic_database_Ponerinae_NA_coords$adm1[Barro_Colorado_entries] <- "Provincia de Panamá Oeste"
Biogeographic_database_Ponerinae_NA_coords$adm2[Barro_Colorado_entries] <- "La Chorrera"
Biogeographic_database_Ponerinae_NA_coords$adm2_shapeName[Barro_Colorado_entries] <- "La Chorrera"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[Barro_Colorado_entries] <- "Panama"
Biogeographic_database_Ponerinae_NA_coords$BENTITY2_N[Barro_Colorado_entries] <- "Panama"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Barro_Colorado_entries] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[Barro_Colorado_entries] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[Barro_Colorado_entries] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[Barro_Colorado_entries] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[Barro_Colorado_entries] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "La Chorrera", "adm2_shapeName"]), km^2)[2]
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[Barro_Colorado_entries] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "La Chorrera")[2]
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[Barro_Colorado_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[Barro_Colorado_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[Barro_Colorado_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[Barro_Colorado_entries] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[Barro_Colorado_entries] <- 0


## WARNING: Entry n°4668 has an error in matching shp names. Initial NE_adm1 = Guangzhou Province. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[4668, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Locality = Zengcheng
# Correct adm1 = Guangzhou Province
# Correct adm2 = Zengchengshi

# A priori correction
# Locality "Zengcheng" in China is adm2 Zengchengshi and adm1 Guangzhou Province
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Zengcheng", replace = F)] <- "Zengchengshi"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Zengcheng", replace = F)] <- "Guangzhou Province"

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[4668] <- 23.300
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[4668] <- 113.747
Biogeographic_database_Ponerinae_NA_coords$adm1[4668] <- "Guangzhou Province"
Biogeographic_database_Ponerinae_NA_coords$adm2[4668] <- "Zengchengshi"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[4668] <- "Guangdong"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[4668] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[4668] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[4668] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1[4668] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[4668] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[4668] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Zengchengshi", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[4668] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Zengchengshi")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[4668] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[4668] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[4668] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[4668] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[4668] <- 0

## WARNING: Entry n°4669 has an error in matching shp names. Initial NE_adm1 = Guangzhou Province. New NE_adm1 = Guangdong
error_entry <- Biogeographic_database_Ponerinae_NA_coords[4669, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Locality = Zengcheng
# Correct adm1 = Guangzhou Province
# Correct adm2 = Zengchengshi

# A priori correction
# Locality "Zengcheng" in China is adm2 Zengchengshi and adm1 Guangzhou Province
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Zengcheng", replace = F)] <- "Zengchengshi"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "Zengcheng", replace = F)] <- "Guangzhou Province"

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[4669] <- 23.300
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[4669] <- 113.747
Biogeographic_database_Ponerinae_NA_coords$adm1[4669] <- "Guangzhou Province"
Biogeographic_database_Ponerinae_NA_coords$adm2[4669] <- "Zengchengshi"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[4669] <- "Guangdong"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[4669] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[4669] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[4669] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_NE_adm1[4669] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[4669] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[4669] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Zengchengshi", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[4669] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Zengchengshi")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[4669] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[4669] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[4669] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[4669] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[4669] <- 0


## WARNING: Entry n°5801 has an error in matching shp names. Initial Bentity2 = San Andres Providencia and Santa Catalina. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[5801, ]
print(error_entry)

# # Retrieve San Andres Providencia and Santa Catalina shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "San Andres Providencia and Santa Catalina", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))

# Bentity2 = San Andres Providencia and Santa Catalina
# Correct adm1 = NA
# Correct adm2 = NA

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[5801] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[5801] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[5801] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[5801] <- 100

## WARNING: Entry n°10215 has an error in matching shp names. Initial Bentity2 = San Andres Providencia and Santa Catalina. New Bentity2 = NA

# Bentity2 = San Andres Providencia and Santa Catalina
# Correct adm1 = NA
# Correct adm2 = NA

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[10215] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[10215] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10215] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10215] <- 100


## WARNING: Entry n°5913 has an error in matching shp names. Initial GB_adm1 = Incheon. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[5913, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Incheon", replace = FALSE), ]

plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Incheon", "adm1_shapeName"])
Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Incheon", replace = FALSE), "adm2_shapeName"]
plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Incheon", replace = FALSE), "adm2_shapeName"])
plot(Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Incheon", replace = FALSE), "adm1_shapeName"])

# Some areas of adm1 Incheon have disappeared from the intersecting shp. Use coordinates in available areas

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[5913] <- 37.496
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[5913] <- 126.719
Biogeographic_database_Ponerinae_NA_coords$adm2[5913] <- "Bupyeong-gu"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[5913] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Incheon", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[5913] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Incheon")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[5913] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[5913] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[5913] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[5913] <- 30
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[5913] <- 0

## Apply the same correction for all adm1 = Incheon errors

Incheon_error_entries <- intersect(which(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Incheon"), entries_with_no_matching_shp)

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[Incheon_error_entries] <- 37.496
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[Incheon_error_entries] <- 126.719
Biogeographic_database_Ponerinae_NA_coords$adm2[Incheon_error_entries] <- "Bupyeong-gu"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[Incheon_error_entries] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Incheon", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[Incheon_error_entries] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Incheon")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[Incheon_error_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[Incheon_error_entries] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[Incheon_error_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[Incheon_error_entries] <- 30
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[Incheon_error_entries] <- 0


## WARNING: Entry n°5994 has an error in matching shp names. Initial NE_adm1 = Lord Howe Island. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[5994, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Lord Howe Island shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_NE_adm1_diff[Intersect_all_shp_all_levels_NE_adm1_diff$name == "Lord Howe Island", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$name == "Lord Howe Island", replace = FALSE),]
Intersect_all_shp_all_levels_NE_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_NE_adm1_diff$name == "Lord Howe Island", replace = FALSE),]
NE_adm1_sf[replace_na(data = NE_adm1_sf$name == "Lord Howe Island", replace = FALSE), ]

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Locality[5994] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_NA_coords$adm1[5994] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[5994] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[5994] <- set_units(st_area(NE_adm1_sf[NE_adm1_sf$name == "Lord Howe Island", "name"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[5994] <- which(NE_adm1_sf$name == "Lord Howe Island")
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[5994] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[5994] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[5994] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[5994] <- 0

## Apply the same correction for all adm1/Bentity2 = Lord Howe Island

Lord_Howe_Island_error_entries <- intersect(which(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Lord Howe Island"), entries_with_no_matching_shp)

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Locality[Lord_Howe_Island_error_entries] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_NA_coords$adm1[Lord_Howe_Island_error_entries] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[Lord_Howe_Island_error_entries] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[Lord_Howe_Island_error_entries] <- set_units(st_area(NE_adm1_sf[NE_adm1_sf$name == "Lord Howe Island", "name"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[Lord_Howe_Island_error_entries] <- which(NE_adm1_sf$name == "Lord Howe Island")
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[Lord_Howe_Island_error_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[Lord_Howe_Island_error_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[Lord_Howe_Island_error_entries] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[Lord_Howe_Island_error_entries] <- 0

## WARNING: Entry n°7347 has an error in matching shp names. Initial NE_adm1 = Macau. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[7347, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$name == "Macau", replace = FALSE), ]
Intersect_all_shp_all_levels_NE_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_NE_adm1_diff$name == "Macau", replace = FALSE), ]
NE_adm1_sf[replace_na(data = NE_adm1_sf$name == "Macau", replace = FALSE), ]

# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$name == "Macau", replace = FALSE), ])
# # plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Macau Special Administrative Region", replace = FALSE), ])
# plot(Intersect_all_shp_all_levels_NE_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_NE_adm1_diff$name == "Macau", replace = FALSE), ])
# plot(NE_adm1_sf[replace_na(data = NE_adm1_sf$name == "Macau", replace = FALSE), ])
# plot(geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Macau Special Administrative Region", replace = FALSE), ])

# Macau shp is super reduced in intersecting shp files... but coordinates and shp names are right anyway.

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm1[7347] <- "Macau Special Administrative Region"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[7347] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_shp[7347] <- "GB_adm1"
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[7347] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Macau Special Administrative Region")
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[7347] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[7347] <- 0

## Apply the same correction for all adm1 = Macau

Macau_error_entries <- intersect(which(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Macau"), entries_with_no_matching_shp)
Macau_error_entries <- unique(c(Macau_error_entries, intersect(which(Biogeographic_database_Ponerinae_NA_coords$bentity2_name == "Macau"), entries_with_no_matching_shp)))
Macau_error_entries <- which(replace_na(Biogeographic_database_Ponerinae_NA_coords$adm1 == "Macau Special Administrative Region", F))

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm1[Macau_error_entries] <- "Macau Special Administrative Region"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[Macau_error_entries] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Macau_error_entries] <- "GB_adm1"
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[Macau_error_entries] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Macau Special Administrative Region")
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[Macau_error_entries] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[Macau_error_entries] <- 0

# WARNING: Entry n°7518 has an error in matching shp names. Initial Bentity2 = Shikoku. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[7518, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Shikoku", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Shikoku", replace = FALSE), "adm2_shapeName"])

# Locality = ishizuchi Mt. N.P., Omogo Valley
# adm2 = Kumakougen
# adm1 = Ehime Prefecture

# A priori correction
# Locality "ishizuchi Mt. N.P., Omogo Valley" in Japan is adm2 Kumakougen and adm1 Ehime Prefecture
Biogeographic_database_Ponerinae_NA_coords$adm2[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "ishizuchi Mt. N.P., Omogo Valley", replace = F)] <- "Kumakougen"
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = Biogeographic_database_Ponerinae_NA_coords$Locality == "ishizuchi Mt. N.P., Omogo Valley", replace = F)] <- "Ehime Prefecture"

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm1[7518] <- "Ehime Prefecture"
Biogeographic_database_Ponerinae_NA_coords$adm2[7518] <- "Kumakougen"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[7518] <- "Shikoku"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[7518] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[7518] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[7518] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[7518] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Kumakougen", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[7518] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Kumakougen")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[7518] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[7518] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[7518] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[7518] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[7518] <- 0

## WARNING: Entry n°9162 has an error in matching shp names. Initial Bentity2 = Izu Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[9162, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Izu Islands which has been severly reduced for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Izu Islands", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Izu Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Izu Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Izu Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Izu Islands", replace = FALSE), "BENTITY2_N"])

# Lot of bentity2 shp are missing from the Intersection files...

# Coordinates are fine.
# Keep adm1 and adm2 as NA...

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[9162] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[9162] <- 100

## Apply same correction for other Izu Islands entries

Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13010] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13010] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13165] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13165] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14447] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14447] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15979] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15979] <- 100

## WARNING: Entry n°9320 has an error in matching shp names. Initial Bentity2 = Ogasawara Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[9320, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Ogasawara Islands shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Ogasawara Islands", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Ogasawara Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Ogasawara Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Ogasawara Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Ogasawara Islands", replace = FALSE), "BENTITY2_N"])

# Coordinates are fine.
# Keep adm1 and adm2 as NA...

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[9320] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[9320] <- 100

## Apply same correction for other Ogasawara Islands entries

Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[11274] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[11274] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[12063] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[12063] <- 100

## WARNING: Entry n°9322 has an error in matching shp names. Initial Bentity2 = Volcano Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[9322, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Volcano Islands shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Volcano Islands", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Volcano Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Volcano Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Volcano Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Volcano Islands", replace = FALSE), "BENTITY2_N"])

# Coordinates are fine.
# Keep adm1 and adm2 as NA...

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[9322] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[9322] <- 100

## Apply same correction for other Volcano Islands entries

Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[11277] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[11277] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[12201] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[12201] <- 100

# WARNING: Entry n°9332 has an error in matching shp names. Initial Bentity2 = Bermuda. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[9332, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Bermuda", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Bermuda", replace = FALSE), "name"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Bermuda", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Bermuda", replace = FALSE), "BENTITY2_N"])

# Coordinates falling in the sea may be changed
# Change coordinates for another location in the island covered by the shp file

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[9332] <- 32.3018
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[9332] <- -64.7708
Biogeographic_database_Ponerinae_NA_coords$adm1[9332] <- "Warwick"
Biogeographic_database_Ponerinae_NA_coords$adm2[9332] <- NA
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[9332] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[9332] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[9332] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[9332] <- 80

## WARNING: Entry n°9524 has an error in matching shp names. Initial Bentity2 = Pelagie Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[9524, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Pelagie Islands shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Pelagie Islands", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Pelagie Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Pelagie Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Pelagie Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Pelagie Islands", replace = FALSE), "BENTITY2_N"])

# adm1 and adm2 remains as NA
# Coordinates falling in the sea may be changed

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[9524] <- 35.5161
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[9524] <- 12.5786
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[9524] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[9524] <- 100

## Apply same correction for other Pelagie Islands entries
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10060] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10060] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[11996] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[11996] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[12232] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[12232] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14342] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14342] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14343] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14343] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14677] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14677] <- 100


error_entry <- Biogeographic_database_Ponerinae_NA_coords[10824, ]
print(error_entry)

## WARNING: Entry n°10297 has an error in matching shp names. Initial Bentity2 = Senkaku Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[10297, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Senkaku Islands shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Senkaku Islands", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Senkaku Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Senkaku Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Senkaku Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Senkaku Islands", replace = FALSE), "BENTITY2_N"])

# Coordinates are fine.
# Keep adm1 and adm2 as NA...

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10297] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10297] <- 100

## Apply same correction for other Senkaku Islands entries

Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10299] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10299] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10497] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10497] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10669] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10669] <- 100

## WARNING: Entry n°10376 has an error in matching shp names. Initial Bentity2 = Satsunan Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[10376, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Satsunan Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Satsunan Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Satsunan Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Satsunan Islands", replace = FALSE), "BENTITY2_N"])

# Coordinates are fine, but just landed on a tiny islands not in GB
# Keep adm1 and adm2 as NA...

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10376] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10376] <- 100

## WARNING: Entry n°10824 has an error in matching shp names. Initial Bentity2 = Pontine Islands. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[10824, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Pontine Islands shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Pontine Islands", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Pontine Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Pontine Islands", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Pontine Islands", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Pontine Islands", replace = FALSE), "BENTITY2_N"])

# Coordinates are fine, but just landed on a tiny islands not in GB
# Keep adm1 and adm2 as NA...

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[10824] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[10824] <- 100

## Apply same correction for other Pontine Islands entries
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[12012] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[12012] <- 100

## WARNING: Entry n°12404 has an error in matching shp names. Initial NE_SUBUNIT = Martinique. New NE_SUBUNIT = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[12404, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$SUBUNIT == "Martinique", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$SUBUNIT == "Martinique", replace = FALSE), "adm1_shapeName"])

# Bentity2 to be adjusted
# adm1 and adm2 = NA

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[12404] <- "Lesser Antilles"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[12404] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[12404] <- 100

## Apply same correction for other Martinique entries
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[13044] <- "Lesser Antilles"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13044] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13044] <- 100

## WARNING: Entry n°12997 has an error in matching shp names. Initial Bentity2 = Tuscan Archipelago. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[12997, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Tuscan Archipelago shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Tuscan Archipelago", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Tuscan Archipelago", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Tuscan Archipelago", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Tuscan Archipelago", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Tuscan Archipelago", replace = FALSE), "BENTITY2_N"])

# Coordinates falling in water need to be adjusted
# adm1 and adm2 = NA

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[12997] <- 43.0697
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[12997] <- 9.824
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[12997] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[12997] <- 100

## Apply same correction for other Tuscan Archipelago entries
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15940] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15940] <- 100

## WARNING: Entry n°13120 has an error in matching shp names. Initial GB_adm1 = Manus Province. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[13120, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Manus Province", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Manus Province", replace = FALSE), "adm1_shapeName"])
# Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Manus Province", replace = FALSE), "adm1_shapeName"]
# plot(Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Manus Province", replace = FALSE), "adm1_shapeName"])

# Random coordinates on Wavulu island, tiny lost island. Better to move to main island
# adm2 = Manus District

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[13120] <- -2.0783
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[13120] <- 146.9095
Biogeographic_database_Ponerinae_NA_coords$adm2[13120] <- "Manus District"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[13120] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[13120] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[13120] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Manus District", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[13120] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Manus District")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[13120] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[13120] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[13120] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13120] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13120] <- 0

## WARNING: Entry n°13303 has an error in matching shp names. Initial GB_adm1 = Kagoshima Prefecture. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[13303, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Kagoshima Prefecture", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Kagoshima Prefecture", replace = FALSE), "adm1_shapeName"])
# Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Kagoshima Prefecture", replace = FALSE), "adm1_shapeName"]
# plot(Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Kagoshima Prefecture", replace = FALSE), "adm1_shapeName"])
# geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture", replace = FALSE), "adm1_shapeName"]
# plot(geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture", replace = FALSE), "adm1_shapeName"])

# For some reason, Nagashima Island has disappear from Kagoshima Prefecture in the intersecting shp files...
# Chose another random coordinate in the adm1
# Bentity_2 = Kyushu
# adm2 = Kagoshima

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[13303] <- 31.590
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[13303] <- 130.5506
Biogeographic_database_Ponerinae_NA_coords$adm1[13303] <- "Kagoshima Prefecture"
Biogeographic_database_Ponerinae_NA_coords$adm2[13303] <- "Kagoshima"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[13303] <- "Kyushu"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[13303] <- "GB_adm1"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[13303] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[13303] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[13303] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[13303] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[13303] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[13303] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[13303] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[13303] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13303] <- 95
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13303] <- 0

## Apply same correction to other Kagoshima Prefecture entries

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[13748] <- 31.590
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[13748] <- 130.5506
Biogeographic_database_Ponerinae_NA_coords$adm1[13748] <- "Kagoshima Prefecture"
Biogeographic_database_Ponerinae_NA_coords$adm2[13748] <- "Kagoshima"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[13748] <- "Kyushu"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[13748] <- "GB_adm1"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[13748] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[13748] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[13748] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[13748] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[13748] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[13748] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[13748] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[13748] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13748] <- 95
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13748] <- 0

Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[15638] <- 31.590
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[15638] <- 130.5506
Biogeographic_database_Ponerinae_NA_coords$adm1[15638] <- "Kagoshima Prefecture"
Biogeographic_database_Ponerinae_NA_coords$adm2[15638] <- "Kagoshima"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[15638] <- "Kyushu"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[15638] <- "GB_adm1"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[15638] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[15638] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[15638] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[15638] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[15638] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Kagoshima Prefecture")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[15638] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[15638] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[15638] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15638] <- 95
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15638] <- 0

## WARNING: Entry n°13486 has an error in matching shp names. Initial NE_SUBUNIT = Marshall Islands. New NE_SUBUNIT = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[13486, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$SUBUNIT == "Marshall Islands", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$SUBUNIT == "Marshall Islands", replace = FALSE), "adm1_shapeName"])

# Coordinates need to be adjusted to not fall in ocean
# adm1 and adm2 = NA
# Keep adm1 as Namorik Atoll, but also inform locality

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[13486] <- 5.6149
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[13486] <- 168.1269
Biogeographic_database_Ponerinae_NA_coords$Locality[13486] <- "Namorik Atoll"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[13486] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[13486] <- 100

## WARNING: Entry n°14084 has an error in matching shp names. Initial GB_adm1 = Okinawa Prefecture. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[14907, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Okinawa Prefecture", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Okinawa Prefecture", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Okinawa Prefecture", replace = FALSE), "adm1_shapeName"]
# plot(Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Okinawa Prefecture", replace = FALSE), "adm1_shapeName"])
# geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture", replace = FALSE), "adm1_shapeName"]
# plot(geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture", replace = FALSE), "adm1_shapeName"])

# For some reason, Minamidaitō Island has disappear from Okinawa Prefecture in the intersecting shp files...
# Chose another random coordinate in the adm1
# adm2 = Kunigami

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[14084] <- 26.758
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[14084] <- 128.2549
Biogeographic_database_Ponerinae_NA_coords$adm2[14084] <- "Kunigami"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[14084] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[14084] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[14084] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[14084] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[14084] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[14084] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[14084] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14084] <- 90
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14084] <- 0

## Apply same correction to other Okinawa Prefecture entries

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[14907] <- 26.758
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[14907] <- 128.2549
Biogeographic_database_Ponerinae_NA_coords$adm2[14907] <- "Kunigami"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[14907] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[14907] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[14907] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[14907] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[14907] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[14907] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[14907] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14907] <- 90
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14907] <- 0

Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[15064] <- 26.758
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[15064] <- 128.2549
Biogeographic_database_Ponerinae_NA_coords$adm2[15064] <- "Kunigami"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[15064] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[15064] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[15064] <- set_units(st_area(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture", "adm1_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[15064] <- which(geoBoundaries_adm1_sf$adm1_shapeName == "Okinawa Prefecture")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[15064] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[15064] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[15064] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15064] <- 90
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15064] <- 0

## WARNING: Entry n°14303 has an error in matching shp names. Initial GB_adm1 = Angaur. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[14303, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Angaur", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Angaur", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Angaur", replace = FALSE), "adm1_shapeName"]
# plot(Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Angaur", replace = FALSE), "adm1_shapeName"])
# geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Angaur", replace = FALSE), "adm1_shapeName"]
# plot(geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Angaur", replace = FALSE), "adm1_shapeName"])

# adm1 Angaur in Palaus as disappeared in Intersecting shp files for some reason...
# Coordinates and adm1 are good.
# adm2 = Ngaramasch

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm2[14303] <- "Ngaramasch"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[14303] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[14303] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[14303] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[14303] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[14303] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[14303] <- 0

## Apply same correction to other Angaur entries

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm2[16059] <- "Ngaramasch"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[16059] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[16059] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[15064] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[15064] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[16059] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[16059] <- 0

Biogeographic_database_Ponerinae_NA_coords$adm2[16060] <- "Ngaramasch"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[16060] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[16060] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[16060] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[16060] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[16060] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[16060] <- 0

## WARNING: Entry n°15000 has an error in matching shp names. Initial NE_adm1 = Mayotte. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[15000, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$SUBUNIT == "Mayotte", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$SUBUNIT == "Mayotte", replace = FALSE), "BENTITY2_N"])

# Coordinates falling in the ocean to adjust
# Locality = Mount Choungui
# adm1 and adm2 = NA

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[15000] <- -12.957
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[15000] <- 45.134
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15000] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15000] <- 100

## WARNING: Entry n°15003 has an error in matching shp names. Initial NE_adm1 = Mayotte. New NE_adm1 = NA

# Locality = Dziani Karihani
# adm1 and adm2 = NA

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[15003] <- -12.794
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[15003] <- 45.1195
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15003] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15003] <- 100

## WARNING: Entry n°15542 has an error in matching shp names. Initial GB_adm1 = Koror. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[15542, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Koror", replace = FALSE), ]
# # plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$adm1_shapeName == "Kochi", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Koror", replace = FALSE), "adm1_shapeName"]
# plot(Intersect_all_shp_all_levels_GB_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_GB_adm1_diff$adm1_shapeName == "Koror", replace = FALSE), "adm1_shapeName"])
# geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Koror", replace = FALSE), "adm1_shapeName"]
# plot(geoBoundaries_adm1_sf[replace_na(data = geoBoundaries_adm1_sf$adm1_shapeName == "Koror", replace = FALSE), "adm1_shapeName"])

# adm1 Koror in Palaus as disappeared in Intersecting shp files for some reason...
# Coordinates and adm1 are good.
# adm2 = Melekeok

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm2[15542] <- "Melekeok"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[15542] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[15542] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[15542] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[15542] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15542] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15542] <- 0

## WARNING: Entry n°15818 has an error in matching shp names. Initial Bentity2 = Cocos Island (Costa Rica). New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[15818, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Cocos Island (Costa Rica) shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_Bentity2_diff[Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Cocos Island (Costa Rica)", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Cocos Island (Costa Rica)", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$BENTITY2_N == "Cocos Island (Costa Rica)", replace = FALSE), "adm2_shapeName"])
# Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Cocos Island (Costa Rica)", replace = FALSE), "BENTITY2_N"]
# plot(Intersect_all_shp_all_levels_Bentity2_diff[replace_na(data = Intersect_all_shp_all_levels_Bentity2_diff$BENTITY2_N == "Cocos Island (Costa Rica)", replace = FALSE), "BENTITY2_N"])

# adm1 and adm2 = NA
# Add Cocos Island as Locality as it is not a valid adm1

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm1[15818] <- NA
Biogeographic_database_Ponerinae_NA_coords$Locality[15818] <- "Cocos Island"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15818] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15818] <- 100

## WARNING: Entry n°15826 has an error in matching shp names. Initial NE_adm1 = Clipperton Island. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[15826, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Clipperton Island shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_NE_adm1_diff[Intersect_all_shp_all_levels_NE_adm1_diff$name == "Clipperton Island", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$name == "Clipperton Island", replace = FALSE), ]
# Intersect_all_shp_all_levels_NE_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_NE_adm1_diff$name == "Clipperton Island", replace = FALSE), ]
# NE_adm1_sf[replace_na(data = NE_adm1_sf$name == "Clipperton Island", replace = FALSE), ]

# Clipperton Island has disappeared in intersecting shp files... but coordinates and shp names are right anyway.
# Record as Locality as adm1 is not valid in GB
# Record Bentity2

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm1[15826] <- NA
Biogeographic_database_Ponerinae_NA_coords$Locality[15826] <- "Clipperton Island"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[15826] <- "Clipperton Island"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15826] <- 100
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15826] <- 100

## WARNING: Entry n°15908 has an error in matching shp names. Initial Bentity2 = Shikoku. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[15908, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Locality = Shimanto River Basin
# adm2 = Shimanto
# adm1 = Kochi Prefecture

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[15908] <- 33.0598
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[15908] <- 132.8276
Biogeographic_database_Ponerinae_NA_coords$adm1[15908] <- "Kochi Prefecture"
Biogeographic_database_Ponerinae_NA_coords$adm2[15908] <- "Shimanto"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[15908] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[15908] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[15908] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[15908] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[15908] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Shimanto", "adm2_shapeName"]), km^2)[1]
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[15908] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Shimanto")[1]
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[15908] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[15908] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[15908] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[15908] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[15908] <- 0

## WARNING: Entry n°29513 has an error in matching shp names. Initial Bentity2 = Choco. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[29513, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Locality = Choco. Guarato. Qda Cuadralito
# adm2 = Tadó
# adm1 = Chocó

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[29513] <- 5.2994
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[29513] <- -76.367
Biogeographic_database_Ponerinae_NA_coords$adm1[29513] <- "Chocó"
Biogeographic_database_Ponerinae_NA_coords$adm2[29513] <- "Tadó"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[29513] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[29513] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[29513] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[29513] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[29513] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Tadó", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[29513] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Tadó")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[29513] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[29513] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[29513] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[29513] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[29513] <- 0

## WARNING: Entry n°31644 has an error in matching shp names. Initial NE_adm1 = Gibraltar. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[31644, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# # Retrieve Gibraltar shp which has been lost for some reason...
# Intersect_all_shp_all_levels <- dplyr::bind_rows(Intersect_all_shp_all_levels, st_transform(x = Intersect_all_shp_all_levels_NE_adm1_diff[Intersect_all_shp_all_levels_NE_adm1_diff$name == "Clipperton Island", ], crs = st_crs(geoBoundaries_adm2_sf)))
# Intersect_all_shp_all_levels$Intersect_shp_ID <- 1:nrow(Intersect_all_shp_all_levels)

# Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$name == "Gibraltar", replace = FALSE), ]
# # plot(Intersect_all_shp_all_levels[replace_na(data = Intersect_all_shp_all_levels$name == "Gibraltar", replace = FALSE), ])
# Intersect_all_shp_all_levels_NE_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_NE_adm1_diff$name == "Gibraltar", replace = FALSE), ]
# plot(Intersect_all_shp_all_levels_NE_adm1_diff[replace_na(data = Intersect_all_shp_all_levels_NE_adm1_diff$name == "Gibraltar", replace = FALSE), ])
# plot(NE_adm1_sf[replace_na(data = NE_adm1_sf$name == "Gibraltar", replace = FALSE), "name"])

# Locality = Gibraltar
# adm1 and adm2 = NA
# SUBUNIT = Gibraltar
# Country_ISO3_name = Gibraltar
# Country_ISO3_code = GIB

# For all Gibraltar entries

Gibraltar_entries <- which(Biogeographic_database_Ponerinae_NA_coords$Locality == "Gibraltar")

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Locality[Gibraltar_entries] <- "Gibraltar"
Biogeographic_database_Ponerinae_NA_coords$adm1[Gibraltar_entries] <- NA
Biogeographic_database_Ponerinae_NA_coords$SUBUNIT_name[Gibraltar_entries] <- "Gibraltar"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_name[Gibraltar_entries] <- "Gibraltar"
Biogeographic_database_Ponerinae_NA_coords$Country_ISO3_code[Gibraltar_entries] <- "GIB"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[Gibraltar_entries] <- "NE_adm1"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[Gibraltar_entries] <- set_units(st_area(NE_adm1_sf[NE_adm1_sf$name == "Gibraltar", "name"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[Gibraltar_entries] <- which(NE_adm1_sf$name == "Gibraltar")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[Gibraltar_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[Gibraltar_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[Gibraltar_entries] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[Gibraltar_entries] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[Gibraltar_entries] <- 0

## WARNING: Entry n°33419 has an error in matching shp names. Initial NE_adm1 = Puntarenas. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[33419, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# adm2 = Puntarenas
# adm1 = Provincia Puntarenas

# A posteriori correction

Biogeographic_database_Ponerinae_NA_coords$adm2[33419] <- "Puntarenas"
Biogeographic_database_Ponerinae_NA_coords$adm1[33419] <- "Provincia Puntarenas"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[33419] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Puntarenas", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp[33419] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[33419] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Puntarenas")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[33419] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[33419] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[33419] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[33419] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[33419] <- 0

## WARNING: Entry n°39075 has an error in matching shp names. Initial Bentity2 = Myanmar. New Bentity2 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[39075, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# Locality = Tenasserim
# adm2 = Myeik
# adm1 = Tanitharyi

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[39075] <- 12.0878
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[39075] <- 99.0124
Biogeographic_database_Ponerinae_NA_coords$adm2[39075] <- "Myeik"
Biogeographic_database_Ponerinae_NA_coords$adm1[39075] <- "Tanitharyi"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[39075] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Myeik", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[39075] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Myeik")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[39075] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[39075] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[39075] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[39075] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[39075] <- 0

## WARNING: Entry n°46685 has an error in matching shp names. Initial NE_adm1 = Shanghai. New NE_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[46685, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# adm1 = Shanghai Municipality
# adm2 = Shanghaishi

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[46685] <- 31.233
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[46685] <- 121.5088
Biogeographic_database_Ponerinae_NA_coords$adm2[46685] <- "Shanghaishi"
Biogeographic_database_Ponerinae_NA_coords$adm1[46685] <- "Shanghai Municipality"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[46685] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Shanghaishi", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[46685] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Shanghaishi")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[46685] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[46685] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[46685] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[46685] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[46685] <- 0

## WARNING: Entry n°46891 has an error in matching shp names. Initial NE_adm1 = Shanghai. New NE_adm1 = NA

# adm1 = Shanghai Municipality
# adm2 = Shanghaishi

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[46891] <- 31.233
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[46891] <- 121.5088
Biogeographic_database_Ponerinae_NA_coords$adm2[46891] <- "Shanghaishi"
Biogeographic_database_Ponerinae_NA_coords$adm1[46891] <- "Shanghai Municipality"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[46891] <- "GB_adm2"
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[46891] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Shanghaishi", "adm2_shapeName"]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[46891] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Shanghaishi")
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[46891] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[46891] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[46891] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[46891] <- 0
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[46891] <- 0

## WARNING: Entry n°50094 has an error

# Locality = locality unknown in Samland Peninsula
# Correct adm1 = Kaliningrad (Not Kaliningradskaya Oblast as initially)

# A priori correction
# Locality "locality unknown in Samland Peninsula" in USA is adm1 = Kaliningrad
Biogeographic_database_Ponerinae_NA_coords$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_NA_coords$Locality, pattern = "Samland"), replace = F)] <- "Kaliningrad"

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$Latitude_dec[50094] <- 54.657
Biogeographic_database_Ponerinae_NA_coords$Longitude_dec[50094] <- 21.171
Biogeographic_database_Ponerinae_NA_coords$adm2[50094] <- "Gvardeysky District"
Biogeographic_database_Ponerinae_NA_coords$bentity2_name[50094] <- "Kaliningradskaya oblast"
Biogeographic_database_Ponerinae_NA_coords$matching_shp[50094] <- "GB_adm1"
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm2[50094] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$matching_GB_adm1[50094] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$matching_Bentity2[50094] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_area[50094] <- set_units(st_area(geoBoundaries_adm1_sf[2307,]), km^2)
Biogeographic_database_Ponerinae_NA_coords$matching_shp_ID[50094] <- 2307
Biogeographic_database_Ponerinae_NA_coords$multiple_matches[50094] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[50094] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm1[50094] <- FALSE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[50094] <- 90
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[50094] <- 0

### Cases with matching NA on higher levels. Recover lower levels when possible

## WARNING: Entry n°66 has an error in matching shp names. Initial GB_adm1 = Valle del Cauca. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[66, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm2[66] <- "Buenaventura"
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[66] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[66] <- 70
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[66] <- 0

## WARNING: Entry n°68 has an error in matching shp names. Initial GB_adm1 = Valle del Cauca. New GB_adm1 = NA
error_entry <- Biogeographic_database_Ponerinae_NA_coords[68, ]
print(error_entry)
new_shp_all_levels <- suppressMessages(suppressWarnings(sf::st_intersection(error_entry, Intersect_all_shp_all_levels)))
print(new_shp_all_levels)

# A posteriori correction
Biogeographic_database_Ponerinae_NA_coords$adm2[66] <- "Buenaventura"
Biogeographic_database_Ponerinae_NA_coords$Interpolated_adm2[66] <- TRUE
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm2[66] <- 70
Biogeographic_database_Ponerinae_NA_coords$Uncertainty_adm1[66] <- 0

# WARNING: Entry n°762 has an error in matching shp names. Initial GB_adm1 = Valle del Cauca. New GB_adm1 = NA
# WARNING: Entry n°1097 has an error in matching shp names. Initial GB_adm1 = West Bengal. New GB_adm1 = NA
# WARNING: Entry n°1142 has an error in matching shp names. Initial GB_adm1 = Kerala. New GB_adm1 = NA

sf_use_s2(TRUE)

# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "CHN", ])
# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "CHN", ])
# View(Intersect_all_shp_all_levels[Intersect_all_shp_all_levels$adm1_shapeName == "Valle del Cauca", "adm2_shapeName"])
#
# 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName %in% c("Tamazunchale", "San Martín Chalchicuautla"), "adm2_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% c("Tamazunchale", "San Martín Chalchicuautla"), "adm1_shapeName"])
# 
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Shimanto", "adm2_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName == "Kochi Prefecture", "adm1_shapeName"])
#
# plot(Intersect_all_shp_all_levels[Intersect_all_shp_all_levels$adm1_shapeName == "Valle del Cauca", "adm2_shapeName"])



## Save database of NA coordinates
# saveRDS(Biogeographic_database_Ponerinae_NA_coords, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")


##### 4/ Merge randomly drawn NA coordinates with curated coordinates ####

### 4.1/ Merge both database ####

# Load database of occurrences with initial GPS coordinates
Biogeographic_database_Ponerinae_flags <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_flags.rds")

# Load database of occurrences without initial GPS coordinates, but with new coordinates drawn at random
Biogeographic_database_Ponerinae_NA_coords <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_NA_coords.rds")

# Merge without geometry
Biogeographic_database_Ponerinae_curated <- dplyr::full_join(st_drop_geometry(Biogeographic_database_Ponerinae_flags), st_drop_geometry(Biogeographic_database_Ponerinae_NA_coords))

# Remove control variables for intersecting shapes
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  select(-ADMIN, -NE_Country_sf_ID, -SUBUNIT, -NE_SUBUNIT_sf_ID, -BENTITY2_N, -Bentity2_sf_ID, -name, -NE_adm1_sf_ID, -adm1_shapeName, -GB_adm1_sf_ID, -adm2_shapeName, -GB_adm2_sf_ID)

# Add ID for tracking
Biogeographic_database_Ponerinae_curated$Occurrence_ID <- 1:nrow(Biogeographic_database_Ponerinae_curated)

# Flag occurrences that are not interpolated (provided with GPS coordinates)
Biogeographic_database_Ponerinae_curated$Interpolated_coordinates[is.na(Biogeographic_database_Ponerinae_curated$Interpolated_coordinates)] <- FALSE
table(Biogeographic_database_Ponerinae_curated$Interpolated_coordinates)

Biogeographic_database_Ponerinae_curated$Uncertainty_area[is.na(Biogeographic_database_Ponerinae_curated$Uncertainty_area)] <- 0
Biogeographic_database_Ponerinae_curated$Uncertainty_area <- set_units(Biogeographic_database_Ponerinae_curated$Uncertainty_area, km^2)

Biogeographic_database_Ponerinae_curated$Interpolated_adm2[is.na(Biogeographic_database_Ponerinae_curated$Interpolated_adm2)] <- FALSE
Biogeographic_database_Ponerinae_curated$Uncertainty_adm2[is.na(Biogeographic_database_Ponerinae_curated$Uncertainty_adm2)] <- 0

Biogeographic_database_Ponerinae_curated$Interpolated_adm1[is.na(Biogeographic_database_Ponerinae_curated$Interpolated_adm1)] <- FALSE
Biogeographic_database_Ponerinae_curated$Uncertainty_adm1[is.na(Biogeographic_database_Ponerinae_curated$Uncertainty_adm1)] <- 0

# Transform back into sf format
Biogeographic_database_Ponerinae_curated$Latitude_copy <- Biogeographic_database_Ponerinae_curated$Latitude_dec
Biogeographic_database_Ponerinae_curated$Longitude_copy <- Biogeographic_database_Ponerinae_curated$Longitude_dec
Biogeographic_database_Ponerinae_curated <- st_as_sf(Biogeographic_database_Ponerinae_curated, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_curated) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
# Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_curated


### 4.2/ Find intersecting polygons for all entries based on coordinates ####

# Record when info is updated based on coordinates vs. when match what was provided ????
# Record adm1/adm2 uncertainty as 0
# Record if adm1/adm2 were provided initially or retrieved from coordinates or interpolated from higher levels

# Load Biogeographic_database_Ponerinae_curated
Biogeographic_database_Ponerinae_curated <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

## Use modified sf files to record the nearest polygon under a different name than the intersecting one

# For GB_Countries
geoBoundaries_Countries_sf_Nearest <- geoBoundaries_Countries_sf %>% 
  rename(GB_Country_Nearest = Country_shapeName) %>% 
  select(GB_Country_Nearest)

# For adm1
geoBoundaries_adm1_sf_Nearest <- geoBoundaries_adm1_sf %>% 
  rename(GB_adm1_Nearest = adm1_shapeName) %>% 
  select(GB_adm1_Nearest)

# For adm2
geoBoundaries_adm2_sf_Nearest <- geoBoundaries_adm2_sf %>% 
  rename(GB_adm2_Nearest = adm2_shapeName) %>% 
  select(GB_adm2_Nearest)

### Do not use a loop to extract info! Do the batch thing to extract intersection info, then loop to show warning and validate the update ####
# It is the extraction step that takes forever!

## Find intersecting polygons by batches of 100 entries (to keep track of progress)

# Step needed to limit the number of run of st_intersection which would be too big to run as a loop per entries

out <- data.frame() # Store output
batch_size <- 1000   # Number of entries per batch
nb_batches <- (nrow(Biogeographic_database_Ponerinae_curated) %/% batch_size) + is.numeric((nrow(Biogeographic_database_Ponerinae_curated) %% batch_size) > 0)
seq_i <- seq(from = 1, to = batch_size * nb_batches + 1, by = batch_size)

sf_use_s2(FALSE)
for (i in seq_i)
{
  # i <- 1

  # Get indices of batch entries
  batch_i <- seq(from = i, by = 1, length.out = batch_size)

  # Adjust indices for the last batch
  if (max(batch_i) > nrow(Biogeographic_database_Ponerinae_curated)) { batch_i <- min(batch_i):nrow(Biogeographic_database_Ponerinae_curated) }

  # Find intersecting polygons for Countries/SUBUNIT/Bentity2/adm1/adm2/
  out_batch_Countries <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_curated[batch_i, ], geoBoundaries_Countries_sf[, "Country_shapeName"])))
  out_batch_SUBUNIT <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_curated[batch_i, ], NE_subunits_sf[, "SUBUNIT"])))
  out_batch_bentity2 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_curated[batch_i, ], Bentity2_sf[, "BENTITY2_N"])))
  out_batch_adm1 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_curated[batch_i, ], geoBoundaries_adm1_sf[, "adm1_shapeName"])))
  out_batch_adm2 <- suppressMessages(suppressWarnings(sf::st_intersection(Biogeographic_database_Ponerinae_curated[batch_i, ], geoBoundaries_adm2_sf[, "adm2_shapeName"])))

  # Find nearest polygons for GB_Countries
  out_batch_Country_Nearest_ID <- suppressMessages(suppressWarnings(sf::st_nearest_feature(Biogeographic_database_Ponerinae_curated[batch_i, ], geoBoundaries_Countries_sf_Nearest[, "GB_Country_Nearest"])))
  out_batch_Country_Nearest <- geoBoundaries_Country_sf_Nearest[out_batch_Country_Nearest_ID, ]
  out_batch_Country_Nearest$Occurrence_ID <- batch_i
  
  # Find nearest polygons for adm1
  out_batch_adm1_Nearest_ID <- suppressMessages(suppressWarnings(sf::st_nearest_feature(Biogeographic_database_Ponerinae_curated[batch_i, ], geoBoundaries_adm1_sf_Nearest[, "GB_adm1_Nearest"])))
  out_batch_adm1_Nearest <- geoBoundaries_adm1_sf_Nearest[out_batch_adm1_Nearest_ID, ]
  out_batch_adm1_Nearest$Occurrence_ID <- batch_i
  
  # Find nearest polygons for adm2
  out_batch_adm2_Nearest_ID <- suppressMessages(suppressWarnings(sf::st_nearest_feature(Biogeographic_database_Ponerinae_curated[batch_i, ], geoBoundaries_adm2_sf_Nearest[, "GB_adm2_Nearest"])))
  out_batch_adm2_Nearest <- geoBoundaries_adm2_sf_Nearest[out_batch_adm2_Nearest_ID, ]
  out_batch_adm2_Nearest$Occurrence_ID <- batch_i

  # Keep only the first match per occurrence
  out_batch_Countries <- out_batch_Countries %>% 
    arrange(Occurrence_ID) %>% 
    group_by(Occurrence_ID) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_SUBUNIT <- out_batch_SUBUNIT %>% 
    arrange(Occurrence_ID) %>% 
    group_by(Occurrence_ID) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_bentity2 <- out_batch_bentity2 %>% 
    arrange(Occurrence_ID) %>% 
    group_by(Occurrence_ID) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_adm1 <- out_batch_adm1 %>% 
    arrange(Occurrence_ID) %>% 
    group_by(Occurrence_ID) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  out_batch_adm2 <- out_batch_adm2 %>% 
    arrange(Occurrence_ID) %>% 
    group_by(Occurrence_ID) %>% 
    mutate(Duplicates_counter = row_number(Occurrence_ID)) %>% 
    filter(Duplicates_counter == 1) %>% 
    select(-Duplicates_counter) %>%
    ungroup()
  
  # Join batch output for multiple levels, including entry for occurrences with no match (keeping track with ID)
  out_batch <- suppressMessages(left_join(x = st_drop_geometry(Biogeographic_database_Ponerinae_curated[batch_i, ]), y = st_drop_geometry(out_batch_Countries)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_SUBUNIT)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_bentity2)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_adm1)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_adm2)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_Country_Nearest)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_adm1_Nearest)))
  out_batch <- suppressMessages(left_join(x = out_batch, y = st_drop_geometry(out_batch_adm2_Nearest)))
  
  # Merge batch output with global output
  out <- rbind(out, out_batch)

  # Print progress
  cat(paste0(Sys.time(), " - Occurrence n°",max(batch_i), " / ", nrow(Biogeographic_database_Ponerinae_curated),"\n"))

}
sf_use_s2(TRUE)

# Check that the final numbers of row are equal
nrow(out)
nrow(Biogeographic_database_Ponerinae_curated)

View(out)

# If the output file seems valid, replace initial file
Biogeographic_database_Ponerinae_curated <- out
# Biogeographic_database_Ponerinae_curated$GB_Country_Nearest <- out$GB_Country_Nearest
# Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest <- out$GB_adm1_Nearest
# Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest <- out$GB_adm2_Nearest

## Convert back to sf
Biogeographic_database_Ponerinae_curated$Latitude_copy <- Biogeographic_database_Ponerinae_curated$Latitude_dec
Biogeographic_database_Ponerinae_curated$Longitude_copy <- Biogeographic_database_Ponerinae_curated$Longitude_dec
Biogeographic_database_Ponerinae_curated <- st_as_sf(Biogeographic_database_Ponerinae_curated, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_curated) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
# Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_curated

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

### 4.3/ Inspect discrepancies ####

### 4.3.1/ For GB_Countries  ####

## Update Country_GB_name based on NE_Country_ISO3 names

Biogeographic_database_Ponerinae_curated$Country_GB_name <- Biogeographic_database_Ponerinae_curated$Country_shapeName

# Flag initial invalid GB name
Biogeographic_database_Ponerinae_curated$valid_GB_Country_name <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% geoBoundaries_Countries_sf$Country_shapeName), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$valid_GB_Country_name)

# Check if NA can be retrieved from GB-valid Country_ISO3_name or if coordinates must be adjusted
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name) & Biogeographic_database_Ponerinae_curated$valid_GB_Country_name, c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])

# Use Country_ISO3_name with a valid GB name to update missing data
Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name)] <- Biogeographic_database_Ponerinae_curated$Country_ISO3_name[Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name)]

# Check if NA can be retrieved from GB-invalid Country_ISO3_name or if coordinates must be adjusted

# Entries with valid Country_ISO3_Code
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name) & !Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & (Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% geoBoundaries_Countries_sf[, "Country_shapeGroup", drop = TRUE]), c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])

# Entries without valid Country_ISO3_Code
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name) & !Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & !(Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% geoBoundaries_Countries_sf[, "Country_shapeGroup", drop = TRUE]), c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])

# Country_ISO3_name that are part of the United States (USA)
  # American Samoa (ASM)
  # United States Virgin Islands (VIR)
  # Guam (GUM)
  # Marshall Islands (MHL)
  # Northern Mariana Islands (MNP)
  # Puerto Rico (PRI)
  # United States Minor Outlying Islands (UMI)

  
Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("ASM", "VIR", "GUM", "MHL", "MNP", "PRI", "UMI")] <- "United States"

# Country_ISO3_name that are part of France (FRA)
  # Wallis and Futuna (WLF)
  # New Caledonia (NCL)
  # Saint Martin (MAF)
  # Clipperton Island (CPT) or (CLP)
  # French Polynesia (PYF)
  # French Southern and Antarctic Lands (ATF)
  # Saint Pierre and Miquelon (SPM)
  # Saint Barthelemy (BLM)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("WLF", "NCL", "MAF", "CPT", "CLP", "PYF", "ATF", "SPM", "BLM")] <- "France"

# Country_ISO3_name that are part of Australia (AUS)
  # Indian Ocean Territories CCI for Cocos (Keeling) Islands + Christmas Island
  # Norfolk Island (NFK)
  # Heard Island and McDonald Islands (HMD)
  # Indian Ocean Territories (IOA)
  # Coral Sea Islands (CSI)
  # Ashmore and Cartier Islands (ATC)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("CCI", "NFK", "HMD", "IOA", "CSI", "ATC")] <- "Australia"

# Country_ISO3_name that are part of the United Kingdom (GBR)
  # Montserrat (MSR)
  # Bermuda (BMU)
  # British Virgin Islands (VGB)
  # Jersey (JEY)
  # Guernsey (GGY)
  # Gibraltar (GIB)
  # Pitcairn Islands (PCN)
  # Anguilla (AIA)
  # Cayman Islands (CYM)
  # Isle of Man (IMN)
  # Turks and Caicos Islands (TCA)
  # Saint Helena (SHN)
  # South Georgia and the Islands (SGS)
  # British Indian Ocean Territory (IOT)

plot(geoBoundaries_Countries_sf[geoBoundaries_Countries_sf$Country_shapeName %in% c("United Kingdom"), "Country_shapeName"])

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("MSR", "BMU", "VGB", "JEY", "GGY", "GIB", "PCN", "AIA", "CYM", "IMN", "TCA", "SHN", "SGS", "IOT")] <- "United Kingdom"

# Country_ISO3_name that are part of China (CHN)
  # Macao S.A.R (MAC)
  # Hong Kong S.A.R. (HKG)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("MAC", "HKG")] <- "China"

# Country_ISO3_name that are part of Somalia (SOM)
  # Somaliland (SOL)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("SOL")] <- "Somalia"

# Country_ISO3_name that are part of New Zealand (NZL)
  # Niue (NIU)
  # Cook Islands (COK)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("NIU", "COK")] <- "New Zealand"

# Country_ISO3_name that are part of the Netherlands (NLD)
  # Aruba (ABW)
  # Sint Maarten (SXM)
  # Curaçao (CUW)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("ABW", "SXM", "CUW")] <- "Netherlands"

# Country_ISO3_name that are part of Finland (FIN)
  # Aland (ALD)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("ALD")] <- "Finland"

# Country_ISO3_name that are part of Denmark (DNK)
  # Faroe Islands (FRO)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("FRO")] <- "Denmark"

# Country_ISO3_name that are part of Cyprus (CYP)
  # Cyprus No Mans Area (CNM)
  # Northern Cyprus (CYN)

Biogeographic_database_Ponerinae_curated$Country_GB_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("CNM", "CYN")] <- "Cyprus"

# Country_ISO3_name Palestine is split into GB: Gaza Strip (118) and West Bank (129)
plot(geoBoundaries_Countries_sf[geoBoundaries_Countries_sf$Country_shapeName %in% c("Israel", "Gaza Strip", "West Bank"), "Country_shapeName"])

View(Biogeographic_database_Ponerinae_curated[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PSX", "PSE"), replace = F), c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])
View(Biogeographic_database_Ponerinae_curated[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Palestine", replace = F), c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])

Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Palestine", replace = F)] <- "West Bank"

# Use Country_ISO3_code to update missing data with GB-invalid Country_ISO3_name
Country_GB_names_update <- geoBoundaries_Countries_sf[match(x = Biogeographic_database_Ponerinae_curated$Country_ISO3_code, table = st_drop_geometry(geoBoundaries_Countries_sf[, "Country_shapeGroup", drop = TRUE])), "Country_shapeName", drop = TRUE]
Biogeographic_database_Ponerinae_curated$Country_GB_name[!Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name)] <- Country_GB_names_update[!Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name)]

table(is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name))


## Flag mismatches
Biogeographic_database_Ponerinae_curated$matching_GB_Countries <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == Biogeographic_database_Ponerinae_curated$Country_shapeName), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Countries)

# Check if mismatches can be corrected or if coordinates must be adjusted
View(Biogeographic_database_Ponerinae_curated[!Biogeographic_database_Ponerinae_curated$matching_GB_Countries & Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & (Biogeographic_database_Ponerinae_curated$Country_GB_name != Biogeographic_database_Ponerinae_curated$Country_ISO3_name) , c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])

# Inspect mismatches to detect potential errors to correct, and correct "Country_GB_name"

# Locality = Los Lagos Hotel in Leticia. Should be in Colombia, not Peru!
# View(Biogeographic_database_Ponerinae_curated[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Leticia. Los Lagos") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Peru", replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Leticia. Los Lagos") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Peru", replace = FALSE)] <- -4.1794
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Leticia. Los Lagos") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Peru", replace = FALSE)] <- -69.9498
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Leticia. Los Lagos") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Peru", replace = FALSE)] <- "Colombia"

# Locality = Santa Ana National Wildlife Refuge. Should be in the US, not Mexico!
# View(Biogeographic_database_Ponerinae_curated[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Ana National Wildlife Refuge") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Mexico", replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Ana National Wildlife Refuge") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Mexico", replace = FALSE)] <- 26.0836
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Ana National Wildlife Refuge") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Mexico", replace = FALSE)] <- -98.1356
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Ana National Wildlife Refuge") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Mexico", replace = FALSE)] <- "United States"

# Locality = Puerto Malonado, Cuzco Amazonico. Should be in Peru, not Colombia!
# View(Biogeographic_database_Ponerinae_curated[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Malonado") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Colombia", replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Malonado") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Colombia", replace = FALSE)] <- -12.3025
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Malonado") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Colombia", replace = FALSE)] <- -69.17077
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Malonado") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Colombia", replace = FALSE)] <- "Peru"

# Locality = Estiron, Rio Ampiacu. Should be in Peru, not Brazil!
# View(Biogeographic_database_Ponerinae_curated[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Brazil", replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Brazil", replace = FALSE)] <- -4.1554
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Brazil", replace = FALSE)] <- -70.7092
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Brazil", replace = FALSE)] <- "Peru"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu"), replace = FALSE)] <- "Peru"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu"), replace = FALSE)] <- "Peru"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu"), replace = FALSE)] <- "Loreto"
Biogeographic_database_Ponerinae_curated$adm1_shapeName[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu"), replace = FALSE)] <- "Loreto"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu"), replace = FALSE)] <- "Mariscal Ramón Castilla"
Biogeographic_database_Ponerinae_curated$adm2_shapeName[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estiron, Rio Ampiacu"), replace = FALSE)] <- "Mariscal Ramón Castilla"

# Locality = Union Juarez Volcan Tacana. Should be in Mexico, not Guatemala!
# View(Biogeographic_database_Ponerinae_curated[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Union Juarez Volcan Tacana") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Guatemala", replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Union Juarez Volcan Tacana") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Guatemala", replace = FALSE)] <- 15.1319
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Union Juarez Volcan Tacana") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Guatemala", replace = FALSE)] <- -92.1093
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Union Juarez Volcan Tacana") & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Guatemala", replace = FALSE)] <- "Mexico"

### Too many to correct...
# Only correct the weird ones for points that do not lie close to the borders of the two mismatch countries

## Use valid Country_ISO3_name as Country_GB_name
View(Biogeographic_database_Ponerinae_curated[replace_na(data = !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & Biogeographic_database_Ponerinae_curated$valid_GB_Country_name, replace = FALSE), c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & Biogeographic_database_Ponerinae_curated$valid_GB_Country_name, replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & Biogeographic_database_Ponerinae_curated$valid_GB_Country_name, replace = FALSE)] 

## Correct for exceptions where the Country_GB_name is different from the Country_ISO3_name

# SUBUNIT_name = West Bank => Country_GB_name = West Bank Palestine?
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "West Bank", replace = FALSE)] <- "West Bank"

# Use Country_ISO3_code to update missing data with GB-invalid Country_ISO3_name
Country_GB_names_update <- geoBoundaries_Countries_sf[match(x = Biogeographic_database_Ponerinae_curated$Country_ISO3_code, table = st_drop_geometry(geoBoundaries_Countries_sf[, "Country_shapeGroup", drop = TRUE])), "Country_shapeName", drop = TRUE]
Biogeographic_database_Ponerinae_curated$Country_GB_name[!Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & (Biogeographic_database_Ponerinae_curated$Country_GB_name != Biogeographic_database_Ponerinae_curated$Country_ISO3_name)] <- Country_GB_names_update[!Biogeographic_database_Ponerinae_curated$valid_GB_Country_name & (Biogeographic_database_Ponerinae_curated$Country_GB_name != Biogeographic_database_Ponerinae_curated$Country_ISO3_name)]

View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Country_GB_name != Biogeographic_database_Ponerinae_curated$Country_ISO3_name, c("Occurrence_ID", "Latitude_dec", "Longitude_dec", "Country_initial", "adm1", "adm2", "Locality", "Country_ISO3_name", "Country_ISO3_code", "valid_GB_Country_name", "Country_GB_name")])

# Manual correction for remaining weird errors
# Entry n°127875 should be labeled as in South Sudan, not Central African Republic
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[Biogeographic_database_Ponerinae_curated$Occurrence_ID == 127875] <- "South Sudan"

## ReFlag mismatches based on the updated GB_Country_names 
Biogeographic_database_Ponerinae_curated$matching_GB_Countries <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_GB_name == Biogeographic_database_Ponerinae_curated$Country_shapeName), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Countries)

## Save Biogeographic database with all curated coordinates
# saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

### 4.3.2/ For NE_SUBUNIT ####

##### DO not update automatically if higher level did not match !!!! Because it probably means the coordinates is slightly incorrect....

# Flag mismatches
Biogeographic_database_Ponerinae_curated$matching_SUBUNIT <- replace_na(data = (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == Biogeographic_database_Ponerinae_curated$SUBUNIT), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_SUBUNIT)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Countries, Biogeographic_database_Ponerinae_curated$matching_SUBUNIT)

# Check currently recorded NA vs. NA retrieved from intersecting shp
table(is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name), is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT))

## Case 1: SUBUNIT_name currently recorded AND NA retrieved from intersecting shp

# Check if the current SUBUNIT_name are valid SUBUNIT names
SUBUNIT_validity_test <- replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name %in% NE_subunits_sf$SUBUNIT, replace = F)

# Adjust invalid SUBUNIT names
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !SUBUNIT_validity_test,  c("matching_shp", "Latitude_dec", "Longitude_dec", "SUBUNIT_name", "SUBUNIT", "Locality", "adm2", "adm1", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "BENTITY2_N")])

# Gibraltar => NA (not present in the NE_SUBUNIT layer)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT == "Gibraltar", replace = FALSE)] <- NA
# Clipperton Island => NA (not present in the NE_SUBUNIT layer)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT == "Clipperton Island", replace = FALSE)] <- NA
# Antigua and Barbuda is split between Antigua (Latitude < 17.4°N) and Barbuda (Latitude > 17.4°N)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Antigua and Barbuda") & Biogeographic_database_Ponerinae_curated$Latitude_dec > 17.4, replace = FALSE)] <- "Barbuda"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Antigua and Barbuda") & Biogeographic_database_Ponerinae_curated$Latitude_dec < 17.4, replace = FALSE)] <- "Antigua"
# France in Lesser Antilles (Bentity2)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[Biogeographic_database_Ponerinae_curated$Country_initial == "Guadeloupe"] <- "Guadeloupe"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[Biogeographic_database_Ponerinae_curated$Country_initial == "French Guiana"] <- "French Guiana"
View(Biogeographic_database_Ponerinae_curated[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "France"), replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "France") & Biogeographic_database_Ponerinae_curated$Country_initial == "Guadeloupe", replace = FALSE)] <- "Guadeloupe"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "France") & Biogeographic_database_Ponerinae_curated$Country_initial == "Guadeloupe Islands", replace = FALSE)] <- "Guadeloupe"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "France") & Biogeographic_database_Ponerinae_curated$Country_initial == "Martinique", replace = FALSE)] <- "Martinique"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "France") & Biogeographic_database_Ponerinae_curated$Country_initial == "?Unknown", replace = FALSE)] <- "Martinique"
# Netherlands in Lesser Antilles (Bentity2)
View(Biogeographic_database_Ponerinae_curated[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Netherlands"), replace = FALSE), ])
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = ((Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles") | (Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Antilles")) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Netherlands"), replace = FALSE)] <- "Caribbean Netherlands"
# Reunion in Mascarene Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[Biogeographic_database_Ponerinae_curated$Country_initial == "Reunion"] <- "Reunion"

# Look at valid entries and see if they should be turned into NA for some reason
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & SUBUNIT_validity_test,  c("matching_shp", "Latitude_dec", "Longitude_dec", "SUBUNIT_name", "SUBUNIT", "Locality", "adm2", "adm1", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "BENTITY2_N")])

plot(NE_subunits_sf[NE_subunits_sf$SUBUNIT == "Australia", "SUBUNIT"])

## Case 2: NA currently recorded AND NA retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT),  c("matching_shp", "Latitude_dec", "Longitude_dec", "SUBUNIT_name", "SUBUNIT", "Locality", "adm2", "adm1", "bentity2_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "BENTITY2_N")])

# Retrieve name from Country_ISO3 if valid SUBUNIT_name
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% NE_subunits_sf$SUBUNIT), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% NE_subunits_sf$SUBUNIT), replace = FALSE)]

# Deal with special case when Country_ISO3 is not a valid SUBUNIT_name

# Clipperton Island => NA (absent from the layer)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Clipperton Island"), replace = FALSE)] <- NA

# Equatorial Guinea is split between Bioko (Island) and Rio Muni (Continental)
# plot(NE_subunits_sf[NE_subunits_sf$SUBUNIT %in% c("Bioko", "Rio Muni"), "SUBUNIT"])
# Latitude > 2.75° N is Bioko
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Equatorial Guinea") & Biogeographic_database_Ponerinae_curated$Latitude_dec > 2.75, replace = FALSE)] <- "Bioko"
# Latitude < 2.75° N is Rio Muni
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Equatorial Guinea") & Biogeographic_database_Ponerinae_curated$Latitude_dec < 2.75, replace = FALSE)] <- "Rio Muni"

# Cocos (Keeling) Islands (bentity2_name) in Indian Ocean Territories (Country_ISO3_name) => Cocos (Keeling) Islands
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$bentity2_name == "Cocos (Keeling) Islands"), replace = FALSE)] <- "Cocos (Keeling) Islands"

# Christmas Island (bentity2_name OR BENTITY_N) in Indian Ocean Territories (Country_ISO3_name) => Christmas Island
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Christmas Island", F)] <- "Christmas Island"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Christmas Island", F)] <- "Christmas Island"

# Macao S.A.R.(Country_ISO3_name) => Macao S.A.R
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Macao S.A.R."), replace = FALSE)] <- "Macao S.A.R"

# New Zealand (Country_ISO3_name) is split between North Island and South Island
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Zealand") & str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "North Island"), replace = FALSE)] <- "North Island"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Zealand") & str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Whangarei Heads"), replace = FALSE)] <- "North Island"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Zealand") & str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "South Island"), replace = FALSE)] <- "South Island"

# São Tomé and Principe (Country_ISO3_name) is split between São Tomé (Latitude < 1°N) and Principe (Latitude > 1°N)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "São Tomé and Principe") & (Biogeographic_database_Ponerinae_curated$Latitude_dec > 1), replace = FALSE)] <- "Principe"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "São Tomé and Principe") & (Biogeographic_database_Ponerinae_curated$Latitude_dec < 1), replace = FALSE)] <- "São Tomé"

# Trinidad and Tobago (Country_ISO3_name) is split between Trinidad (Latitude < 11°N) and Tobago (Latitude > 11°N)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Trinidad and Tobago") & (Biogeographic_database_Ponerinae_curated$Latitude_dec > 11), replace = FALSE)] <- "Tobago"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Trinidad and Tobago") & (Biogeographic_database_Ponerinae_curated$Latitude_dec < 11), replace = FALSE)] <- "Trinidad"

# United Kingdom (Country_ISO3_name) is split between England, Northern Ireland, Scotland, and Wales
# All entries are in England, except two points with Latitude > 51.35°N and Longitude < -3.3°W that are in Wales
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United Kingdom") & (Biogeographic_database_Ponerinae_curated$Latitude_dec > 51.35) & (Biogeographic_database_Ponerinae_curated$Longitude_dec < -3.3), replace = FALSE)] <- "Wales"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United Kingdom"), replace = FALSE)] <- "England"

# test_map <- ggplot() + 
#   geom_sf(data = NE_subunits_sf[NE_subunits_sf$ADMIN %in% c("United Kingdom"), "SUBUNIT"],
#                                mapping = aes(fill =  SUBUNIT)) + 
#   geom_sf(data = Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United Kingdom", ], 
#           col = "darkred", size = 3) + 
#   theme_bw() + theme(axis.title = element_blank())
# print(test_map)

## Case 3: NA currently recorded but SUBUNIT retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT),  c("matching_shp", "Latitude_dec", "Longitude_dec", "SUBUNIT_name", "SUBUNIT", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "Country_shapeName", "Locality", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName", "BENTITY2_N")])

# Update SUBUNIT_name for all the entries that were matching Country
table(Biogeographic_database_Ponerinae_curated$matching_GB_Countries[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT)])
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & Biogeographic_database_Ponerinae_curated$matching_GB_Countries] <- Biogeographic_database_Ponerinae_curated$SUBUNIT[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & Biogeographic_database_Ponerinae_curated$matching_GB_Countries]

# Inspect the ones that were not matching Country to see if the update from the intersecting shp is valid
# All entries that miss matches because Country_shapeName is NA are valid and can be updated for SUBUNIT
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName)] <- Biogeographic_database_Ponerinae_curated$SUBUNIT[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName)]

# All others are wrong match and Country_ISO3_name should be used instead, except when it is not a valid SUBUNIT name...
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & !is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% NE_subunits_sf$SUBUNIT)] <- Biogeographic_database_Ponerinae_curated$Country_ISO3_name[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & !is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% NE_subunits_sf$SUBUNIT)]

# Manually correct for cases of wrong match from intersecting shp + non-valid Country_ISO3_name
# Belgium is split between Brussels Capital Region, Flemish Region, and Walloon Region
# Here, all entries with Latitude > 50.7°N are in Flemish Region and all entries with Latitude > 50.7°N are in Walloon Region
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & !is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Belgium") & (Biogeographic_database_Ponerinae_curated$Latitude_dec > 50.7)] <- "Flemish Region"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & !is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Belgium") & (Biogeographic_database_Ponerinae_curated$Latitude_dec < 50.7)] <- "Walloon Region"

# test_map <- ggplot() +
#   geom_sf(data = NE_subunits_sf[NE_subunits_sf$ADMIN %in% c("Belgium"), "SUBUNIT"],
#                                mapping = aes(fill =  SUBUNIT)) +
#   geom_sf(data = Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name) & !is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT) & !Biogeographic_database_Ponerinae_curated$matching_GB_Countries & !is.na(Biogeographic_database_Ponerinae_curated$Country_shapeName) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Belgium", ],
#           col = "darkred", size = 3) +
#   theme_bw() + theme(axis.title = element_blank())
# print(test_map)

## Case 4: SUBUNIT currently recorded does not match the SUBUNIT retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[replace_na(data = (Biogeographic_database_Ponerinae_curated$SUBUNIT_name != Biogeographic_database_Ponerinae_curated$SUBUNIT), replace = FALSE),  c("matching_shp", "Latitude_dec", "Longitude_dec", "SUBUNIT_name", "SUBUNIT", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "Country_shapeName", "Locality", "adm2", "adm1", "bentity2_name", "adm2_shapeName", "adm1_shapeName", "BENTITY2_N")])

# Do not updates as there are cases of occurrences falling slightly across the borders
# Exception for cases where occurrence fall in the right place but SUBUNIT name need to be updated (Look by SUBUNIT match)

# French Guiana is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "French Guiana", replace = F)] <- "French Guiana"
# Crimea is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "Crimea", replace = F)] <- "Crimea"
# Kaliningrad is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "Kaliningrad", replace = F)] <- "Kaliningrad"
# Kyushu is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "Kyushu", replace = F)] <- "Kyushu"
# Mayotte is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "Mayotte", replace = F)] <- "Mayotte"
# Nanseishoto is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "Nanseishoto", replace = F)] <- "Nanseishoto"
# Shikoku is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "Shikoku", replace = F)] <- "Shikoku"
# United States is valid
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$SUBUNIT == "United States", replace = F)] <- "United States"

# Locality Rio Grande Village is in Texas, United States
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rio Grande Village"), replace = F)] <- "United States"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rio Grande Village"), replace = F)] <- "United States"

# adm1 Chiriqui is in Panama, not Costa Rica
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$adm1, pattern = "Chiriqui"), replace = F)] <- "Panama"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$adm1, pattern = "Chiriqui"), replace = F)] <- "Panama"

# Country Colombia are in SUBUNIT Colombia
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Colombia"), replace = F)] <- "Colombia"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Colombia"), replace = F)] <- "Colombia"

# Country Switzerland are in SUBUNIT Switzerland
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Switzerland"), replace = F)] <- "Switzerland"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Switzerland"), replace = F)] <- "Switzerland"

# Country Nicaragua are in SUBUNIT Nicaragua
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Nicaragua"), replace = F)] <- "Nicaragua"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Nicaragua"), replace = F)] <- "Nicaragua"

# Country Zimbabwe are in SUBUNIT Zimbabwe
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Zimbabwe"), replace = F)] <- "Zimbabwe"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Zimbabwe"), replace = F)] <- "Zimbabwe"


## Save Biogeographic database with all curated coordinates
# saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

### 4.3.3/ For Bentity2 ####

##### DO not update automatically if higher level did not match !!!! Because it probably means the coordinates is slightly incorrect....

# Flag mismatches
Biogeographic_database_Ponerinae_curated$matching_Bentity2 <- replace_na(data = (Biogeographic_database_Ponerinae_curated$bentity2_name == Biogeographic_database_Ponerinae_curated$BENTITY2_N), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_Bentity2)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Countries, Biogeographic_database_Ponerinae_curated$matching_Bentity2)

# Check currently recorded NA vs. NA retrieved from intersecting shp
table(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name), is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N))

## Case 1: bentity2_name currently recorded AND NA retrieved from intersecting shp (BENTITY2_N)

# Check if the current bentity2_name are valid Bentity2 names
bentity2_validity_test <- replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name %in% Bentity2_sf$BENTITY2_N, replace = F)
table(bentity2_validity_test, is.na(Biogeographic_database_Ponerinae_curated$bentity2_name))

# Adjust invalid Bentity2 names
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & !bentity2_validity_test,  c("matching_shp", "Latitude_dec", "Longitude_dec", "bentity2_name", "BENTITY2_N", "Locality", "adm2", "adm1", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "SUBUNIT")])

# Lesser_Antilles => Lesser Antilles
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser_Antilles", replace = FALSE)] <- "Lesser Antilles"

# Guadeloupe is in Lesser Antilles
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Guadeloupe", replace = FALSE)] <- "Lesser Antilles"

# Look at valid entries and see if they should be turned into NA or corrected for some reason (Sort by bentity2_name)
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & SUBUNIT_validity_test,  c("matching_shp", "Latitude_dec", "Longitude_dec", "bentity2_name", "BENTITY2_N", "Locality", "adm2", "adm1", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "SUBUNIT")])

# Caroline Islands have errors
# Palau (Country_ISO3_name) = Palau (Bentity2)
# Yap (Locality) = Micronesia (Bentity2)
# Other part of Federated States of Micronesia (Country_ISO3_name) = Caroline Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Palau"), replace = FALSE)] <- "Palau"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$bentity2_name == "Caroline Islands") & str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yap"), replace = FALSE)] <- "Micronesia"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Federated States of Micronesia") & str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yap"), replace = FALSE)] <- "Micronesia"

# plot(Bentity2_sf[Bentity2_sf$BENTITY2_N %in% c("Caroline Islands", "Micronesia", "Palau"), "BENTITY2_N"])
plot(Bentity2_sf[Bentity2_sf$BENTITY2_N %in% c("Micronesia", "Caroline Islands"), "BENTITY2_N"])
# plot(Bentity2_sf[Bentity2_sf$BENTITY2_N %in% c("Micronesia", "Palau"), "BENTITY2_N"])

# Lord Howe Island (adm1/adm2/Locality) = Lord Howe Island (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1 == "Lord Howe Island"), replace = FALSE)] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$adm2 == "Lord Howe Island"), replace = FALSE)] <- "Lord Howe Island"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Lord Howe Island"), replace = FALSE)] <- "Lord Howe Island"

# Macao S.A.R (Country_ISO3_name) = Macau (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Macao S.A.R"), replace = FALSE)] <- "Macau"

# Singapore (Country_ISO3_name) = Malaysia and Singapore (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Singapore"), replace = FALSE)] <- "Malaysia and Singapore"


## Case 2: NA currently recorded AND NA retrieved from intersecting shp (sort by Country_ISO3_name)
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N),  c("matching_shp", "Latitude_dec", "Longitude_dec", "bentity2_name", "BENTITY2_N", "Locality", "adm2", "adm1", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "SUBUNIT")])

# Retrieve name from Country_ISO3 if valid bentity2_name
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% Bentity2_sf$BENTITY2_N), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% Bentity2_sf$BENTITY2_N), replace = FALSE)]

# Retrieve name from SUBUNIT_name if valid bentity2_name
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name %in% Bentity2_sf$BENTITY2_N), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$SUBUNIT_name %in% Bentity2_sf$BENTITY2_N), replace = FALSE)]

# Retrieve name from adm1 if valid bentity2_name
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$adm1 %in% Bentity2_sf$BENTITY2_N), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$adm1 %in% Bentity2_sf$BENTITY2_N), replace = FALSE)]

# Deal with special case when Country_ISO3/SUBUNIT/adm1 is not a valid bentity2_name

# Cameroon Line Archipelago (Bentity2) = Bioko (SUBUNIT), São Tomé (SUBUNIT), and Principe (SUBUNIT)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name %in% c("Bioko", "São Tomé", "Principe"), replace = FALSE)] <- "Cameroon Line Archipelago"

# Equatorial Guinea (Bentity2) = Rio Muni (SUBUNIT)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name %in% c("Rio Muni"), replace = FALSE)] <- "Equatorial Guinea"

# Lesser Antilles (Bentity2) = Saint Vincent and the Grenadines + British Virgin Islands + Barbados + Grenada + Dominica
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Saint Vincent and the Grenadines", "British Virgin Islands", "Barbados", "Grenada", "Dominica"), replace = FALSE)] <- "Lesser Antilles"

# Hispaniola (Bentity2) = Haiti + Dominican Republic (Country_ISO3)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Haiti", "Dominican Republic"), replace = FALSE)] <- "Hispaniola"

# Bahamas (Bentity2) = The Bahamas (Country_ISO3)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("The Bahamas"), replace = FALSE)] <- "Bahamas"

# Samoan Islands (Bentity2) = Samoa + American Samoa (Country_ISO3)Samoa
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Samoa", "American Samoa"), replace = FALSE)] <- "Samoan Islands"

# Western Australia (adm1) is split between two Bentity2: North Western Australia (Latitude > -26.6°S) & South Western Australia (Latitude < -26.6°S)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1 == "Western Australia") & (Biogeographic_database_Ponerinae_curated$Latitude_dec > -26.6), replace = FALSE)] <- "North Western Australia"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1 == "Western Australia") & (Biogeographic_database_Ponerinae_curated$Latitude_dec < -26.6), replace = FALSE)] <- "South Western Australia"

# Brazilian adm1 with diacritics or different spelling
# Espírito Santo (adm1) = Espirito Santo (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Espírito Santo"), replace = FALSE)] <- "Espirito Santo"
# Paraíba (adm1) = Paraiba (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Paraíba"), replace = FALSE)] <- "Paraiba"
# Pará (adm1) = Para (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Pará"), replace = FALSE)] <- "Para"
# São Paulo (adm1) = Sao Paulo (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("São Paulo"), replace = FALSE)] <- "Sao Paulo"
# Rio de Jeneiro (adm1) = Rio de Janeiro (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Rio de Jeneiro"), replace = FALSE)] <- "Rio de Janeiro"

# Zhejiang Province (adm1) = Zhejiang (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Zhejiang Province"), replace = FALSE)] <- "Zhejiang"
# Jiangsu Province (adm1) = Jiangsu (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Jiangsu Province"), replace = FALSE)] <- "Jiangsu"
# Shanghai Municipality (adm1) = Shanghai (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Shanghai Municipality"), replace = FALSE)] <- "Shanghai"

# Democratic Republic of the Congo (Country_ISO3) = Zaire (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Democratic Republic of the Congo"), replace = FALSE)] <- "Zaire"

# Federated States of Micronesia (Country_ISO3) is split between two Bentity2: Micronesia (Longitude < 141°W) & Caroline Islands (Longitude > 141°W)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Federated States of Micronesia") & (Biogeographic_database_Ponerinae_curated$Longitude_dec < 141), replace = FALSE)] <- "Micronesia"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Federated States of Micronesia") & (Biogeographic_database_Ponerinae_curated$Longitude_dec > 141), replace = FALSE)] <- "Caroline Islands"

# Europa Island (Locality) = Europa Island (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality %in% c("Europa Island"), replace = FALSE)] <- "Europa Island"

# Hong Kong S.A.R. (Country_ISO3) = Hong Kong (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Hong Kong S.A.R."), replace = FALSE)] <- "Hong Kong"

# Borneo (Bentity2) = Sarawak + Sabah + Central Kalimantan + East Kalimantan + North Kalimantan + South Kalimantan + West Kalimantan
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Sarawak", "Sabah", "Central Kalimantan", "East Kalimantan", "North Kalimantan", "South Kalimantan", "West Kalimantan"), replace = FALSE)] <- "Borneo"

# Other adm1 from Malaysia than Sarawak and Sabah are in Malaysia and Singapore (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Malaysia") & !(Biogeographic_database_Ponerinae_curated$adm1 %in% c("Sarawak", "Sabah")), replace = FALSE)] <- "Malaysia and Singapore"

# Mauritius (Country_ISO3) => Mascarene Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Mauritius"), replace = FALSE)] <- "Mascarene Islands"

# Northern Mariana Islands (Country_ISO3) => Mariana Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Northern Mariana Islands", "Guam"), replace = FALSE)] <- "Mariana Islands"

## Indonesia is split in multiple Benitity2. Use adm1 to assigned the proper Bentity2

# Krakatau (Locality) = Krakatau Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Krakatau"), replace = FALSE)] <- "Krakatau Islands"

# Maluku + North Maluku (adm1) = Maluku Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Maluku", "North Maluku", "Maluku Utara"), replace = FALSE)] <- "Maluku Islands"

# Bali + East Nusa Tenggara + West Nusa Tenggara (adm1) = Lesser Sunda Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Bali", "East Nusa Tenggara", "West Nusa Tenggara", "Nusa Tenggara Timur", "Nusa Tenggara Barat"), replace = FALSE)] <- "Lesser Sunda Islands"

# North Sumatra + West Sumatra + Aceh (adm1) => Sumatra (Bentity2) BUT be careful of special cases of Enggano Island, Mentawai Islands, Nias Island, Simeulue Island, and Riau Archipelago
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("North Sumatra", "West Sumatra", "Aceh"), replace = FALSE)] <- "Sumatra"
# Nias Utara (adm2) = Nias Island (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 %in% c("Nias Utara"), replace = FALSE)] <- "Nias Utara"
# Kepulauan Mentawai (adm2) = Mentawai Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 %in% c("Kepulauan Mentawai"), replace = FALSE)] <- "Mentawai Islands"
# Pulau Banyak Barat (Locality) => Sumatra (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pulau Banyak Barat"), replace = FALSE)] <- "Sumatra"

# West Java => Java (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("West Java"), replace = FALSE)] <- "Java"

# Riau Islands (adm1) = Riau Archipelago (Bentity2) BUT be careful of special cases of Natuna (adm2) = Natuna Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Riau Islands"), replace = FALSE)] <- "Riau Archipelago"
# Natuna (adm2) = Natuna Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 %in% c("Natuna"), replace = FALSE)] <- "Natuna Islands"

# Waigeu (Locality) => Raja Ampat Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Waigeu"), replace = FALSE)] <- "Raja Ampat Islands"

# Wammar (Locality) => New Guinea (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Wammar"), replace = FALSE)] <- "New Guinea"

# Aru Island (Locality) => Maluku Islands # Need to adjust coordinates
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Aru Is"), replace = FALSE)] <- -6.1634
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Aru Is"), replace = FALSE)] <- 134.4654
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Aru Is"), replace = FALSE)] <- "Maluku Islands"

# Entry n°58417 is on Pulau Numfoor => Schouten Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[Biogeographic_database_Ponerinae_curated$Occurrence_ID == 58417] <- "Schouten Islands"

## Papua New Guinea is split in multiple Benitity2. Use adm1 to assigned the proper Bentity2

# Default for PNG = New Guinea (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Papua New Guinea") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = FALSE)] <- "New Guinea"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Papua New Guinea") & (Biogeographic_database_Ponerinae_curated$adm1 == "null"), replace = FALSE)] <- "New Guinea"

# East Sepik, Madang, Central, Western, Sandaun, Northern, Morobe Province (adm1) => New Guinea (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("East Sepik", "Madang", "Central", "Western", "Sandaun", "Northern", "Morobe Province") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Papua New Guinea", replace = FALSE)] <- "New Guinea"

# View(Biogeographic_database_Ponerinae_curated[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("East Sepik", "Madang", "Central", "Western", "Sandaun", "Northern", "Morobe Province") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Papua New Guinea", replace = FALSE), ])

# Bismarck Archipelago (Bentity2) = East New Britain Province + West New Britain Province + New Ireland Province + Manus Province (adm1)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("East New Britain Province", "West New Britain Province", "New Ireland Province", "Manus Province", "Bismarck Is.", "New Britain", "New Ireland", "Manus") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Papua New Guinea", replace = FALSE)] <- "Bismarck Archipelago"

# Autonomous Region of Bougainville (adm1) => Solomon Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$adm1, pattern = "Bougainville"), replace = FALSE)] <- "Solomon Islands"

# Tami Islands (Locality) => New Guinea (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tami Is"), replace = FALSE)] <- "New Guinea"

## Japan is split in multiple Bentity2. Use adm1 to assigned the proper Bentity2

# Fukuoka Prefecture (adm1) => Kyushu (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Fukuoka Prefecture"), replace = FALSE)] <- "Kyushu"
# Kiu-Shiu (Locality) => Kyushu (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kiu-Shiu"), replace = FALSE)] <- "Kyushu"

# Nagasaki Prefecture (adm1) => Kyushu (Bentity2) but includes the Tsushima Island (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Nagasaki Prefecture"), replace = FALSE)] <- "Kyushu"
# Nagasaki Prefecture (adm1) BUT (Latitude > 34°N AND Longitude < 129.7°E) => Tsushima Island (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Nagasaki Prefecture") & (Biogeographic_database_Ponerinae_curated$Latitude_dec > 34) & (Biogeographic_database_Ponerinae_curated$Longitude_dec < 129.7), replace = FALSE)] <- "Tsushima Island"
# Tsushima (adm2) => Tsushima Island (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 %in% c("Tsushima"), replace = FALSE)] <- "Tsushima Island"

# Kagoshima Prefecture (adm1) => Kyushu (Bentity2) but includes the Satsunan Islands
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Kagoshima Prefecture"), replace = FALSE)] <- "Kyushu"
# Kagoshima Prefecture (adm1) BUT (Latitude < 30.9°N) => Satsunan Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Kagoshima Prefecture") & (Biogeographic_database_Ponerinae_curated$Latitude_dec < 30.9), replace = FALSE)] <- "Satsunan Islands"

# Hiroshima + Tottori Prefecture (adm1) => Chugoku (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Hiroshima", "Tottori Prefecture"), replace = FALSE)] <- "Chugoku"

# Kagawa Prefecture + Tokushima Prefecture (adm1) => Shikoku (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Kagawa Prefecture", "Tokushima Prefecture"), replace = FALSE)] <- "Shikoku"
# Aoshima (Locality) => Shikoku (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Aoshima"), replace = FALSE)] <- "Shikoku"

# Osaka Prefecture (adm1) => Kinki (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Osaka Prefecture"), replace = FALSE)] <- "Kinki"

# Okinawa Prefecture (adm1) => Okinawa (Bentity2) but includes the Daito Islands, Yaeyama Islands, Senkaku Islands
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Okinawa Prefecture"), replace = FALSE)] <- "Okinawa"
# Okinawa Prefecture (adm1) BUT (Longitude > 130°E) => Daito Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Okinawa Prefecture") & (Biogeographic_database_Ponerinae_curated$Longitude_dec > 130), replace = FALSE)] <- "Daito Islands"
# Okinawa Prefecture (adm1) BUT (Longitude < 124.5°E AND Latitude < 25°N AND ) => Yaeyama Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Okinawa Prefecture") & (Biogeographic_database_Ponerinae_curated$Longitude_dec < 124.5) & (Biogeographic_database_Ponerinae_curated$Latitude_dec < 25), replace = FALSE)] <- "Yaeyama Islands"
# Okinawa Prefecture (adm1) BUT (Longitude < 124.5°E AND Latitude > 25°N AND ) => Senkaku Islands (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% c("Okinawa Prefecture") & (Biogeographic_database_Ponerinae_curated$Longitude_dec < 124.5) & (Biogeographic_database_Ponerinae_curated$Latitude_dec > 25), replace = FALSE)] <- "Senkaku Islands"

# Tokyo (adm1) => Kanto (Bentity2) but includes the Izu Islands, Ogasawara Islands, Volcano Islands

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "PER", ])
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "PER", ])


## Case 3: NA currently recorded but BENTITY2_N retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N),  c("matching_shp", "Latitude_dec", "Longitude_dec", "bentity2_name", "BENTITY2_N", "Locality", "adm2", "adm1", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "SUBUNIT")])

# Update bentity2_name for all the entries that were matching Country (so we assume they were right)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Countries[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N)])
Biogeographic_database_Ponerinae_curated$bentity2_name[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$matching_GB_Countries] <- Biogeographic_database_Ponerinae_curated$BENTITY2_N[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$matching_GB_Countries]

# Update bentity2_name for all the entries for which the retrieved BENTITY2_N match either Country_ISO3/Country_GB/SUBUNIT/adm1
table(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$Country_ISO3_name | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$Country_GB_name | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$SUBUNIT | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$adm1))
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$Country_ISO3_name | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$Country_GB_name | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$SUBUNIT | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & (Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$Country_ISO3_name | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$Country_GB_name | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$SUBUNIT | Biogeographic_database_Ponerinae_curated$BENTITY2_N == Biogeographic_database_Ponerinae_curated$adm1), replace = F)]

## Correct for systematic mistakes based on Country_ISO3_name when it is a valid Bentity2
Biogeographic_database_Ponerinae_curated$BENTITY2_N[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Panama"] <- "Panama"
Biogeographic_database_Ponerinae_curated$bentity2_name[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Panama"] <- "Panama"

Biogeographic_database_Ponerinae_curated$BENTITY2_N[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Eritrea"] <- "Eritrea"
Biogeographic_database_Ponerinae_curated$bentity2_name[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Eritrea"] <- "Eritrea"

Biogeographic_database_Ponerinae_curated$BENTITY2_N[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Paraguay"] <- "Paraguay"
Biogeographic_database_Ponerinae_curated$bentity2_name[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Paraguay"] <- "Paraguay"

## Manually correct for a case with coordinates falling on the border

# Locality = Mabira Forest
Mabira_Forest_entries <- which(replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mabira Forest"), replace = FALSE))

Biogeographic_database_Ponerinae_curated$Latitude_dec[Mabira_Forest_entries] <- 0.47389
Biogeographic_database_Ponerinae_curated$Longitude_dec[Mabira_Forest_entries] <- 33.007
Biogeographic_database_Ponerinae_curated$bentity2_name[Mabira_Forest_entries] <- "Uganda"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[Mabira_Forest_entries] <- "Uganda"
Biogeographic_database_Ponerinae_curated$adm1_shapeName[Mabira_Forest_entries] <- "Central Region"
Biogeographic_database_Ponerinae_curated$adm1[Mabira_Forest_entries] <- "Central Region"
Biogeographic_database_Ponerinae_curated$adm2[Mabira_Forest_entries] <- "Buikwe"
Biogeographic_database_Ponerinae_curated$adm2_shapeName[Mabira_Forest_entries] <- "Buikwe"
Biogeographic_database_Ponerinae_curated$matching_shp[Mabira_Forest_entries] <- "GB_adm2"
Biogeographic_database_Ponerinae_curated$matching_GB_adm2[Mabira_Forest_entries] <- TRUE
Biogeographic_database_Ponerinae_curated$matching_GB_adm1[Mabira_Forest_entries] <- TRUE
Biogeographic_database_Ponerinae_curated$matching_Bentity2[Mabira_Forest_entries] <- TRUE
Biogeographic_database_Ponerinae_curated$Uncertainty_area[Mabira_Forest_entries] <- set_units(st_area(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName == "Buikwe", "adm2_shapeName"]), km^2)[2]
Biogeographic_database_Ponerinae_curated$matching_shp_ID[Mabira_Forest_entries] <- which(geoBoundaries_adm2_sf$adm2_shapeName == "Buikwe")[2]
Biogeographic_database_Ponerinae_curated$multiple_matches[Mabira_Forest_entries] <- FALSE
Biogeographic_database_Ponerinae_curated$Interpolated_adm2[Mabira_Forest_entries] <- FALSE
Biogeographic_database_Ponerinae_curated$Interpolated_adm1[Mabira_Forest_entries] <- FALSE
Biogeographic_database_Ponerinae_curated$Uncertainty_adm2[Mabira_Forest_entries] <- 0
Biogeographic_database_Ponerinae_curated$Uncertainty_adm1[Mabira_Forest_entries] <- 0

# Locality = Lotti Forest in South Sudan
Lotti_Forest_entries <- which(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Lotti Forest"), replace = FALSE))

Biogeographic_database_Ponerinae_curated$bentity2_name[Lotti_Forest_entries] <- "Sudan"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[Lotti_Forest_entries] <- "Sudan"

# Locality = Imatong Mountains in South Sudan

Imatong_Mountains_entries <- which(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Imatong Mountains"), replace = FALSE))

Biogeographic_database_Ponerinae_curated$Latitude_dec[Imatong_Mountains_entries] <- 3.9474
Biogeographic_database_Ponerinae_curated$Longitude_dec[Imatong_Mountains_entries] <- 32.900
Biogeographic_database_Ponerinae_curated$bentity2_name[Imatong_Mountains_entries] <- "Sudan"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[Imatong_Mountains_entries] <- "Sudan"

# Locality = Bentson Rio Grande Valley

Bentson_entries <- which(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bentson Rio Grande Valley"), replace = FALSE))

Biogeographic_database_Ponerinae_curated$bentity2_name[Bentson_entries] <- "Texas"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[Bentson_entries] <- "Texas"

# Locality = Querari in Colombia (by the border of Brazil)

Querari_entries <- which(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Querari"), replace = FALSE))

Biogeographic_database_Ponerinae_curated$bentity2_name[Querari_entries] <- "Vaupes"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[Querari_entries] <- "Vaupes"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[Querari_entries] <- "Colombia"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[Querari_entries] <- "COL"
Biogeographic_database_Ponerinae_curated$Country_GB_name[Querari_entries] <- "Colombia"
Biogeographic_database_Ponerinae_curated$Country_shapeName[Querari_entries] <- "Colombia"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[Querari_entries] <- "Colombia"
Biogeographic_database_Ponerinae_curated$SUBUNIT[Querari_entries] <- "Colombia"

## All remaining cases are good matches and can be updated from BENTITY2_N
Biogeographic_database_Ponerinae_curated$bentity2_name[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N)] <- Biogeographic_database_Ponerinae_curated$BENTITY2_N[is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & !is.na(Biogeographic_database_Ponerinae_curated$BENTITY2_N)]


## Case 4: Bentity2 currently recorded does not match the BENTITY2_N retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[replace_na(data = (Biogeographic_database_Ponerinae_curated$bentity2_name != Biogeographic_database_Ponerinae_curated$BENTITY2_N), replace = FALSE),  c("matching_shp", "Latitude_dec", "Longitude_dec", "bentity2_name", "BENTITY2_N", "Locality", "adm2", "adm1", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "adm1_shapeName", "SUBUNIT")])

# Do not updates as there are cases of occurrences falling slightly across the borders
# Exception for cases where occurrence fall in the right place but Bentity2 name need to be updated (Look by BENTITY2_N match)

# Angola entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Angola", replace = F)] <- "Angola"
# Bismarck Archipelago entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Bismarck Archipelago", replace = F)] <- "Bismarck Archipelago"
# Borneo entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Borneo", replace = F)] <- "Borneo"
# Central African Republic entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Central African Republic", replace = F)] <- "Central African Republic"
# Chile_c entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Chile_c", replace = F)] <- "Chile_c"
# Chugoku entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Chugoku", replace = F)] <- "Chugoku"
# Cocos Island (Costa Rica) entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Cocos Island (Costa Rica)", replace = F)] <- "Cocos Island (Costa Rica)"
# Colima entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Colima", replace = F)] <- "Colima"
# Eritrea entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Eritrea", replace = F)] <- "Eritrea"
# Gujarat entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Gujarat", replace = F)] <- "Gujarat"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Gujarat", replace = F)] <- "Gujarat"
# Guyana entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Guyana", replace = F)] <- "Guyana"
# Israel and Palestine entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Israel and Palestine", replace = F)] <- "Israel and Palestine"
# Jeju Island entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Jeju Island", replace = F)] <- "Jeju Island"
# Jordan entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Jordan", replace = F)] <- "Jordan"
# Lesser Sunda Islands entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lesser Sunda Islands", replace = F)] <- "Lesser Sunda Islands"
# Lord Howe Island entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Lord Howe Island", replace = F)] <- "Lord Howe Island"
# Loyalty Islands entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Loyalty Islands", replace = F)] <- "Loyalty Islands"
# Madhya Pradesh entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Madhya Pradesh", replace = F)] <- "Madhya Pradesh"
# Montenegro entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Montenegro", replace = F)] <- "Montenegro"
# Namibia entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Namibia", replace = F)] <- "Namibia"
# Nias Island entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Nias Island", replace = F)] <- "Nias Island"
# Okinawa entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Okinawa", replace = F)] <- "Okinawa"
# Satsunan Islands entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Satsunan Islands", replace = F)] <- "Satsunan Islands"
# Solomon Islands entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Solomon Islands", replace = F)] <- "Solomon Islands"
# Tohoku entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Tohoku", replace = F)] <- "Tohoku"
# Trinidad and Tobago entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Trinidad and Tobago", replace = F)] <- "Trinidad and Tobago"
# Vaupes entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Vaupes", replace = F)] <- "Vaupes"
# Vichada entries from Colombia are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Vichada" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Colombia", replace = F)] <- "Vichada"
# Yaeyama Islands entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Yaeyama Islands", replace = F)] <- "Yaeyama Islands"
# Zanzibar Archipelago entries are valid
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Zanzibar Archipelago", replace = F)] <- "Zanzibar Archipelago"

# Locality Dolo Sped. Brunelli is in Ethiopia as retrieved, not Somalia
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Dolo Sped. Brunelli", replace = F)] <- "Ethiopia"

# Locality = Lusaka is in Zambia
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Lusaka", replace = F)] <- "Zambia"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Lusaka", replace = F)] <- "Zambia"

# Locality Norfolk has wrong coordinates in Queensland
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- "Norfolk Island"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- "Norfolk Island"
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- -29.0303
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- 167.9567
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- "Norfolk Island"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- "NFK"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- "Norfolk Island"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(Biogeographic_database_Ponerinae_curated$Locality == "Norfolk" & Biogeographic_database_Ponerinae_curated$Country_GB_name == "Australia", replace = F)] <- "Norfolk Island"

# Locality = Batulicin is in South Kalimantan
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "W Batulicin"), replace = F)] <- -3.9537
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "W Batulicin"), replace = F)] <- 114.8753
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "W Batulicin"), replace = F)] <- "Borneo"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "W Batulicin"), replace = F)] <- "Borneo"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "W Batulicin"), replace = F)] <- "South Kalimantan"
Biogeographic_database_Ponerinae_curated$adm1_shapeName[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "W Batulicin"), replace = F)] <- "South Kalimantan"

# Locality Madikwe Game Reserve is in South Africa
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Madikwe Game Reserve"), replace = F)] <- "South Africa"

# Locality = Mbabane is in eSwatini/Swaziland
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "Swaziland"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "Swaziland"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "eSwatini"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "SWZ"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "Swaziland"
Biogeographic_database_Ponerinae_curated$Country_shapeName[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "Swaziland"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "eSwatini"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mbabane"), replace = F)] <- "eSwatini"

# Locality = Botswana is in Botswana
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "BWA"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$Country_shapeName[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Botswana"), replace = F)] <- "Botswana"

# Locality = Puntarenas is in Costa Rica
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Puntarenas" & Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Thailand"), replace = F)] <- 8.5922
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Puntarenas" & Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Thailand"), replace = F)] <- -83.506
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Puntarenas" & Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Thailand"), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$SUBUNIT[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Puntarenas" & Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Thailand"), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Puntarenas" & Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Thailand"), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na((Biogeographic_database_Ponerinae_curated$Locality == "Puntarenas" & Biogeographic_database_Ponerinae_curated$BENTITY2_N == "Thailand"), replace = F)] <- "Costa Rica"

# Locality = Yaku Island is in Satsunan Islands, and need new coordinates...
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yaku Island"), replace = F)] <- 30.327
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yaku Island"), replace = F)] <- 130.593
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yaku Island"), replace = F)] <- "Satsunan Islands"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yaku Island"), replace = F)] <- "Satsunan Islands"

# All Macao S.A.R (Country_ISO3) should be in Macau (Bentity2)
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Macao S.A.R", replace = F)] <- "Macau"
Biogeographic_database_Ponerinae_curated$BENTITY2_N[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Macao S.A.R", replace = F)] <- "Macau"

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "CRI", ])
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "CRI", ])

table(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name))

## Save Biogeographic database with all curated coordinates
# saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


### 4.3.4/ For GB_adm1 ####

##### DO not update automatically if higher level did not match !!!! Because it probably means the coordinates is slightly incorrect....

# Flag mismatches between current adm1 and Intersecting GB_adm1
Biogeographic_database_Ponerinae_curated$matching_GB_adm1 <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1 == Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm1)

# Flag mismatches between current adm1 and Nearest GB_adm1
Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1 == Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest)

# Flag mismatches between Intersecting GB_adm1 and Nearest GB_adm1
Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest_vs_intersect <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1_shapeName == Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest_vs_intersect, is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName))

# Flag mismatches between GB_Country_name and Nearest GB_Country to detect potential error in Nearest shp retrieval
Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_GB_name == Biogeographic_database_Ponerinae_curated$GB_Country_Nearest), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest, is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name))


## Case n°1: GB_adm1 currently recorded AND NA retrieved from intersecting shp (adm1_shapeName)

# Three cases:
  # 1/ The coordinates falls in a waterbody and is close to its true location => Can use nearest polygon. Should correct coordinates.
  # 2/ The coordinates falls in a waterbody and is a mistake => CANNOT use nearest polygon. Need to correct coordinates.
  # 3/ The coordinates falls on land, but this land is not included in geoBoundaries shape files => Should remain a true NA. Coordinates are fine.

# Check if the current adm1 are valid adm1 names
GB_adm1_validity_test <- replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% geoBoundaries_adm1_sf$adm1_shapeName, replace = F)
table(GB_adm1_validity_test, is.na(Biogeographic_database_Ponerinae_curated$adm1))

# Adjust invalid adm1 names for potential misspelling
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !GB_adm1_validity_test,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

# Algarve Province = FARO
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Algarve Province", replace = FALSE)] <- "FARO"
# Amapá = Amapa
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Amapá", replace = FALSE)] <- "Amapa"
# Balearic Islands = Illes Balears
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Balearic Islands", replace = FALSE)] <- "Illes Balears"
# Balearic Islands = Illes Balears
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Balearic Islands", replace = FALSE)] <- "Illes Balears"
# Bismarck Is. = Manus Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Bismarck Is.", replace = FALSE)] <- "Manus Province"
# Cádiz = Andalucía
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Cádiz", replace = FALSE)] <- "Andalucía"
# Cakaudrove Province = Northern
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Cakaudrove Province", replace = FALSE)] <- "Northern"
# Canary Islands = Canarias
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Canary Islands", replace = FALSE)] <- "Canarias"
# Castries Parish = Castries
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Castries Parish", replace = FALSE)] <- "Castries"
# Cayenne = NA (Not adm1 in French Guyana)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Cayenne", replace = FALSE)] <- NA
# Ceará = Ceara
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Ceará", replace = FALSE)] <- "Ceara"
# Central Division = Central
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Central Division" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Fiji", replace = FALSE)] <- "Central"
# Central Visayas Region = Central Visayas
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Central Visayas Region", replace = FALSE)] <- "Central Visayas"
# Chalkidiki Prefecture = Macedonia-Thrace
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Chalkidiki Prefecture", replace = FALSE)] <- "Macedonia-Thrace"
# Choco = Chocó
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Choco" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Colombia", replace = FALSE)] <- "Chocó"
# Choiseul Province = Choiseul
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Choiseul Province", replace = FALSE)] <- "Choiseul"
# Christmas Island = Other Territories
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Christmas Island", replace = FALSE)] <- "Other Territories"
# Clipperton Island = NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Clipperton Island", replace = FALSE)] <- NA
# Cocos (Keeling) Islands = Other Territories
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Cocos (Keeling) Islands", replace = FALSE)] <- "Other Territories"
# East Sepik = East Sepik Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "East Sepik", replace = FALSE)] <- "East Sepik Province"
# Espírito Santo = Espirito Santo
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Espírito Santo", replace = FALSE)] <- "Espirito Santo"
# Fukuoka = Fukuoka Prefecture
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Fukuoka", replace = FALSE)] <- "Fukuoka Prefecture"
# Gangwon Province = Gangwon
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Gangwon Province", replace = FALSE)] <- "Gangwon"
# Gibraltar = NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Gibraltar", replace = FALSE)] <- NA
# Grand Anse Praslin = Grand Anse
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Grand Anse Praslin", replace = FALSE)] <- "Grand Anse"
# Gros-islet = Gros Islet
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Gros-islet", replace = FALSE)] <- "Gros Islet"
# Guadalcanal Province = Guadalcanal
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Guadalcanal Province", replace = FALSE)] <- "Guadalcanal"
# Guanacaste = Provincia Guanacaste
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Guanacaste", replace = FALSE)] <- "Provincia Guanacaste"
# Guantanamo = Guantánamo
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Guantanamo", replace = FALSE)] <- "Guantánamo"
# Gyeonggi Province = Gyeonggi
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Gyeonggi Province", replace = FALSE)] <- "Gyeonggi"
# Hatahobei = Hatohobei
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Hatahobei", replace = FALSE)] <- "Hatohobei"
# Hong Kong = Hong Kong Special Administrative Region
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Hong Kong", replace = FALSE)] <- "Hong Kong Special Administrative Region"
# Hyōgo = Hyogo Prefecture
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Hyōgo", replace = FALSE)] <- "Hyogo Prefecture"
# Irian Jaya = West Papua
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Irian Jaya", replace = FALSE)] <- "West Papua"
# Isabel Province = Isabel
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Isabel Province", replace = FALSE)] <- "Isabel"
# Islas de la Bahia = Bay Islands
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Islas de la Bahia", replace = FALSE)] <- "Bay Islands"
# Islas de la Bahía = Bay Islands
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Islas de la Bahía", replace = FALSE)] <- "Bay Islands"
# Isola di Palmaria = Palmaria
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Isola di Palmaria", replace = FALSE)] <- "Palmaria"
# izabal = Izabal
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "izabal", replace = FALSE)] <- "Izabal"
# Kadavu = Eastern
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Kadavu", replace = FALSE)] <- "Eastern"
# Kadavu Province = Eastern
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Kadavu Province", replace = FALSE)] <- "Eastern"
# Kagoshima = Kagoshima Prefecture
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Kagoshima", replace = FALSE)] <- "Kagoshima Prefecture"
# Kanagawa Prefecture = Kanagawa
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Kanagawa Prefecture", replace = FALSE)] <- "Kanagawa"
# Kongo Central = Kongo-Central
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Kongo Central", replace = FALSE)] <- "Kongo-Central"
# Kwazulu-Natal = KwaZulu-Natal
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "KwaZulu-Natal", replace = FALSE)] <- "KwaZulu-Natal"
# La Altagracia Province = La Altagracia
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "La Altagracia Province", replace = FALSE)] <- "La Altagracia"
# Lanao del Sur (adm1) = ARMM (adm1) ; Lanao del Sur (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Lanao del Sur", replace = FALSE)] <- "Lanao del Sur"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lanao del Sur", replace = FALSE)] <- "ARMM"
# Languedoc-Roussillon = Occitanie
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Languedoc-Roussillon", replace = FALSE)] <- "Occitanie"
# Lau (adm1) = Central (adm1) ; Lau (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Lau", replace = FALSE)] <- "Lau"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lau", replace = FALSE)] <- "Central"
# Lau Province (adm1) = Central (adm1) ; Lau (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Lau Province", replace = FALSE)] <- "Lau"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lau Province", replace = FALSE)] <- "Central"
# Pontine Islands (bentity2) = Centro (adm1) ; Lazio (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Pontine Islands", replace = FALSE)] <- "Lazio"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Pontine Islands", replace = FALSE)] <- "Centro"
# Liguria (adm1) = Centro (adm1) ; Liguria (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Liguria", replace = FALSE)] <- "Liguria"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Liguria", replace = FALSE)] <- "Centro"
# Limón = Provincia Limón
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Limón", replace = FALSE)] <- "Provincia Limón"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Limon", replace = FALSE)] <- "Provincia Limón"
# Litoral = Litoral Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Litoral", replace = FALSE)] <- "Litoral Province"
# Lomaiviti (adm1) = Eastern (adm1) ; Lomaiviti (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Lomaiviti", replace = FALSE)] <- "Lomaiviti"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lomaiviti", replace = FALSE)] <- "Eastern"
# Lomaiviti Province (adm1) = Eastern (adm1) ; Lomaiviti (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Lomaiviti Province", replace = FALSE)] <- "Lomaiviti"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lomaiviti", replace = FALSE)] <- "Eastern"
# Lord Howe Island (adm1) = New South Wales (adm1) ; Unincorporated NSW (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Lord Howe Island", replace = FALSE)] <- "Unincorporated NSW"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lord Howe Island", replace = FALSE)] <- "New South Wales"
# Macedonia = Macedonia-Thrace
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Macedonia", replace = FALSE)] <- "Macedonia-Thrace"
# Madang = Madang Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Madang", replace = FALSE)] <- "Madang Province"
# Makira-Ulawa Province = Makira
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Makira-Ulawa Province", replace = FALSE)] <- "Makira"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Makira-Ulawa", replace = FALSE)] <- "Makira"
# Malaita Province = Malaita
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Malaita Province", replace = FALSE)] <- "Malaita"
# Mallorca = Illes Balears
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mallorca", replace = FALSE)] <- "Illes Balears"
# Maluku Province = Maluku
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Maluku Province", replace = FALSE)] <- "Maluku"
# Maluku Utara = North Maluku
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Maluku Utara", replace = FALSE)] <- "North Maluku"
# Manus = Manus Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Manus", replace = FALSE)] <- "Manus Province"
# Martinique = NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Martinique", replace = FALSE)] <- NA
# Mayotte = NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mayotte", replace = FALSE)] <- NA
# Miyagi Prefecture = Miyagi
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Miyagi Prefecture", replace = FALSE)] <- "Miyagi"
# Mohéli = Moheli
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mohéli", replace = FALSE)] <- "Moheli"
# Monte Cristi Province = Monte Cristi
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Monte Cristi Province", replace = FALSE)] <- "Monte Cristi"
# Morobe = Morobe Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Morobe", replace = FALSE)] <- "Morobe Province"
# Nadroga-Navosa Province (adm1) = Western (adm1) ; Nadroga-Navosa Province (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Nadroga-Navosa Province", replace = FALSE)] <- "Nadroga-Navosa"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Nadroga-Navosa", replace = FALSE)] <- "Western"
# Negros Oriental (adm1) = Central Visayas (adm1) ; Negros Oriental (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Negros Oriental", replace = FALSE)] <- "Negros Oriental"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Negros Oriental", replace = FALSE)] <- "Central Visayas"
# New Georgia = Western
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "New Georgia", replace = FALSE)] <- "Western"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kolombangara"), replace = FALSE)] <- "Gizo-Kolombangara"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(string = Biogeographic_database_Ponerinae_curated$Locality, pattern = "Gizo"), replace = FALSE)] <- "Gizo-Kolombangara"
# Nggela (adm1) = Central (adm1) ; Nggela (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Nggela", replace = FALSE)] <- "Nggela"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Nggela", replace = FALSE)] <- "Central"
# North Gyeongsang Province = North Gyeongsang
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "North Gyeongsang Province", replace = FALSE)] <- "North Gyeongsang"
# Nusa Tenggara Timur = East Nusa Tenggara
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Nusa Tenggara Timur", replace = FALSE)] <- "East Nusa Tenggara"
# Nyanga Province = Nyanga
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Nyanga Province", replace = FALSE)] <- "Nyanga"
# null = NA (temporarily)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "null", replace = FALSE)] <- NA
# Palmaria (adm1) = Nord-Ovest (adm1) ; Palmaria (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Palmaria", replace = FALSE)] <- "Palmaria"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Palmaria", replace = FALSE)] <- "Nord-Ovest"
# Panama (adm1) = Provincia de Panamá (adm1)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Panama", replace = FALSE)] <- "Provincia de Panamá"
# Pará = Para
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Pará", replace = FALSE)] <- "Para"
# Paraíba = Paraiba
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Paraíba", replace = FALSE)] <- "Paraiba"
# Pedernales Province = Pedernales
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Pedernales Province", replace = FALSE)] <- "Pedernales"
# Peloponese = Peloponisos-W. Greece & Ionian
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Peloponese", replace = FALSE)] <- "Peloponisos-W. Greece & Ionian"
# Pointe-à-Pitre = NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Pointe-à-Pitre", replace = FALSE)] <- NA
# Pontevedra (adm1) = Galicia (adm1) ; Pontevedra (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Pontevedra", replace = FALSE)] <- "Pontevedra"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Pontevedra", replace = FALSE)] <- "Galicia"
# Provence-Alpes-Cote d'Azur = Provence-Alpes-Côte d'Azur
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Provence-Alpes-Cote d'Azur", replace = FALSE)] <- "Provence-Alpes-Côte d'Azur"
# Puntarenas = Provincia Puntarenas
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Puntarenas", replace = FALSE)] <- "Provincia Puntarenas"
# Pwani region = Pwani
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Pwani region", replace = FALSE)] <- "Pwani"
# Ra (adm1) = Western (adm1) ; Ra (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Ra", replace = FALSE)] <- "Ra"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Ra", replace = FALSE)] <- "Western"
# Rennell and Bellona Province = Rennell and Bellona
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Rennell and Bellona Province", replace = FALSE)] <- "Rennell and Bellona"
# Rennell Is. = Rennell and Bellona
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Rennell Is.", replace = FALSE)] <- "Rennell and Bellona"
# Rio de Janeiro = Rio de Jeneiro
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Rio de Janeiro", replace = FALSE)] <- "Rio de Jeneiro"
# Rio Grande (adm1) = Puerto Rico (adm1) ; Río Grande (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Rio Grande" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Puerto Rico", replace = FALSE)] <- "Río Grande"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Río Grande" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Puerto Rico", replace = FALSE)] <- "Puerto Rico"
# Russell Is. (adm1) = Central (adm1) ; Savo-Russull Islands (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Russell Is.", replace = FALSE)] <- "Savo-Russull Islands"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Savo-Russull Islands", replace = FALSE)] <- "Central"
# Locality = Old Booby Hill, Spring Bay Trail => Saba Island: does not have adm1 and adm2
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Old Booby Hill, Spring Bay Trail", replace = FALSE)] <- "Saba Island, Old Booby Hill, Spring Bay Trail"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Saba Island, Old Booby Hill, Spring Bay Trail", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Saba Island, Old Booby Hill, Spring Bay Trail", replace = FALSE)] <- NA
# Saint-Laurent-du-Maroni (in French Guiana) => no adm1 and adm2
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint-Laurent-du-Maroni", replace = FALSE)] <- NA
# Saint Andrew Parish = Saint Andrew
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint Andrew Parish", replace = FALSE)] <- "Saint Andrew"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint Andrew", replace = FALSE)] <- "Saint Andrew"
# Saint Anthony Parish (Montserrat) = NA (no adm1 and adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Montserrat" , replace = FALSE)] <- NA
# Saint David Parish = Saint David
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint David Parish", replace = FALSE)] <- "Saint David"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint David", replace = FALSE)] <- "Saint David"
# Saint George Parish = Saint George
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint George Parish", replace = FALSE)] <- "Saint George"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint George", replace = FALSE)] <- "Saint George"
# Saint Peter Parish = Saint Peter
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint Peter Parish", replace = FALSE)] <- "Saint Peter"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint Peter", replace = FALSE)] <- "Saint Peter"
# Saint Laurent du Maroni (in French Guiana) => no adm1 and adm2
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "French Guiana" , replace = FALSE)] <- NA
# Saint Michael Parish = Saint Michael
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint Michael Parish", replace = FALSE)] <- "Saint Michael"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Saint Michael", replace = FALSE)] <- "Saint Michael"
# Samaná Province = Samaná
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Samaná Province" , replace = FALSE)] <- "Samaná"
# San Cristobal = Makira
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "San Cristobal" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Solomon Islands", replace = FALSE)] <- "Makira"
# Sangre Grande Regional Corporation = Sangre Grande (adm1 and adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Sangre Grande Regional Corporation", replace = FALSE)] <- "Sangre Grande"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Sangre Grande", replace = FALSE)] <- "Sangre Grande"
# Santa Cruz Gp. = Temotu
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Santa Cruz Gp." , replace = FALSE)] <- "Temotu"
# São Paulo = Sao Paulo
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "São Paulo" , replace = FALSE)] <- "Sao Paulo"
# São Tomé = São Tomé Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "São Tomé" , replace = FALSE)] <- "São Tomé Province"
# Sava Region = Sava
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Sava Region" , replace = FALSE)] <- "Sava"
# Sava Region = Sava
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Sava Region" , replace = FALSE)] <- "Sava"
# Santo Domingo Province = Santo Domingo
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Santo Domingo Province" , replace = FALSE)] <- "Santo Domingo"
# Shanghai = Shanghai Municipality
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Shanghai" , replace = FALSE)] <- "Shanghai Municipality"
# Sonsorol State = Sonsorol (adm1) and Sonsorol + Pulo Anna + Merir (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Sonsorol State" , replace = FALSE)] <- "Sonsorol"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Sonsorol" , replace = FALSE)] <- "Sonsorol + Pulo Anna + Merir"
# South Chungcheong Province = South Chungcheong
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "South Chungcheong Province" , replace = FALSE)] <- "South Chungcheong"
# South Gyeongsang Province = South Gyeongsang
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "South Gyeongsang Province" , replace = FALSE)] <- "South Gyeongsang"
# South Jeolla Province = South Jeolla
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "South Jeolla Province" , replace = FALSE)] <- "South Jeolla"
# Tacloban = Eastern Visayas (adm1) and Leyte
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Tacloban" , replace = FALSE)] <- "Eastern Visayas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Tacloban" , replace = FALSE)] <- "Leyte"
# Temotu Province = Temotu
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Temotu Province" , replace = FALSE)] <- "Temotu"
# Tinh Khanh Hoa = Khánh Hòa
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Tinh Khanh Hoa" , replace = FALSE)] <- "Khánh Hòa"
# Tokyo Prefecture = Tokyo
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Tokyo Prefecture" , replace = FALSE)] <- "Tokyo"
# British Virgin Islands (Country ISO3) => no adm1 and adm2
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "British Virgin Islands", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "British Virgin Islands", replace = FALSE)] <- NA
# Truk Islands = Chuuk
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Truk Islands", replace = FALSE)] <- "Chuuk"
# Tsarevo (adm1) = Burgas (adm1) ; Tsarevo (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Tsarevo", replace = FALSE)] <- "Tsarevo"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Tsarevo", replace = FALSE)] <- "Burgas"
# Veracruz (in Mexico) = Veracruz de Ignacio de la Llave
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Veracruz" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico", replace = FALSE)] <- "Veracruz de Ignacio de la Llave"
# Vieques Municipality (adm1) = Puerto Rico (adm1) ; Vieques (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Vieques Municipality", replace = FALSE)] <- "Vieques"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Vieques", replace = FALSE)] <- "Puerto Rico"
# Bermuda (Country ISO3) => no adm1 and adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Bermuda", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Bermuda", replace = FALSE)] <- NA
# Wellington = Wellington Region (adm1) ; Wellington City (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Wellington", replace = FALSE)] <- "Wellington City"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Wellington City", replace = FALSE)] <- "Wellington Region"
# West Papua Province = West Papua
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "West Papua Province", replace = FALSE)] <- "West Papua"
# West Papua Province [Irian Jaya] = West Papua
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "West Papua Province [Irian Jaya]", replace = FALSE)] <- "West Papua"
# Western Division (in Fiji) = Western
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Western Division" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Fiji", replace = FALSE)] <- "Western"
# Yap Group / Yap State = Yap
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Yap Group", replace = FALSE)] <- "Yap"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Yap State", replace = FALSE)] <- "Yap"
# Zambales (adm1) = Central Luzon (adm1) ; Zambales (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Zambales", replace = FALSE)] <- "Zambales"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Zambales", replace = FALSE)] <- "Central Luzon"
# Zhejiang = Zhejiang Province
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Zhejiang", replace = FALSE)] <- "Zhejiang Province"

# Antsiranana (Madagascar) => Use either Diana or Sava according to nearest adm1 match
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Antsiranana" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Antsiranana" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Antisiranana (Madagascar) => Use either Diana or Sava according to nearest adm1 match
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Antisiranana" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Antisiranana" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Antsiranana Province (Madagascar) => Use either Diana or Sava according to nearest adm1 match
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Antsiranana Province" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Antsiranana Province" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Diego-Suarez (Madagascar) => Use either Diana or Sava according to nearest adm1 match
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Diego-Suarez" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Diego-Suarez" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Toamasina (Madagascar) => Use either Analanjirofo or Atsinanana according to nearest adm1 match. Also update adm2 using nearest adm2 match
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Toamasina Province (Madagascar) => Use either Analanjirofo or Atsinanana according to nearest adm1 match. Also update adm2 using nearest adm2 match
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina Province" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina Province" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina Province" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toamasina Province" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Toliara (Madagascar) => Use either Anosy or Atsimo-Andrefana according to nearest adm1 match. Also update adm2 using nearest adm2 match
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toliara" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toliara" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toliara" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Toliara" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Fianarantsoa (Madagascar) => Use Vatovavy-Fitovinany according to nearest adm1 match. Also update adm2 using nearest adm2 match
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Fianarantsoa" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Fianarantsoa" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Fianarantsoa" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Fianarantsoa" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Mahajanga (Madagascar) => Use Sofia according to nearest adm1 match. Also update adm2 using nearest adm2 match
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mahajanga" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mahajanga" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mahajanga" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Mahajanga" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
# Singapore => Use adm1 according to nearest adm1 match. Also update adm2 using nearest adm2 match
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Singapore" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Singapore" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Singapore" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 == "Singapore" & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]


# Locality = Siboney => Havana (adm1), Arroyo Naranjo (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Siboney"), replace = FALSE)] <- "Havana"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Siboney"), replace = FALSE)] <- "Arroyo Naranjo"
# Locality = Beqa Island (-18.400000, 178.13300) => Central (adm1) and Rewa (adm2)
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Latitude_dec == -18.400000 & Biogeographic_database_Ponerinae_curated$Longitude_dec == 178.13300, replace = FALSE)] <- "Beqa Island"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Beqa Island", replace = FALSE)] <- "Central"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Beqa Island", replace = FALSE)] <- "Rewa"
# Locality = Praia => Praia (adm1)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Praia") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Cabo Verde", replace = FALSE)] <- "Praia"
# Locality = Playon Rincon => Samaná (adm1) and Santa Bárbara de Samaná (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Playon Rincon") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Dominican Republic", replace = FALSE)] <- "Samaná"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Playon Rincon") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Dominican Republic", replace = FALSE)] <- "Santa Bárbara de Samaná"
# Locality = Castelnuovo => Herceg Novi Municipality (adm1 and adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Castelnuovo") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Montenegro", replace = FALSE)] <- "Herceg Novi Municipality"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Castelnuovo") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Montenegro", replace = FALSE)] <- "Herceg Novi Municipality"
# Locality = Tortuguero => Provincia Limón (adm1) and Pococi (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tortuguero"), replace = FALSE)] <- "Provincia Limón"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tortuguero"), replace = FALSE)] <- "Pococi"

## Look at current valid adm1 entries

## Check the valid adm1 entries without intersecting adm1, but a matching nearest adm1. Check if there is any reason not to use the current/nearest adm1
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

# Use all nearest adm1 AND adm2 as valid.
Biogeographic_database_Ponerinae_curated$adm2[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest]

# Modify manually exceptions when nearest adm2 is invalid
# Locality = Presidio in California => adm2 = San Francisco
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Presidio" & Biogeographic_database_Ponerinae_curated$adm1 == "California", replace = FALSE)] <- "San Francisco"
# Locality = Marinella di Sarzana => adm2 = Liguria
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Marinella di Sarzana", replace = FALSE)] <- "Liguria"

# Locality = Isla Clarion => adm1 = Colima ; adm2 = NA ; Revillagigedo Islands (bentity2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Isla Clarion"), replace = FALSE)] <- "Colima"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Isla Clarion"), replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Isla Clarion"), replace = FALSE)] <- "Revillagigedo Islands"

# Locality = Tall Timbers Research Station => Adjust coordinates. Florida (adm1) ; Leon County (adm2)
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tall Timbers Research Station"), replace = FALSE)] <- 30.6559
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tall Timbers Research Station"), replace = FALSE)] <- -84.2089
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tall Timbers Research Station"), replace = FALSE)] <- "Florida"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tall Timbers Research Station"), replace = FALSE)] <- "Leon County"

# Locality = Siboney => Havana (adm1), Arroyo Naranjo (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Siboney"), replace = FALSE)] <- "Havana"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Siboney"), replace = FALSE)] <- "Arroyo Naranjo"

# Locality = Palmaria => Palmaria (adm2) 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Palmaria"), replace = FALSE)] <- "Palmaria"

# Country_ISO3 = Hong Kong. No adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Hong Kong S.A.R.", replace = FALSE)] <- NA

# Lord Howe Island (Locality)
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lord Howe Island", replace = FALSE)] <- "Lord Howe Island"

# Locality = Whitsunday Islands (-20.445550, 149.04249) => adm1 = Queensland ; adm2 = Whitsunday
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Latitude_dec == -20.445550 & Biogeographic_database_Ponerinae_curated$Longitude_dec == 149.04249, replace = FALSE)] <- "Whitsunday Islands"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Whitsunday Islands", replace = FALSE)] <- "Queensland"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Whitsunday Islands", replace = FALSE)] <- "Whitsunday"

## Check the valid adm1 entries without intersecting adm1, and a non matching nearest adm1. Maybe an error to correct
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

# Update only the one with a matching GB_country
Biogeographic_database_Ponerinae_curated$adm1[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]
Biogeographic_database_Ponerinae_curated$adm2[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & GB_adm1_validity_test & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]

# Manually correct for entires that should not have been updated based on Nearest
# Locality Gorgona in Colombia => adm1 = Cauca, bentity2 = Cauca, adm2 = Guapi
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Gorgona") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Colombia", replace = FALSE)] <- "Cauca"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Gorgona") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Colombia", replace = FALSE)] <- "Cauca"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Gorgona") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Colombia", replace = FALSE)] <- "Guapi"

# Locality Ventotene => adm1 = Centro, bentity2 = Pontine Islands, adm2 = Lazio
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ventotene"), replace = FALSE)] <- "Pontine Islands"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ventotene"), replace = FALSE)] <- "Centro"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ventotene"), replace = FALSE)] <- "Lazio"

# Eastern in Fiji => Bad adm1 shp needs to be updated from adm2 (Lomaiviti)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lomaiviti", replace = FALSE)] <- "Eastern"

# Guangxi Zhuang Autonomous Region in China => Bad adm1 shp needs to be updated from adm2 (Fangchenggangshi)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Fangchenggangshi", replace = FALSE)] <- "Guangxi Zhuang Autonomous Region"

# Country_ISO3 = Hong Kong. adm1 = "Hong Kong Special Administrative Region". No adm2.
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Hong Kong S.A.R.", replace = FALSE)] <- "Hong Kong Special Administrative Region"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Hong Kong S.A.R.", replace = FALSE)] <- NA

# Locality = Samsan-myeon (37.697445, 126.31462) => Incheon (adm1) and Ganghwa-gun (adm2)
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(21996, 21998), replace = FALSE)] <- "Samsan-myeon"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Samsan-myeon", replace = FALSE)] <- "Incheon"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Samsan-myeon", replace = FALSE)] <- "Ganghwa-gun"
# Locality = Bukpori => Incheon (adm1) and Ongjin-gun (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Bukpori", replace = FALSE)] <- "Incheon"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Bukpori", replace = FALSE)] <- "Ongjin-gun"

# Entry n°25992 = Yoron (Locality) ; Kagoshima Prefecture (adm1) ; NA (adm2)
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(25992), replace = FALSE)] <- "Yoron"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Samsan-myeon", replace = FALSE)] <- "Kagoshima Prefecture"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Samsan-myeon", replace = FALSE)] <- NA

# Locality = 23 km NE of Baeza (Locality) ; Napo (adm1) ; Santa Rosa (adm2)
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- -0.197
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- -77.707
Biogeographic_database_Ponerinae_curated$Uncertainty_area[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- set_units(567.43442, km^2)
Biogeographic_database_Ponerinae_curated$Uncertainty_adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- 0
Biogeographic_database_Ponerinae_curated$Uncertainty_adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- 0
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- "Napo"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "23 km NE of Baeza", replace = FALSE)] <- "Santa Rosa"

# Country_ISO3 = New Caledonia. No adm1. No adm2.
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Caledonia", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Caledonia", replace = FALSE)] <- NA

# Locality = 143 => North Gyeongsang (adm1) ; Uljin-gun (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "143", replace = FALSE)] <- "North Gyeongsang"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "143", replace = FALSE)] <- "Uljin-gun"

# Locality = Torres, Rio Grande do Sul => Rio Grande do Sul (adm1) ; Torres (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torres, Rio Grande do Sul"), replace = FALSE)] <- "Rio Grande do Sul"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torres, Rio Grande do Sul"), replace = FALSE)] <- "Torres"

# Locality = Andai => West Papua (adm1) ; Manokwari Selatan (adm2)
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Andai", replace = FALSE)] <- -0.9200
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Andai", replace = FALSE)] <- 134.0097
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Andai", replace = FALSE)] <- "West Papua"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Andai", replace = FALSE)] <- "Manokwari Selatan"

# Locality = nr. Townsville 
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "nr. Townsville", replace = FALSE)] <- -19.2746
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "nr. Townsville", replace = FALSE)] <- 146.7956
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "nr. Townsville", replace = FALSE)] <- "Queensland"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "nr. Townsville", replace = FALSE)] <- "Townsville"

# Torres Strait Island (adm2) + bentity2 (Torres Strait Islands) in Australia => Murray Island, Torres Strait, Dauan Island, 
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Murray Island") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Australia", replace = FALSE)] <- "Torres Strait Islands"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Murray Island") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Australia", replace = FALSE)] <- "Torres Strait Island"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torres Strait") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Australia", replace = FALSE)] <- "Torres Strait Islands"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torres Strait") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Australia", replace = FALSE)] <- "Torres Strait Island"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dauan Island") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Australia", replace = FALSE)] <- "Torres Strait Islands"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dauan Island") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Australia", replace = FALSE)] <- "Torres Strait Island"


## Case n°2: NA currently recorded AND NA retrieved from intersecting shp (sort by Country_ISO3_name)

# Three cases:
  # 1/ The coordinates falls in a waterbody and is close to its true location => Can use nearest polygon. Should correct coordinates.
  # 2/ The coordinates falls in a waterbody and is a mistake => CANNOT use nearest polygon. Need to correct coordinates.
  # 3/ The coordinates falls on land, but this land is not included in geoBoundaries shape files => Should remain a true NA. Coordinates are fine.

# Check cases where nearest country do not match (likely a piece of land not in sf shape files so should stay as NA)
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

# Marshall Islands (country ISO3) => Use nearest adm1 and adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Marshall Islands" & is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Marshall Islands" & is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Marshall Islands" & is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Marshall Islands" & is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName), replace = FALSE)]

# Bentity2 = Senkaku Islands => Senkakus (adm1) ; Senkakus (adm2)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Senkaku Islands", replace = FALSE)] <- "Senkakus"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Senkaku Islands", replace = FALSE)] <- "Senkakus"

# Locality = Reserva Nacional Yasuni => Orellana (adm1) ; Orellana (adm2)
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- -0.6534
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- -76.0707
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- "Orellana"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- "Orellana"
Biogeographic_database_Ponerinae_curated$Uncertainty_area[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- set_units(21399.319, km^2)
Biogeographic_database_Ponerinae_curated$Uncertainty_adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- 0
Biogeographic_database_Ponerinae_curated$Uncertainty_adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni") & Biogeographic_database_Ponerinae_curated$matching_shp == "Bentity2", replace = FALSE)] <- 0

# Locality = Petit Saint Vincent Island => Grenadines (adm1) ; Grenadines (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Petit Saint Vincent Island"), replace = FALSE)] <- "Grenadines"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Petit Saint Vincent Island"), replace = FALSE)] <- "Grenadines"

# Locality = Gibraltar
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gibraltar", replace = FALSE)] <- "Gibraltar"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gibraltar", replace = FALSE)] <- "GIB"


# Check cases where nearest country match (coordinates in water?) => Trust nearest? or Keep as NA?
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

# Locality = Mont Chongui => in Mayotte (SUBUNIT)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Mont Chongui summit", replace = FALSE)] <- "Mayotte"
# Locality = Gorgora Kandza => in Mayotte (SUBUNIT)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gorgora Kandza", replace = FALSE)] <- "Mayotte"
# Locality = Tanaraki => in Mayotte (SUBUNIT)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Tanaraki", replace = FALSE)] <- "Mayotte"
# Locality = Sazile => in Mayotte (SUBUNIT)
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Sazile", replace = FALSE)] <- "Mayotte"

# Update all adm1 and adm2 with nearest matches
Biogeographic_database_Ponerinae_curated$adm1[is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm1_Nearest[is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]
Biogeographic_database_Ponerinae_curated$adm2[is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[is.na(Biogeographic_database_Ponerinae_curated$adm1) & is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]

## Manually update cases where adm1/adm2 should stay as NA
# French Guiana (bentity2) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "French Guiana", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "French Guiana", replace = FALSE)] <- NA
# Cook Islands (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Cook Islands", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Cook Islands", replace = FALSE)] <- NA
# French Polynesia (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "French Polynesia", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "French Polynesia", replace = FALSE)] <- NA
# Gibraltar (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Gibraltar", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Gibraltar", replace = FALSE)] <- NA
# Mayotte (SUBUNIT) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Mayotte", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Mayotte", replace = FALSE)] <- NA
# Europa Island (bentity2) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Europa Island", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Europa Island", replace = FALSE)] <- NA
# Réunion (SUBUNIT) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Réunion", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Réunion", replace = FALSE)] <- NA
# Clipperton Island (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Clipperton Island", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Clipperton Island", replace = FALSE)] <- NA
# Aruba (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Aruba", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Aruba", replace = FALSE)] <- NA
# Tokelau (SUBUNIT) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Tokelau", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Tokelau", replace = FALSE)] <- NA
# Martinique (SUBUNIT) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Martinique", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Martinique", replace = FALSE)] <- NA
# Macao S.A.R (Country_ISO3) => no adm2 BUT adm1!
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Macao S.A.R", replace = FALSE)] <- NA
# Bermuda (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Bermuda", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Bermuda", replace = FALSE)] <- NA
# Wallis and Futuna (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Wallis and Futuna", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Wallis and Futuna", replace = FALSE)] <- NA
# Channel Islands (bentity2) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Channel Islands", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Channel Islands", replace = FALSE)] <- NA
# Montserrat (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Montserrat", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Montserrat", replace = FALSE)] <- NA
# Guadeloupe (SUBUNIT) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Guadeloupe", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Guadeloupe", replace = FALSE)] <- NA
# Saint Martin (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Saint Martin", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Saint Martin", replace = FALSE)] <- NA
# Caribbean Netherlands (SUBUNIT) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Caribbean Netherlands", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Caribbean Netherlands", replace = FALSE)] <- NA
# New Caledonia (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Caledonia", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Caledonia", replace = FALSE)] <- NA
# Niue (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Niue", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Niue", replace = FALSE)] <- NA
# British Virgin Islands (Country_ISO3) => no adm1/adm2
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "British Virgin Islands", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "British Virgin Islands", replace = FALSE)] <- NA

# Update Galapagos Islands (bentity2 + SUBUNIT_name) based on adm2
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Santa Cruz" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Ecuador", replace = FALSE)] <- "Galapagos Islands"
Biogeographic_database_Ponerinae_curated$bentity2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Santa Cruz" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Ecuador", replace = FALSE)] <- "Galapagos Islands"

# Update Guadeloupe in Lesser Antilles (bentity2 + SUBUNIT_name) based on Locality
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Basse Terre, "), replace = FALSE)] <- "Guadeloupe"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Basse Terre, "), replace = FALSE)] <- "Lesser Antilles"

# Update Comoros (bentity2) for Mayotte (SUBUNIT)
Biogeographic_database_Ponerinae_curated$bentity2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Mayotte", replace = FALSE)] <- "Comoros"

# United States Virgin Islands (Country_ISO3) => no adm2, but all adm1 = United States Virgin Islands
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States Virgin Islands", replace = FALSE)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States Virgin Islands", replace = FALSE)] <- "United States Virgin Islands"


## Case n°3: NA currently recorded but adm1_shapeName retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName),  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])

# Check cases where GB_country are not matching 
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "Locality", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])
# Need manual correction for coordinates

# Entry n°30180 should be in Botswana
Biogeographic_database_Ponerinae_curated$Latitude_dec[Biogeographic_database_Ponerinae_curated$Occurrence_ID == 30180] <- -25.5902
Biogeographic_database_Ponerinae_curated$Longitude_dec[Biogeographic_database_Ponerinae_curated$Occurrence_ID == 30180] <- 25.5147
Biogeographic_database_Ponerinae_curated$adm1[Biogeographic_database_Ponerinae_curated$Occurrence_ID == 30180] <- "Southern District"
Biogeographic_database_Ponerinae_curated$adm2[Biogeographic_database_Ponerinae_curated$Occurrence_ID == 30180] <- "Barolong"

# Locality = Gyula => Country = Hungary. adm1 = Békés. adm2 = Gyula
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gyula" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 46.6456
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gyula" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 21.2761
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gyula" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Gyula"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gyula" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Békés"

# Locality = 11 Miles From Lochiel To Mbabane => Country = South Africa. adm1 = Mpumalanga. adm2 = Gert Sibande
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "South Africa"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "South Africa"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "South Africa"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "ZAF"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "South Africa"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "Gert Sibande"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "11 Miles From Lochiel To Mbabane", replace = F)] <- "Mpumalanga"

# Locality = Mlanje, 2000 Feet => Country = Malawi. adm1 = Southern Region. adm2 = Mulanje. Adjust Coordinates
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mlanje") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -15.9907
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mlanje") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 35.5468
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mlanje") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Mulanje"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mlanje") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Southern Region"

# Locality = Basutoland, Mamathes => Country = Lesotho. adm1 = Berea District. adm2 = Phuthiatsana
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "Lesotho"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "Lesotho"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "Lesotho"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "LSO"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "Lesotho"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "Berea District"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Basutoland, Mamathes", replace = F)] <- "Phuthiatsana"

# Locality = Mont Elgon => Country = Uganda. adm1 = Eastern Region. adm2 = Manjiya
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Uganda"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Uganda"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Uganda"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "UGA"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Uganda"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Manjiya"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Elgon") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Eastern Region"

# Locality = Adlesici => Country = Malawi. adm1 = Vzhodna. adm2 = Crnomelj. Adjust Coordinates
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Adlesici" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 45.5225
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Adlesici" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 15.3136
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Adlesici" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Crnomelj"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Adlesici" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Vzhodna"

# Locality = Chirundu => Country = Zimbabwe. adm1 = Mashonaland West. adm2 = Chirundu.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Chirundu, Zimbabwe" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -16.0531
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Chirundu, Zimbabwe" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 28.8783
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Chirundu, Zimbabwe" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Chirundu"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Chirundu, Zimbabwe" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Mashonaland West"

# Locality = Ndumu Game Reserve => Country = South Africa. adm1 = KwaZulu-Natal. adm2 = Umkhanyakude.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -26.8781
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 32.2537
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Umkhanyakude"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "KwaZulu-Natal"

# Locality = Mamili National Park => Country = Namibia. adm1 = Capriviri. adm2 = Linyandi.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Mamili National Park" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -18.1067
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Mamili National Park" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 23.5243
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Mamili National Park" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Namibia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Mamili National Park" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Linyandi"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Mamili National Park" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Capriviri"

# Locality = Gaberone => Country = Botswana. adm1 = South-East District. adm2 = Gaborone.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gaberone" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -24.729
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gaberone" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 25.9153
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gaberone" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Botswana"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gaberone" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Gaborone"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Gaberone" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "South-East District"

# Locality = Indio Mais Res., San Juan and Serapaqui Rivers => Country = Costa Rica. adm1 = Provincia Heredia. adm2 = Sarapiqui
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "CRI"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Costa Rica"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Sarapiqui"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Indio Mais Res., San Juan and Serapaqui Rivers") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Provincia Heredia"

# Locality = New River => Country = Suriname. adm1 = Sipaliwini. adm2 = VI-7 Upper Corentyne
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Suriname"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Suriname"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Suriname"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "SUR"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Suriname"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "VI-7 Upper Corentyne"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "New River") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Sipaliwini"

# Locality = Dolo Sped. Brunelli => Country = Ethiopia. adm1 = Somali. adm2 = Afder
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Ethiopia"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Ethiopia"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Ethiopia"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "ETH"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Ethiopia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Afder"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Dolo Sped. Brunelli") & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Somali"

# Locality = Coleford Nature Reserve => Country = South Africa. adm1 = KwaZulu-Natal. adm2 = Sisonke.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Coleford Nature Reserve" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -29.9494
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Coleford Nature Reserve" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 29.4537
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Coleford Nature Reserve" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "South Africa"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Coleford Nature Reserve" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Sisonke"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Coleford Nature Reserve" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "KwaZulu-Natal"

# Locality = Lubila => Country = South Africa. adm1 = North Kivu. adm2 = Walikale.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Lubila" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- -0.92293
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Lubila" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- 28.8977
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Lubila" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "Walikale"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Lubila" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = F)] <- "North Kivu"


# Check cases where GB_country are matching 
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])

# Update using the intersecting adm1 and Nearest adm2
Biogeographic_database_Ponerinae_curated$adm1[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$adm1_shapeName[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]
Biogeographic_database_Ponerinae_curated$adm2[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]

# Manually adjust cases where there is an adm1 but no adm2
# United States Virgin Islands (Country_ISO3) => no adm2, but all adm1 = United States Virgin Islands
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States Virgin Islands", replace = FALSE)] <- NA


## Case n°4: adm1 currently recorded AND adm1_shapeName retrieved from intersecting shp

# Rerun flags for matching
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm1)

# Only inspect cases with mismatches

# Check cases where GB_country are not matching, so you expect a mistake in coordinates that need to be adjusted
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !is.na(Biogeographic_database_Ponerinae_curated$matching_GB_adm1) & !Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "GB_Country_Nearest", "BENTITY2_N", "SUBUNIT")])

## Manually update entries with wrong coordinates

# Entry n°126412 should be drawn randomly in Eritrea but ended up in Ethiopia
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 126412, replace = F)] <- 12.93242
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 126412, replace = F)] <- 42.1746
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 126412, replace = F)] <- "Southern Red Sea Region"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 126412, replace = F)] <- "Debub Deb.Keih Bahri"

# Entry n°33575 should be in Colombia, not Brazil
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 33575, replace = F)] <- -4.1969
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 33575, replace = F)] <- -69.9377
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 33575, replace = F)] <- "Amazonas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 33575, replace = F)] <- "Leticia"

# Locality = San Carlos de Rio Negro. Country = Venezuela. adm1 = Amazonas. adm2 = Rio Negro
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San Carlos de Rio Negro"), replace = F)] <- 1.9192
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San Carlos de Rio Negro"), replace = F)] <- -67.0581
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San Carlos de Rio Negro"), replace = F)] <- "Amazonas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San Carlos de Rio Negro"), replace = F)] <- "Rio Negro"

# Locality = Benjamin Constant. Country = Brazil. adm1 = Amazonas. adm2 = Benjamin Constant
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Benjamin Constant"), replace = F)] <- -4.38029
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Benjamin Constant"), replace = F)] <- -70.0333
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Benjamin Constant"), replace = F)] <- "Amazonas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Benjamin Constant"), replace = F)] <- "Benjamin Constant"

# Locality = Marques de Comillas/Marquez de Comillas. Country = Mexico. adm1 = Chiapas. adm2 = Benemérito de las Américas
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marques de Comillas"), replace = F)] <- 16.0856
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marques de Comillas"), replace = F)] <- -90.7533
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marques de Comillas"), replace = F)] <- "Chiapas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marques de Comillas"), replace = F)] <- "Benemérito de las Américas"
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marquez de Comillas"), replace = F)] <- 16.0856
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marquez de Comillas"), replace = F)] <- -90.7533
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marquez de Comillas"), replace = F)] <- "Chiapas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Marquez de Comillas"), replace = F)] <- "Benemérito de las Américas"

# Locality = Volcan Tacana. Country = Mexico. adm1 = Chiapas. adm2 = Union Juarez
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcan Tacana"), replace = F)] <- 15.1319
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcan Tacana"), replace = F)] <- -92.1093
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcan Tacana"), replace = F)] <- "Chiapas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcan Tacana"), replace = F)] <- "Union Juarez"

# Locality = La Balsa. Country = Colombia. adm1 = Chocó. adm2 = Riosucio
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "La Balsa. "), replace = F)] <- 7.040556
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "La Balsa. "), replace = F)] <- -77.337778
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "La Balsa. "), replace = F)] <- "Chocó"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "La Balsa. "), replace = F)] <- "Riosucio"

# Locality = Rhodes. Country = South Africa. adm1 = Eastern Cape Province. adm2 = Joe Gqabi
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rhodes") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- -30.79688
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rhodes") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- 27.9622
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rhodes") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- "Eastern Cape Province"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rhodes") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- "Joe Gqabi"

# Mnt. Elgon. Country = Uganda. adm1 = Eastern Region. adm2 = Manjiya
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mnt. Elgon"), replace = F)] <- 1.1272
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mnt. Elgon"), replace = F)] <- 34.5513
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mnt. Elgon"), replace = F)] <- "Eastern Region"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mnt. Elgon"), replace = F)] <- "Manjiya"

# Locality = Bethlehem. Country = South Africa. adm1 = Free State. adm2 = Thabo Mofutsanyane
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bethlehem") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- -28.2631
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bethlehem") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- 28.2941
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bethlehem") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- "Free State"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bethlehem") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "South Africa", replace = F)] <- "Thabo Mofutsanyane"

# Locality = Ouren. Country = Belgium. adm1 = Wallonne Gewest. adm2 = Luik
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ouren"), replace = F)] <- 50.1393
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ouren"), replace = F)] <- 6.1334
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ouren"), replace = F)] <- "Wallonne Gewest"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ouren"), replace = F)] <- "Luik"

# Locality = Veldwezelt. Country = Belgium. adm1 = Vlaams Gewest. adm2 = Limburg
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Veldwezelt"), replace = F)] <- 50.8675
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Veldwezelt"), replace = F)] <- 5.6308
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Veldwezelt"), replace = F)] <- "Vlaams Gewest"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Veldwezelt"), replace = F)] <- "Limburg"

# Locality = Lommel. Country = Belgium. adm1 = Vlaams Gewest. adm2 = Limburg
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Lommel"), replace = F)] <- 51.2258
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Lommel"), replace = F)] <- 5.3055
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Lommel"), replace = F)] <- "Vlaams Gewest"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Lommel"), replace = F)] <- "Limburg"

# Locality = Torgny. Country = Belgium. adm1 = Wallonne Gewest. adm2 = Luxemburg
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torgny"), replace = F)] <- 49.5074
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torgny"), replace = F)] <- 5.4737
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torgny"), replace = F)] <- "Wallonne Gewest"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Torgny"), replace = F)] <- "Luxemburg"

# Locality = Tayrona National Natural Park. Country = Colombia. adm1 = Magdalena. adm2 = Santa Marta
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- 11.3072
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- -74.073
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- "Magdalena"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- "Santa Marta"

# Locality = 9km NW Jalapa. Country = Nicaragua. adm1 = Nueva Segovia. adm2 = Municipio Jalapa
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "9km NW Jalapa"), replace = F)] <- 13.9753
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "9km NW Jalapa"), replace = F)] <- -86.1834
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "9km NW Jalapa"), replace = F)] <- "Nicaragua"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "9km NW Jalapa"), replace = F)] <- "Nueva Segovia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "9km NW Jalapa"), replace = F)] <- "Municipio Jalapa"

# Entries n°85477 & 87177: Locality = Forte Príncipe da Beira. Country = Brazil. adm1 = Rondonia. adm2 = Costa Marques
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(85477, 87177), replace = F)] <- -12.4249
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(85477, 87177), replace = F)] <- -64.4189
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(85477, 87177), replace = F)] <- "Rondonia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(85477, 87177), replace = F)] <- "Costa Marques"

# Check cases where GB_country are matching, so you expect a mistake in the initial adm1 that to be updated
View(Biogeographic_database_Ponerinae_curated[replace_na(!is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1 & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest, replace = F),  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "Locality", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "GB_Country_Nearest", "BENTITY2_N", "SUBUNIT")])

# Use intersecting adm1 and intersecting adm2 to update both. But need to manually reupdate exceptions
Biogeographic_database_Ponerinae_curated$adm1[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1 & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$adm1_shapeName[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1 & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]
Biogeographic_database_Ponerinae_curated$adm2[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1 & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest] <- Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest[!is.na(Biogeographic_database_Ponerinae_curated$adm1) & !is.na(Biogeographic_database_Ponerinae_curated$adm1_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1 & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest]


# Locality = Via Tarapac. Country = Brazil. adm1 = Amazonas. adm2 = Tarapacá
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = " Tarapac"), replace = F)] <- -2.8997
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = " Tarapac"), replace = F)] <- -69.7444
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = " Tarapac"), replace = F)] <- "Amazonas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = " Tarapac"), replace = F)] <- "Tarapacá"

# Locality = Itatim. Country = Brazil. adm1 = Bahia. adm2 = ?
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Itatim"), replace = F)] <- -39.6970
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Itatim"), replace = F)] <- "Bahia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Itatim"), replace = F)] <- NA

# Locality = SFF Los Colorados. Country = Colombia. adm1 = Bolívar. adm2 = San Juan Nepomuceno
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- 9.9447
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- -75.1005
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- "Bolívar"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- "San Juan Nepomuceno"

# Entry n°33583. Locality = P.N.N. La Serranía de Chiribiquete. Country = Colombia. adm1 = Caquetá. adm2 = Cartagena Del Chairá
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(33583), replace = F)] <- -12.4249
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(33583), replace = F)] <- -64.4189
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(33583), replace = F)] <- "Caquetá"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% c(33583), replace = F)] <- "Cartagena Del Chairá"

# Locality = Areguá, Luque. Country = Paraguay. adm1 = CENTRAL. adm2 = AREGUA
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- -25.300000
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- -57.3833333
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- "CENTRAL"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SFF Los Colorados"), replace = F)] <- "AREGUA"

# Locality = Ocozocautla de Espinosa. Country = Mexico. adm1 = Chiapas. adm2 = Ocozocoautla de Espinosa
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ocozocautla de Espinosa"), replace = F)] <- 16.7568
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ocozocautla de Espinosa"), replace = F)] <- -93.3736
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ocozocautla de Espinosa"), replace = F)] <- "Chiapas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ocozocautla de Espinosa"), replace = F)] <- "Ocozocoautla de Espinosa"

# Locality = Cienfuegos. Country = Cuba. adm1 = Cienfuegos. adm2 = Cienfuegos
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cienfuegos"), replace = F)] <- 22.1687
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cienfuegos"), replace = F)] <- -80.4275
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cienfuegos"), replace = F)] <- "Cienfuegos"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cienfuegos"), replace = F)] <- "Cienfuegos"

# Locality = 25 km E of Saltillo. Country = Mexico. adm1 = Coahuila de Zaragoza. adm2 = Ramos Arizpe
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "25 km E of Saltillo"), replace = F)] <- 25.9128
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "25 km E of Saltillo"), replace = F)] <- -101.1529
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "25 km E of Saltillo"), replace = F)] <- "Coahuila de Zaragoza"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "25 km E of Saltillo"), replace = F)] <- "Ramos Arizpe"

# Locality = Corrientes. Country = Argentina. adm1 = Corrientes. adm2 = Capital
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Corrientes"), replace = F)] <- -27.4778
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Corrientes"), replace = F)] <- -58.8253
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Corrientes"), replace = F)] <- "Corrientes"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Corrientes"), replace = F)] <- "Capital"

# Locality = Omogo Valley. Country = Japan. adm1 = Ehime Prefecture. adm2 = Kumakougen
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Omogo Valley") & Biogeographic_database_Ponerinae_curated$adm2_shapeName != "Kumakougen", replace = F)] <- 33.7541
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Omogo Valley") & Biogeographic_database_Ponerinae_curated$adm2_shapeName != "Kumakougen", replace = F)] <- 133.1193
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Omogo Valley") & Biogeographic_database_Ponerinae_curated$adm2_shapeName != "Kumakougen", replace = F)] <- "Ehime Prefecture"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Omogo Valley") & Biogeographic_database_Ponerinae_curated$adm2_shapeName != "Kumakougen", replace = F)] <- "Kumakougen"

# Locality = Linhares. Country = Brazil. adm1 = Espirito Santo. adm2 = Linhares
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Linhares"), replace = F)] <- -19.38826
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Linhares"), replace = F)] <- -40.0528
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Linhares"), replace = F)] <- "Espirito Santo"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Linhares"), replace = F)] <- "Linhares"

# Locality = Esp?rito Santo, Santa Teresa. Country = Brazil. adm1 = Espirito Santo. adm2 = Santa Teresa
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- -19.9329
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- -40.5991
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- "Espirito Santo"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- "Santa Teresa"

# Locality = Parque Nacional Pilcomayo. Country = Argentina. adm1 = Formosa. adm2 = Pilcomayo
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- -25.1743
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- -58.129
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- "Formosa"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "rito Santo, Santa Teresa"), replace = F)] <- "Pilcomayo"

# Locality = Pafuri, Kruger National Park. Country = South Africa. adm1 = Mpumalanga. adm2 = Ehlanzeni
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri, Kruger National Park"), replace = F)] <- -22.4227
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri, Kruger National Park"), replace = F)] <- 31.2204
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri, Kruger National Park"), replace = F)] <- "Mpumalanga"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri, Kruger National Park"), replace = F)] <- "Ehlanzeni"

# Locality = Pafuri 264M, Kruger National Park. Country = South Africa. adm1 = Mpumalanga. adm2 = Ehlanzeni
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri 264M, Kruger National Park"), replace = F)] <- -22.4227
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri 264M, Kruger National Park"), replace = F)] <- 31.2204
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri 264M, Kruger National Park"), replace = F)] <- "Mpumalanga"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Pafuri 264M, Kruger National Park"), replace = F)] <- "Ehlanzeni"

# Locality = Guanaiuato [Guanajuato]. Country = Mexico. adm1 = Guanajuato. adm2 = Guanajuato
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guanaiuato [Guanajuato]"), replace = F)] <- 21.0194
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guanaiuato [Guanajuato]"), replace = F)] <- -101.2599
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guanaiuato [Guanajuato]"), replace = F)] <- "Guanajuato"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guanaiuato [Guanajuato]"), replace = F)] <- "Guanajuato"

# Locality = Highway 57, Km 305 Rancho Jardin. Country = Mexico. adm1 = Guanajuato. adm2 = Dolores Hidalgo Cuna de la Independencia Nacional
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Highway 57, Km 305 Rancho Jardin"), replace = F)] <- 21.14318
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Highway 57, Km 305 Rancho Jardin"), replace = F)] <- -100.9543
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Highway 57, Km 305 Rancho Jardin"), replace = F)] <- "Guanajuato"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Highway 57, Km 305 Rancho Jardin"), replace = F)] <- "Dolores Hidalgo Cuna de la Independencia Nacional"

# Locality = Huila. Tesalia. Country = Colombia. adm1 = Huila. adm2 = Tesalia
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Huila. Tesalia"), replace = F)] <- 2.4864
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Huila. Tesalia"), replace = F)] <- -75.7285
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Huila. Tesalia"), replace = F)] <- "Huila"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Huila. Tesalia"), replace = F)] <- "Tesalia"

# Locality = Puerto Vallarta, Estero El Salado. Country = Mexico. adm1 = Nayarit. adm2 = Puerto Vallarta
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Vallarta, Estero El Salado"), replace = F)] <- 20.671
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Vallarta, Estero El Salado"), replace = F)] <- -105.236
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Vallarta, Estero El Salado"), replace = F)] <- "Nayarit"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Vallarta, Estero El Salado"), replace = F)] <- "Puerto Vallarta"

# Locality = Jaminda's Paradise Hotel. Country = Kenya. adm1 = Kakamega. adm2 = Lurambi
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jaminda's Paradise Hotel"), replace = F)] <- 0.28351
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jaminda's Paradise Hotel"), replace = F)] <- 34.7551
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jaminda's Paradise Hotel"), replace = F)] <- "Kakamega"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jaminda's Paradise Hotel"), replace = F)] <- "Lurambi"

# Locality = Thirunelly. Country = India. adm1 = Kerala. adm2 = Wayanad
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Thirunelly"), replace = F)] <- 11.9059
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Thirunelly"), replace = F)] <- 75.9997
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Thirunelly"), replace = F)] <- "Kerala"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Thirunelly"), replace = F)] <- "Wayanad"

# Locality = Silent Valley Reserve. Country = India. adm1 = Kerala. adm2 = Palakkad
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Silent Valley Reserve"), replace = F)] <- 11.0757
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Silent Valley Reserve"), replace = F)] <- 76.4246
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Silent Valley Reserve"), replace = F)] <- "Kerala"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Silent Valley Reserve"), replace = F)] <- "Palakkad"

# Locality = Ndumu Game Reserve, Red Cliff => Country = South Africa. adm1 = KwaZulu-Natal. adm2 = Umkhanyakude.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff", replace = F)] <- -26.8781
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff", replace = F)] <- 32.2537
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff", replace = F)] <- "KwaZulu-Natal"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "Ndumu Game Reserve, Red Cliff", replace = F)] <- "Umkhanyakude"

# Locality = Cathedral Peak area => Country = South Africa. adm1 = KwaZulu-Natal. adm2 = Uthukela.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cathedral Peak area"), replace = F)] <- -28.8731
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cathedral Peak area"), replace = F)] <- 29.0996
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cathedral Peak area"), replace = F)] <- "KwaZulu-Natal"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cathedral Peak area"), replace = F)] <- "Uthukela"

# Locality = Terra Firme evergreen rainforest Plot => Country = Peru. adm1 = Madre de Dios. adm2 = Tambopata.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Terra Firme evergreen rainforest Plot"), replace = F)] <- -12.5143
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Terra Firme evergreen rainforest Plot"), replace = F)] <- -68.9358
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Terra Firme evergreen rainforest Plot"), replace = F)] <- "Madre de Dios"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Terra Firme evergreen rainforest Plot"), replace = F)] <- "Tambopata"

# Locality = Santa Marta Mountains, Fundacion => Country = Colombia. adm1 = Magdalena. adm2 = Fundación.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Marta Mountains, Fundacion"), replace = F)] <- 10.5184
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Marta Mountains, Fundacion"), replace = F)] <- -74.1915
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Marta Mountains, Fundacion"), replace = F)] <- "Magdalena"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santa Marta Mountains, Fundacion"), replace = F)] <- "Fundación"

# Locality = Tayrona National Natural Park. Country = Colombia. adm1 = Magdalena. adm2 = Santa Marta
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- 11.3072
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- -74.073
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- "Magdalena"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tayrona"), replace = F)] <- "Santa Marta"

# Locality = Estreito. Country = Brazil. adm1 = Maranhao. adm2 = Estreito
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estreito"), replace = F)] <- -6.5584
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estreito"), replace = F)] <- -47.4432
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estreito"), replace = F)] <- "Maranhao"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Estreito"), replace = F)] <- "Estreito"

# Locality = Meta, Puerto Lleras => Country = Colombia. adm1 = Meta. adm2 = Puerto Lleras
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Meta, Puerto Lleras"), replace = F)] <- 3.2699
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Meta, Puerto Lleras"), replace = F)] <- -73.3738
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Meta, Puerto Lleras"), replace = F)] <- "Meta"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Meta, Puerto Lleras"), replace = F)] <- "Puerto Lleras"

# Locality = Bom Despacho. Country = Brazil. adm1 = Minas Gerais. adm2 = Bom Despacho
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bom Despacho"), replace = F)] <- -19.738
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bom Despacho"), replace = F)] <- -45.261
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bom Despacho"), replace = F)] <- "Minas Gerais"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bom Despacho"), replace = F)] <- "Bom Despacho"

# Locality = San Ignacio, Misiones => Country = Argentina. adm1 = Misiones. adm2 = San Ignacio
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San Ignacio, Misiones") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San ignacio") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"

Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San ignacio") & Biogeographic_database_Ponerinae_curated$adm2 == "Ensenada", replace = F)] <- "Baja California"


# Locality = Parque Nacional Iguazú => Country = Argentina. adm1 = Misiones. adm2 = Iguazú
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Parque Nacional Iguazú") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Iguazu National Park") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "iguazu National Park") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "P.N. iguazu") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Libertad") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Misiones") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Iguazo") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Iguazú") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "National Park of Iguazú") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "San Androcito") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "P.N. Iguazu") & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Argentina", replace = F)] <- "Misiones"

# Locality = Yecapixtla => Country = Mexico. adm1 = Morelos. adm2 = Yecapixtla
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yecapixtla"), replace = F)] <- 18.87904
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yecapixtla"), replace = F)] <- -98.8614
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yecapixtla"), replace = F)] <- "Morelos"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yecapixtla"), replace = F)] <- "Yecapixtla"

# Locality = Cueva de los Tayos => Country = Ecuador. adm1 = Morona Santiago. adm2 = San Juan Bosco
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cueva de los Tayos"), replace = F)] <- "Ecuador"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cueva de los Tayos"), replace = F)] <- "Morona Santiago"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Cueva de los Tayos"), replace = F)] <- "San Juan Bosco"

# Locality = Maria Madro island => Country = Ecuador. adm1 = Nayarit. adm2 = Maria Madre
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Maria Madro island"), replace = F)] <- 21.6316
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Maria Madro island"), replace = F)] <- -106.5879
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Maria Madro island"), replace = F)] <- "Nayarit"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Maria Madro island"), replace = F)] <- "Maria Madre"

# Locality = Alpine, Bergen County, New Jersey => Country = USA. adm1 = New Jersey. adm2 = Bergen
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alpine, Bergen County"), replace = F)] <- 40.9893
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alpine, Bergen County"), replace = F)] <- -73.9213
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alpine, Bergen County"), replace = F)] <- "New Jersey"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alpine, Bergen County"), replace = F)] <- "Bergen"

# Country = Norfolk Island. adm1 = Other Territories. adm2 = Unincorp. Other Territories
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Norfolk Island"), replace = F)] <- "Other Territories"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Country_ISO3_name, pattern = "Norfolk Island"), replace = F)] <- "Unincorp. Other Territories"

# Locality = Mount Klabat => Country = Indonesia (Sulawesi). adm1 = North Sulawesi. adm2 = Minahasa Utara
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mount Klabat"), replace = F)] <- 1.503000
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mount Klabat"), replace = F)] <- 125.05270
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mount Klabat"), replace = F)] <- "North Sulawesi"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mount Klabat"), replace = F)] <- "Minahasa Utara"

# Locality = Mesa de Chipinque => Country = Mexico. adm1 = Nuevo Leon. adm2 = San Pedro Garza García
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mesa de Chipinque"), replace = F)] <- 25.6091
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mesa de Chipinque"), replace = F)] <- -100.36166
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mesa de Chipinque"), replace = F)] <- "Nuevo León"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mesa de Chipinque"), replace = F)] <- "San Pedro Garza García"

# Locality = Motel Siesta, 4mi S Monterrey => Country = Mexico. adm1 = Nuevo Leon. adm2 = Monterrey
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Motel Siesta, 4mi S Monterrey"), replace = F)] <- 25.6015
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Motel Siesta, 4mi S Monterrey"), replace = F)] <- -100.2656
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Motel Siesta, 4mi S Monterrey"), replace = F)] <- "Nuevo León"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Motel Siesta, 4mi S Monterrey"), replace = F)] <- "Monterrey"

# Locality = Reserva Nacional Yasuni => Orellana (adm1) ; Orellana (adm2)
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni"), replace = FALSE)] <- "Orellana"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Reserva Nacional Yasuni"), replace = FALSE)] <- "Orellana"

# Locality = Stanleyville => Tshopo (adm1) ; Kisangani (adm2)
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Stanleyville"), replace = F)] <- 0.5238
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Stanleyville"), replace = F)] <- 25.1940
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Stanleyville"), replace = F)] <- "Tshopo"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Stanleyville"), replace = F)] <- "Kisangani"

# Kuala Lompat => Country = Malaysia. adm1 = Pahang. adm2 = Temerloh
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kuala Lompat"), replace = F)] <- 3.7162
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kuala Lompat"), replace = F)] <- 102.2884
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kuala Lompat"), replace = F)] <- "Pahang"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kuala Lompat"), replace = F)] <- "Temerloh"

# Locality = Rio Palenque Station => Country = Ecuador. adm1 = Los Rios. adm2 = Valencia
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rio Palenque Station"), replace = F)] <- -0.58804
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rio Palenque Station"), replace = F)] <- -79.3632
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rio Palenque Station"), replace = F)] <- "Los Ríos"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Rio Palenque Station"), replace = F)] <- "Valencia"

# Locality = Otongachi => Country = Ecuador. adm1 = Pichincha. adm2 = Mejia
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Otongachi"), replace = F)] <- -0.3186
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Otongachi"), replace = F)] <- -78.9529
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Otongachi"), replace = F)] <- "Pichincha"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Otongachi"), replace = F)] <- "Mejia"

# Locality = Monteverde, Open pasture near Sunset House => Country = Costa Rica. adm1 = Provincia Puntarenas. adm2 = Puntarenas
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Monteverde, Open pasture near Sunset House"), replace = F)] <- 10.3174
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Monteverde, Open pasture near Sunset House"), replace = F)] <- -84.8302
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Monteverde, Open pasture near Sunset House"), replace = F)] <- "Provincia Puntarenas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Monteverde, Open pasture near Sunset House"), replace = F)] <- "Puntarenas"

# Locality = Jardín Botánico Ignacio Rodríguez de Alconedo => Country = Mexico. adm1 = Puebla. adm2 = Puebla.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- 19.0004
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- -98.1985
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- "Puebla"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- "Puebla"

# Locality = Jardín Botánico Ignacio Rodríguez de Alconedo => Country = Mexico. adm1 = Puebla. adm2 = Puebla.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- 19.0004
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- -98.1985
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- "Puebla"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jardín Botánico Ignacio Rodríguez de Alconedo"), replace = F)] <- "Puebla"

# Locality = Mont St. Hilaire Biosphere Reserve => Country = Canada. adm1 = Quebec. adm2 = Montérégie.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mont St. Hilaire Biosphere Reserve"), replace = F)] <- 45.5539
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mont St. Hilaire Biosphere Reserve"), replace = F)] <- -73.1580
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mont St. Hilaire Biosphere Reserve"), replace = F)] <- "Quebec"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mont St. Hilaire Biosphere Reserve"), replace = F)] <- "Montérégie"

# Locality = Mt Isa => Country = Australia. adm1 = Queensland. adm2 = Mount Isa.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isa"), replace = F)] <- -20.7229
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isa"), replace = F)] <- 139.4987
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isa"), replace = F)] <- "Queensland"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isa"), replace = F)] <- "Mount Isa"

# Locality = Finca la Carmelita => Country = Colombia. adm1 = Risaralda. adm2 = Pereira.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca la Carmelita"), replace = F)] <- 4.8791
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca la Carmelita"), replace = F)] <- -75.7386
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca la Carmelita"), replace = F)] <- "Risaralda"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca la Carmelita"), replace = F)] <- "Pereira"

# Locality = Finca Corcega => Country = Colombia. adm1 = Risaralda. adm2 = Pereira.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca Corcega"), replace = F)] <- 4.7756
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca Corcega"), replace = F)] <- -75.7467
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca Corcega"), replace = F)] <- "Risaralda"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca Corcega"), replace = F)] <- "Pereira"

# Locality = Alejandria => Country = Colombia. adm1 = Risaralda. adm2 = Pereira.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alejandria"), replace = F)] <- 4.79217
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alejandria"), replace = F)] <- -75.7311
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alejandria"), replace = F)] <- "Risaralda"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Alejandria"), replace = F)] <- "Pereira"

# Locality = Miraldino => Country = Colombia. adm1 = Risaralda. adm2 = Pereira.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- 4.7135
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- -75.7325
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- "Risaralda"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- "Pereira"

# Locality = Pueblo Rico, Entre Sta. Cecilia y El Pital => Country = Colombia. adm1 = Risaralda. adm2 = Pueblo Rico.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- 5.3408
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- -76.1449
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- "Risaralda"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Miraldino"), replace = F)] <- "Pueblo Rico"

# Locality = Ouro Preto => Country = Brazil. adm1 = Rondonia. adm2 = Guajará-Mirim.
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ouro Preto"), replace = F)] <- "Rondonia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ouro Preto"), replace = F)] <- "Guajará-Mirim"

# Locality = Teotonio => Country = Brazil. adm1 = Rondonia. adm2 = Porto Velho.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Teotonio"), replace = F)] <- -8.8733
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Teotonio"), replace = F)] <- -64.0567
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Teotonio"), replace = F)] <- "Rondonia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Teotonio"), replace = F)] <- "Porto Velho"

# Locality = Porto Velho, Rio Madiera => Country = Brazil. adm1 = Rondonia. adm2 = Porto Velho.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- -8.7540
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- -63.9099
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- "Rondonia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- "Porto Velho"

# Locality = Real Forte Príncipe da Beira => Country = Brazil. adm1 = Rondonia. adm2 = Costa Marques.
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Real Forte Príncipe da Beira"), replace = F)] <- "Rondonia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Real Forte Príncipe da Beira"), replace = F)] <- "Costa Marques"

# Locality = Tamazunchale => Country = Mexico. adm1 = San Luis Potosí. adm2 = Tamazunchale.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- 21.2612
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- -98.7889
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- "San Luis Potosí"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Porto Velho, Rio Madiera"), replace = F)] <- "Tamazunchale"

# Locality = Chapeco => Country = Brazil. adm1 = Santa Catarina. adm2 = Chapecó.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Chapeco"), replace = F)] <- -27.0936
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Chapeco"), replace = F)] <- -52.6545
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Chapeco"), replace = F)] <- "Santa Catarina"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Chapeco"), replace = F)] <- "Chapecó"

# Locality = Xanxere => Country = Brazil. adm1 = Santa Catarina. adm2 = Xanxerê.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Xanxere"), replace = F)] <- -26.8724
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Xanxere"), replace = F)] <- -52.4059
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Xanxere"), replace = F)] <- "Santa Catarina"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Xanxere"), replace = F)] <- "Xanxerê"

# Locality = Volcán Tecuamburro => Country = Guatemala. adm1 = Santa Rosa. adm2 = Pueblo Nuevo Viñas.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcán Tecuamburro"), replace = F)] <- 14.15455
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcán Tecuamburro"), replace = F)] <- -90.4055
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcán Tecuamburro"), replace = F)] <- "Santa Rosa"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Volcán Tecuamburro"), replace = F)] <- "Pueblo Nuevo Viñas"

# Locality = Santiago, Jardin Botanico => Country = Cuba. adm1 = Santiago de Cuba Province. adm2 = Santiago de Cuba.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santiago, Jardin Botanico"), replace = F)] <- 20.0214
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santiago, Jardin Botanico"), replace = F)] <- -75.8016
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santiago, Jardin Botanico"), replace = F)] <- "Santa Rosa"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Santiago, Jardin Botanico"), replace = F)] <- "Pueblo Nuevo Viñas"

# Est. Biol. Boraceia  => Country = Brazil. adm1 = Sao Paulo. adm2 = Salesópolis.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Est. Biol. Boraceia"), replace = F)] <- -23.5304
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Est. Biol. Boraceia"), replace = F)] <- -45.8474
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Est. Biol. Boraceia"), replace = F)] <- "Sao Paulo"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Est. Biol. Boraceia"), replace = F)] <- "Salesópolis"

# Locality = Numazu City => Country = Japan. adm1 = Shizuoka. adm2 = Numadu.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Numazu City"), replace = F)] <- 35.0928
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Numazu City"), replace = F)] <- 138.8663
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Numazu City"), replace = F)] <- "Shizuoka"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Numazu City"), replace = F)] <- "Numadu"

# Locality = Nahualate, Baluarte => Country = Guatemala. adm1 = Suchitepéquez. adm2 = Chicacao.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Nahualate, Baluarte"), replace = F)] <- 14.4479
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Nahualate, Baluarte"), replace = F)] <- -91.3758
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Nahualate, Baluarte"), replace = F)] <- "Suchitepéquez"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Nahualate, Baluarte"), replace = F)] <- "Chicacao"

# Locality = Sumatra O.K., Medan => Country = Indonesia. adm1 = North Sumatra. adm2 = Medan.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Sumatra O.K., Medan"), replace = F)] <- 3.5746
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Sumatra O.K., Medan"), replace = F)] <- 98.6719
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Sumatra O.K., Medan"), replace = F)] <- "North Sumatra"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Sumatra O.K., Medan"), replace = F)] <- "Deli Serdang"

# Locality = Big Bend National Park, Rio Grande River near Santa Elena Canyon => Country = USA. adm1 = Texas. adm2 = Brewster
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Big Bend National Park, Rio Grande River near Santa Elena Canyon"), replace = F)] <- "Texas"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Big Bend National Park, Rio Grande River near Santa Elena Canyon"), replace = F)] <- "Brewster"

# Locality = Guyabal => Country = Colombia. adm1 = Tolima. adm2 = Armero. 
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- 5.0338
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- -74.8837
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- "Tolima"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- "Armero"

# Locality = Buenos Aires, Ibague => Country = Colombia. adm1 = Tolima. adm2 = Ibagué. 
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Buenos Aires, Ibague"), replace = F)] <- 4.3315
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Buenos Aires, Ibague"), replace = F)] <- -75.0809
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Buenos Aires, Ibague"), replace = F)] <- "Tolima"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Buenos Aires, Ibague"), replace = F)] <- "Ibagué"

# Locality = El Chaco, Piedras => Country = Colombia. adm1 = Tolima. adm2 = Piedras. 
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Chaco, Piedras"), replace = F)] <- 4.54299
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Chaco, Piedras"), replace = F)] <- -74.8788
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Chaco, Piedras"), replace = F)] <- "Tolima"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Chaco, Piedras"), replace = F)] <- "Piedras"

# Locality = CURN-UT, Centro Universitario Regional del Norte Armero-Guayabal => Country = Colombia. adm1 = Tolima. adm2 = Armero.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- 5.0022
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- -74.9078
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- "Tolima"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Guyabal"), replace = F)] <- "Armero"

# Locality = Horco Molle => Country = Argentina. adm1 = Tucumán. adm2 = Yerba Buena.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Horco Molle"), replace = F)] <- -26.7911
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Horco Molle"), replace = F)] <- -65.3156
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Horco Molle"), replace = F)] <- "Tucumán"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Horco Molle"), replace = F)] <- "Yerba Buena"

# Locality = El Hatico => Country = Colombia. adm1 = Valle del Cauca. adm2 = El Cerrito.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Hatico"), replace = F)] <- 3.6410
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Hatico"), replace = F)] <- -76.3170
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Hatico"), replace = F)] <- "Valle del Cauca"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "El Hatico"), replace = F)] <- "El Cerrito"

# Locality = Bajo Anchicaya => Country = Colombia. adm1 = Valle del Cauca. adm2 = Buenaventura.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- 3.6093
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- -76.9196
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- "Valle del Cauca"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- "Buenaventura"

# Locality = EstaciÃ³n BiolÃ³gica CaparÃº => Country = Colombia. adm1 = Vaupés. adm2 = Mitú.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- 1.0723
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- -70.6756
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- "Vaupés"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Bajo Anchicaya"), replace = F)] <- "Mitú"

# Locality = Fortin de las Flores, Posada Loma => Country = Mexico. adm1 = Veracruz de Ignacio de la Llave. adm2 = Fortín.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fortin de las Flores, Posada Loma"), replace = F)] <- 18.9014
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fortin de las Flores, Posada Loma"), replace = F)] <- -96.9892
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fortin de las Flores, Posada Loma"), replace = F)] <- "Veracruz de Ignacio de la Llave"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fortin de las Flores, Posada Loma"), replace = F)] <- "Fortín"

# Locality = South Quay NAP => Country = USA. adm1 = Virginia. adm2 = City of Suffolk.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "South Quay NAP"), replace = F)] <- 36.6275
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "South Quay NAP"), replace = F)] <- -76.8761
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "South Quay NAP"), replace = F)] <- "Virginia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "South Quay NAP"), replace = F)] <- "City of Suffolk"

# Locality = Mattaponi WMA => Country = USA. adm1 = Virginia. adm2 = Caroline.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mattaponi WMA"), replace = F)] <- 38.0585
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mattaponi WMA"), replace = F)] <- -77.3899
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mattaponi WMA"), replace = F)] <- "Virginia"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mattaponi WMA"), replace = F)] <- "Caroline"

# Locality = SE Salawati => Country = Indonesia (Raja Ampat Islands). adm1 = West Papua. adm2 = Raja Ampat.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SE Salawati"), replace = F)] <- -1.2519
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SE Salawati"), replace = F)] <- 131.0173
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$bentity2_name, pattern = "SE Salawati"), replace = F)] <- "Raja Ampat Islands"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SE Salawati"), replace = F)] <- "West Papua"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "SE Salawati"), replace = F)] <- "Raja Ampat"

# Locality = Kakamega Forest Preserve => Country = Kenya. adm1 = Kakamega. adm2 = Shinyalu.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kakamega Forest Preserve"), replace = F)] <- 0.3001
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kakamega Forest Preserve"), replace = F)] <- 34.859
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kakamega Forest Preserve"), replace = F)] <- "Kakamega"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kakamega Forest Preserve"), replace = F)] <- "Shinyalu"

# Locality = Wychwood => Country = USA. adm1 = Wisconsin. adm2 = Linn.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Wychwood"), replace = F)] <- 42.5820
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Wychwood"), replace = F)] <- -88.4674
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Wychwood"), replace = F)] <- "Wisconsin"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Wychwood"), replace = F)] <- "Linn"

# Locality = Finca La Guáquira, ca. San Felipe => Country = Venezuela. adm1 = Yaracuy. adm2 = Nirgua.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca La Guáquira, ca. San Felipe"), replace = F)] <- 10.2882
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca La Guáquira, ca. San Felipe"), replace = F)] <- -68.6664
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca La Guáquira, ca. San Felipe"), replace = F)] <- "Yaracuy"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Finca La Guáquira, ca. San Felipe"), replace = F)] <- "Nirgua"


### 4.3.5/ For GB_adm2 ####

##### DO not update automatically if higher level did not match !!!! Because it probably means the coordinates is slightly incorrect....

# Turn null into NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "null", replace = FALSE)] <- NA

# Flag mismatches between current adm2 and Intersecting GB_adm2
Biogeographic_database_Ponerinae_curated$matching_GB_adm2 <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm2 == Biogeographic_database_Ponerinae_curated$adm2_shapeName), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm2)

# Flag mismatches between current adm2 and Nearest GB_adm2
Biogeographic_database_Ponerinae_curated$matching_GB_adm2_nearest <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm2 == Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm2_nearest)

# Flag mismatches between Intersecting GB_adm2 and Nearest GB_adm2
Biogeographic_database_Ponerinae_curated$matching_GB_adm2_nearest_vs_intersect <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm2_shapeName == Biogeographic_database_Ponerinae_curated$GB_adm2_Nearest), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm2_nearest_vs_intersect, is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName))

# Flag mismatches between GB_Country_name and Nearest GB_Country to detect potential error in Nearest shp retrieval
Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_GB_name == Biogeographic_database_Ponerinae_curated$GB_Country_Nearest), replace = FALSE)
table(Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest, is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name))

## Case n°1: GB_adm2 currently recorded AND NA retrieved from intersecting shp (adm2_shapeName)

# Three cases:
# 1/ The coordinates falls in a waterbody and is close to its true location => Can use nearest polygon. Should correct coordinates.
# 2/ The coordinates falls in a waterbody and is a mistake => CANNOT use nearest polygon. Need to correct coordinates.
# 3/ The coordinates falls on land, but this land is not included in geoBoundaries shape files => Should remain a true NA. Coordinates are fine.

# Check if the current adm2 are valid adm2 names
GB_adm2_validity_test <- replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 %in% geoBoundaries_adm2_sf$adm2_shapeName, replace = F)
table(GB_adm2_validity_test, is.na(Biogeographic_database_Ponerinae_curated$adm2))

# Adjust invalid adm2 names for potential misspelling
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !GB_adm2_validity_test,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm1_shapeName", "BENTITY2_N", "SUBUNIT")])

# Lanaudiere = Lanaudière
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lanaudiere", replace = FALSE)] <- "Lanaudière"
# Monteregie = Montérégie
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Monteregie", replace = FALSE)] <- "Montérégie"
# City of Virginia Beach = Virginia Beach
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "City of Virginia Beach", replace = FALSE)] <- "Virginia Beach"
# Okaloosa County = Okaloosa
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Okaloosa County", replace = FALSE)] <- "Okaloosa"
# Lee County = Lee
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Lee County", replace = FALSE)] <- "Lee"
# Monroe County = Monroe
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Monroe County", replace = FALSE)] <- "Monroe"
# Palmaria = Liguria (Italy)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Palmaria" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Italy", replace = FALSE)] <- "Liguria"
# Vieques Municipality = Vieques
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Vieques Municipality", replace = FALSE)] <- "Vieques"
# Ca = Cadiz (Andalucía, Spain)
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Ca" & Biogeographic_database_Ponerinae_curated$adm1 == "Andalucía", replace = FALSE)] <- "Cadiz"
# Ile Aux Aigrettes = Grand Port 
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Ile Aux Aigrettes", replace = FALSE)] <- "Grand Port"

## Look at current valid adm2 entries

## Check the valid adm2 entries without intersecting adm2, but a matching nearest adm2. Check if there is any reason not to use the current/nearest adm2
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & GB_adm2_validity_test & Biogeographic_database_Ponerinae_curated$matching_GB_adm2_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

## Check the valid adm2 entries without intersecting adm2, and a non matching nearest adm2. Maybe an error to correct
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & GB_adm2_validity_test & !Biogeographic_database_Ponerinae_curated$matching_GB_adm2_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm2_shapeName", "BENTITY2_N", "SUBUNIT")])

# Locality = 6 km North Siboney, Rio Juragua => Country = Cuba, adm1 = Santiago de Cuba, adm2 = Santiago de Cuba
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "6 km North Siboney, Rio Juragua"), replace = F)] <- 19.9535
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "6 km North Siboney, Rio Juragua"), replace = F)] <- -75.6748
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "6 km North Siboney, Rio Juragua"), replace = F)] <- "Santiago de Cuba"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "6 km North Siboney, Rio Juragua"), replace = F)] <- "Santiago de Cuba"

# Entry n°153805. Locality = Omogo Valley. Country = Japan. adm1 = Ehime Prefecture. adm2 = Kumakougen
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 153805, replace = F)] <- 33.7541
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 153805, replace = F)] <- 133.1193
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 153805, replace = F)] <- "Ehime Prefecture"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 153805, replace = F)] <- "Kumakougen"

# Entry n°9920. Locality = Presidio of San Francisco. Country = USA. adm1 = California. adm2 = San Francisco
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 9920, replace = F)] <- 37.7966
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 9920, replace = F)] <- -122.4669


## Case n°2: NA currently recorded AND NA retrieved from intersecting shp (sort by Country_ISO3_name)

# Three cases:
  # 1/ The coordinates falls in a waterbody and is close to its true location => Can use nearest polygon. Should correct coordinates.
  # 2/ The coordinates falls in a waterbody and is a mistake => CANNOT use nearest polygon. Need to correct coordinates.
  # 3/ The coordinates falls on land, but this land is not included in geoBoundaries shape files => Should remain a true NA. Coordinates are fine.

# Check cases where nearest country do not match (likely a piece of land not in sf shape files so should stay as NA)
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm2) & is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm1_shapeName", "BENTITY2_N", "SUBUNIT")])

# Check cases where nearest country match (coordinates in water?) => Trust nearest? or Keep as NA?
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm2) & is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "adm1_shapeName", "BENTITY2_N", "SUBUNIT")])

# bentity2 = Kuril Islands => adm1 = Sakhalin Oblast. adm2 = Kurilsky District
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$bentity2_name, pattern = "Kuril Islands"), replace = F)] <- "Sakhalin Oblast"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$bentity2_name, pattern = "Kuril Islands"), replace = F)] <- "Kurilsky District"

# Locality = nr. Townsville => Country = Australia. adm1 = Queensland. adm2 = Townsville
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "nr. Townsville"), replace = F)] <- -19.2603
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "nr. Townsville"), replace = F)] <- 146.8059
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "nr. Townsville"), replace = F)] <- "Queensland"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "nr. Townsville"), replace = F)] <- "Townsville"

# Locality = Isla de N. Grande => Country = Equatorial Guinea. adm1 = Litoral Province. adm2 = COGO
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Isla de N. Grande"), replace = F)] <- "Litoral Province"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Isla de N. Grande"), replace = F)] <- "COGO"

## Case n°3: NA currently recorded but adm2_shapeName retrieved from intersecting shp
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName),  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])

# Check cases where GB_country are not matching 
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])
# Need manual correction for coordinates

# Locality = Batet (720) => Country = France. adm1 = Occitanie. adm2 = Pyrénées-Orientales
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "FRA"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "Occitanie"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Batet (720)"), replace = F)] <- "Pyrénées-Orientales"
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "FRA"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "France"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "Occitanie"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 36131, replace = F)] <- "Pyrénées-Orientales"

# Locality = Puerto Bertoni => Country = Paraguay. adm1 = ALTO PARANA. adm2 = PRESIDENTE FRANCO
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Bertoni"), replace = F)] <- -25.6548
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Bertoni"), replace = F)] <- -54.5918
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Bertoni"), replace = F)] <- "ALTO PARANA"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Puerto Bertoni"), replace = F)] <- "PRESIDENTE FRANCO"

# Entry n°100673. Locality = Monteggio. => Country = Switzerland. adm1 = Lugano. adm2 = NA
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 100673, replace = F)] <- "Monteggio"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 100673, replace = F)] <- "Lugano"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID == 100673, replace = F)] <- NA

# Check cases where adm1 are not matching 
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])
# Need manual correction for coordinates

# Check cases where adm1 are matching 
View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "BENTITY2_N", "SUBUNIT")])

# Update using the intersecting adm2
Biogeographic_database_Ponerinae_curated$adm2[is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest] <- Biogeographic_database_Ponerinae_curated$adm2_shapeName[is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & Biogeographic_database_Ponerinae_curated$matching_GB_adm1_nearest]

# Manually adjust cases where there is no adm2
# United States Virgin Islands (Country_ISO3) => no adm2, but all adm2 = United States Virgin Islands
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States Virgin Islands", replace = FALSE)] <- NA


## Case n°4: adm2 currently recorded AND adm2_shapeName retrieved from intersecting shp

# Rerun flags for matching
table(Biogeographic_database_Ponerinae_curated$matching_GB_adm2)

# Only inspect cases with mismatches

# Check cases where GB_country are not matching, so you expect a mistake in coordinates that need to be adjusted
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !is.na(Biogeographic_database_Ponerinae_curated$matching_GB_adm2) & !Biogeographic_database_Ponerinae_curated$matching_GB_Country_nearest,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "GB_Country_Nearest", "BENTITY2_N", "SUBUNIT")])

## Manually update entries with wrong coordinates

# adm2 = Hidalgo Co. => adm2 = Hidalgo
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$adm2 == "Hidalgo Co.", replace = F)] <- "Hidalgo"

# Check cases where adm1 are not matching, so you expect a mistake in coordinates that need to be adjusted
View(Biogeographic_database_Ponerinae_curated[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !is.na(Biogeographic_database_Ponerinae_curated$matching_GB_adm2) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm1,  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "GB_Country_Nearest", "BENTITY2_N", "SUBUNIT")])

# Check cases where adm1 are matching, so you expect a mistake in the initial adm2 that to be updated
View(Biogeographic_database_Ponerinae_curated[replace_na(!is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm2 & Biogeographic_database_Ponerinae_curated$matching_GB_adm1, replace = F),  c("matching_shp", "Latitude_dec", "Longitude_dec", "matching_GB_Country_nearest", "adm2", "adm2_shapeName", "GB_adm2_Nearest", "Locality", "adm1", "adm1_shapeName", "GB_adm1_Nearest", "bentity2_name", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "GB_Country_Nearest", "BENTITY2_N", "SUBUNIT")])

# Use intersecting adm2. But need to manually reupdate exceptions
Biogeographic_database_Ponerinae_curated$adm2[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm2 & Biogeographic_database_Ponerinae_curated$matching_GB_adm1] <- Biogeographic_database_Ponerinae_curated$adm2_shapeName[!is.na(Biogeographic_database_Ponerinae_curated$adm2) & !is.na(Biogeographic_database_Ponerinae_curated$adm2_shapeName) & !Biogeographic_database_Ponerinae_curated$matching_GB_adm2 & Biogeographic_database_Ponerinae_curated$matching_GB_adm1]

# France DOM SUBUNIT should not have adm1/adm2
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Guadeloupe", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Guadeloupe", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "French Guiana", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "French Guiana", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Martinique", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Martinique", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Mayotte", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Mayotte", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Reunion", replace = NA)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name == "Reunion", replace = NA)] <- NA


## See list of exceptions to rerun in Case n°4 of adm1


# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "PAK", ])
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "BRA", ])

# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% c("Fortín"), "adm1_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "PAK", "adm1_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "LCA", "adm2_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName %in% c("Oshima"), "adm2_shapeName"])

# par(oma = c(0,0,3,10))
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "KOR", "adm1_shapeName"])

table(is.na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name))
table(is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name))
table(is.na(Biogeographic_database_Ponerinae_curated$SUBUNIT_name))
table(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name))
table(is.na(Biogeographic_database_Ponerinae_curated$adm1))
table(is.na(Biogeographic_database_Ponerinae_curated$adm2))

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


### 4.3.6/ Update geometry with corrected coordinates ####

Biogeographic_database_Ponerinae_curated <- st_drop_geometry(Biogeographic_database_Ponerinae_curated)
Biogeographic_database_Ponerinae_curated$Latitude_copy <- Biogeographic_database_Ponerinae_curated$Latitude_dec
Biogeographic_database_Ponerinae_curated$Longitude_copy <- Biogeographic_database_Ponerinae_curated$Longitude_dec
Biogeographic_database_Ponerinae_curated <- st_as_sf(Biogeographic_database_Ponerinae_curated, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_curated) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_curated

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

print(Biogeographic_database_Ponerinae_curated[94038, ])

##### 5/ Retrieve Bioregion for all entries ####

### 5.1/ Load files ####

# Load Biogeographic database with all curated coordinates
Biogeographic_database_Ponerinae_curated <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

# Load metadata with bioregion assignment
Countries_NE_sf_metadata <- openxlsx::read.xlsx(xlsxFile = "./input_data/Biogeographic_data/Countries_NE_sf_metadata.xlsx")

### 5.2/ Correct manually the Bioregion errors ####

# Locality = Tombouctou => Country = Mali. adm1 = Tombouctou. adm2 = Tombouctou.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- 16.7729
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- -3.0054
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "Mali"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "MLI"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "Mali"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "Mali"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "Mali"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "Tombouctou"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tombouctou"), replace = F)] <- "Tombouctou"

# Locality = Baguezans Mounts, Aïr => Country = Niger. adm1 = Tahoua/Agadez. adm2 = Tchirozérine.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Baguezans Mounts, Aïr"), replace = F)] <- 17.7086
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Baguezans Mounts, Aïr"), replace = F)] <- 8.7124
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Baguezans Mounts, Aïr"), replace = F)] <- "Tahoua/Agadez"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Baguezans Mounts, Aïr"), replace = F)] <- "Tchirozérine"

# Locality = Fort Archambault => Country = Chad. adm1 = Moyen-Chari. adm2 = Bahr-Köh.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fort Archambault"), replace = F)] <- 9.1332
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fort Archambault"), replace = F)] <- 18.3666
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fort Archambault"), replace = F)] <- "Moyen-Chari"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Fort Archambault"), replace = F)] <- "Bahr-Köh"

# Locality = Jammu & Kashmir => Country = India. adm1 = Jammu and Kashm?r. adm2 = Anantnag.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jammu & Kashmir"), replace = F)] <- 33.7295
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jammu & Kashmir"), replace = F)] <- 75.1724
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jammu & Kashmir"), replace = F)] <- "Jammu and Kashmir"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Jammu & Kashmir"), replace = F)] <- "Anantnag"

# Locality = Surinsar => Country = India. adm1 = Jammu and Kashm?r. adm2 = Udhampur.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Surinsar"), replace = F)] <- 32.6980
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Surinsar"), replace = F)] <- 75.1498
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Surinsar"), replace = F)] <- "Jammu and Kashmir"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Surinsar"), replace = F)] <- "Udhampur"

# Errors with Yunnan boundaries
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Yunnan" & Biogeographic_database_Ponerinae_curated$matching_shp == "NE_adm1", replace = F)] <- "Yunnan Province"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name == "Yunnan" & Biogeographic_database_Ponerinae_curated$adm1 == "Kachin", replace = F)] <- "Yunnan Province"

# Locality = Mengla => Country = China. adm1 = Yunnan Province. adm2 = Menglaxian.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mengla"), replace = F)] <- 21.491
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mengla"), replace = F)] <- 101.570
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mengla"), replace = F)] <- "Yunnan Province"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mengla"), replace = F)] <- "Menglaxian"

# Locality =	Yichang Village, Wenlong Town => Country = China. adm1 = Yunnan Province. adm2 = Jingdongyizuzizhixian.
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yichang Village, Wenlong Town"), replace = F)] <- 24.644
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yichang Village, Wenlong Town"), replace = F)] <- 100.7340
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yichang Village, Wenlong Town"), replace = F)] <- "Yunnan Province"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Yichang Village, Wenlong Town"), replace = F)] <- "Jingdongyizuzizhixian"

# Errors with Guangxi boundaries
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1_initial == "Guangxi" & Biogeographic_database_Ponerinae_curated$matching_shp == "NE_adm1", replace = F)] <- "Guangxi Zhuang Autonomous Region"

Saba_suspected_entries <- Biogeographic_database_Ponerinae_curated$Occurrence_ID[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name_initial == "Lesser Antilles" & Biogeographic_database_Ponerinae_curated$Country_initial == "Netherlands", replace = F)]

# Entries labeled in the Netherlands AND Lesser Antilles are suspected to be from Saba Island => Move to Saba
Saba_suspected_entries <- Biogeographic_database_Ponerinae_curated$Occurrence_ID[replace_na(data = Biogeographic_database_Ponerinae_curated$bentity2_name_initial == "Lesser Antilles" & Biogeographic_database_Ponerinae_curated$Country_initial == "Netherlands", replace = F)]
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- 17.632
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- -63.235
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- NA
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- NA
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- "Lesser Antilles"
# Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- "Neotropics"
# Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- "Neotropics"
# Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- "Neotropics"
# Biogeographic_database_Ponerinae_curated$Bioregion_8[replace_na(data = Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% Saba_suspected_entries, replace = F)] <- "Neotropics"

# Locality = Is. Oahu, H.J. => Hawaii
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- 21.5835
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- -158.0647
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Hawaii"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Honolulu"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Hawaii"
# Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Australasia"
# Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Australasia"
# Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Australasia"
# Biogeographic_database_Ponerinae_curated$Bioregion_8[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Is. Oahu, H.J."), replace = F)] <- "Australasia"

# Locality = Mt Isarog => Philippines
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isarog"), replace = F)] <- 13.6611
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isarog"), replace = F)] <- 123.3363
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isarog"), replace = F)] <- "Bicol Region"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isarog"), replace = F)] <- "Camarines Sur"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt Isarog"), replace = F)] <- "Philippines"

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "PHL", ])
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "PHL", ])

# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% c("Fortín"), "adm1_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "PAK", "adm1_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "LCA", "adm2_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName %in% c("Oshima"), "adm2_shapeName"])

### 5.3/ Update geometry ####

# Remove previous geometry
Biogeographic_database_Ponerinae_curated <- st_drop_geometry(Biogeographic_database_Ponerinae_curated)

# Convert Flagged df to sf 
Biogeographic_database_Ponerinae_curated$Latitude_copy <- Biogeographic_database_Ponerinae_curated$Latitude_dec
Biogeographic_database_Ponerinae_curated$Longitude_copy <- Biogeographic_database_Ponerinae_curated$Longitude_dec
Biogeographic_database_Ponerinae_curated <- st_as_sf(Biogeographic_database_Ponerinae_curated, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_curated) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% select(-c("Longitude_copy", "Latitude_copy"))
Biogeographic_database_Ponerinae_curated


### 5.4/ Assign Bioregion to entries based on Country code ####

Biogeographic_database_Ponerinae_curated$Bioregion <- Countries_NE_sf_metadata$Bioregion_6[match(Biogeographic_database_Ponerinae_curated$Country_ISO3_code, Countries_NE_sf_metadata$ISO_A3)]

### 5.5/ Deal with the particular cases of countries overlapping bioregions ####

## France: Mayotte, Reunion, Guyane, Martinique, Guadeloupe
# View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France", ] %>% arrange(SUBUNIT_name))

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")] <- "Palearctic"

Biogeographic_database_Ponerinae_curated$Bioregion[str_detect(string = Biogeographic_database_Ponerinae_curated$SUBUNIT_name, pattern =  "Guadeloupe") & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")] <- "Neotropics"
Biogeographic_database_Ponerinae_curated$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name ==  "Martinique", replace = F) | replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 ==  "Martinique", replace = F)) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")] <- "Neotropics"
Biogeographic_database_Ponerinae_curated$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name ==  "Mayotte", replace = F) | replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 ==  "Mayotte", replace = F)) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")] <- "Afrotropics"
Biogeographic_database_Ponerinae_curated$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name ==  "Reunion", replace = F)) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")] <- "Afrotropics"
Biogeographic_database_Ponerinae_curated$Bioregion[(replace_na(data = Biogeographic_database_Ponerinae_curated$SUBUNIT_name ==  "French Guiana", replace = F)) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")] <- "Neotropics"

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")])

## Indonesia: Use adm1 to distinguish between IndoMalaya and Australasia according to AntWeb

# # Longitude 125.5°. Not right but good enough for rough first estimates
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Longitude_dec < 125.5) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia")] <- "Indomalaya"
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Longitude_dec >= 125.5) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia")] <- "Australasia"

Indonesia_adm1_in_Australasia <- c("Maluku", "North Maluku", "East Nusa Tenggara", "West Nusa Tenggara", "Papua", "West Papua")

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia")] <- "Indomalaya"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia" & Biogeographic_database_Ponerinae_curated$adm1 %in% Indonesia_adm1_in_Australasia, replace = F) ] <- "Australasia"

# View(Biogeographic_database_Ponerinae_curated[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia"), ])

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "IDN", "adm1_shapeName"])

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia")])

## India: Three regions in Palearctic !!

India_adm1_in_Palearctic <- c("Him?chal Pradesh", "Himachal Pradesh", "Jammu and Kashm?r", "Jammu and Kashmir", "Ladakh", "Lad?kh")

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "India")] <- "Indomalaya"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "India" & Biogeographic_database_Ponerinae_curated$adm1 %in% India_adm1_in_Palearctic, replace = F) ] <- "Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "India")])

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "IND", "adm1_shapeName"])

## Pakistan: Two regions in Palearctic !!

Pakistan_adm1_in_Palearctic <- c("Azad Kashmir", "Gilgit-Baltistan")

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Pakistan")] <- "Indomalaya"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Pakistan" & Biogeographic_database_Ponerinae_curated$adm1 %in% Pakistan_adm1_in_Palearctic, replace = F) ] <- "Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Pakistan")])

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "PAK", "adm1_shapeName"])

## Japan: Okinawa, and maybe some Bentity2 entities are in Indomalaya or even Australasia for the one far off in the Pacific Ocean

# Use Longitude 125.5 as a rough separation
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Longitude_dec < 125.5) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia")] <- "Indomalaya"
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Longitude_dec >= 125.5) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Indonesia")] <- "Australasia"

# Make cut based on Bentity2

# Need to fix NA
# View(Biogeographic_database_Ponerinae_curated[replace_na(data = is.na(Biogeographic_database_Ponerinae_curated$bentity2_name) & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan", replace = F), ])

Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Ishizuchi"), replace = F)] <- "Shikoku"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mount Fujiyama"), replace = F)] <- "Chubu"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Riukiyu Is"), replace = F)] <- "Okinawa"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Mt. Omoto"), replace = F)] <- "Yaeyama Islands"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Takarazuka"), replace = F)] <- "Kinki"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Aoshima"), replace = F)] <- "Kyushu"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Nakagusuku"), replace = F)] <- "Okinawa"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Tsushima"), replace = F)] <- "Chubu"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Hokkaido"), replace = F)] <- "Hokkaido"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Osaka"), replace = F)] <- "Kinki"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Kiu-Shiu"), replace = F)] <- "Kyushu"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$adm2, pattern = "Amakusa"), replace = F)] <- "Kyushu"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Honshiu, Namase"), replace = F)] <- "Tohoku"

table(Biogeographic_database_Ponerinae_curated$bentity2_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan"])
table(is.na(Biogeographic_database_Ponerinae_curated$bentity2_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan"]))

unique(Biogeographic_database_Ponerinae_curated$bentity2_name[Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan"])

Japan_bentity2_in_IndoMalaya <- c("Satsunan Islands", "Yaeyama Islands", "Senkaku Islands", "Daito Islands", "Okinawa")
Japan_bentity2_in_Australasia <- c("Ogasawara Islands", "Volcano Islands")

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan")] <- "Palearctic"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% Japan_bentity2_in_IndoMalaya, replace = F) ] <- "Indomalaya"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% Japan_bentity2_in_Australasia, replace = F) ] <- "Australasia"

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan")])
        
## Mexico: 15 regions in Nearctic

# # 22° Latitude. Not right but good enough for rough first estimates
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Latitude_dec < 22) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico")] <- "Neotropics"
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Latitude_dec >= 22) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico")] <- "Nearctic"

Mexico_adm1_in_Nearctic <- c("Aguascalientes", "Baja California", "Baja California Sur", "Chihuahua", "Coahuila de Zaragoza", "Durango", "Guanajuato", "Hidalgo", "México", "MÃ©xico",
                             "Nuevo León", "Nuevo LeÃ³n", "Querétaro", "QuerÃ©taro de Arteaga", "Querétaro de Arteaga", "San Luis Potosí", "San Luis PotosÃ­", "San Luis PotosÃ", "Sonora", "Tamaulipas", "Tlaxcala", "Zacatecas")

# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% Mexico_adm1_in_Nearctic, "adm1_shapeName"])
# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "MEX", "adm1_shapeName"])

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico")] <- "Neotropics"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico" & Biogeographic_database_Ponerinae_curated$adm1 %in% Mexico_adm1_in_Nearctic, replace = F) ] <- "Nearctic"

# View(Biogeographic_database_Ponerinae_curated[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = FALSE), ])

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Mexico")])

## China: 11 regions in Indomalaya

# # 33° Latitude (not right but enough for our data)
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Latitude_dec < 33) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China")] <- "Indomalaya"
# Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Latitude_dec >= 33) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China")] <- "Palearctic"

China_adm1_in_Indomalaya <- c("Chongqing", "Chongqing Municipality", "Fujian", "Fujian Province", "Guangdong", "Guangzhou Province",
                              "Guangxi", "Guangxi Zhuang Autonomous Region", "Guizhou", "Guizhou Province", "Hainan", "Hainan Province",
                              "Hong Kong", "Hong Kong Special Administrative Region", "Hubei", "Hubei Province", "Hunan", "Hunan Province",
                              "Jiangxi", "Jiangxi Province", "Yunnan", "Yunnan Province", "Zhejiang", "Zhejiang Province")

# plot(geoBoundaries_adm1_sf[replace_na(geoBoundaries_adm1_sf$adm1_shapeName %in% China_adm1_in_Indomalaya, replace = F), "adm1_shapeName"])
# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "CHN", "adm1_shapeName"])

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China")] <- "Palearctic"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China" & Biogeographic_database_Ponerinae_curated$adm1 %in% China_adm1_in_Indomalaya, replace = F) ] <- "Indomalaya"

# View(Biogeographic_database_Ponerinae_curated[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China" & is.na(Biogeographic_database_Ponerinae_curated$adm1), replace = FALSE), ])

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China")])

## USA, Hawaii: 150° longitude (works because we have no points in Alaska

# View(Biogeographic_database_Ponerinae_curated[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States of America" & (Biogeographic_database_Ponerinae_curated$Longitude_dec < -150), replace = FALSE), ])

Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States", replace = F)] <- "United States of America"

Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Longitude_dec < -150) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States of America")] <- "Australasia"
Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Longitude_dec >= -150) & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States of America")] <- "Nearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "United States of America")])

# TAAF, Ile Europa: Afrotropics
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Europa Island"), replace = F)] <- "Afrotropics"

# Netherlands, Saba Island: Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Netherlands")] <- "Palearctic"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_initial == "Bonaire, Sint Eustatius and Saba", replace = F)] <- "Neotropics"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Netherlands" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Lesser Antilles", replace = F)] <- "Neotropics"

table(Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Netherlands")])


# Clipperton Island: Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Clipperton Island", replace = F)] <- "Neotropics"


table(is.na(Biogeographic_database_Ponerinae_curated$Bioregion))
# View(Biogeographic_database_Ponerinae_curated[is.na(Biogeographic_database_Ponerinae_curated$Bioregion), c("Latitude_dec", "Longitude_dec", "Country_initial", "Country_GB_name", "Country_ISO3_name", "Country_ISO3_code", "bentity2_name", "adm1", "adm2", "Locality") ])

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


### 5.6/ Interactive map for Bioregions ####

# Extract number of categories to plot
nb_bioregions <- length(unique(Biogeographic_database_Ponerinae_curated$Bioregion[]))
bioregions_names <- levels(as.factor(Biogeographic_database_Ponerinae_curated$Bioregion))

# Define palette function
pal_bioregions <- brewer.pal(n = nb_bioregions, name = "Spectral")
# pal_4 <- pal[c(1, 4, 5, 6)]
# pal_2 <- pal[c(5, 6)]

plot(Biogeographic_database_Ponerinae_curated[, ]["Bioregion"])

# Select a unique Bioregion to display
selected_Bioregion <- "Afrotropics" 
selected_Bioregion <- "Australasia"
selected_Bioregion <- "Indomalaya"
selected_Bioregion <- "Nearctic"
selected_Bioregion <- "Neotropics"
selected_Bioregion <- "Palearctic" 

selected_bioregion_ID <- which(bioregions_names == selected_Bioregion)
  
### With color per bioregions
interactive_map_bioregions <- mapview::mapview(
  # x = Biogeographic_database_Ponerinae_curated[ , ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
  x = Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Bioregion == selected_Bioregion, ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
  zcol = "Bioregion",
  cex = 7,
  burst = T, legend = T,
  # col.regions = pal_bioregions, # Color to use to plot spatial units in the spatial object
  col.regions = pal_bioregions[selected_bioregion_ID], # Color to use to plot spatial units in the spatial object
  layer.name = "Bioregions", # To specify the legend name of this layer
  # map.types = mapviewGetOption("basemaps")
  map.types = c("OpenStreetMap", "Esri.WorldImagery")
  # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stadia.StamenWatercolor") # To specify basemaps
  # ... # and many more, depending of the class of the spatial object
)

interactive_map_bioregions


## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


##### 6/ Retrieve elevation data #####



##### 7/ Flag and remove duplicates #####

## Create a database without duplicates. Keep AntWeb over GABI when possible. Run taxa-summary stat on without duplicates data

## Load Biogeographic database with all curated coordinates
Biogeographic_database_Ponerinae_curated <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

# Consider "null" Localities as NA
Biogeographic_database_Ponerinae_curated$Locality[replace_na(data = Biogeographic_database_Ponerinae_curated$Locality == "null", replace = FALSE)] <- NA

### 7.1/ Flag duplicates of non-interpolated occurrences based on rounded GPS coordinates ####

# 0.01° = 1.1 km

# Criteria to select
  # Keep Antweb over GABI
  # Keep the one with a Locality name
  # Choose randomly based on first Occurrence ID

Biogeographic_database_Ponerinae_curated$Latitude_rounded <- round(Biogeographic_database_Ponerinae_curated$Latitude_dec, 2)
Biogeographic_database_Ponerinae_curated$Longitude_rounded <- round(Biogeographic_database_Ponerinae_curated$Longitude_dec, 2)

# Flag duplicates based on GPS coordinates
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  group_by(Current_name, Latitude_rounded, Longitude_rounded) %>% # Group by taxa and GPS coordinates
  arrange(Source, Locality, .by_group = TRUE) %>% # AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_GPS_rank = row_number()) %>% 
  mutate(Duplicates_GPS_flag = Duplicates_GPS_rank > 1) %>%
  ungroup() %>% 
  arrange(Occurrence_ID)

levels(as.factor(Biogeographic_database_Ponerinae_curated$Source))

# View(arrange(Biogeographic_database_Ponerinae_curated[, c("Current_name", "Source", "Latitude_rounded", "Longitude_rounded", "Duplicates_GPS_rank", "Duplicates_GPS_flag", "Locality", "adm2", "adm1", "Country_ISO3_name")], Current_name, Latitude_rounded, Longitude_rounded, Duplicates_GPS_rank))

### 7.2/ Remove duplicates of non-interpolated occurrences ####

# For Interpolated occurrences, use the matching shp level
# Run duplicate ranking for each possible matching level: adm2, adm1, bentity2_name, SUBUNIT_name, Country_ISO3_code

table(Biogeographic_database_Ponerinae_curated$matching_shp)

# Criteria to select,
  # Non-interpolated over interpolated
  # Keep Antweb over GABI
  # Keep the one with a Locality name
  # Keep the one with the smallest uncertainty area (although they should be the same for all duplicated occurrences)
  # Choose randomly based on first Occurrence ID

### 7.2.1/ Rank duplicates for adm2

Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  group_by(Current_name, adm2) %>% # Group by taxa and adm2
  arrange(Interpolated_coordinates, Source, Locality, Uncertainty_area, .by_group = TRUE) %>% # Non-Interpolated Occurrences 1st. AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_adm2_rank = row_number()) %>% 
  ungroup() %>% 
  arrange(Occurrence_ID)

# View(arrange(Biogeographic_database_Ponerinae_curated[, c("Current_name", "Interpolated_coordinates", "Source", "Locality", "Uncertainty_area", "Duplicates_adm2_rank", "adm2", "adm1", "Country_ISO3_name")], Current_name, adm2, Duplicates_adm2_rank))

### 7.2.2/ Rank duplicates for adm1

Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  group_by(Current_name, adm1) %>% # Group by taxa and adm2
  arrange(Interpolated_coordinates, Source, Locality, Uncertainty_area, .by_group = TRUE) %>% # Non-Interpolated Occurrences 1st. AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_adm1_rank = row_number()) %>% 
  ungroup() %>% 
  arrange(Occurrence_ID)

# View(arrange(Biogeographic_database_Ponerinae_curated[, c("Current_name", "Interpolated_coordinates", "Source", "Locality", "Uncertainty_area", "Duplicates_adm1_rank", "adm2", "adm1", "Country_ISO3_name")], Current_name, adm1, Duplicates_adm1_rank))

### 7.2.3/ Rank duplicates for bentity2

Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  group_by(Current_name, bentity2_name) %>% # Group by taxa and adm2
  arrange(Interpolated_coordinates, Source, Locality, Uncertainty_area, .by_group = TRUE) %>% # Non-Interpolated Occurrences 1st. AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_bentity2_rank = row_number()) %>% 
  ungroup() %>% 
  arrange(Occurrence_ID)

# View(arrange(Biogeographic_database_Ponerinae_curated[, c("Current_name", "Interpolated_coordinates", "Source", "Locality", "Uncertainty_area", "Duplicates_bentity2_rank", "bentity2_name", "adm2", "adm1", "Country_ISO3_name")], Current_name, bentity2_name, Duplicates_bentity2_rank))

### 7.2.4/ Rank duplicates for SUBUNIT
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  group_by(Current_name, SUBUNIT_name) %>% # Group by taxa and adm2
  arrange(Interpolated_coordinates, Source, Locality, Uncertainty_area, .by_group = TRUE) %>% # Non-Interpolated Occurrences 1st. AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_SUBUNIT_rank = row_number()) %>% 
  ungroup() %>% 
  arrange(Occurrence_ID)

# View(arrange(Biogeographic_database_Ponerinae_curated[, c("Current_name", "Interpolated_coordinates", "Source", "Locality", "Uncertainty_area", "Duplicates_SUBUNIT_rank", "SUBUNIT_name", "adm2", "adm1", "bentity2_name", "Country_ISO3_name")], Current_name, SUBUNIT_name, Duplicates_SUBUNIT_rank))

### 7.2.5/ Rank duplicates for Country_ADMIN
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  group_by(Current_name, Country_ISO3_name) %>% # Group by taxa and adm2
  arrange(Interpolated_coordinates, Source, Locality, Uncertainty_area, .by_group = TRUE) %>% # Non-Interpolated Occurrences 1st. AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_Country_rank = row_number()) %>% 
  ungroup() %>% 
  arrange(Occurrence_ID)

# View(arrange(Biogeographic_database_Ponerinae_curated[, c("Current_name", "Interpolated_coordinates", "Source", "Locality", "Uncertainty_area", "Duplicates_Country_rank", "Country_ISO3_name", "adm2", "adm1", "bentity2_name", "SUBUNIT_name")], Current_name, Country_ISO3_name, Duplicates_Country_rank))

## Flag as duplicate only if not ranked as first in its matching level

# List all matching levels
matching_level_list <- c("GB_adm2", "GB_adm1", "NE_adm1", "Bentity2", "NE_SUBUNIT", "NE_ADMIN")

# Initiate flag variable
Biogeographic_database_Ponerinae_curated$Duplicates_interpolated_flag <- F

for (i in 1:nrow(Biogeographic_database_Ponerinae_curated))
{
  # i <- 105575
  
  if (Biogeographic_database_Ponerinae_curated$Interpolated_coordinates[i]) # Only flag entries with interpolated coordinates
  {
    # Extract matching shp
    entry_matching_shp <- Biogeographic_database_Ponerinae_curated$matching_shp[i]
    
    # Extract all duplicate ranks for all matching level
    entry_duplicate_ranks <- st_drop_geometry(Biogeographic_database_Ponerinae_curated[i, c("Duplicates_adm2_rank", "Duplicates_adm1_rank", "Duplicates_adm1_rank" , "Duplicates_bentity2_rank", "Duplicates_SUBUNIT_rank" ,"Duplicates_Country_rank")])
    
    # Extract duplicate rank associated with proper matching level
    entry_matching_shp_index <- which(entry_matching_shp == matching_level_list)
    entry_duplicate_rank <- entry_duplicate_ranks[1, entry_matching_shp_index][1,1, drop = T]
    
    # Flag as duplicate if not the first in the duplicate ranking
    if (entry_duplicate_rank != 1)
    {
      Biogeographic_database_Ponerinae_curated$Duplicates_interpolated_flag[i] <- T
    }
  }
  
  # Print progress
  if (i %% 1000 == 0) { cat(paste0(Sys.time(), " - Occurrence n°",i, " / ", nrow(Biogeographic_database_Ponerinae_curated),"\n")) }
  
}

table(Biogeographic_database_Ponerinae_curated$Duplicates_interpolated_flag)

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


### 7.3/ Remove duplicates of all types ####

Biogeographic_database_Ponerinae_curated_no_duplicates <- Biogeographic_database_Ponerinae_curated %>% 
  filter(!Duplicates_GPS_flag) %>% 
  filter(!Duplicates_interpolated_flag)
  
# Compare dataset size
nrow(Biogeographic_database_Ponerinae_curated)
nrow(Biogeographic_database_Ponerinae_curated_no_duplicates)

# Compare Sources: Antweb or GABI
table(Biogeographic_database_Ponerinae_curated$Source)
table(Biogeographic_database_Ponerinae_curated_no_duplicates$Source)

# Compare Type of data: Interpolated or not
table(Biogeographic_database_Ponerinae_curated$Interpolated_coordinates)
table(Biogeographic_database_Ponerinae_curated_no_duplicates$Interpolated_coordinates)

# Compare taxa list: should be the same: 2580 taxa
length(unique(Biogeographic_database_Ponerinae_curated$Current_name))
length(unique(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name))

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated_no_duplicates, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated_no_duplicates.rds")


##### 8/ Detect outliers ####

# Rerun distance based and Bioregion-based outliers detection using also the randomly drawn occurrences

## Load Biogeographic database with non-duplicated curated coordinates
Biogeographic_database_Ponerinae_curated_no_duplicates <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated_no_duplicates.rds")

### 8.1/ Flag Distance-based outliers ####

### Need to use the custom patched version of the function to avoid issue with duplicated row.names

source("./functions/cc_outl_patch.R")

distance_outliers_flags <- cc_outl_patch(x = st_drop_geometry(Biogeographic_database_Ponerinae_curated_no_duplicates[, c("Longitude_dec", "Latitude_dec", "Current_name")]),
                                   lon = "Longitude_dec", lat = "Latitude_dec",
                                   species = "Current_name",
                                   value = "flagged",       # To define the type of output. Can be a spatial df ("spatialvalid"), a logical vector recording entries with at least one flag ("flagged"), a df with dubious coordinates removed ("clean").
                                   verbose = T,
                                   method = "distance",     # Use minimum distance to detect outlier
                                   tdi = 1000,              # Minimum distance to detect outlier (in km)
                                   min_occs = 3)            # Minimum number of records for a given taxa to test for outliers


table(distance_outliers_flags)
Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier <- !distance_outliers_flags


### 8.2/ Flag Bioregion-based outliers ####

# Create table with nb of occurrence per bioregions
Taxa_bioregions_quantitative_table <- Biogeographic_database_Ponerinae_curated_no_duplicates %>%
  st_drop_geometry() %>% 
  group_by(Current_name, Bioregion) %>% 
  summarise(nb_occ = n()) %>% 
  pivot_wider(names_from = Bioregion, values_from = nb_occ) %>%
  mutate_all(., ~replace_na(.,0))

# Turn into percentage, then binary test for bioregions hosting less than 20% of occurrences
Taxa_bioregions_quantitative_table$Total_occ <- apply(X = Taxa_bioregions_quantitative_table[, -1], MARGIN = 1, FUN = sum)  # Compute total occurrence per taxa
Taxa_bioregions_perc_table <- round(Taxa_bioregions_quantitative_table[, -1]/Taxa_bioregions_quantitative_table$Total_occ * 100, 1) # Compute percentage of occurrence per taxa in each bioregion
Taxa_bioregions_binary_test_table <- t(apply(X = Taxa_bioregions_perc_table, MARGIN = 1, FUN = function (x) {(x > 0) & (x <= 20)} )) # Flag Bioregion to consider as outliers for each taxa
row.names(Taxa_bioregions_binary_test_table) <- Taxa_bioregions_quantitative_table$Current_name
Taxa_bioregions_quantitative_table$Outliers_bioregion  <- apply(X = Taxa_bioregions_binary_test_table, MARGIN = 1, FUN = any) # Flag taxa for having any region recorded as outlier

table(Taxa_bioregions_quantitative_table$Outliers_bioregion)

# Save table of binary tests for bioregion outliers per taxa
saveRDS(object = Taxa_bioregions_binary_test_table, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_test_table.rds")

# Save table of counts of occurrences per taxa x bioregions
saveRDS(object = Taxa_bioregions_quantitative_table, file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table.rds")

# List taxa with outliers in dubious bioregions
taxa_with_bioregion_outliers <- Taxa_bioregions_quantitative_table$Current_name[Taxa_bioregions_quantitative_table$Outliers_bioregion]
taxa_with_bioregion_outliers <- taxa_with_bioregion_outliers[order(taxa_with_bioregion_outliers)]

## Loop per entry to check Bioregion outlier status based on taxa x Bioregion

# initiate variable to flag entries for being a bioregion outlier 
Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier <- F

# Loop only on entries from taxa flag as having bioregion outliers
bioregion_outliers_entry_indices <- which(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name %in% taxa_with_bioregion_outliers)

for (i in bioregion_outliers_entry_indices)
{
  # i <- 1
  
  # Extract focal taxa name
  focal_taxa <- Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name[i]
  
  # Extract list of outlier bioregions for the focal taxa
  outlier_bioregions <- names(which(Taxa_bioregions_binary_test_table[focal_taxa, ]))
  
  # Extract entry bioregion
  entry_bioregion <- Biogeographic_database_Ponerinae_curated_no_duplicates$Bioregion[i]
  
  # Flag if matching the list of outlier bioregions
  Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier[i] <- entry_bioregion %in% outlier_bioregions
}

table(Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier)

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated_no_duplicates, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated_no_duplicates.rds")


### 8.3/ Flag entries for their outliers type ####

# Bioregion outliers > Distance outliers > OK

Biogeographic_database_Ponerinae_curated_no_duplicates$Outlier_type <- "OK"
Biogeographic_database_Ponerinae_curated_no_duplicates$Outlier_type[Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier] <- "Distance"
Biogeographic_database_Ponerinae_curated_no_duplicates$Outlier_type[Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier] <- "Bioregion"

table(Biogeographic_database_Ponerinae_curated_no_duplicates$Outlier_type)


### 8.4/ Find categories of taxa according to degree of error risk in the records ####

# Can have multiple categories, but in this case, record the higher one

# Rank of categories
  # 1/	Potentially introduced
  # 2/	Bioregions outliers
  # 3/	Distance outliers
  # 4/  Stuff in analyses: two subfolders (In phylo + valid species)
  # 5/	Other stuff

## Load taxa-level summary df
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")

## Initiate a taxa-level summary df for taxa in the biogeographic database (may include morphotaxa that are not in the phylogeny)

Ponerinae_Biogeographic_taxa_database <- Biogeographic_database_Ponerinae_curated_no_duplicates %>%
  st_drop_geometry() %>%
  group_by(Current_name) %>% # Group by taxa
  mutate(Occurrence_rank = row_number()) %>% 
  ungroup() %>% 
  mutate(Occurrence_filter = Occurrence_rank == 1) %>%
  filter(Occurrence_filter) %>%
  select(Current_name)

## 8.4.1/ Flag taxa for Potentially introduced status ####

# Load AntWeb information about native range of potentially introduced species
Introduced_species_native_range_binary <- read.xlsx(xlsxFile = "./input_data/Biogeographic_data/Introduced_Map_Manager.xlsx")
Introduced_species_native_range_binary$Genus_species <- paste0(Introduced_species_native_range_binary$Genus, "_", Introduced_species_native_range_binary$species)

row.names(Introduced_species_native_range_binary) <- Introduced_species_native_range_binary$Genus_species

# Merge Afrotropical and Magalasy into Afrotropics
Introduced_species_native_range_binary$Afrotropics <- as.numeric(Introduced_species_native_range_binary$Afrotropical | Introduced_species_native_range_binary$Malagasy)

# Merge Australasia and Oceania into Australasia_extended
Introduced_species_native_range_binary$Australasia_extended <- as.numeric(Introduced_species_native_range_binary$Australasia | Introduced_species_native_range_binary$Oceania)

# Extract list of potentially introduced taxa
taxa_potentially_introduced <- Introduced_species_native_range_binary$Genus_species[order(Introduced_species_native_range_binary$Genus_species)]

# Clean table
Introduced_species_native_range_binary <- Introduced_species_native_range_binary %>% 
  select(-Australasia) %>% 
  rename(Neotropics = Neotropical) %>%
  rename(Australasia = Australasia_extended) %>% 
  select("Afrotropics", "Australasia", "Indomalaya", "Nearctic", "Neotropics", "Palearctic")

## Flag Introduced species in Taxa-level summary df
Ponerinae_Biogeographic_taxa_database$Taxa_Potentially_Introduced <- Ponerinae_Biogeographic_taxa_database$Current_name %in% taxa_potentially_introduced
table(Ponerinae_Biogeographic_taxa_database$Taxa_Potentially_Introduced)

## Save table for binary native range of Introduced species
saveRDS(object = Introduced_species_native_range_binary, file = "./input_data/AntWeb_data/Introduced_species_native_range_binary.rds")

## 8.4.2/ Flag taxa for Biogeographic outliers ####

# Flag them in Taxa-level summary df
Ponerinae_Biogeographic_taxa_database$Taxa_with_Bioregion_outliers <- Ponerinae_Biogeographic_taxa_database$Current_name %in% taxa_with_bioregion_outliers
table(Ponerinae_Biogeographic_taxa_database$Taxa_with_Bioregion_outliers)

## 8.4.3/ Flag taxa for Distance outliers ####

taxa_with_distance_outliers <- unique(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name[Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier])
taxa_with_distance_outliers <- taxa_with_distance_outliers[order(taxa_with_distance_outliers)]

# Flag them in Taxa-level summary df
Ponerinae_Biogeographic_taxa_database$Taxa_with_Distance_outliers <- Ponerinae_Biogeographic_taxa_database$Current_name %in% taxa_with_distance_outliers
table(Ponerinae_Biogeographic_taxa_database$Taxa_with_Distance_outliers)

## 8.4.4/ Flag taxa for use in Analyses (Valid taxa + Morphotaxa in phylogeny) ####

taxa_In_analyses <- Ponerinae_Macroevolution_taxa_database$Current_name
taxa_In_analyses <- taxa_In_analyses[order(taxa_In_analyses)]

# Flag them in Taxa-level summary df
Ponerinae_Biogeographic_taxa_database$Taxa_In_analyses <- Ponerinae_Biogeographic_taxa_database$Current_name %in% taxa_In_analyses
table(Ponerinae_Biogeographic_taxa_database$Taxa_In_analyses)

## 8.4.5/ Record main type of taxa according to the hierarchy of categories

Ponerinae_Biogeographic_taxa_database$Taxa_Type <- "Other"
Ponerinae_Biogeographic_taxa_database$Taxa_Type[Ponerinae_Biogeographic_taxa_database$Taxa_In_analyses] <- "In_analyses"
Ponerinae_Biogeographic_taxa_database$Taxa_Type[Ponerinae_Biogeographic_taxa_database$Taxa_with_Distance_outliers] <- "Distance_outliers"
Ponerinae_Biogeographic_taxa_database$Taxa_Type[Ponerinae_Biogeographic_taxa_database$Taxa_with_Bioregion_outliers] <- "Bioregion_outliers"
Ponerinae_Biogeographic_taxa_database$Taxa_Type[Ponerinae_Biogeographic_taxa_database$Taxa_Potentially_Introduced] <- "Potentially_introduced"

table(Ponerinae_Biogeographic_taxa_database$Taxa_Type)

## Save taxa-level summary df for taxa in the biogeographic database (may include morphotaxa that are not in the phylogeny)
saveRDS(object = Ponerinae_Biogeographic_taxa_database, file = "./input_data/Biogeographic_data/Ponerinae_Biogeographic_taxa_database.rds")


### 8.5/ Plot maps per taxa and display them in proper category ####

Ponerinae_Biogeographic_taxa_database <- readRDS(file = "./input_data/Biogeographic_data/Ponerinae_Biogeographic_taxa_database.rds")


# Use shapes for type of records: true (stars?) vs. interpolated (circles)
# Use size and transparency for uncertainty of record => Bigger and more transparent ~ Uncertainty_area
# Use colors for outliers: green = OK ; orange = Distance ; red = Bioregion

# For potentially introduced species, display the native range on the map as a title. Use "Unknown" for cases where there is no native range recorded

## Prepare color palette

# Create Green/Orange/Red palette
Green_col <- RColorBrewer::brewer.pal(n = 6, "Greens")[5]
Orange_col <- RColorBrewer::brewer.pal(n = 6, "Oranges")[3]
Red_col <- RColorBrewer::brewer.pal(n = 6, "Reds")[5]
pal_ROG <- c(Red_col, Orange_col, Green_col)

## Prepare size vector from 6 to 40 based on Uncertainty area

Biogeographic_database_Ponerinae_curated_no_duplicates$Uncertainty_area[is.na(Biogeographic_database_Ponerinae_curated_no_duplicates$Uncertainty_area)] <- set_units(0, km^2)

# Use log(x+1)
cex_values <- log1p(drop_units(Biogeographic_database_Ponerinae_curated_no_duplicates$Uncertainty_area))
# Constrain range between 0 and 1
cex_values <- (cex_values - min(cex_values)) / (max(cex_values) - min(cex_values))
# Constrain range between 6 and 40
cex_values <- cex_values * (40-6) + 6
hist(cex_values)

## Prepare alpha vector from 0.2 to 0.6 based on Uncertainty area

Biogeographic_database_Ponerinae_curated_no_duplicates$Uncertainty_area[is.na(Biogeographic_database_Ponerinae_curated_no_duplicates$Uncertainty_area)] <- set_units(0, km^2)

# Use log(x+1)
alpha_values <- log1p(drop_units(Biogeographic_database_Ponerinae_curated_no_duplicates$Uncertainty_area))
# Reverse values
alpha_values <- -1 * alpha_values + max(alpha_values)
# Constrain range between 0 and 1
alpha_values <- (alpha_values - min(alpha_values)) / (max(alpha_values) - min(alpha_values))
# Constrain range between 0.2 and 0.6
alpha_values <- alpha_values * 0.4 + 0.2
hist(alpha_values)


# ## Function to create temporary icons
# pchIcons <- function(pch = 1, width = 30, height = 30, bg = "transparent", col = "black", ...)
# {
#   n = length(pch)
#   files = character(n)
#   # create a sequence of png images
#   for (i in seq_len(n)) {
#     f = tempfile(fileext = '.png')
#     png(f, width = width, height = height, bg = bg)
#     par(mar = c(0, 0, 0, 0))
#     plot.new()
#     points(.5, .5, pch = pch[i], col = col[i], cex = min(width, height) / 8, ...)
#     dev.off()
#     files[i] = f
#   }
#   files
# }


# ## Prepare shape vector with pch = 16 (circle) for interpolated data ; pch = 17 (triangle) for non-interpolated data
# shape_values = c(17, 16)[as.numeric(Biogeographic_database_Ponerinae_curated_no_duplicates$Interpolated_coordinates) + 1]

## Initiate list of taxa type and associated output folders
taxa_type_list <- c("Potentially_introduced", "Bioregion_outliers", "Distance_outliers", "In_analyses", "Other")
taxa_type_folder_list <- c("01_Potentially_introduced", "02_Bioregion_outliers", "03_Distance_outliers", "04_In_analyses", "05_Others")

### Loop per taxa

# Generate map
# Adjust title if Introduced
# Save screenshot in proper folder according to type
# Save the interactive version for # 1/	Potentially introduced # 2/	Bioregions outliers # 3/	Distance outliers

taxa_for_interactive_maps <- which(Ponerinae_Biogeographic_taxa_database$Taxa_Type %in% c("Potentially_introduced", "Bioregion_outliers", "Distance_outliers"))

# for (i in taxa_for_interactive_maps)
for (i in 1:nrow(Ponerinae_Biogeographic_taxa_database))
{
  # i <- 1
  # i <- 2
  
  # Extract type of taxa
  taxon_type <- Ponerinae_Biogeographic_taxa_database$Taxa_Type[i]
  
  # Extract occurrence data for the focal taxa
  focal_taxon <- Ponerinae_Biogeographic_taxa_database$Current_name[i]
  taxon_entry_indices <- Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == focal_taxon
  focal_taxon_occ_data <- Biogeographic_database_Ponerinae_curated_no_duplicates[taxon_entry_indices, ]
  
  # Adjust cex and alpha
  cex_adjusted <- cex_values[taxon_entry_indices]
  alpha_adjusted <- alpha_values[taxon_entry_indices]
  # shape_adjusted <- shape_values[taxon_entry_indices]
  
  # Adjust color palette according to the type of occurrences to show
  pal_adjusted <- pal_ROG[c("Bioregion", "Distance", "OK") %in% focal_taxon_occ_data$Outlier_type]
  
  # # Create temporary icons
  # iconFiles <- pchIcons(pch = shape_adjusted, width = 40, height = 40, col = pal_adjusted[as.numeric(as.factor(focal_taxon_occ_data$Outlier_type))], lwd = 4)
  
  # Need this option to enable screenshots! Need to be set before creating the mapview object
  mapviewOptions(fgb = FALSE) 
  
  # Plot by taxa in case of doubt for the group to evaluate
  interactive_map_focal_taxon <- mapview::mapview(x = focal_taxon_occ_data, # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                                  zcol = "Outlier_type",
                                                  cex = cex_adjusted,
                                                  burst = T, legend = T,
                                                  col.regions = pal_adjusted, # Color to use to plot spatial units in the spatial object
                                                  # alpha.regions = regionOpacity(x), # Alpha to use to plot spatial units in the spatial object
                                                  alpha.regions = alpha_adjusted, # Alpha to use to plot spatial units in the spatial object
                                                  layer.name = "Occurrences", # To specify the legend name of this layer
                                                  # map.types = mapviewGetOption("basemaps")
                                                  map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                                  # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                                  # ... # and many more, depending of the class of the spatial object
  )
  
  # ## Add non-interpolated occurrences as additional markers using leaflet
  # 
  # # ?leaflet::addMarkers
  # # ?leaflet::addLayersControl
  # 
  # interactive_map_focal_taxon@map <- interactive_map_focal_taxon@map %>%
  #   leaflet::addMarkers(data = focal_taxon_occ_data,
  #                       lng = ~Longitude_dec, lat = ~Latitude_dec,
  #                       group = "Type", label = ~Outlier_type,
  #                       icon = ~ icons(iconWidth = 40, iconHeight = 40,
  #                         iconUrl = iconFiles, 
  #                         popupAnchorX = 20, popupAnchorY = 0
  #                       ),
  #                       labelOptions=labelOptions(noHide=F),
  #                       popup = ~paste0("Group = ",focal_taxon_occ_data$Outlier_type))
  
  # Create title HTML object
  tag.map.title <- htmltools::tags$style(HTML("
    .leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 40%;
    bottom: 2%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    font-size: 22px;
    }
    "))
  
  # Adjust title according to the type of Taxa
  if (taxon_type == "Potentially_introduced") 
  {
    # Include information on Native range
    
    # Extract list of outlier bioregions for the focal taxa
    outlier_bioregions <- names(Introduced_species_native_range_binary)[as.logical(Introduced_species_native_range_binary[focal_taxon, ])]
    if (length(outlier_bioregions) == 0) { outlier_bioregions <- "Unknown" }
    if (length(outlier_bioregions) > 1) { outlier_bioregions <- paste0(outlier_bioregions, collapse = ", ") }
    
    title <- tags$div(
      tag.map.title, 
      HTML(text = paste0(str_replace(string = focal_taxon, pattern = "_", replacement = " "), "<br/>Native range: ", outlier_bioregions))) # Type title
    
  } else {
    
    # Only taxa name
    
    title <- tags$div(
      tag.map.title, 
      HTML(text = str_replace(string = focal_taxon, pattern = "_", replacement = " "))) # Type title
  }
  
  # Add title to the leafmap /mapview object
  interactive_map_focal_taxon@map <- interactive_map_focal_taxon@map %>%
    leaflet::addControl(title, position = "bottomleft", className = "map-title")
  
  interactive_map_focal_taxon
  
  ## Select output folder according to taxa type
  taxa_type_folder <- taxa_type_folder_list[taxa_type_list %in% taxon_type]
  
  ## Save a screenshot
  mapshot(x = interactive_map_focal_taxon,
          file = paste0("./maps/Taxa_occurrence_Control_maps/Screenshots/",taxa_type_folder,"/Occurrences_control_map_",focal_taxon,".jpeg"),
          remove_controls = NULL # delay = 0.5
  )
  
  ## Save the interactive version
  if (taxon_type %in% c("Potentially_introduced", "Bioregion_outliers", "Distance_outliers"))
  {
    mapshot(x = interactive_map_focal_taxon,
            url = paste0("./maps/Taxa_occurrence_Control_maps/Interactive_maps/",taxa_type_folder,"/Occurrences_control_interactive_map_",focal_taxon,".html"), # To save an interactive .html map
            remove_controls = NULL) # c("zoomControl", "layersControl", "homeButton", "scaleBar"))  # To specify which control buttons to remove (or not) from the output
  }
  
  mapviewOptions(fgb = TRUE)
  
  # Print progress
  cat(paste0(Sys.time(), " - Map plotted for ", focal_taxon, " = Taxon N°",i,"/",nrow(Ponerinae_Biogeographic_taxa_database),"\n"))
}


### 8.6/ Create .xlsx tables to evaluate taxa ####

## Load taxa-level summary df for taxa in the biogeographic database (may include morphotaxa that are not in the phylogeny)
Ponerinae_Biogeographic_taxa_database <- readRDS(object = Ponerinae_Biogeographic_taxa_database, file = "./input_data/Biogeographic_data/Ponerinae_Biogeographic_taxa_database.rds")

Evaluation_table_occurrence_maps <- Ponerinae_Biogeographic_taxa_database

# Add In_phylogeny information
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")
Evaluation_table_occurrence_maps$In_phylogeny <- Evaluation_table_occurrence_maps$Current_name %in% Ponerinae_Macroevolution_taxa_database$Current_name[Ponerinae_Macroevolution_taxa_database$In_phylogeny]

# Add new columns to record evaluations
Evaluation_table_occurrence_maps <- Evaluation_table_occurrence_maps %>% 
  mutate(Evaluation = NA, Comments = NA, Source = NA)
  
# Arrange by priority
Evaluation_table_occurrence_maps$Taxa_Type <- factor(x = Evaluation_table_occurrence_maps$Taxa_Type, levels = c("Potentially_introduced", "Bioregion_outliers", "Distance_outliers", "In_analyses", "Other"))
Evaluation_table_occurrence_maps <- Evaluation_table_occurrence_maps %>% 
  arrange(Taxa_Type, desc(In_phylogeny), Current_name)

# Merge with previous evaluations when occurrences missing GPS coordinates were not included
Evaluation_table_taxa_outliers_v1 <- read.xlsx(xlsxFile = "./input_data/Biogeographic_data/Evaluation_table_taxa_outliers_v1.xlsx")
Evaluation_table_taxa_outliers_v1 <- Evaluation_table_taxa_outliers_v1 %>% 
  rename(Previous_Source = eval.source) %>%
  rename(Previous_Comments = Comments) %>%
  rename(Previous_Evaluation = Evaluation) %>% 
  select(Taxa, Previous_Evaluation, Previous_Comments, Previous_Source)

Evaluation_table_occurrence_maps <- left_join(x = Evaluation_table_occurrence_maps, y = Evaluation_table_taxa_outliers_v1, by= c("Current_name" = "Taxa"))

## Export evaluation table to be filled
saveRDS(object = Evaluation_table_occurrence_maps, file = "./input_data/Biogeographic_data/Evaluation_table_occurrence_maps.rds")
openxlsx::write.xlsx(x = Evaluation_table_occurrence_maps, file = "./input_data/Biogeographic_data/Evaluation_table_occurrence_maps.xlsx")

table(Evaluation_table_occurrence_maps$Taxa_Type, Evaluation_table_occurrence_maps$In_phylogeny)

##### 9/ Manually curate biogeographic errors based on visual checking of maps ####

### 9.1/ Add field for individual curation of Bioregion assignments ####

# To keep true Bioregion of outliers, but record 'curated' version to use for Bioregion assignment table

Biogeographic_database_Ponerinae_curated$Bioregion_from_GPS <- Biogeographic_database_Ponerinae_curated$Bioregion

### 9.2/ Occurrences to change (Location match a more credible GPS location, or redetermination) ####

# Occurrence n°41364: Anochetus_mayri in Sonora. Not credible that north. Locality = Manicaragua in Cuba. # adm2 = Manicaragua # adm1 = Villa Clara
Biogeographic_database_Ponerinae_curated$Latitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- 22.148
Biogeographic_database_Ponerinae_curated$Longitude_dec[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- -79.975
Biogeographic_database_Ponerinae_curated$Latitude_rounded[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- 22.15
Biogeographic_database_Ponerinae_curated$Longitude_rounded[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- -79.98
Biogeographic_database_Ponerinae_curated$Country_ISO3_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = F)] <- "Cuba"
Biogeographic_database_Ponerinae_curated$Country_ISO3_code[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = F)] <- "CUB"
Biogeographic_database_Ponerinae_curated$Country_GB_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = F)] <- "Cuba"
Biogeographic_database_Ponerinae_curated$SUBUNIT_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = F)] <- "Cuba"
Biogeographic_database_Ponerinae_curated$bentity2_name[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = F)] <- "Cuba"
Biogeographic_database_Ponerinae_curated$adm1[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- "Villa Clara"
Biogeographic_database_Ponerinae_curated$adm2[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- "Manicaragua"
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- "Neotropics"
Biogeographic_database_Ponerinae_curated$Bioregion_from_GPS[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Manicaragua"), replace = FALSE)] <- "Neotropics"

# Reidentify occurrence of Leptogenys_peninsularis in Guerrero, Mexico to Leptogenys_peninsularis_nr
occ_ID <- Biogeographic_database_Ponerinae_curated$Occurrence_ID[replace_na(data = (Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_peninsularis" & Biogeographic_database_Ponerinae_curated$adm1 == "Guerrero"), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$Current_name[Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% occ_ID] <- "Leptogenys_peninsularis_nr"

# Reidentify records of Odontoponera_transversa in the Philippines as Odontoponera_denticulata
occ_ID <- Biogeographic_database_Ponerinae_curated$Occurrence_ID[replace_na(data = (Biogeographic_database_Ponerinae_curated$Current_name == "Odontoponera_transversa" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Philippines"), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$Current_name[Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% occ_ID] <- "Odontoponera_denticulata"

# Reidentify records of Euponera_sharpi from Afrotropics as Euponera_brunoi
occ_ID <- Biogeographic_database_Ponerinae_curated$Occurrence_ID[replace_na(data = (Biogeographic_database_Ponerinae_curated$Current_name == "Euponera_sharpi" & Biogeographic_database_Ponerinae_curated$Bioregion == "Afrotropics"), replace = FALSE)]
Biogeographic_database_Ponerinae_curated$Current_name[Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% occ_ID] <- "Euponera_brunoi"

# Anochetus_siphneus => Anochetus_katonae_nr2. Change all specimens records from Zambia!!!
Biogeographic_database_Ponerinae_curated$Current_status[(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_siphneus") & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Zambia")] <- "morphotaxon"
Biogeographic_database_Ponerinae_curated$Current_name[(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_siphneus") & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Zambia")] <- "Anochetus_katonae_nr2"
# Anochetus_siphneus => Anochetus_katonae_nr3. Rename specimen from DRC for a new unique name (Anochetus_katonae_nr3) not to use in our database!!!
Biogeographic_database_Ponerinae_curated$Current_status[(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_siphneus") & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Democratic Republic of Congo")] <- "morphotaxon"
Biogeographic_database_Ponerinae_curated$Current_name[(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_siphneus") & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Democratic Republic of Congo")] <- "Anochetus_katonae_nr3"

# Odontomachus_brunneus => Odontomachus_brunneus_nr. Change all specimens records from South America/Outside South East USA!!!
Biogeographic_database_Ponerinae_curated$Current_status[(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_brunneus") & (Biogeographic_database_Ponerinae_curated$Bioregion == "Neotropical")] <- "morphotaxon"
Biogeographic_database_Ponerinae_curated$Current_name[(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_brunneus") & (Biogeographic_database_Ponerinae_curated$Bioregion == "Neotropical")] <- "Odontomachus_brunneus_nr"

# Change all Hypoponera punctatissima records to Hypoponera ergatandria, except for the specimens in South Africa identified by Phil
View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_punctatissima",])
True_Hypoponera_punctatissima_Codes <- c("casent0884422", "casent0884423", "casent0884424", "casent0884432")
Biogeographic_database_Ponerinae_curated$Current_name[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_punctatissima" & !(Biogeographic_database_Ponerinae_curated$Specimen_code %in% True_Hypoponera_punctatissima_Codes)] <- "Hypoponera_ergatandria"
Biogeographic_database_Ponerinae_curated$Name_updated[Biogeographic_database_Ponerinae_curated$Initial_name == "Hypoponera_punctatissima" & !(Biogeographic_database_Ponerinae_curated$Specimen_code %in% True_Hypoponera_punctatissima_Codes)] <- TRUE
# Treat bioregion outlier in Egypt as an Afrotropics record.
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_ergatandria"] <- "Afrotropics"
Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_ergatandria"] <- "Afrotropics"
Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_ergatandria"] <- "Afrotropics"
Biogeographic_database_Ponerinae_curated$Bioregion_8[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_ergatandria"] <- "Afrotropics"
# Check updated database
View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_punctatissima",])
View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_ergatandria",])

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "CUB", ])
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "CUB", ])

# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% c("Fortín"), "adm1_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "CUB", "adm1_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "CUB", "adm2_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeName %in% c("Oshima"), "adm2_shapeName"])

# par(oma = c(0,0,3,10))
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "CUB", "adm1_shapeName"])


# ## Save Biogeographic database with all curated coordinates
# saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


### 9.3/ Occurrences to add from new AntWeb update to fill gaps ####

# Use Brian's updated AntWeb database
Last_update_AntWeb_df <- read_excel("input_data/AntWeb_data/AntWeb_database_Ponerinae_2024_05_30.xlsx")

## Leptogenys_falcigera
View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_falcigera",])
# Keep only records in continental Afrotropics
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  filter(!(Current_name == "Leptogenys_falcigera" & Bioregion != "Afrotropics"))
# Add records from continental Afrotropics previously recorded as Introduced
New_records_Leptogenys_falcigera <- Last_update_AntWeb_df %>% 
  filter(species == "falcigera" & bioregion == "Afrotropical") %>%
  mutate(Current_name = "Leptogenys_falcigera",
         Initial_name = "Leptogenys_falcigera",
         Name_updated = FALSE,
         Current_status = "valid",
         In_phylogeny = TRUE,
         Latitude_dec = decimal_latitude,
         Longitude_dec = decimal_longitude,
         Country_initial = country,
         adm1 = adm1,
         adm2 = "Mecufi", # To retrieve
         Locality = localityname,
         bentity2_name = country, # To adjust
         Source = "AntWeb",
         Specimen_code = SpecimenCode,
         Locality_code = localitycode,
         Elevation = elevation,
         duplicate = FALSE, # To check
         Latitude_dec_initial = decimal_latitude,
         Longitude_dec_initial = decimal_longitude,
         adm1_initial = adm1,
         adm2_initial = adm2,
         Locality_initial = localityname,
         bentity2_name_initial = country, # To adjust
         Elevation_initial = elevation,
         Country_ISO3_name = country, # To adjust
         Country_ISO3_code = "MOZ", # To adjust
         valid_coordinates = TRUE,
         Bioregion = "Afrotropics",
         Interpolated_coordinates = FALSE,
         SUBUNIT_name = country, # To adjust
         Uncertainty_area = units::set_units(0, "km^2"), 
         Interpolated_adm1 = FALSE,
         Interpolated_adm2 = FALSE,
         Uncertainty_adm2 = 0, 
         Uncertainty_adm1 = 0, 
         Interpolated_Bentity2 = FALSE,
         Country_GB_name = country, # To adjust
         valid_GB_Country_name = TRUE,
         Latitude_rounded = round(decimal_latitude, 2),
         Longitude_rounded = round(decimal_longitude, 2),
         Bioregion_7_PaleA = "Afrotropics",
         Bioregion_7_Malagasy = "Afrotropics",
         Bioregion_8 = "Afrotropics",
         Updated_coordinates = FALSE,
         Updated_adm2 = TRUE,
         Updated_adm1 = FALSE,
         Updated_Bentity2 = FALSE,
         Updated_Country = FALSE) %>%
  select(Current_name, Initial_name, Name_updated, Current_status, In_phylogeny, Latitude_dec, Longitude_dec, Country_initial, adm1, adm2,
         Locality, bentity2_name, Source, Specimen_code, Locality_code, Elevation, duplicate, Latitude_dec_initial, Longitude_dec_initial,
         adm1_initial, adm2_initial, Locality_initial, bentity2_name_initial, Elevation_initial, Country_ISO3_name, Country_ISO3_code, 
         valid_coordinates, Bioregion, Interpolated_coordinates, SUBUNIT_name, Uncertainty_area, Interpolated_adm1,
         Interpolated_adm2, Uncertainty_adm1, Uncertainty_adm1, Interpolated_Bentity2, Country_GB_name, valid_GB_Country_name,
         Latitude_rounded, Longitude_rounded, Bioregion_7_PaleA, Bioregion_7_Malagasy, Bioregion_8,
         Updated_coordinates, Updated_adm2, Updated_adm1, Updated_Bentity2, Updated_Country)
# Retrieve adm2
# View(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "MOZ", "adm2_shapeName"])
# plot(geoBoundaries_adm2_sf[geoBoundaries_adm2_sf$adm2_shapeGroup == "MOZ", "adm2_shapeName"])
# Add occurrence_ID
last_occurrence_ID <- max(Biogeographic_database_Ponerinae_curated$Occurrence_ID)
New_records_Leptogenys_falcigera$Occurrence_ID <- (last_occurrence_ID + 1):(last_occurrence_ID + nrow(New_records_Leptogenys_falcigera))
# Flag duplicates based on GPS coordinates
New_records_Leptogenys_falcigera <- New_records_Leptogenys_falcigera %>% 
  group_by(Current_name, Latitude_rounded, Longitude_rounded) %>% # Group by taxa and GPS coordinates
  arrange(Source, Locality, .by_group = TRUE) %>% # AntWeb 1st, GABI 2nd. NA Locality as last
  mutate(Duplicates_GPS_rank = row_number()) %>% 
  mutate(Duplicates_GPS_flag = Duplicates_GPS_rank > 1) %>%
  mutate(duplicate = Duplicates_GPS_flag) %>%
  ungroup() %>% 
  arrange(Occurrence_ID)
# Add missing columns
template_df <- Biogeographic_database_Ponerinae_curated[0,]
New_records_Leptogenys_falcigera <- left_join(New_records_Leptogenys_falcigera, template_df)
New_records_Leptogenys_falcigera <- New_records_Leptogenys_falcigera %>% 
  select(names(Biogeographic_database_Ponerinae_curated))
# Add geometry
New_records_Leptogenys_falcigera$Latitude_copy <- New_records_Leptogenys_falcigera$Latitude_dec
New_records_Leptogenys_falcigera$Longitude_copy <- New_records_Leptogenys_falcigera$Longitude_dec
New_records_Leptogenys_falcigera <- sf::st_as_sf(New_records_Leptogenys_falcigera, coords = c("Longitude_copy", "Latitude_copy"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
sf::st_crs(New_records_Leptogenys_falcigera) <- sp::CRS('+init=EPSG:4326')
# Add to occurrence database
Biogeographic_database_Ponerinae_curated <- rbind(Biogeographic_database_Ponerinae_curated, New_records_Leptogenys_falcigera)
# Check updated database
View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_falcigera", ])


### 9.4/ Occurrences to remove (not credible, or introduced) ####

# Brachyponera_chinensis: Remove distance outlier in India
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_chinensis" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code == "IND"), ]
# Brachyponera_chinensis: Remove bioregion outlier in Ogasawara Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_chinensis" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Ogasawara Islands")), ]

# Brachyponera_obscurans: Remove Bioregion outlier in Himachal Pradesh
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_obscurans" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Himachal Pradesh")), ]

# Brachyponera_sennaarensis: Remove all occurrences from Cabo Verde (introduced)
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!((Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_sennaarensis") & (Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Cabo Verde")), ]

# Leptogenys_maxillosa: Remove distance outliers in DRC and Sudan
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_maxillosa" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code == "SDN"), ]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_maxillosa" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code == "COD"), ]

# Odontomachus_ruginodis: Remove Bioregion outlier in New Caledonia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_ruginodis" & Biogeographic_database_Ponerinae_curated$bentity2_name == "New Caledonia"), ]

# Odontomachus_simillimus: Remove all distance and bioregion outliers
bioreg_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Odontomachus_simillimus" & Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier)]
dist_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Odontomachus_simillimus" & !Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier & Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% dist_outliers_ID), ]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID), ]

# Parvaponera_darwinii: Remove outlier from UAE. Also remove Afrotropics records as suspected from Introduction.
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  filter(!(Current_name == "Parvaponera_darwinii" & Bioregion %in% c("Afrotropics", "Palearctic")))

# Platythyrea_parallela: Remove distance outliers
dist_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Platythyrea_parallela" & !Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier & Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% dist_outliers_ID), ]
# Platythyrea_parallela: Record bioregion outliers in Hymalayan India as IndoMalaya
bioreg_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Platythyrea_parallela" & Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier)]
Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID)] <- "Indomalaya"

# Ponera_leae: Remove distance outlier from Western Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_leae" & Biogeographic_database_Ponerinae_curated$adm1 == "Western Australia"), ]

# Ponera_leae: Remove outliers from New Zealand
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_leae" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "New Zealand"), ]
# Ponera_swezeyi: Remove records from Hawaii
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_swezeyi" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Hawaii"), ]

# Pseudoponera_stigma: Remove all bioregion outliers in Florida and Northern Mexico
bioreg_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Pseudoponera_stigma" & Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID), ]

# Brachyponera_luteipes: Remove all bioregion outliers in Pacific Islands, except Maluku Island
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_luteipes" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Ogasawara Islands", "Micronesia", "Palau")), ]

# Hypoponera_elliptica: Remove distance outlier from Victoria, Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_elliptica" & Biogeographic_database_Ponerinae_curated$adm1 == "Victoria"), ]

# Hypoponera_opacior: Remove everything that is not in the Caribbean region
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_opacior" & !Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Lesser Antilles", "Puerto Rico", "Trinidad and Tobago", "Hispaniola", "Cuba", "Jamaica", "Bahamas")), ]

# Pachycondyla_solitaria: Remove records from the Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Pachycondyla_solitaria" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PHL")), ]

# Anochetus_cato: Remove records from the Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_cato" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PHL")), ]

# Anochetus_ghilianii: Remove records from Brazil
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_ghilianii" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("BRA")), ]

# Anochetus_graeffei: Remove distance outliers from Kiribati
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_graeffei" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("KIR")), ]
# Anochetus_graeffei: Remove bioregion outliers in Afrotropics and Neotropics
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_graeffei" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Neotropics", "Afrotropics")), ]
# Anochetus_graeffei: Record bioregion outliers in Himalayan India as IndoMalaya
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_graeffei" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Anochetus_myops: Treat bioregion outliers in Himalayan India as Indomalaya records
bioreg_outliers_ID <- Biogeographic_database_Ponerinae_curated$Occurrence_ID[(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_myops" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Palearctic"))]
Biogeographic_database_Ponerinae_curated$Bioregion[(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID)] <- "Indomalaya"

# Anochetus_turneri: Remove the distance outlier in South Australia 
dist_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Anochetus_turneri" & !Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier & Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% dist_outliers_ID), ]
# Anochetus_turneri: Remove the bioregion outlier in the Philippines
bioreg_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Anochetus_turneri" & Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID), ]

# Belonopelta_deletrix: Remove records from Durango
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Belonopelta_deletrix" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Durango")), ]
# Belonopelta_deletrix: Treat record from Hidalgo as Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Belonopelta_deletrix" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Hidalgo")] <- "Neotropics"

# Centromyrmex_feae: Remove bioregion outliers in Afrotropics
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Centromyrmex_feae" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Afrotropics")), ]

# Cryptopone_guatemalensis: Treat record from Hidalgo as Neotropics.
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Cryptopone_guatemalensis" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Hidalgo")] <- "Neotropics"

# Cryptopone_ochracea: Remove bioregion outlier in New Caledonia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Cryptopone_ochracea" & Biogeographic_database_Ponerinae_curated$bentity2_name == "New Caledonia"), ]

# Cryptopone_testacea: Remove distance outlier in Victoria, Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Cryptopone_testacea" & Biogeographic_database_Ponerinae_curated$adm1 == "Victoria"), ]

# Cryptopone_typhlos: Remove bioregion outlier in Papua New Guinea
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Cryptopone_typhlos" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code == "PNG"), ]

# Ectomomyrmex_annamitus: Remove bioregion outliers in Palearctic China
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ectomomyrmex_annamitus" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Palearctic")), ]

# Ectomomyrmex_astutus: Remove bioregion outliers in PNG and Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ectomomyrmex_astutus" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("AUS", "PNG")), ]

# Ectomomyrmex_leeuwenhoeki: Remove bioregion outliers in Gansu Province, China
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ectomomyrmex_leeuwenhoeki" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Gansu Province")), ]

# Hypoponera_inexorata: Remove outliers from Ecuador, Dominican Republic, Panama, Costa Rica, Guatemala, and Quintana Roo (Mexico).
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_inexorata" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Ecuador", "Hispaniola", "Panama", "Costa Rica", "Guatemala", "Quintana Roo")), ]

# Hypoponera_nitidula: Remove records from Rio de Janeiro (Brazil), Suriname, and Durango (Mexico).
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_nitidula" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Rio de Janeiro", "Suriname", "Durango")), ]

# Hypoponera_trigona: Remove bioregion outliers in the USA
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_trigona" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("USA")), ]

# Leptogenys_consanguinea: Remove records in Argentina and Durango, Mexico
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_consanguinea" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("ARG")), ]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_consanguinea" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Durango")), ]

# Leptogenys_diminuta: Remove bioregion outliers in Himalayan India and Palearctic China
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_diminuta" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Palearctic")), ]

# Leptogenys_elongata: Remove Washington DC (District of Columbia) record
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_elongata" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("District of Columbia")), ]

# Leptogenys_montuosa: Remove all Mexican records
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_montuosa" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("MEX")), ]

# Leptogenys_pubiceps: Remove Galapagos (Ecuador) and Sonora (Mexico) records
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_pubiceps" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Galápagos", "Sonora")), ]

# Mesoponera_australis: Remove Sumatra records
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Mesoponera_australis" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Sumatra")), ]

# Mesoponera_melanaria: Remove from Seychelles as suspected from introduction
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Mesoponera_melanaria" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Seychelles")), ]

# Mesoponera_rubra: Remove bioregion outliers in PNG and Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Mesoponera_rubra" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("AUS", "PNG")), ]

# Neoponera_apicalis: Treat bioregion outliers in Nearctic Mexico as Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Neoponera_apicalis" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Nearctic")] <- "Neotropics"

# Neoponera_crenata: Remove bioregion outliers in Nearctic Mexico
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Neoponera_crenata" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Nearctic")), ]

# Neoponera_lineaticeps: Treat bioregion outliers in Nearctic Mexico as Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Neoponera_lineaticeps" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Nearctic")] <- "Neotropics"

# Neoponera_unidentata: Treat bioregion outliers in Nearctic Mexico as Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Neoponera_unidentata" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Nearctic")] <- "Neotropics"

# Odontomachus_assiniensis: Remove bioregion outlier in Malaysia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_assiniensis" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("MYS")), ]

# Odontomachus_cephalotes: Remove bioregion outlier in Algeria
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_cephalotes" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("DZA")), ]

# Odontomachus_chelifer: Treat bioregion outliers in Nearctic Mexico as Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_chelifer" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Nearctic")] <- "Neotropics"

# Odontomachus_haematodus: Keep only records from South America
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_haematodus" & !Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("COL", "VEN", "GUY", "SUR", "FRA", "ECU", "PER", "BRA", "BOL", "PRY", "ARG")), ]

# Odontomachus_insularis: Keep only records from Caribbean islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_insularis" & !Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Trinidad and Tobago", "Lesser Antilles", "Puerto Rico", "Hispaniola", "Cuba", "Jamaica", "Bahamas")), ]

# Odontomachus_meinerti: Treat bioregion outliers in Nearctic Mexico as Neotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_meinerti" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Nearctic")] <- "Neotropics"

# Odontomachus_opaciventris: Remove bioregion outlier in Guanajuato, Mexico
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_opaciventris" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Guanajuato")), ]

# Odontomachus_papuanus: Remove bioregion outliers in Southeast Sulawesi and the Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_papuanus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Sulawesi", "Philippines")), ]

# Odontomachus_rixosus: Remove bioregion outliers in Jammu & Kashmir
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_rixosus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir")), ]

# Odontomachus_saevissimus: Remove bioregion outliers in Central Sulawesi and the Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_saevissimus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Sulawesi", "Philippines")), ]

# Odontomachus_troglodytes: Remove distance outlier from Seychelles
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_troglodytes" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("SYC")), ]
# Odontomachus_troglodytes: Treat bioregion outliers from Yemen as Afrotropics
Biogeographic_database_Ponerinae_curated$Bioregion[Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_troglodytes" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Palearctic")] <- "Afrotropics"

# Odontomachus_tyrannicus: Remove bioregion outliers in Central Sulawesi
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_tyrannicus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Sulawesi")), ]

# Odontomachus_yucatecus: Remove all records in South America
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_yucatecus" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("COL", "VEN", "GUY", "SUR", "FRA", "ECU", "PER", "BRA", "BOL", "PRY", "ARG")), ]
# Odontomachus_yucatecus: Remove bioregion outlier in San Luis Potosi, Mexico
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_yucatecus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("San Luis Potosi")), ]

# Odontoponera_transversa: Remove record in Papua New Guinea
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontoponera_transversa" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PNG")), ]

# Pachycondyla_harpax: Remove record in Georgia, USA 
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Pachycondyla_harpax" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Georgia")), ]

# Platythyrea_modesta: Remove distance outlier from Northern Cape, South Africa
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Platythyrea_modesta" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Nothern Cape")), ]

# Ponera_coarctata: Remove outliers from Japan and the USA
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_coarctata" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("USA", "JPN")), ]

# Ponera_japonica: Remove record in Vietnam
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_japonica" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("VNM")), ]

# Ponera_pennsylvanica: Remove all Mexico records
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_pennsylvanica" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("MEX")), ]
# Ponera_pennsylvanica: Washington state (USA) records
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_pennsylvanica" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Washington")), ]

# Ponera_selenophora: Remove distance outlier from southern Queensland 
dist_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Ponera_selenophora" & !Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier & Biogeographic_database_Ponerinae_curated_no_duplicates$distance_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% dist_outliers_ID), ]
# Ponera_selenophora: Remove bioregion outliers from Borneo, Indonesia
bioreg_outliers_ID <- Biogeographic_database_Ponerinae_curated_no_duplicates$Occurrence_ID[(Biogeographic_database_Ponerinae_curated_no_duplicates$Current_name == "Ponera_selenophora" & Biogeographic_database_Ponerinae_curated_no_duplicates$bioregion_outlier)]
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID), ]

# Ponera_testacea: Remove bioregion outliers in the USA
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_testacea" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("USA")), ]

# Rasopone_ferruginea: Keep only records from Nicaragua, Honduras, El Salvador, Belize, Guatemala, and Mexico
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Rasopone_ferruginea" & !Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("NIC", "HND", "SLV", "BLZ", "GTM", "MEX")), ]

# Anochetus_cryptus: Treat all records as Indomalaya
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_cryptus", replace = F)] <- "Indomalaya"

# Anochetus_madaraszi: Treat records in Jammu & Kashmir as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_madaraszi" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Jammu & Kashmir", replace = F)] <- "Indomalaya"

# Anochetus_risii: Remove bioregion outliers in the Pacific islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_risii" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Australasia")), ]

# Anochetus_sedilloti: Keep only records from continental Africa (Afrotropics + Western Palearctic)
View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_sedilloti",])
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated %>% 
  filter(!(Current_name == "Anochetus_sedilloti" & (Bioregion != "Afrotropics" & Country_ISO3_name != "Tunisia")))

# Bothroponera_sulcata: Remove bioregion oulier in Himachal Pradesh
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Bothroponera_sulcata" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Himachal Pradesh")), ]
# Bothroponera_sulcata: Treat bioregion outliers in Jammu & Kashmir as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Bothroponera_sulcata" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Jammu & Kashmir", replace = F)] <- "Indomalaya"
# Bothroponera_tesseronoda: Treat bioregion outliers in Himachal Pradesh as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Bothroponera_tesseronoda" & Biogeographic_database_Ponerinae_curated$bentity2_name == "Himachal Pradesh", replace = F)] <- "Indomalaya"

# Brachyponera_croceicornis: Remove bioregion outliers in Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_croceicornis" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Philippines")), ]

# Brachyponera_jerdonii: Treat bioregion outliers in Himalayan India as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_jerdonii" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Brachyponera_nakasujii: Remove Vietnam outlier
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Brachyponera_nakasujii" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("VNM")), ]

# Cryptopone_motschulskyi: Remove bioregion outliers in Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Cryptopone_motschulskyi" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Philippines")), ]

# Emeryopone_loebli: Remove Malaysia/Singapore records
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Emeryopone_loebli" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Malaysia and Singapore")), ]

# Euponera_pilosior: Remove bioregion outliers from Ogasawara Islands and Volcano Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Euponera_pilosior" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Ogasawara Islands", "Volcano Islands")), ]

# Harpegnathos_venator: Treat bioregion outliers in Himalayan India as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Harpegnathos_venator" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Hypoponera_assmuthi: Treat bioregion outliers in Jammu & Kashmir as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_assmuthi" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Hypoponera_biroi: Remove bioregion outliers in Taiwan, Sumatra and Java
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_biroi" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Taiwan", "Sumatra", "Java")), ]

# Hypoponera_gibbinota: Remove the two occurrences. Is from Neotropics, but no georeferenced occurrence there.
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_gibbinota"), ]

# Hypoponera_nippona: Remove record from Volcano Islands in Ogasawara, Japan
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_nippona" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Volcano Islands")), ]

# Hypoponera_sabronae: Remove bioregion outliers in Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_sabronae" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Philippines")), ]

# Hypoponera_sauteri: Remove bioregion outliers from Ogasawara Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_sauteri" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Ogasawara Islands")), ]

# Hypoponera_truncata: Remove bioregion outlier in Shaanxi Province, China
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_truncata" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Shaanxi Province")), ]

# Leptogenys_bohlsi: Remove bioregion outlier in Mexico
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_bohlsi" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("MEX")), ]

# Leptogenys_chinensis: Treat bioregion outliers in Jammu & Kashmir as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_chinensis" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Leptogenys_hysterica: Remove records in Pakistan
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_hysterica" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PAK")), ]
# Leptogenys_hysterica: Treat bioregion outliers in Himachal Pradesh as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_hysterica" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Leptogenys_kitteli: Treat bioregion outliers in Sichuan and Himachal Pradesh as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_kitteli" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Sichuan", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Leptogenys_reggae: Remove Vietnam record
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Leptogenys_reggae" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("VNM")), ]

# Myopias_cribriceps: Remove bioregion outlier in Bali, Indonesia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Myopias_cribriceps" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Bali")), ]

# Odontomachus_desertorum: Remove bioregion outlier in Colima, Mexico 
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_desertorum" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Colima")), ]
# Odontomachus_desertorum: Remove distance outliers in Texas, USA
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_desertorum" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Texas")), ]

# Odontomachus_infandus: Remove bioregion outlier in PNG
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_infandus" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PNG")), ]

# Odontomachus_monticola: Remove bioregion outlier in Queensland, Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_monticola" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("AUS")), ]

# Odontomachus_opaculus: Remove bioregion outlier in Bali, Indonesia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_opaculus" & Biogeographic_database_Ponerinae_curated$adm1 %in% c("Bali")), ]

# Odontomachus_simillimus: Remove in Seychelles
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_simillimus" & Biogeographic_database_Ponerinae_curated$Country_ISO3_name %in% c("Seychelles")), ]

# Platythyrea_sagei: Remove distance outliers in Singapour
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Platythyrea_sagei" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("SGP")), ]
# Platythyrea_sagei: Treat bioregion outliers in Himachal Pradesh as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Platythyrea_sagei" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Himachal Pradesh"), replace = F)] <- "Indomalaya"

# Ponera_petila: Remove Seychelles and Mauritius records as suspected from Introduction
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_petila" & Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Afrotropics")), ]

# Ponera_scabra: Remove bioregion outlier in PNG
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_scabra" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("PNG")), ]

# Ponera_szaboi: Remove distance outlier from Wallis and Futuna
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_szaboi" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Wallis and Futuna")), ]
# Ponera_szaboi: Remove bioregion outliers in Borneo, Malaysia and the Philippines
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_szaboi" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Borneo", "Philippines")), ]

# Ponera_xenagos: Remove bioregion outliers from Sabah, Borneo, Malaysia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_xenagos" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Borneo")), ]

# Pseudoneoponera_bispinosa: Remove bioregion outlier from Australia
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Pseudoneoponera_bispinosa" & Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% c("AUS")), ]
# Pseudoneoponera_bispinosa: Treat bioregion outliers in Himalayan India as Indomalaya records
Biogeographic_database_Ponerinae_curated$Bioregion[replace_na(data = Biogeographic_database_Ponerinae_curated$Current_name == "Pseudoneoponera_bispinosa" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Jammu & Kashmir", "Himachal Pradesh"), replace = F)] <- "Indomalaya"

## Inspect potentially introduced occurrences in the Pacific region
Oceania_occurrences_df <- Biogeographic_database_Ponerinae_curated %>% 
  filter(Longitude_dec < -150 | Longitude_dec > 170) %>% 
  filter(Country_ISO3_name != "New Zealand")

Oceania_taxa_bentity2_df <- Oceania_occurrences_df %>%
  st_drop_geometry() %>%
  group_by(Current_name, bentity2_name) %>%
  summarize(occ_counts = n())

write.xlsx(x = st_drop_geometry(Oceania_occurrences_df), file = "./input_data/Biogeographic_data/Oceania_occurrences_df.xlsx")
write.xlsx(x = Oceania_taxa_bentity2_df, file = "./input_data/Biogeographic_data/Oceania_taxa_bentity2_df.xlsx")

# Anochetus_graeffei: Remove in Cook Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Anochetus_graeffei" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Cook Islands")), ]
# Hypoponera_johannae_cf: Remove in Austral Islands and Hawaii
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_johannae_cf" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Austral Islands", "Hawaii")), ]
# Ponera_petila: Remove in Society Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_petila" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Society Islands")), ]
# Ponera_swezeyi: Remove in Hawaii
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Ponera_swezeyi" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Hawaii")), ]
# Hypoponera_confinis: Remove in Marshall Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Hypoponera_confinis" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Marshall Islands")), ]
# Odontomachus_simillimus: Remove in Kiribati, Line Islands, Marshall Islands
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_simillimus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Kiribati", "Line Islands", "Marshall Islands")), ]

## Remove errors with empty geometry
Biogeographic_database_Ponerinae_curated <- Biogeographic_database_Ponerinae_curated[!st_is_empty(Biogeographic_database_Ponerinae_curated), ]


# View(Biogeographic_database_Ponerinae_curated[(Biogeographic_database_Ponerinae_curated$Occurrence_ID == 144063), ])
# View(Biogeographic_database_Ponerinae_curated[(Biogeographic_database_Ponerinae_curated$Current_name == "Odontomachus_papuanus" & Biogeographic_database_Ponerinae_curated$bentity2_name %in% c("Sulawesi", "Philippines")), ])
# View(Biogeographic_database_Ponerinae_curated[(Biogeographic_database_Ponerinae_curated$Occurrence_ID %in% bioreg_outliers_ID), ])

## Save Biogeographic database with all curated coordinates
# saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")


#### Record changes in the database including duplicates. Then, rerun the duplicate detection (Section 7)


##### 10/ Update records from initial databases too (GABI and AntWeb), not only the merged one ####

## Load Biogeographic database with all curated coordinates
Biogeographic_database_Ponerinae_curated <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")
## Load the initial curated databases (before merging)
GABI_database_Ponerinae <- readRDS(file = "./input_data/GABI_Data_Release1.0_18012020/GABI_database_Ponerinae.rds")
AntWeb_database_curated <- readRDS(file = "./input_data/AntWeb_data/AntWeb_database_curated.rds")

### 10.1/ Update GABI database ####

# Use GABI_accession_ID

GABI_database_Ponerinae <- GABI_database_Ponerinae %>% 
  rename(country_initial = country) %>%
  rename(adm2_initial = adm2) %>%
  rename(adm1_initial = adm1) %>%
  rename(locality_initial = locality) %>%
  rename(dec_lat_initial = dec_lat) %>%
  rename(dec_long_initial = dec_long) %>% 
  rename(bentity2_name_initial = bentity2_name)

GABI_database_Ponerinae <- left_join(x = GABI_database_Ponerinae,
                                     y = Biogeographic_database_Ponerinae_curated[, c("GABI_accession_ID", "Country_GB_name", "adm2", "adm1", "Locality", "bentity2_name", "Latitude_dec", "Longitude_dec")], 
                                     by = c("gabi_acc_number" = "GABI_accession_ID")) %>% 
  rename(country = Country_GB_name) %>%
  rename(locality = Locality) %>%
  rename(dec_lat = Latitude_dec) %>%
  rename(dec_long = Longitude_dec)

# Flag for changes in coordinates
GABI_database_Ponerinae$Updated_coordinates <- replace_na(data = (GABI_database_Ponerinae$dec_lat_initial != GABI_database_Ponerinae$dec_lat) | (GABI_database_Ponerinae$dec_long_initial != GABI_database_Ponerinae$dec_long), replace = T)
table(GABI_database_Ponerinae$Updated_coordinates)

# Flag for changes in administrative layers (Locality, adm2, adm1, bentity2, country)
GABI_database_Ponerinae$Updated_locality <- replace_na(data = (GABI_database_Ponerinae$locality_initial != GABI_database_Ponerinae$locality), replace = T) & (!is.na(GABI_database_Ponerinae$locality_initial) & !is.na(GABI_database_Ponerinae$locality))
table(GABI_database_Ponerinae$Updated_locality)
GABI_database_Ponerinae$Updated_adm2 <- replace_na(data = (GABI_database_Ponerinae$adm2_initial != GABI_database_Ponerinae$adm2), replace = T) & (!is.na(GABI_database_Ponerinae$adm2_initial) & !is.na(GABI_database_Ponerinae$adm2))
table(GABI_database_Ponerinae$Updated_adm2)
GABI_database_Ponerinae$Updated_adm1 <- replace_na(data = (GABI_database_Ponerinae$adm1_initial != GABI_database_Ponerinae$adm1), replace = T) & (!is.na(GABI_database_Ponerinae$adm1_initial) & !is.na(GABI_database_Ponerinae$adm1))
table(GABI_database_Ponerinae$Updated_adm1)
GABI_database_Ponerinae$Updated_bentity2_name <- replace_na(data = (GABI_database_Ponerinae$bentity2_name_initial != GABI_database_Ponerinae$bentity2_name), replace = T) & (!is.na(GABI_database_Ponerinae$bentity2_name_initial) & !is.na(GABI_database_Ponerinae$bentity2_name))
table(GABI_database_Ponerinae$Updated_bentity2_name)
GABI_database_Ponerinae$Updated_country <- replace_na(data = (GABI_database_Ponerinae$country_initial != GABI_database_Ponerinae$country), replace = T) & (!is.na(GABI_database_Ponerinae$country_initial) & !is.na(GABI_database_Ponerinae$country))
table(GABI_database_Ponerinae$Updated_country)

# View(GABI_database_Ponerinae[GABI_database_Ponerinae$Updated_country, ])

### 10.2/ Update Antweb database ####

# Use Specimen_code to update "country", "adm2", "adm1", "localityname", "decimal_latitude", "decimal_longitude"
# Keep track of former information with "_initial" prefixe

AntWeb_database_curated <- AntWeb_database_curated %>% 
  rename(country_initial = country) %>%
  rename(adm2_initial = adm2) %>%
  rename(adm1_initial = adm1) %>%
  rename(localityname_initial = localityname) %>%
  rename(decimal_latitude_initial = decimal_latitude) %>%
  rename(decimal_longitude_initial = decimal_longitude)

AntWeb_database_curated <- left_join(x = AntWeb_database_curated,
                                     y = Biogeographic_database_Ponerinae_curated[, c("Specimen_code", "Country_GB_name", "adm2", "adm1", "Locality", "Latitude_dec", "Longitude_dec")], 
                                     by = c("SpecimenCode" = "Specimen_code")) %>% 
  rename(country = Country_GB_name) %>%
  rename(localityname = Locality) %>%
  rename(decimal_latitude = Latitude_dec) %>%
  rename(decimal_longitude = Longitude_dec)

# Flag for changes in coordinates
AntWeb_database_curated$Updated_coordinates <- replace_na(data = (AntWeb_database_curated$decimal_latitude_initial != AntWeb_database_curated$decimal_latitude) | (AntWeb_database_curated$decimal_longitude_initial != AntWeb_database_curated$decimal_longitude), replace = T)
table(AntWeb_database_curated$Updated_coordinates)

# Flag for changes in administrative layers (Locality, adm2, adm1, country)
AntWeb_database_curated$Updated_locality <- replace_na(data = (AntWeb_database_curated$localityname_initial != AntWeb_database_curated$localityname), replace = T) & (!is.na(AntWeb_database_curated$localityname_initial) & !is.na(AntWeb_database_curated$localityname))
table(AntWeb_database_curated$Updated_locality)
AntWeb_database_curated$Updated_adm2 <- replace_na(data = (AntWeb_database_curated$adm2_initial != AntWeb_database_curated$adm2), replace = T) & (!is.na(AntWeb_database_curated$adm2_initial) & !is.na(AntWeb_database_curated$adm2))
table(AntWeb_database_curated$Updated_adm2)
AntWeb_database_curated$Updated_adm1 <- replace_na(data = (AntWeb_database_curated$adm1_initial != AntWeb_database_curated$adm1), replace = T) & (!is.na(AntWeb_database_curated$adm1_initial) & !is.na(AntWeb_database_curated$adm1))
table(AntWeb_database_curated$Updated_adm1)
AntWeb_database_curated$Updated_country <- replace_na(data = (AntWeb_database_curated$country_initial != AntWeb_database_curated$country), replace = T) & (!is.na(AntWeb_database_curated$country_initial) & !is.na(AntWeb_database_curated$country))
table(AntWeb_database_curated$Updated_country)


### 10.3/ Export changes in AntWeb for updates ####

### 10.3.1/ Flag changes for all entries in the curated database

# Flag for changes in coordinates
Biogeographic_database_Ponerinae_curated$Updated_coordinates <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Latitude_dec_initial != Biogeographic_database_Ponerinae_curated$Latitude_dec) | (Biogeographic_database_Ponerinae_curated$Longitude_dec_initial != Biogeographic_database_Ponerinae_curated$Longitude_dec), replace = T)
table(Biogeographic_database_Ponerinae_curated$Updated_coordinates)

# Flag for changes in administrative layers (Locality, adm2, adm1, bentity2, SUBUNIT, country)
Biogeographic_database_Ponerinae_curated$Updated_Locality <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Locality_initial != Biogeographic_database_Ponerinae_curated$Locality), replace = T) & (!is.na(Biogeographic_database_Ponerinae_curated$Locality_initial) & !is.na(Biogeographic_database_Ponerinae_curated$Locality))
table(Biogeographic_database_Ponerinae_curated$Updated_Locality)
Biogeographic_database_Ponerinae_curated$Updated_adm2 <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm2_initial != Biogeographic_database_Ponerinae_curated$adm2), replace = T) & (!is.na(Biogeographic_database_Ponerinae_curated$adm2_initial) & !is.na(Biogeographic_database_Ponerinae_curated$adm2))
table(Biogeographic_database_Ponerinae_curated$Updated_adm2)
Biogeographic_database_Ponerinae_curated$Updated_adm1 <- replace_na(data = (Biogeographic_database_Ponerinae_curated$adm1_initial != Biogeographic_database_Ponerinae_curated$adm1), replace = T) & (!is.na(Biogeographic_database_Ponerinae_curated$adm1_initial) & !is.na(Biogeographic_database_Ponerinae_curated$adm1))
table(Biogeographic_database_Ponerinae_curated$Updated_adm1)
Biogeographic_database_Ponerinae_curated$Updated_Bentity2 <- replace_na(data = (Biogeographic_database_Ponerinae_curated$bentity2_name_initial != Biogeographic_database_Ponerinae_curated$bentity2_name), replace = T) & (!is.na(Biogeographic_database_Ponerinae_curated$bentity2_name_initial) & !is.na(Biogeographic_database_Ponerinae_curated$bentity2_name))
table(Biogeographic_database_Ponerinae_curated$Updated_Bentity2)
Biogeographic_database_Ponerinae_curated$Updated_Country <- replace_na(data = (Biogeographic_database_Ponerinae_curated$Country_initial != Biogeographic_database_Ponerinae_curated$Country_GB_name), replace = T) & (!is.na(Biogeographic_database_Ponerinae_curated$Country_initial) & !is.na(Biogeographic_database_Ponerinae_curated$Country_GB_name))
table(Biogeographic_database_Ponerinae_curated$Updated_Country)

### 10.3.2/ Provide the list of updates to Brian when the changes are not regarding stuff that was interpolated

# Filter/select only useful fields

AntWeb_Ponerinae_database_Need_biogeographic_updates <- st_drop_geometry(Biogeographic_database_Ponerinae_curated) %>% 
  filter(Source == "AntWeb") %>%
  select(Specimen_code, Current_name, Initial_name, Updated_coordinates, Latitude_dec, Longitude_dec, Latitude_dec_initial, Longitude_dec_initial,
         Updated_Locality, Locality, Locality_initial, Updated_adm2, adm2, adm2_initial, Updated_adm1, adm1, adm1_initial,
         Updated_Country, Country_GB_name, Country_initial, Interpolated_adm2, Interpolated_adm1)

# Do not record updates when interpolated
AntWeb_Ponerinae_database_Need_biogeographic_updates$adm1[AntWeb_Ponerinae_database_Need_biogeographic_updates$Interpolated_adm1] <- AntWeb_Ponerinae_database_Need_biogeographic_updates$adm1_initial[AntWeb_Ponerinae_database_Need_biogeographic_updates$Interpolated_adm1]
AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm1[AntWeb_Ponerinae_database_Need_biogeographic_updates$Interpolated_adm1] <- FALSE
AntWeb_Ponerinae_database_Need_biogeographic_updates$adm2[AntWeb_Ponerinae_database_Need_biogeographic_updates$Interpolated_adm2] <- AntWeb_Ponerinae_database_Need_biogeographic_updates$adm2_initial[AntWeb_Ponerinae_database_Need_biogeographic_updates$Interpolated_adm2]
AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm2[AntWeb_Ponerinae_database_Need_biogeographic_updates$Interpolated_adm2] <- FALSE

table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm1)
table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm2)

View(AntWeb_Ponerinae_database_Need_biogeographic_updates[AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm1, ])

# Filter only entries with a change
AntWeb_Ponerinae_database_Need_biogeographic_updates <- AntWeb_Ponerinae_database_Need_biogeographic_updates %>% 
  select(-Interpolated_adm2, -Interpolated_adm1) %>%
  filter(Updated_Locality | Updated_adm2 | Updated_adm1 | Updated_Country) 

table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_coordinates)
table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_Locality)
table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm2)
table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_adm1)
table(AntWeb_Ponerinae_database_Need_biogeographic_updates$Updated_Country)

## Export AntWeb_Ponerinae_database_Need_biogeographic_updates to allow updates in AntWeb
saveRDS(object = AntWeb_Ponerinae_database_Need_biogeographic_updates, file = "./input_data/AntWeb_data/AntWeb_Ponerinae_database_Need_biogeographic_updates.rds")
write.xlsx(x = AntWeb_Ponerinae_database_Need_biogeographic_updates, file = "./input_data/AntWeb_data/AntWeb_Ponerinae_database_Need_biogeographic_updates.xlsx")


##### 11/ Map cleaned dataset vs. original one ####

# Plot initial coords in grey for entries with updates
# Plot all curated coords with colors according to type: GABI_OK, GABI_errors, GABI_New, AntWeb_OK, AntWeb_Errors, AntWeb_New

## Load Biogeographic database with all curated coordinates
Biogeographic_database_Ponerinae_curated_no_duplicates <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated_no_duplicates.rds")

Biogeographic_database_Ponerinae_updates_summary <- Biogeographic_database_Ponerinae_curated_no_duplicates %>% 
  select("Occurrence_ID", "Source", "Specimen_code", "GABI_accession_ID", "Current_name", "Current_status", "In_phylogeny", "Latitude_dec", "Longitude_dec", "Latitude_dec_initial", "Longitude_dec_initial", 
         "Bioregion", "Elevation", "Locality", "Locality_initial", "adm2", "adm2_initial", "adm1", "adm1_initial", "bentity2_name" , "bentity2_name_initial", "SUBUNIT_name", "Country_ISO3_name", "Country_ISO3_code", "Country_GB_name", "Country_initial",
         "Interpolated_coordinates", "matching_shp", "Uncertainty_area", "Interpolated_adm2", "Interpolated_adm1", "Uncertainty_adm2", "Uncertainty_adm1", "Interpolated_Bentity2")

# Flag for changes in coordinates
Biogeographic_database_Ponerinae_updates_summary$Updated_coordinates <- replace_na(data = (Biogeographic_database_Ponerinae_updates_summary$Latitude_dec_initial != Biogeographic_database_Ponerinae_updates_summary$Latitude_dec) | (Biogeographic_database_Ponerinae_updates_summary$Longitude_dec_initial != Biogeographic_database_Ponerinae_updates_summary$Longitude_dec), replace = T) & (!is.na(Biogeographic_database_Ponerinae_updates_summary$Latitude_dec_initial) & !is.na(Biogeographic_database_Ponerinae_updates_summary$Longitude_dec_initial))
table(Biogeographic_database_Ponerinae_updates_summary$Updated_coordinates)

# Extract only occurrences with changes to provide initial coordinates for plotting
Biogeographic_database_Ponerinae_updated_to_merge <- Biogeographic_database_Ponerinae_updates_summary[Biogeographic_database_Ponerinae_updates_summary$Updated_coordinates, ] %>% 
  mutate(Latitude_to_plot = Latitude_dec_initial) %>% 
  mutate(Longitude_to_plot = Longitude_dec_initial)

# Merge occurrences with initial coordinates
Biogeographic_database_Ponerinae_updates_summary <- Biogeographic_database_Ponerinae_updates_summary %>% 
  mutate(Latitude_to_plot = Latitude_dec) %>% 
  mutate(Longitude_to_plot = Longitude_dec) %>% 
  rbind(., Biogeographic_database_Ponerinae_updated_to_merge)

# Update geometry
Biogeographic_database_Ponerinae_updates_summary <- st_drop_geometry(Biogeographic_database_Ponerinae_updates_summary)
Biogeographic_database_Ponerinae_updates_summary <- st_as_sf(Biogeographic_database_Ponerinae_updates_summary, coords = c("Longitude_to_plot", "Latitude_to_plot"), crs = sp::CRS('+init=EPSG:4326'))
# Set CRS
st_crs(Biogeographic_database_Ponerinae_updates_summary) <- sp::CRS('+init=EPSG:4326')
# Remove copies of Long/Lat of still present
# Biogeographic_database_Ponerinae_updates_summary <- Biogeographic_database_Ponerinae_updates_summary %>% select(-c("Longitude_to_plot", "Latitude_to_plot"))
# Biogeographic_database_Ponerinae_updates_summary

# Flag type of occurrences
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type <- NA
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type[Biogeographic_database_Ponerinae_updates_summary$Source == "AntWeb"] <- "AntWeb_OK"
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type[Biogeographic_database_Ponerinae_updates_summary$Source == "AntWeb" & Biogeographic_database_Ponerinae_updates_summary$Updated_coordinates] <- "AntWeb_Error"
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type[Biogeographic_database_Ponerinae_updates_summary$Source == "AntWeb" & Biogeographic_database_Ponerinae_updates_summary$Interpolated_coordinates] <- "AntWeb_New"
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type[Biogeographic_database_Ponerinae_updates_summary$Source == "GABI"] <- "GABI_OK"
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type[Biogeographic_database_Ponerinae_updates_summary$Source == "GABI" & Biogeographic_database_Ponerinae_updates_summary$Updated_coordinates] <- "GABI_Error"
Biogeographic_database_Ponerinae_updates_summary$Occurrence_type[Biogeographic_database_Ponerinae_updates_summary$Source == "GABI" & Biogeographic_database_Ponerinae_updates_summary$Interpolated_coordinates] <- "GABI_New"
table(Biogeographic_database_Ponerinae_updates_summary$Occurrence_type)

View(Biogeographic_database_Ponerinae_updates_summary[Biogeographic_database_Ponerinae_updates_summary$Occurrence_type == "AntWeb_Error", ])

# ## Adjust levels order
# Biogeographic_database_Ponerinae_updates_summary$Occurrence_type <- factor(x = Biogeographic_database_Ponerinae_updates_summary$Occurrence_type, levels = c("GABI_OK", "AntWeb_OK", "GABI_New", "AntWeb_New", "GABI_Error", "AntWeb_Error"))
# Biogeographic_database_Ponerinae_updates_summary$Occurrence_type

## Prepare color palette

# Create Green/Blues/Red palette
AntWeb_OK_col <- RColorBrewer::brewer.pal(n = 9, "Greens")[7]
GABI_OK_col <- RColorBrewer::brewer.pal(n = 9, "Greens")[4]
AntWeb_New_col <- RColorBrewer::brewer.pal(n = 9, "PuBu")[7]
GABI_New_col <- RColorBrewer::brewer.pal(n = 9, "PuBu")[5]
AntWeb_Error_col <- RColorBrewer::brewer.pal(n = 9, "Reds")[7]
GABI_Error_col <- RColorBrewer::brewer.pal(n = 9, "Reds")[4]

levels(as.factor(Biogeographic_database_Ponerinae_updates_summary$Occurrence_type))
pal_6 <- c(AntWeb_Error_col, AntWeb_New_col, AntWeb_OK_col, GABI_Error_col, GABI_New_col, GABI_OK_col)
# pal_6 <- c(GABI_OK_col, AntWeb_OK_col, GABI_New_col, AntWeb_New_col, GABI_Error_col, AntWeb_Error_col)

# Plot by taxa in case of doubt for the group to evaluate
interactive_map_all_updates <- mapview::mapview(x = Biogeographic_database_Ponerinae_updates_summary, # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
                                                zcol = "Occurrence_type",
                                                cex = 7,
                                                burst = T, legend = T,
                                                col.regions = pal_6, # Color to use to plot spatial units in the spatial object
                                                # alpha.regions = regionOpacity(x), # Alpha to use to plot spatial units in the spatial object
                                                # alpha.regions = alpha_adjusted, # Alpha to use to plot spatial units in the spatial object
                                                layer.name = "Occurrences", # To specify the legend name of this layer
                                                # map.types = mapviewGetOption("basemaps")
                                                map.types = c("OpenStreetMap", "Esri.WorldImagery", "Esri.WorldStreetMap")
                                                # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stamen.Watercolor") # To specify basemaps
                                                # ... # and many more, depending of the class of the spatial object
)

interactive_map_all_updates


## Save the interactive version

mapviewOptions(fgb = FALSE)

mapshot(x = interactive_map_all_updates,
        url = paste0("./maps/Summary_Biogeographic_data_curation/Interactive_map_Biogeographic_data_curation.html"), # To save an interactive .html map
        remove_controls = NULL) # c("zoomControl", "layersControl", "homeButton", "scaleBar"))  # To specify which control buttons to remove (or not) from the output

mapviewOptions(fgb = TRUE)


##### 12/ Create Biogeographic table assigning taxa to each bioregion #####

## Load Biogeographic database with all curated coordinates
Biogeographic_database_Ponerinae_curated_no_duplicates <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated_no_duplicates.rds")
Biogeographic_database_Ponerinae_curated <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

# Load metadata with bioregion assignment
Countries_NE_sf_metadata <- openxlsx::read.xlsx(xlsxFile = "./input_data/Biogeographic_data/Countries_NE_sf_metadata.xlsx")

### 12.1/ Add Western/Eastern Palearctic ####

### 12.1.1/ Use previous 6 region classification

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA <- Biogeographic_database_Ponerinae_curated$Bioregion

## 12.1.2/ Assign Paleartic subregions to entries based on Country code ####

Palearctic_countries_codes <- Countries_NE_sf_metadata$ISO_A3[Countries_NE_sf_metadata$Bioregion_7_PaleA %in% c("Eastern Palearctic", "Western Palearctic")]
Palearctic_entries <- which(Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% Palearctic_countries_codes)

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[Palearctic_entries] <- Countries_NE_sf_metadata$Bioregion_7_PaleA[match(Biogeographic_database_Ponerinae_curated$Country_ISO3_code[Palearctic_entries], Countries_NE_sf_metadata$ISO_A3)]

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA)

## 12.1.3/ Deal with the particular cases of countries overlapping Palearctic bioregions

## Russia is split between Eastern and Western Palearctic based on adm1

Russia_adm1_in_Eastern_Palearctic <- c("Altai Krai", "Altai Republic", "Amur Oblast", "Buryatia", "Chelyabinsk Oblast", "Chukotka Autonomous Okrug", "Irkutsk Oblast", "Jewish Autonomous Oblast", "Kamchatka Krai", "Kemerovo Oblast", "Khabarovsk Krai", "Khakassia", "Khanty-Mansiysk Autonomous Okrug ? Ugra", "Krasnoyarsk Krai", "Kurgan Oblast", "Magadan Oblast", "Novosibirsk Oblast", "Omsk Oblast", "Primorsky Krai", "Sakha Republic", "Sakhalin Oblast", "Sverdlovsk Oblast", "Tomsk Oblast", "Tuva", "Tyumen Oblast", "Yamalo-Nenets Autonomous Okrug", "Zabaykalsky Krai")

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[(Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Russia")] <- "Western Palearctic"
Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$adm1 %in% Russia_adm1_in_Eastern_Palearctic, replace = F) ] <- "Eastern Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Russia")])

# View(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "RUS", "adm1_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeGroup == "RUS", "adm1_shapeName"])
# plot(geoBoundaries_adm1_sf[geoBoundaries_adm1_sf$adm1_shapeName %in% Russia_adm1_in_Eastern_Palearctic, "adm1_shapeName"])

## India: Three regions in Palearctic are in Eastern Paleartic

# India_adm1_in_Palearctic <- c("Him?chal Pradesh", "Himachal Pradesh", "Jammu and Kashm?r", "Jammu and Kashmir", "Ladakh", "Lad?kh")

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "India" & Biogeographic_database_Ponerinae_curated$Bioregion == "Palearctic", replace = F)] <- "Eastern Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "India")])

## Pakistan: Two regions in Palearctic are in Eastern Paleartic

# Pakistan_adm1_in_Palearctic <- c("Azad Kashmir", "Gilgit-Baltistan")

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Pakistan" & Biogeographic_database_Ponerinae_curated$Bioregion == "Palearctic", replace = F)] <- "Eastern Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Pakistan")])

## Japan: Main Islands in Palearctic are in Eastern Paleartic

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan" & Biogeographic_database_Ponerinae_curated$Bioregion == "Palearctic", replace = F)] <- "Eastern Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Japan")])

## China: Most regions in Palearctic are in Eastern Paleartic

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China" & Biogeographic_database_Ponerinae_curated$Bioregion == "Palearctic", replace = F)] <- "Eastern Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "China")])

## France: Main areas in Palearctic is in Western Paleartic

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France" & Biogeographic_database_Ponerinae_curated$Bioregion == "Palearctic", replace = F)] <- "Western Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")])

## Netherlands: Main area in Palearctic is in Western Paleartic

Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Netherlands" & Biogeographic_database_Ponerinae_curated$Bioregion == "Palearctic", replace = F)] <- "Western Palearctic"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "Netherlands")])

# Summary
table(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA)
table(is.na(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA))


### 12.2/ Add Malagasy/Afrotropics ####

### 12.2.1/ Use previous 6 region classification

Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy <- Biogeographic_database_Ponerinae_curated$Bioregion

## 12.2.2/ Assign Malagasy/Afrotropics subregions to entries based on Country code ####

AfroMalagasy_countries_codes <- Countries_NE_sf_metadata$ISO_A3[Countries_NE_sf_metadata$Bioregion_7_Malagasy %in% c("Afrotropics", "Malagasy")]
AfroMalagasy_entries <- which(Biogeographic_database_Ponerinae_curated$Country_ISO3_code %in% AfroMalagasy_countries_codes)

Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[AfroMalagasy_entries] <- Countries_NE_sf_metadata$Bioregion_7_Malagasy[match(Biogeographic_database_Ponerinae_curated$Country_ISO3_code[AfroMalagasy_entries], Countries_NE_sf_metadata$ISO_A3)]

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy)
table(is.na(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy))

## 12.2.3/ Deal with the particular cases of countries overlapping Malagasy/Afrotropics bioregions

## France: Mayotte, Reunion are in Malagasy, not Afrotropics
# View(Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France", ] %>% arrange(SUBUNIT_name))

Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France" & Biogeographic_database_Ponerinae_curated$Bioregion == "Afrotropics", replace = F)] <- "Malagasy"

table(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[replace_na(data = Biogeographic_database_Ponerinae_curated$Country_ISO3_name == "France")])

## TAAF, Ile Europa: in Malagasy, not Afrotropics
Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[replace_na(data = str_detect(Biogeographic_database_Ponerinae_curated$Locality, pattern = "Europa Island"), replace = F)] <- "Malagasy"

# Summary
table(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy)
table(is.na(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy))


### 12.3/ Inform the 8 bioregion scheme ####

Biogeographic_database_Ponerinae_curated$Bioregion_8 <- NA

# Get info for Paleotropics, Neotropics, Australasia and IndoMalaya from the 6 Bioregion scheme
Other_entries <- which(Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Australasia", "Indomalaya", "Neotropics", "Nearctic"))
Biogeographic_database_Ponerinae_curated$Bioregion_8[Other_entries] <- Biogeographic_database_Ponerinae_curated$Bioregion[Other_entries]
  
# Get info for Eastern Palearctic and Western Palearctic from the dedicated 7 regions scheme
PaleA_entries <- which(Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Palearctic"))
Biogeographic_database_Ponerinae_curated$Bioregion_8[PaleA_entries] <- Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[PaleA_entries]

# Get info for Afrotropics and Malagasy from the dedicated 7 regions scheme
AfroMalagasy_entries <- which(Biogeographic_database_Ponerinae_curated$Bioregion %in% c("Afrotropics"))
Biogeographic_database_Ponerinae_curated$Bioregion_8[AfroMalagasy_entries] <- Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[AfroMalagasy_entries]

# Summary
table(Biogeographic_database_Ponerinae_curated$Bioregion_8)
table(is.na(Biogeographic_database_Ponerinae_curated$Bioregion_8))


### 12.4/ Interactive map for alternative Bioregions ####

# Extract number of categories to plot
nb_bioregions <- length(unique(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA[]))
bioregions_names <- levels(as.factor(Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA))

nb_bioregions <- length(unique(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy[]))
bioregions_names <- levels(as.factor(Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy))

# Define palette function
pal_bioregions <- brewer.pal(n = nb_bioregions, name = "Spectral")
# pal_4 <- pal[c(1, 4, 5, 6)]
# pal_2 <- pal[c(5, 6)]

plot(Biogeographic_database_Ponerinae_curated[, ]["Bioregion"])

# Select a unique Bioregion to display
selected_Bioregion <- "Afrotropics" 
selected_Bioregion <- "Australasia"
selected_Bioregion <- "Indomalaya"
selected_Bioregion <- "Nearctic"
selected_Bioregion <- "Neotropics"
selected_Bioregion <- "Palearctic" 

selected_Bioregion <- "Eastern Palearctic"
selected_Bioregion <- "Western Palearctic"
selected_Bioregion <- c("Eastern Palearctic", "Western Palearctic")

selected_Bioregion <- "Afrotropics"
selected_Bioregion <- "Malagasy"


# selected_bioregion_ID <- which(bioregions_names == selected_Bioregion)
selected_bioregion_ID <- which(bioregions_names %in% selected_Bioregion)


### With color per bioregions
interactive_map_bioregions <- mapview::mapview(
  # x = Biogeographic_database_Ponerinae_curated[ , ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
  x = Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Bioregion_7_PaleA == selected_Bioregion, ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
  # x = Biogeographic_database_Ponerinae_curated[Biogeographic_database_Ponerinae_curated$Bioregion_7_Malagasy == selected_Bioregion, ], # sf/tmap/sp/raster/dataframe(with coordinates)... object to plot interactively
  # zcol = "Bioregion",
  zcol = "Bioregion_7_PaleA",
  cex = 7,
  burst = T, legend = T,
  # col.regions = pal_bioregions, # Color to use to plot spatial units in the spatial object
  col.regions = pal_bioregions[selected_bioregion_ID], # Color to use to plot spatial units in the spatial object
  layer.name = "Bioregions", # To specify the legend name of this layer
  # map.types = mapviewGetOption("basemaps")
  map.types = c("OpenStreetMap", "Esri.WorldImagery")
  # map.types = c("OpenTopoMap", "Esri.WorldImagery", "Esri.WorldStreetMap", "OpenStreetMap", "Stadia.StamenWatercolor") # To specify basemaps
  # ... # and many more, depending of the class of the spatial object
)

interactive_map_bioregions

## 12.4/ Update the database without duplicates

Biogeographic_database_Ponerinae_curated_no_duplicates <- left_join(x = Biogeographic_database_Ponerinae_curated_no_duplicates,
                                                                    y = st_drop_geometry(Biogeographic_database_Ponerinae_curated[, c("Occurrence_ID", "Bioregion_7_PaleA", "Bioregion_7_Malagasy", "Bioregion_8")]),
                                                                    by = "Occurrence_ID")

# Biogeographic_database_Ponerinae_curated_no_duplicates <- Biogeographic_database_Ponerinae_curated_no_duplicates %>%
#   rename(Bioregion_7_PaleA = Bioregion_7_PaleA.y,
#          Bioregion_7_Malagasy = Bioregion_7_Malagasy.y,
#          Bioregion_8 = Bioregion_8.y) %>%
#   select(-Bioregion_7_PaleA.x,
#          -Bioregion_7_Malagasy.x,
#          -Bioregion_8.x)

## Save Biogeographic database with all curated coordinates
saveRDS(object = Biogeographic_database_Ponerinae_curated, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")
saveRDS(object = Biogeographic_database_Ponerinae_curated_no_duplicates, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated_no_duplicates.rds")


### 12.4/ Extract bioregion assignments from records ####

# Create table with nb of occurrence per bioregions (6 bioregions)
Taxa_bioregions_quantitative_table <- Biogeographic_database_Ponerinae_curated_no_duplicates %>%
  st_drop_geometry() %>% 
  group_by(Current_name, Bioregion_8) %>% 
  dplyr::summarise(nb_occ = dplyr::n()) %>% 
  pivot_wider(names_from = Bioregion_8, values_from = nb_occ) %>%
  mutate_all(., ~replace_na(.,0))

# Same but including duplicates
Taxa_bioregions_quantitative_table_with_duplicates <- Biogeographic_database_Ponerinae_curated %>%
  st_drop_geometry() %>% 
  group_by(Current_name, Bioregion_8) %>% 
  dplyr::summarise(nb_occ = dplyr::n()) %>% 
  pivot_wider(names_from = Bioregion_8, values_from = nb_occ) %>%
  mutate_all(., ~replace_na(.,0))

# Add Merged bioregions
Taxa_bioregions_quantitative_table <- Taxa_bioregions_quantitative_table %>%
  mutate(Palearctic = `Eastern Palearctic` + `Western Palearctic`) %>%
  mutate(Afrotropics_Malagasy = Afrotropics + Malagasy)

Taxa_bioregions_quantitative_table_with_duplicates <- Taxa_bioregions_quantitative_table_with_duplicates %>%
  mutate(Palearctic = `Eastern Palearctic` + `Western Palearctic`) %>%
  mutate(Afrotropics_Malagasy = Afrotropics + Malagasy)

# Join with complete list of taxa
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")

Taxa_bioregions_quantitative_table_for_analyses <- left_join(x = Ponerinae_Macroevolution_taxa_database[, "Current_name", drop = F], y = Taxa_bioregions_quantitative_table)

# Same but including duplicates
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates <- left_join(x = Ponerinae_Macroevolution_taxa_database[, "Current_name", drop = F], y = Taxa_bioregions_quantitative_table_with_duplicates)
names(Taxa_bioregions_quantitative_table_for_analyses_with_duplicates) <- c("Current_name", paste0(names(Taxa_bioregions_quantitative_table_for_analyses_with_duplicates[, -1]), "_duplicates"))

# Replace NA by 0
Taxa_bioregions_quantitative_table_for_analyses[is.na(Taxa_bioregions_quantitative_table_for_analyses)] <- 0
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates[is.na(Taxa_bioregions_quantitative_table_for_analyses_with_duplicates)] <- 0

# Turn into binary (identical with and without duplicates)
Taxa_bioregions_binary_table_for_analyses <- Taxa_bioregions_quantitative_table_for_analyses
Taxa_bioregions_binary_table_for_analyses[, -1] <- Taxa_bioregions_quantitative_table_for_analyses[, -1] > 0

# Save tables of occurrence counts/presences per taxa used in analyses
saveRDS(object = Taxa_bioregions_quantitative_table_for_analyses, file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses.rds")
saveRDS(object = Taxa_bioregions_quantitative_table_for_analyses_with_duplicates, file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses_with_duplicates.rds")
saveRDS(object = Taxa_bioregions_binary_table_for_analyses, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses.rds")

### 12.5/ Fill info for taxa with no occurrences using AntWeb info ####

Taxa_bioregions_quantitative_table_for_analyses$Total_occ <- apply(X = Taxa_bioregions_quantitative_table_for_analyses[, c("Afrotropics", "Malagasy", "Indomalaya", "Australasia", "Neotropics", "Palearctic", "Nearctic")], MARGIN = 1, FUN = sum)
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates$Total_occ_duplicates <- apply(X = Taxa_bioregions_quantitative_table_for_analyses_with_duplicates[, c("Afrotropics_duplicates", "Malagasy_duplicates", "Indomalaya_duplicates", "Australasia_duplicates", "Neotropics_duplicates", "Palearctic_duplicates", "Nearctic_duplicates")], MARGIN = 1, FUN = sum)

taxa_without_occurrences <- Taxa_bioregions_quantitative_table_for_analyses$Current_name[Taxa_bioregions_quantitative_table_for_analyses$Total_occ == 0]

# 12 taxa without occurrences
taxa_without_occurrences

# Ectomomyrmex_horni. Is from Taiwan => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Ectomomyrmex_horni", "Indomalaya"] <- TRUE

# Euponera_grandis. Is from Vietnam => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Euponera_grandis", "Indomalaya"] <- TRUE

# Hypoponera_gibbinota. Is from Neotropics
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Hypoponera_gibbinota", "Neotropics"] <- TRUE

# Mayaponera_longidentata. Is from Colombia => Neotropics
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Mayaponera_longidentata", "Neotropics"] <- TRUE

# Mesoponera_javana. Is from Java in Indonesia => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Mesoponera_javana", "Indomalaya"] <- TRUE

# Myopias_etsukoae. Is from Sabah, Borneo in Malaysia => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Myopias_etsukoae", "Indomalaya"] <- TRUE

# Myopias_striaticeps. Is from Sabah, Borneo in Malaysia => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Myopias_striaticeps", "Indomalaya"] <- TRUE

# Myopias_suwannaphaki. Is from Sabah, Borneo in Malaysia => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Myopias_suwannaphaki", "Indomalaya"] <- TRUE

# Odontomachus_davidsoni. Is from Ecuador => Neotropics
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Odontomachus_davidsoni", "Neotropics"] <- TRUE

# Odontomachus_litoralis. Is from Singapore => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Odontomachus_litoralis", "Indomalaya"] <- TRUE

# Platythyrea_homasawini. Is from Thailand => Indomalaya
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Platythyrea_homasawini", "Indomalaya"] <- TRUE

# Ponera_sysphinctoides. Is from France => Palearctic AND Western Palearctic 
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Ponera_sysphinctoides", "Palearctic"] <- TRUE
Taxa_bioregions_binary_table_for_analyses[Taxa_bioregions_quantitative_table_for_analyses$Current_name == "Ponera_sysphinctoides", "Western Palearctic"] <- TRUE

table(apply(X = Taxa_bioregions_binary_table_for_analyses[,-1], MARGIN = 1, FUN = any))

# Save tables of occurrence counts/presences per taxa used in analyses
saveRDS(object = Taxa_bioregions_quantitative_table_for_analyses, file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses.rds")
saveRDS(object = Taxa_bioregions_quantitative_table_for_analyses_with_duplicates, file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses_with_duplicates.rds")
saveRDS(object = Taxa_bioregions_binary_table_for_analyses, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses.rds")

### 12.6/ Export complete and alternative tables ####

## 12.6.1/ Export table with all classif: Afrotropics + Malagasy, Afrotropics, Malagasy, Palearctic, Western Palearctic, Eastern Palearctic.
saveRDS(object = Taxa_bioregions_binary_table_for_analyses, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses.rds")
write.xlsx(x = Taxa_bioregions_binary_table_for_analyses, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses.xlsx")

## 12.6.2/ Export table with the 6 regions classif
Taxa_bioregions_binary_table_for_analyses_6_regions <- Taxa_bioregions_binary_table_for_analyses %>% 
  select(Current_name, Afrotropics_Malagasy, Australasia, Indomalaya, Nearctic, Neotropics, Palearctic) %>% 
  rename(Afrotropics = Afrotropics_Malagasy)

saveRDS(object = Taxa_bioregions_binary_table_for_analyses_6_regions, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_6_regions.rds")
write.xlsx(x = Taxa_bioregions_binary_table_for_analyses_6_regions, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_6_regions.xlsx")

## 12.6.3/ Export table with the 7 regions classif including two Palearctic regions
Taxa_bioregions_binary_table_for_analyses_7_regions_PaleA <- Taxa_bioregions_binary_table_for_analyses %>% 
  select(Current_name, Afrotropics_Malagasy, Australasia, Indomalaya, Nearctic, Neotropics, `Eastern Palearctic`, `Western Palearctic`) %>% 
  rename(Afrotropics = Afrotropics_Malagasy)

saveRDS(object = Taxa_bioregions_binary_table_for_analyses_7_regions_PaleA, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_7_regions_PaleA.rds")
write.xlsx(x = Taxa_bioregions_binary_table_for_analyses_7_regions_PaleA, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_7_regions_PaleA.xlsx")

## 12.6.4/ Export table with the 7 regions classif including Malagasy
Taxa_bioregions_binary_table_for_analyses_7_regions_Malagasy <- Taxa_bioregions_binary_table_for_analyses %>% 
  select(Current_name, Afrotropics, Australasia, Indomalaya, Malagasy, Nearctic, Neotropics, Palearctic)

saveRDS(object = Taxa_bioregions_binary_table_for_analyses_7_regions_Malagasy, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_7_regions_Malagasy.rds")
write.xlsx(x = Taxa_bioregions_binary_table_for_analyses_7_regions_Malagasy, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_7_regions_Malagasy.xlsx")

## 12.6.5/ Export table with the 8 regions classif including two Palearctic regions AND Malagasy
Taxa_bioregions_binary_table_for_analyses_8_regions <- Taxa_bioregions_binary_table_for_analyses %>% 
  select(Current_name, Afrotropics, Australasia, Indomalaya, Malagasy, Nearctic, Neotropics, `Eastern Palearctic`, `Western Palearctic`)

saveRDS(object = Taxa_bioregions_binary_table_for_analyses_8_regions, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_8_regions.rds")
write.xlsx(x = Taxa_bioregions_binary_table_for_analyses_8_regions, file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_8_regions.xlsx")

### 12.7/ Compare new classification with Gabi's classification to highlight potential issues

# Load 6 regions binary classification
Taxa_bioregions_binary_table_for_analyses_6_regions <- readRDS(file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses_6_regions.rds")
# Load Gabi's current classification
Bioregions_Ponerinae_Gabi_Camacho <- read.xlsx(xlsxFile = "./input_data/Biogeographic_data/Bioregions_Ponerinae_Gabi_Camacho.xlsx")
# Load Ponerinae_Macroevolution_taxa_database to find matches with Current name
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")

## 12.7.1/ Find matches with Current_name

# Match using Phylo label
Bioregions_Ponerinae_Gabi_Camacho <- left_join(x = Bioregions_Ponerinae_Gabi_Camacho,
                                               y = Ponerinae_Macroevolution_taxa_database[, c("Phylo_label", "Current_name")],
                                               by = c("New.sample.name" = "Phylo_label"))

# Match using Specimen code
Specimen_code_Current_names_table <- st_drop_geometry(Biogeographic_database_Ponerinae_curated) %>% 
  select(Specimen_code, Current_name) %>% 
  filter(!is.na(Specimen_code)) %>% 
  mutate(Specimen_code = str_to_upper(Specimen_code))  

Bioregions_Ponerinae_Gabi_Camacho <- left_join(x = Bioregions_Ponerinae_Gabi_Camacho,
                                               y = Specimen_code_Current_names_table,
                                               by = c("Voucher.Specimen.code" = "Specimen_code"))

# Merge both Current_names retrieved
Bioregions_Ponerinae_Gabi_Camacho$Current_name <- NA
Bioregions_Ponerinae_Gabi_Camacho$Current_name[!is.na(Bioregions_Ponerinae_Gabi_Camacho$Current_name.x)] <-Bioregions_Ponerinae_Gabi_Camacho$Current_name.x[!is.na(Bioregions_Ponerinae_Gabi_Camacho$Current_name.x)]
Bioregions_Ponerinae_Gabi_Camacho$Current_name[!is.na(Bioregions_Ponerinae_Gabi_Camacho$Current_name.y)] <-Bioregions_Ponerinae_Gabi_Camacho$Current_name.y[!is.na(Bioregions_Ponerinae_Gabi_Camacho$Current_name.y)]

Bioregions_Ponerinae_Gabi_Camacho <- Bioregions_Ponerinae_Gabi_Camacho %>% 
  select(-Current_name.x, -Current_name.y)

table(is.na(Bioregions_Ponerinae_Gabi_Camacho$Current_name))

## 12.7.2/ Merge with my current biogeographic 6 region classification

Taxa_bioregions_binary_table_for_analyses_6_regions[, -1] <- apply(X = Taxa_bioregions_binary_table_for_analyses_6_regions[, -1], MARGIN = 2, FUN = as.numeric)

names(Taxa_bioregions_binary_table_for_analyses_6_regions) <- c("Current_name", paste0(names(Taxa_bioregions_binary_table_for_analyses_6_regions[, -1]), "_new"))

Bioregions_Ponerinae_Gabi_Camacho <- left_join(x = Bioregions_Ponerinae_Gabi_Camacho,
                                               y = Taxa_bioregions_binary_table_for_analyses_6_regions)

# Remove entries with no match in the new classif
clean_test <- apply(X = Bioregions_Ponerinae_Gabi_Camacho[, 12:17], MARGIN = 1, FUN = function (x) { any(is.na(x))} )
Bioregions_Ponerinae_Gabi_Camacho <- Bioregions_Ponerinae_Gabi_Camacho[!clean_test, ]

## 12.7.3/ Test for equivalency ####

for (i in 1:nrow(Bioregions_Ponerinae_Gabi_Camacho))
{
  # i <- 2
  
  # Extract classifs
  Gabi_classif <- unlist(Bioregions_Ponerinae_Gabi_Camacho[i, 4:9, drop = T])
  New_classif <- unlist(Bioregions_Ponerinae_Gabi_Camacho[i, 12:17, drop = T])
  
  # Text equality
  Bioregions_Ponerinae_Gabi_Camacho$Equal_classifs[i] <- identical(as.numeric(Gabi_classif), as.numeric(New_classif))
}

table(Bioregions_Ponerinae_Gabi_Camacho$Equal_classifs)

View(Bioregions_Ponerinae_Gabi_Camacho[!Bioregions_Ponerinae_Gabi_Camacho$Equal_classifs, ])

## Save and export
saveRDS(object = Bioregions_Ponerinae_Gabi_Camacho, file = "./input_data/Biogeographic_data/Bioregions_Ponerinae_Gabi_Camacho_comparison.rds")
write.xlsx(x = Bioregions_Ponerinae_Gabi_Camacho, file = "./input_data/Biogeographic_data/Bioregions_Ponerinae_Gabi_Camacho_comparison.xlsx")


##### 13/ Inform taxa-level database for biogeographic information ####

## Load Ponerinae_Macroevolution_taxa_database
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")

## Load tables of occurrence counts/presences per taxa used in analyses
Taxa_bioregions_quantitative_table_for_analyses <- readRDS(file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses.rds")
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates <- readRDS(file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses_with_duplicates.rds")
Taxa_bioregions_binary_table_for_analyses <- readRDS(file = "./input_data/Biogeographic_data/Taxa_bioregions_binary_table_for_analyses.rds")

# Check matching order
identical(Ponerinae_Macroevolution_taxa_database$Current_name, Taxa_bioregions_quantitative_table_for_analyses$Current_name)
identical(Ponerinae_Macroevolution_taxa_database$Current_name, Taxa_bioregions_quantitative_table_for_analyses_with_duplicates$Current_name)
identical(Ponerinae_Macroevolution_taxa_database$Current_name, Taxa_bioregions_binary_table_for_analyses$Current_name)

# Add nb of biogeographic records, With and without duplicates
Ponerinae_Macroevolution_taxa_database$Occurrences_nb <- Taxa_bioregions_quantitative_table_for_analyses$Total_occ
Ponerinae_Macroevolution_taxa_database$Occurrences_nb_with_duplicates <- Taxa_bioregions_quantitative_table_for_analyses_with_duplicates$Total_occ_duplicates

hist(Ponerinae_Macroevolution_taxa_database$Occurrences_nb)
hist(Ponerinae_Macroevolution_taxa_database$Occurrences_nb_with_duplicates)

# Remove previous binary bioregion variables
Ponerinae_Macroevolution_taxa_database <- Ponerinae_Macroevolution_taxa_database %>% 
  select(-Afrotropics, -Malagasy, -Indomalaya, -Australasia, -Neotropics, -`Western Palearctic`, -`Eastern Palearctic`, -Nearctic, -Palearctic, -Afrotropics_Malagasy)

# Add Presence/Absence in each Bioregion
Ponerinae_Macroevolution_taxa_database <- cbind(Ponerinae_Macroevolution_taxa_database, Taxa_bioregions_binary_table_for_analyses[, -1])

# Save Ponerinae_Macroevolution_taxa_database
saveRDS(object = Ponerinae_Macroevolution_taxa_database, file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")


##### 14/ Create the Genus-level summary table #####

## Load Ponerinae_Macroevolution_taxa_database
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")
## Load tables of occurrence counts/presences per taxa used in analyses
Taxa_bioregions_quantitative_table_for_analyses <- readRDS(file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses.rds")
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates <- readRDS(file = "./input_data/Biogeographic_data/Taxa_bioregions_quantitative_table_for_analyses_with_duplicates.rds")

# Add Genus
Ponerinae_Macroevolution_taxa_database$Genus <- str_split(string = Ponerinae_Macroevolution_taxa_database$Current_name, pattern = "_", simplify = T)[, 1]
Taxa_bioregions_quantitative_table_for_analyses$Genus <- str_split(string = Taxa_bioregions_quantitative_table_for_analyses$Current_name, pattern = "_", simplify = T)[, 1]
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates$Genus <- str_split(string = Taxa_bioregions_quantitative_table_for_analyses_with_duplicates$Current_name, pattern = "_", simplify = T)[, 1]

# Create summary table and record nb of occurrence
Ponerinae_Biogeography_Genera_summary <- Ponerinae_Macroevolution_taxa_database %>% 
  group_by(Genus) %>% 
  summarize(Total_occ = sum(Occurrences_nb), 
            Total_occ_with_duplicates = sum(Occurrences_nb_with_duplicates))

# Add number of occurrences in each Bioregion
Taxa_bioregions_quantitative_table_for_analyses_Genera_summary <- Taxa_bioregions_quantitative_table_for_analyses %>% 
  select(-Current_name, -Total_occ) %>% 
  group_by(Genus) %>% 
  summarize(across(everything(), list(sum)))

names(Taxa_bioregions_quantitative_table_for_analyses_Genera_summary) <- str_remove(string = names(Taxa_bioregions_quantitative_table_for_analyses_Genera_summary), pattern = "_1")

Ponerinae_Biogeography_Genera_summary <- left_join(Ponerinae_Biogeography_Genera_summary, Taxa_bioregions_quantitative_table_for_analyses_Genera_summary)

# Add number of occurrences in each Bioregion including duplicates
Taxa_bioregions_quantitative_table_for_analyses_with_duplicates_Genera_summary <- Taxa_bioregions_quantitative_table_for_analyses_with_duplicates %>% 
  select(-Current_name, -Total_occ_duplicates) %>% 
  group_by(Genus) %>% 
  summarize(across(everything(), list(sum)))

names(Taxa_bioregions_quantitative_table_for_analyses_with_duplicates_Genera_summary) <- str_remove(string = names(Taxa_bioregions_quantitative_table_for_analyses_with_duplicates_Genera_summary), pattern = "_1")

Ponerinae_Biogeography_Genera_summary <- left_join(Ponerinae_Biogeography_Genera_summary, Taxa_bioregions_quantitative_table_for_analyses_with_duplicates_Genera_summary)

## Save Genus-level summary table for biogeography
saveRDS(object = Ponerinae_Biogeography_Genera_summary, file = "./input_data/Ponerinae_Biogeography_Genera_summary.rds")
write.xlsx(x = Ponerinae_Biogeography_Genera_summary, file = "./input_data/Biogeographic_data/Ponerinae_Biogeography_Genera_summary.xlsx")


##### 15/ Create Bioregion-level summary table ####

## Load Ponerinae_Macroevolution_taxa_database
Ponerinae_Macroevolution_taxa_database <- readRDS(file = "./input_data/Ponerinae_Macroevolution_taxa_database.rds")

table(Ponerinae_Macroevolution_taxa_database$Current_status, Ponerinae_Macroevolution_taxa_database$In_phylogeny)

Ponerinae_Macroevolution_taxa_database$Current_status[Ponerinae_Macroevolution_taxa_database$Current_status == "new"] <- "morphotaxon"

# Compute number and proportion of valid species per bioregions
Valid_taxa_per_bioregions_df <- Ponerinae_Macroevolution_taxa_database %>% 
  select(-Afrotropics) %>%
  rename(Afrotropics = Afrotropics_Malagasy) %>%
  pivot_longer(cols = c("Afrotropics", "Indomalaya", "Australasia", "Neotropics", "Western Palearctic", "Eastern Palearctic", "Nearctic"), names_to = "Bioregions_7_PaleA", values_to = "PA") %>%
  group_by(Bioregions_7_PaleA, In_phylogeny) %>%
  summarize(taxa_counts = sum(PA)) %>%
  pivot_wider(names_from = "In_phylogeny", values_from = "taxa_counts") %>%
  rename("Grafted_counts" = `FALSE`,
         "UCE_counts" = `TRUE`) %>%
  mutate(Total_taxa = Grafted_counts + UCE_counts) %>%
  mutate(Grafted_perc = round(Grafted_counts / Total_taxa * 100, 1)) %>%
  mutate(UCE_perc = round(UCE_counts / Total_taxa * 100, 1))

# Save summary table for Grafted vs. UCE data across bioregions
saveRDS(object = Valid_taxa_per_bioregions_df, file = "./input_data/Biogeographic_data/Valid_taxa_per_bioregions_df.rds")


##### 16/ Export clean occurrence database for Supplementary Data 4 ####

## Load Biogeographic database with all curated coordinates
Biogeographic_database_Ponerinae_curated <- readRDS(file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_curated.rds")

Biogeographic_database_Ponerinae_cleaned <- Biogeographic_database_Ponerinae_curated %>% 
  mutate(AOW_Ponerinae_Occ_ID = paste0("AOTW_Ponerinae_Occ_", 1:nrow(Biogeographic_database_Ponerinae_curated))) %>%
  rename(Taxa_name = Current_name,
         AntWeb_ID = Specimen_code,
         bentity2_temp = bentity2,
         bentity2 = bentity2_name,
         Bioregion_temp = Bioregion,
         Bioregion = Bioregion_7_PaleA) %>%
  sf::st_drop_geometry() %>%
  dplyr::select(AOW_Ponerinae_Occ_ID, Source, AntWeb_ID, GABI_accession_ID, Accession_ID,
                Taxa_name, Initial_name, Current_status,
                Latitude_dec, Longitude_dec,
                Country_ISO3_name, Country_ISO3_code,
                bentity2, adm1, adm2, Locality,
                Bioregion, duplicate,
                Interpolated_coordinates, Uncertainty_area,
                Interpolated_Bentity2, Interpolated_adm1, Interpolated_adm2,
                Uncertainty_adm1, Uncertainty_adm2,
                Updated_coordinates, Updated_Bentity2, Updated_adm1, Updated_adm2, Updated_Locality)

## Save Supplementary Data 3
saveRDS(Biogeographic_database_Ponerinae_cleaned, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_cleaned.rds")
## Export in Excel
openxlsx::write.xlsx(x = Biogeographic_database_Ponerinae_cleaned, file = "./input_data/Biogeographic_data/Biogeographic_database_Ponerinae_cleaned.xlsx")

